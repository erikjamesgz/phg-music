"use strict";const e=require("../utils/index.js"),t=require("../utils/http.js"),s=require("../utils/crypto/index.js"),{formatFileSize:a,formatTime:r}=e.format,i=e=>{if(!e)return"00:00";const t=Math.floor(e/60),s=Math.floor(e%60);return(t<10?"0"+t:t)+":"+(s<10?"0"+s:s)},l={getHotKeywords:(e="all")=>t.http.get("/api/search/hot",{source:e}),getWyHotSearch:()=>t.http.get("https://music.163.com/api/search/chart/detail",{id:"HOT_SEARCH_SONG#@#"}),getTxHotSearch:()=>t.http.post("https://u.y.qq.com/cgi-bin/musicu.fcg",{comm:{ct:"19",cv:"1803",guid:"0",patch:"118",psrf_access_token_expiresAt:0,psrf_qqaccess_token:"",psrf_qqopenid:"",psrf_qqunionid:"",tmeAppID:"qqmusic",tmeLoginType:0,uin:"0",wid:"0"},hotkey:{method:"GetHotkeyForQQMusicPC",module:"tencent_musicsoso_hotkey.HotkeyService",param:{search_id:"",uin:0}}},{headers:{Referer:"https://y.qq.com/portal/player.html"}}),getKgHotSearch:()=>t.http.get("http://mobilecdnbj.kugou.com/api/v3/rank/song",{version:"9108",ranktype:"2",plat:"0",pagesize:"20",area_code:"1",page:"1",volid:"35050",rankid:"6666",with_res_tag:"1"}),getKwHotSearch:()=>t.http.get("http://hotword.kuwo.cn/hotword.s",{prod:"kwplayer_ar_9.3.0.1",corp:"kuwo",newver:2,vipver:"9.3.0.1",source:"kwplayer_ar_9.3.0.1_40.apk",p2p:1,notrace:0,uid:0,plat:"kwplayer_ar",rformat:"json",encoding:"utf8",tabid:1},{headers:{"User-Agent":"Dalvik/2.1.0 (Linux; U; Android 9;)"}}),getMgHotSearch:()=>t.http.get("http://jadeite.migu.cn:7090/music_search/v3/search/hotword"),searchKwSongs:(e,s=1,a=30)=>t.http.get("http://search.kuwo.cn/r.s",{client:"kt",all:e,pn:s-1,rn:a,uid:"794762570",ver:"kwplayer_ar_9.2.2.1",vipver:"1",show_copyright_off:"1",newver:"1",ft:"music",cluster:"0",strategy:"2012",encoding:"utf8",rformat:"json",vermerge:"1",mobi:"1",issubtitle:"1"}).then(e=>{if(!e||!e.abslist)return{source:"kw",list:[]};const t=e.abslist.map(e=>{let t=[];if(e.N_MINFO){const s=e.N_MINFO.split(";"),a=/level:(\w+),bitrate:(\d+),format:(\w+),size:([\w.]+)/;for(let e of s){const s=e.match(a);if(s){switch(s[2]){case"4000":t.push("flac24bit");break;case"2000":t.push("flac");break;case"320":t.push("320k");break;case"128":t.push("128k")}}}}return{id:e.MUSICRID.replace("MUSIC_",""),musicrid:e.MUSICRID,name:e.SONGNAME,singer:e.ARTIST,album:{name:e.ALBUM||"未知专辑",picUrl:e.web_albumpic_small||""},al:{picUrl:e.web_albumpic_small||""},source:"kw",pic:e.web_albumpic_small||"",url:"",quality:t.join(","),duration:1e3*e.DURATION||0,artists:[{name:e.ARTIST}]}});return{source:"kw",list:t,total:parseInt(e.TOTAL)||t.length,allPage:Math.ceil((parseInt(e.TOTAL)||t.length)/a)}}).catch(e=>(console.error("酷我音乐搜索失败:",e),{source:"kw",list:[]})),searchKgSongs:(e,s=1,a=30)=>t.http.get("https://songsearch.kugou.com/song_search_v2",{keyword:e,page:s,pagesize:a,userid:"0",clientver:"",platform:"WebFilter",filter:2,iscorrection:1,privilege_filter:0,area_code:1}).then(e=>{if(!e||!e.data||!e.data.lists)return{source:"kg",list:[]};const t=e.data.lists.map(e=>{const t=e.FileName||"",s=t.split(" - "),a=s[0]||"",r=s[1]||t;let i="";return e.SQFileSize&&e.SQFileSize>0?i="SQ":e.HQFileSize&&e.HQFileSize>0&&(i="HQ"),{id:e.FileHash,name:r,singer:a,album:{name:e.AlbumName||"未知专辑",picUrl:""},al:{picUrl:""},source:"kg",pic:"",url:"",quality:i,duration:1e3*e.Duration||0,artists:[{name:a}]}});return{source:"kg",list:t,total:e.data.total||t.length,allPage:Math.ceil((e.data.total||t.length)/a)}}).catch(e=>(console.error("酷狗音乐搜索失败:",e),{source:"kg",list:[]})),searchTxSongs:(e,s=1,a=30)=>t.http.post("https://u.y.qq.com/cgi-bin/musicu.fcg",{comm:{ct:11,cv:"1003006",v:"1003006",guid:"0",uin:"0"},req:{method:"DoSearchForQQMusicDesktop",module:"music.search.SearchCgiService",param:{query:e,page_num:s,num_per_page:a,search_type:0}}},{headers:{Referer:"https://y.qq.com/portal/player.html"}}).then(e=>{if(!(e&&e.req&&e.req.data&&e.req.data.body&&e.req.data.body.song&&e.req.data.body.song.list))return{source:"tx",list:[]};const t=e.req.data.body.song.list.map(e=>{let t=[];const s=e.file;s&&(s.size_128mp3>0&&t.push("128k"),s.size_320mp3>0&&t.push("320k"),s.size_flac>0&&t.push("flac"),s.size_hires>0&&t.push("flac24bit"));const a=e.singer?e.singer.map(e=>({name:e.name,id:e.mid})):[],r=a.map(e=>e.name).join("/");return{id:e.mid,name:e.name,singer:r,album:{name:e.album?e.album.name:"未知专辑",id:e.album?e.album.mid:"",picUrl:e.album&&e.album.mid?`https://y.qq.com/music/photo_new/T002R300x300M000${e.album.mid}.jpg`:""},al:{picUrl:e.album&&e.album.mid?`https://y.qq.com/music/photo_new/T002R300x300M000${e.album.mid}.jpg`:""},source:"tx",pic:e.album&&e.album.mid?`https://y.qq.com/music/photo_new/T002R300x300M000${e.album.mid}.jpg`:"",url:"",quality:t.join(","),duration:1e3*e.interval||0,artists:a}});return{source:"tx",list:t,total:e.req.data.body.song.totalnum||t.length,allPage:Math.ceil((e.req.data.body.song.totalnum||t.length)/a)}}).catch(e=>(console.error("QQ音乐搜索失败:",e),{source:"tx",list:[]})),searchWySongs:(e,s=1,i=30)=>t.http.get("https://music.163.com/api/search/get",{s:e,type:"1",offset:(s-1)*i,limit:i,csrf_token:""}).then(e=>{if(!e||200!==e.code)return console.error("网易云音乐搜索失败:",e),{source:"wy",list:[]};const t=e.result.songs||[];if(!t.length)return{source:"wy",list:[]};return{list:t.map(e=>{const t=[],s={};let i;if(e.privilege&&"hires"==e.privilege.maxBrLevel&&(i=e.hr?a(e.hr.size):null,t.push({type:"flac24bit",size:i}),s.flac24bit={size:i}),e.privilege)switch(e.privilege.maxbr){case 999e3:i=e.sq?a(e.sq.size):null,t.push({type:"flac",size:i}),s.flac={size:i};break;case 32e4:i=e.h?a(e.h.size):null,t.push({type:"320k",size:i}),s["320k"]={size:i};break;case 192e3:case 128e3:i=e.l?a(e.l.size):null,t.push({type:"128k",size:i}),s["128k"]={size:i}}t.reverse();const l=e.artists?e.artists.map(e=>e.name).join("、"):"";return{id:e.id,name:e.name,singer:l,artists:e.artists?e.artists.map(e=>({id:e.id,name:e.name})):[],album:{id:e.album?e.album.id:null,name:e.album?e.album.name:"未知专辑",picUrl:e.album?e.album.picUrl:""},al:{picUrl:e.album?e.album.picUrl:""},albumName:e.album?e.album.name:"未知专辑",albumId:e.album?e.album.id:null,source:"wy",interval:r(e.duration/1e3),duration:e.duration,songmid:e.id.toString(),img:e.album?e.album.picUrl:"",lrc:null,types:t,_types:s,typeUrl:{},quality:t.length>0?t[0].type:null}}),allPage:Math.ceil((e.result.songCount||0)/i),limit:i,total:e.result.songCount||0,source:"wy"}}).catch(e=>(console.error("网易云音乐搜索失败:",e),{source:"wy",list:[]})),createMgSignature(e,t){const a="963B7AA0D21511ED807EE5846EC87D20";return{sign:s.md5(`${t}6cdc72a439cef99a3418d2a78aa28c73yyapp2d16148780a1dcc7408e06336b98cfd50${a}${e}`),deviceId:a}},searchMgSongs(e,s=1,r=30){const l=Date.now().toString(),o=this.createMgSignature(l,e),c=`https://jadeite.migu.cn/music_search/v3/search/searchAll?isCorrect=0&isCopyright=1&searchSwitch=%7B%22song%22%3A1%2C%22album%22%3A0%2C%22singer%22%3A0%2C%22tagSong%22%3A1%2C%22mvSong%22%3A0%2C%22bestShow%22%3A1%2C%22songlist%22%3A0%2C%22lyricSong%22%3A0%7D&pageSize=${r}&text=${encodeURIComponent(e)}&pageNo=${s}&sort=0&sid=USS`;return t.http.request({url:c,method:"GET",header:{uiVersion:"A_music_3.6.1",deviceId:o.deviceId,timestamp:l,sign:o.sign,channel:"0146921","User-Agent":"Mozilla/5.0 (Linux; U; Android 11.0.0; zh-cn; MI 11 Build/OPR1.170623.032) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30"}}).then(e=>{if(!e||!e.songResultData||!e.songResultData.resultList)return{source:"mg",list:[]};const t=e.songResultData.resultList,s=[],l=new Set;return t.forEach(e=>{e.forEach(e=>{if(!e.songId||!e.copyrightId||l.has(e.copyrightId))return;l.add(e.copyrightId);const t=[],r={};e.audioFormats&&e.audioFormats.forEach(e=>{let s;switch(e.formatType){case"PQ":s=a(e.asize??e.isize),t.push({type:"128k",size:s}),r["128k"]={size:s};break;case"HQ":s=a(e.asize??e.isize),t.push({type:"320k",size:s}),r["320k"]={size:s};break;case"SQ":s=a(e.asize??e.isize),t.push({type:"flac",size:s}),r.flac={size:s};break;case"ZQ24":s=a(e.asize??e.isize),t.push({type:"flac24bit",size:s}),r.flac24bit={size:s}}});let o=e.img3||e.img2||e.img1||null;var c;o&&!/https?:/.test(o)&&(o="http://d.musicapp.migu.cn"+o),s.push({singer:(c=e.singerList,c?c.map(e=>e.name).join("、"):""),name:e.name,albumName:e.album,albumId:e.albumId,songmid:e.songId,copyrightId:e.copyrightId,source:"mg",interval:i(e.duration),img:o,lrc:null,lrcUrl:e.lrcUrl,mrcUrl:e.mrcurl,trcUrl:e.trcUrl,types:t,_types:r,typeUrl:{},id:e.copyrightId,album:{name:e.album||"未知专辑",picUrl:o},al:{picUrl:o},duration:1e3*e.duration||0,artists:e.singerList?e.singerList.map(e=>({name:e.name,id:e.id})):[],quality:t.length>0?t[0].type:null})})}),{source:"mg",list:s,total:e.songResultData.totalCount||s.length,allPage:Math.ceil((e.songResultData.totalCount||s.length)/r)}}).catch(e=>(console.error("咪咕音乐搜索失败:",e),{source:"mg",list:[]}))},searchSongs(e,t="all",s=1,a=30){switch(t){case"kw":return this.searchKwSongs(e,s,a);case"kg":return this.searchKgSongs(e,s,a);case"tx":return this.searchTxSongs(e,s,a);case"wy":return this.searchWySongs(e,s,a);case"mg":return this.searchMgSongs(e,s,a);default:return Promise.all([this.searchKwSongs(e,s,a).catch(()=>({source:"kw",list:[]})),this.searchKgSongs(e,s,a).catch(()=>({source:"kg",list:[]})),this.searchTxSongs(e,s,a).catch(()=>({source:"tx",list:[]})),this.searchWySongs(e,s,a).catch(()=>({source:"wy",list:[]})),this.searchMgSongs(e,s,a).catch(()=>({source:"mg",list:[]}))]).then(e=>{let t=[],s=0,a=1;for(const r of e)r&&r.list&&r.list.length>0&&(t=[...t,...r.list],s+=r.total||0,a=Math.max(a,r.allPage||1));return{source:"all",list:t,total:s,allPage:a}})}},searchWyPlaylists:(e,s=1,a=20)=>t.http.post("https://music.163.com/weapi/cloudsearch/get/web",{s:e,type:1e3,limit:a,offset:(s-1)*a,total:!0},{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.198 Safari/537.36"},isNetease:!0}).then(e=>{if(!e||!e.result||!e.result.playlists)return{source:"wy",list:[]};const t=e.result.playlists.map(e=>({id:e.id,name:e.name,coverImgUrl:e.coverImgUrl,playCount:e.playCount,trackCount:e.trackCount,creator:e.creator?e.creator.nickname:"",description:e.description,source:"wy"}));return{list:t,total:e.result.playlistCount||t.length,allPage:Math.ceil((e.result.playlistCount||t.length)/a),source:"wy"}}).catch(e=>(console.error("网易云音乐歌单搜索失败:",e),{source:"wy",list:[]})),searchTxPlaylists:(e,s=1,a=20)=>t.http.post("https://u.y.qq.com/cgi-bin/musicu.fcg",{comm:{ct:11,cv:"1003006",v:"1003006",guid:"0",uin:"0"},req:{method:"DoSearchForQQMusicDesktop",module:"music.search.SearchCgiService",param:{query:e,page_num:s,num_per_page:a,search_type:2}}},{headers:{Referer:"https://y.qq.com/portal/player.html"}}).then(e=>{if(!(e&&e.req&&e.req.data&&e.req.data.body&&e.req.data.body.songlist&&e.req.data.body.songlist.list))return{source:"tx",list:[]};const t=e.req.data.body.songlist.list.map(e=>({id:e.dissid,name:e.dissname,coverImgUrl:e.imgurl,playCount:e.listennum,trackCount:e.song_count||0,creator:e.creator?e.creator.name:"",description:e.desc||"",source:"tx"}));return{list:t,total:e.req.data.body.songlist.total||t.length,allPage:Math.ceil((e.req.data.body.songlist.total||t.length)/a),source:"tx"}}).catch(e=>(console.error("QQ音乐歌单搜索失败:",e),{source:"tx",list:[]})),searchKgPlaylists:(e,s=1,a=20)=>t.http.get("http://msearchretry.kugou.com/api/v3/search/special",{keyword:e,page:s,pagesize:a,showtype:10,filter:0,version:7910,sver:2}).then(e=>{if(!e||!e.data||!e.data.info)return{source:"kg",list:[]};const t=e.data.info.map(e=>({id:e.specialid,name:e.specialname,coverImgUrl:e.imgurl,playCount:e.playcount||0,trackCount:e.songcount||0,creator:e.nickname||"",description:e.intro||"",source:"kg"}));return{list:t,total:e.data.total||t.length,allPage:Math.ceil((e.data.total||t.length)/a),source:"kg"}}).catch(e=>(console.error("酷狗音乐歌单搜索失败:",e),{source:"kg",list:[]})),searchKwPlaylists:(e,s=1,a=20)=>t.http.get("http://search.kuwo.cn/r.s",{all:e,pn:s-1,rn:a,rformat:"json",encoding:"utf8",ver:"mbox",vipver:"MUSIC_8.7.7.0_BCS37",plat:"pc",devid:"28156413",ft:"playlist",pay:0,needliveshow:0}).then(e=>{if(!e||!e.abslist)return{source:"kw",list:[]};const t=e.abslist.map(e=>({id:String(e.playlistid),name:e.name,coverImgUrl:e.pic,playCount:e.playcnt||0,trackCount:e.songnum||0,creator:e.nickname||"",description:e.intro||"",source:"kw"}));return{list:t,total:e.total||t.length,allPage:Math.ceil((e.total||t.length)/a),source:"kw"}}).catch(e=>(console.error("酷我音乐歌单搜索失败:",e),{source:"kw",list:[]})),searchMgPlaylists:(e,s=1,a=20)=>t.http.get("https://jadeite.migu.cn/music_search/v3/search/searchAll",{isCorrect:1,isCopyright:1,searchSwitch:'{"song":0,"album":0,"singer":0,"tagSong":0,"mvSong":0,"bestShow":0,"songlist":1,"lyricSong":0}',pageSize:a,text:e,pageNo:s,sort:0,sid:"USS"},{headers:{channel:"0146921","User-Agent":"Mozilla/5.0 (Linux; U; Android 11.0.0; zh-cn; MI 11 Build/OPR1.170623.032) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30"}}).then(e=>{if(!e||!e.songListResultData||!e.songListResultData.result)return{source:"mg",list:[]};const t=e.songListResultData.result.map(e=>({id:e.id,name:e.name,coverImgUrl:e.musicListPicUrl,playCount:e.playNum||0,trackCount:e.musicNum||0,creator:e.userName||"",description:e.intro||"",source:"mg"}));return{list:t,total:parseInt(e.songListResultData.totalCount)||t.length,allPage:Math.ceil((parseInt(e.songListResultData.totalCount)||t.length)/a),source:"mg"}}).catch(e=>(console.error("咪咕音乐歌单搜索失败:",e),{source:"mg",list:[]})),searchPlaylists(e,t="all",s=1,a=20){switch(t){case"wy":return this.searchWyPlaylists(e,s,a);case"tx":return this.searchTxPlaylists(e,s,a);case"kg":return this.searchKgPlaylists(e,s,a);case"kw":return this.searchKwPlaylists(e,s,a);case"mg":return this.searchMgPlaylists(e,s,a);default:return Promise.all([this.searchWyPlaylists(e,s,a).catch(()=>({source:"wy",list:[]})),this.searchTxPlaylists(e,s,a).catch(()=>({source:"tx",list:[]})),this.searchKgPlaylists(e,s,a).catch(()=>({source:"kg",list:[]})),this.searchKwPlaylists(e,s,a).catch(()=>({source:"kw",list:[]})),this.searchMgPlaylists(e,s,a).catch(()=>({source:"mg",list:[]}))]).then(e=>{let t=[],s=0,a=1;for(const r of e)r&&r.list&&r.list.length>0&&(t=[...t,...r.list],s+=r.total||0,a=Math.max(a,r.allPage||1));return{source:"all",list:t,total:s,allPage:a}})}},getSuggestions:e=>t.http.post("https://music.163.com/weapi/search/suggest/web",{s:e},{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.198 Safari/537.36"},isNetease:!0}).then(e=>e&&e.result&&e.result.songs?e.result.songs.map(e=>e.name):[]).catch(e=>(console.error("获取搜索建议失败:",e),[]))};exports.searchApi=l;
