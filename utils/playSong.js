"use strict";const o=require("../common/vendor.js"),e=require("../store/modules/list.js"),l=require("../store/modules/player.js"),a=require("../store/modules/system.js"),n=require("./api/music.js"),r=require("./musicUrlCache.js"),i=require("./lyricCache.js"),s=o=>{if(!o)return"0:00";let e=0;if("string"==typeof o){const l=o.split(":");e=2===l.length?60*parseInt(l[0])+parseInt(l[1]):parseInt(o)}else"number"==typeof o&&(e=Math.floor(o/1e3));return`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`};exports.playSongCommon=async(t,m={})=>{var c,u,g,d,y;if(!t||!t.id)return console.error("[playSongCommon] 歌曲信息无效"),!1;const{listId:p=e.LIST_IDS.DEFAULT,addToDefaultList:S=!0,source:h=t.source||"tx"}=m;console.log("[playSongCommon] ========== 开始播放歌曲 =========="),console.log("[playSongCommon] 歌曲ID:",t.id),console.log("[playSongCommon] 歌曲名称:",t.name),console.log("[playSongCommon] 列表ID:",p),console.log("[playSongCommon] 是否添加到试听列表:",S);try{const o=a.systemStore.getState().audioQuality||"128k";console.log("[playSongCommon] 使用音质:",o);const m=null==(c=l.playerStore.state.currentSong)?void 0:c.id;if(console.log("[playSongCommon] 之前播放的歌曲ID:",m),S&&p===e.LIST_IDS.DEFAULT){const o={id:t.id,name:t.name,singer:t.singer||(t.ar?t.ar.map(o=>o.name).join("/"):""),album:t.album||t.albumName||(null==(u=t.al)?void 0:u.name)||"",duration:t.dt||t.interval||t.duration,source:h,songmid:t.songmid,hash:t.hash,copyrightId:t.copyrightId,img:t.img||t.albumPic||(null==(g=t.al)?void 0:g.picUrl)||""},l=e.listStore.state.defaultList.list;new Set(l.map(o=>o.id)).has(o.id)?console.log("[playSongCommon] 歌曲已在试听列表中:",o.name):(e.listStore.addListMusics(e.LIST_IDS.DEFAULT,[o],"top"),console.log("[playSongCommon] 已添加歌曲到试听列表:",o.name))}e.listStore.setPlayerListId(p);const C={id:t.id,name:t.name,singer:t.singer||(t.ar?t.ar.map(o=>o.name).join("/"):""),album:t.album||t.albumName||(null==(d=t.al)?void 0:d.name)||"",duration:t.dt||t.interval||t.duration,source:h,songmid:t.songmid,hash:t.hash,copyrightId:t.copyrightId,img:t.img||t.albumPic||(null==(y=t.al)?void 0:y.picUrl)||"",url:"",playUrl:"",quality:o,lyric:"",tlyric:"",rlyric:"",lxlyric:""};e.listStore.setPlayMusicInfo(p,C,!1),l.playerStore.setCurrentSong(C,!0),l.playerStore.setStatusText("正在获取播放链接...",0),console.log("[playSongCommon] 已设置歌曲信息，MiniPlayer 将显示");const b=m===t.id;if(console.log("[playSongCommon] 是否是同一首歌:",b),b)return console.log("[playSongCommon] 同一首歌，切换播放/暂停状态"),l.playerStore.clearStatusText(),l.playerStore.state.isPlaying?l.playerStore.pause():l.playerStore.resume(),!0;const v=await r.getCachedMusicUrl(t.id,o);let f=v,w=null;if(v){console.log("[playSongCommon] 使用缓存的播放URL");const o=await i.getCachedLyric(t.id,h);o?(w=o,console.log("[playSongCommon] 从缓存获取歌词")):w={}}else{let e,l;switch(console.log("[playSongCommon] 调用API获取播放URL"),h){case"tx":e={source:"tx",musicInfo:{id:t.songmid||t.id,name:t.name,singer:t.singer||"",source:"tx",songmid:t.songmid||t.id,interval:s(t.dt||t.interval||t.duration),meta:{songId:t.songmid||t.id,albumName:t.album||t.albumName||"",hash:t.songmid||t.id}},quality:o};break;case"wy":e={source:"wy",musicInfo:{id:t.id,name:t.name,singer:t.singer||"",source:"wy",interval:s(t.dt||t.interval||t.duration),meta:{songId:t.id,albumName:t.album||t.albumName||"",hash:t.id}},quality:o};break;case"kg":e={source:"kg",musicInfo:{id:t.id,name:t.name,singer:t.singer||"",source:"kg",interval:s(t.dt||t.interval||t.duration),meta:{songId:t.id,albumName:t.album||t.albumName||"",hash:t.hash||t.id}},quality:o};break;case"kw":e={source:"kw",musicInfo:{id:t.id,name:t.name,singer:t.singer||"",source:"kw",interval:s(t.dt||t.interval||t.duration),meta:{songId:t.id,albumName:t.album||t.albumName||"",hash:t.id}},quality:o};break;case"mg":const l=t.songmid||t.songId,a=t.copyrightId||t.id;e={source:"mg",songmid:l,id:a,musicInfo:{songmid:l,copyrightId:a,name:t.name,singer:t.singer||"",album:t.album||t.albumName||""},quality:o};break;default:e={source:h,musicInfo:{id:t.id,name:t.name,singer:t.singer||"",source:h,interval:s(t.dt||t.interval||t.duration),meta:{songId:t.id,albumName:t.album||t.albumName||"",hash:t.id}},quality:o}}console.log("[playSongCommon] 请求参数:",JSON.stringify(e));try{l=await n.getMusicUrl(e),console.log("[playSongCommon] API返回数据")}catch(I){throw console.error("[playSongCommon] API调用失败:",I),new Error("获取播放链接失败: "+(I.message||"网络请求失败"))}if(f=null==l?void 0:l.url,!f)throw console.error("[playSongCommon] API返回数据中没有URL"),new Error("无法获取播放链接，该歌曲可能不可用");console.log("[playSongCommon] 获取到的播放URL:",f),await r.setCachedMusicUrl(t.id,o,f),w={lyric:l.lyric||"",tlyric:l.tlyric||"",rlyric:l.rlyric||"",lxlyric:l.lxlyric||""},(w.lyric||w.tlyric||w.rlyric||w.lxlyric)&&(await i.setCachedLyric(t.id,h,w),console.log("[playSongCommon] 歌词已缓存"))}const L={...C,url:f,playUrl:f,lyric:(null==w?void 0:w.lyric)||"",tlyric:(null==w?void 0:w.tlyric)||"",rlyric:(null==w?void 0:w.rlyric)||"",lxlyric:(null==w?void 0:w.lxlyric)||""};return console.log("[playSongCommon] 最终歌曲信息:",L.name,"URL:",f?"有":"无"),e.listStore.setPlayMusicInfo(p,L,!1),l.playerStore.playSong(L),console.log("[playSongCommon] 播放完成"),!0}catch(C){return console.error("[playSongCommon] 播放失败:",C),l.playerStore.clearStatusText(),o.index.showToast({title:"播放失败: "+(C.message||"未知错误"),icon:"none"}),!1}};
