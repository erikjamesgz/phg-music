"use strict";const o=require("../common/vendor.js"),l=require("../store/modules/list.js"),e=require("../store/modules/player.js"),r=require("../store/modules/system.js"),n=require("./api/music.js"),a=require("./musicUrlCache.js"),i=require("./lyricCache.js"),s=require("./musicParams.js");exports.playSongCommon=async(c,t={})=>{var m,g,u,y,d,S;if(!c||!c.id)return console.error("[playSongCommon] 歌曲信息无效"),!1;const{listId:p=l.LIST_IDS.DEFAULT,addToDefaultList:h=!0,source:C=c.source||"tx"}=t;console.log("[playSongCommon] ========== 开始播放歌曲 =========="),console.log("[playSongCommon] 歌曲ID:",c.id),console.log("[playSongCommon] 歌曲名称:",c.name),console.log("[playSongCommon] 列表ID:",p),console.log("[playSongCommon] 是否添加到试听列表:",h);try{const o=r.systemStore.getState().audioQuality||"128k";console.log("[playSongCommon] 使用音质:",o);const t=null==(m=e.playerStore.state.currentSong)?void 0:m.id;if(console.log("[playSongCommon] 之前播放的歌曲ID:",t),h&&p===l.LIST_IDS.DEFAULT){const o={id:c.id,name:c.name,singer:c.singer||(c.ar?c.ar.map(o=>o.name).join("/"):""),ar:c.ar||(c.singer?c.singer.split("/").map(o=>({name:o})):[]),album:c.album||c.albumName||(null==(g=c.al)?void 0:g.name)||"",duration:c.dt||c.interval||c.duration,source:C,songmid:c.songmid,hash:c.hash,copyrightId:c.copyrightId,img:c.img||c.albumPic||(null==(u=c.al)?void 0:u.picUrl)||""},e=l.listStore.state.defaultList.list;new Set(e.map(o=>o.id)).has(o.id)?console.log("[playSongCommon] 歌曲已在试听列表中:",o.name):(l.listStore.addListMusics(l.LIST_IDS.DEFAULT,[o],"top"),console.log("[playSongCommon] 已添加歌曲到试听列表:",o.name))}l.listStore.setPlayerListId(p);const I={id:c.id,name:c.name,singer:c.singer||(c.ar?c.ar.map(o=>o.name).join("/"):""),ar:c.ar||(c.singer?c.singer.split("/").map(o=>({name:o})):[]),album:c.album||c.albumName||(null==(y=c.al)?void 0:y.name)||"",duration:c.dt||c.interval||c.duration,source:C,songmid:c.songmid,hash:c.hash,copyrightId:c.copyrightId,img:c.img||c.albumPic||(null==(d=c.al)?void 0:d.picUrl)||"",url:"",playUrl:"",quality:o,lyric:"",tlyric:"",rlyric:"",lxlyric:""};l.listStore.setPlayMusicInfo(p,I,!1),e.playerStore.setCurrentSong(I,!0),e.playerStore.setStatusText("正在获取播放链接...",0),console.log("[playSongCommon] 已设置歌曲信息，MiniPlayer 将显示");const b=t===c.id;if(console.log("[playSongCommon] 是否是同一首歌:",b),b)return console.log("[playSongCommon] 同一首歌，切换播放/暂停状态"),e.playerStore.clearStatusText(),e.playerStore.state.isPlaying?e.playerStore.pause():e.playerStore.resume(),!0;let w=await a.getCachedMusicUrl(c.id,o,C),U=w,L=null,k=C;if(w){console.log("[playSongCommon] 使用缓存的播放URL (source:",C,")"),e.playerStore.setUsingCachedUrl(!0);const o=await i.getCachedLyric(c.id,C);o?(L=o,console.log("[playSongCommon] 从缓存获取歌词")):L={},k=C}else{console.log("[playSongCommon] 调用API获取播放URL");const l={...c,source:C},e=s.buildMusicRequestParams(l,o);if(!e)throw new Error("构建请求参数失败");let r;console.log("[playSongCommon] 请求参数:",JSON.stringify(e));try{r=await n.getMusicUrl(e),console.log("[playSongCommon] API返回数据")}catch(f){throw console.error("[playSongCommon] API调用失败:",f),new Error("获取播放链接失败: "+(f.message||"网络请求失败"))}if(U=null==r?void 0:r.url,!U)throw console.error("[playSongCommon] API返回数据中没有URL"),new Error("无法获取播放链接，该歌曲可能不可用");console.log("[playSongCommon] 获取到的播放URL:",U);const t=(null==(S=r.fallback)?void 0:S.newSource)||C;k=t;const m=["128k","320k","flac"];for(const o of m)await a.setCachedMusicUrl(c.id,o,U,C);if(console.log("[playSongCommon] 播放URL已缓存 (原始source):",c.id,"source:",C,"所有音质"),t!==C){for(const o of m)await a.setCachedMusicUrl(c.id,o,U,t);console.log("[playSongCommon] 播放URL已缓存 (换源后source):",c.id,"source:",t,"所有音质")}L={lyric:r.lyric||"",tlyric:r.tlyric||"",rlyric:r.rlyric||"",lxlyric:r.lxlyric||""},(L.lyric||L.tlyric||L.rlyric||L.lxlyric)&&(await i.setCachedLyric(c.id,C,L),console.log("[playSongCommon] 歌词已缓存 (原始source):",c.id,"source:",C),t!==C&&(await i.setCachedLyric(c.id,t,L),console.log("[playSongCommon] 歌词已缓存 (换源后source):",c.id,"source:",t))),r.fallback&&r.fallback.toggled&&(console.log("[playSongCommon] 检测到换源:",{originalSource:r.fallback.originalSource,newSource:r.fallback.newSource}),I.source=r.fallback.newSource,I._toggleMusicInfo={originalSource:r.fallback.originalSource,newSource:r.fallback.newSource,matchedSong:r.fallback.matchedSong,toggleTime:Date.now()},r.fallback.matchedSong&&(I.songmid=r.fallback.matchedSong.songmid||c.songmid,I.hash=r.fallback.matchedSong.hash||c.hash,I.copyrightId=r.fallback.matchedSong.copyrightId||c.copyrightId),console.log("[playSongCommon] 已更新歌曲换源信息"))}const v={...I,source:k,url:U||"",playUrl:U||"",lyric:(null==L?void 0:L.lyric)||"",tlyric:(null==L?void 0:L.tlyric)||"",rlyric:(null==L?void 0:L.rlyric)||"",lxlyric:(null==L?void 0:L.lxlyric)||""};return console.log("[playSongCommon] 最终歌曲信息:",v.name,"URL:",U?"有":"无","使用缓存:",!!w),l.listStore.setPlayMusicInfo(p,v,!1),e.playerStore.playSong(v),console.log("[playSongCommon] 播放完成"),!0}catch(I){return console.error("[playSongCommon] 播放失败:",I),e.playerStore.clearStatusText(),o.index.showToast({title:"播放失败: "+(I.message||"未知错误"),icon:"none"}),!1}};
