"use strict";const e=require("../common/vendor.js"),o="music_url_",n={musicUrl:new Map,picUrl:new Map,lyric:new Map,otherSource:new Map},c={isLoading:!1,preProgress:0,info:null};function r(e,o="128k"){return`${e}_${o}`}async function i(c,i="128k",s){if(!s||!c)return;const t=r(c,i);n.musicUrl.set(t,s);try{const n=o+t;e.index.setStorageSync(n,s),console.log("[AudioCache] URL已缓存到本地存储:",t)}catch(a){console.error("[AudioCache] 保存到本地存储失败:",a)}}async function s(c,i="128k"){const s=r(c,i);if(n.musicUrl.has(s))return!0;try{const n=o+s;return!!e.index.getStorageSync(n)}catch(t){return!1}}exports.getCachedMusicUrl=async function(c,i="128k"){const s=r(c,i);if(n.musicUrl.has(s))return console.log("[AudioCache] 内存缓存命中:",s),n.musicUrl.get(s);try{const c=o+s,r=e.index.getStorageSync(c);if(r)return console.log("[AudioCache] 本地存储缓存命中:",s),n.musicUrl.set(s,r),r}catch(t){console.error("[AudioCache] 读取本地存储失败:",t)}return null},exports.isMusicUrlCached=s,exports.preloadNextMusic=async function(e,o,n="128k"){if(!e||!e.id)return;if(c.isLoading)return;if(await s(e.id,n))console.log("[AudioCache] 下一首已有缓存，无需预加载:",e.name);else{c.isLoading=!0,c.info=e,console.log("[AudioCache] 开始预加载下一首:",e.name);try{const c=await o(e,n);c&&c.url&&(await i(e.id,n,c.url),console.log("[AudioCache] 预加载成功:",e.name))}catch(r){console.error("[AudioCache] 预加载失败:",r.message)}finally{c.isLoading=!1,c.info=null}}},exports.setCachedMusicUrl=i;
