"use strict";const r=require("../common/vendor.js"),e=new Uint8Array([64,71,97,119,94,50,116,71,81,54,49,45,206,210,110,105]);function t(r){return new TextDecoder("utf-8").decode(r)}async function n(n){if(!n||"string"!=typeof n)return"";try{let i;try{const e=r.index.base64ToArrayBuffer(n);i=new Uint8Array(e)}catch(c){i=function(r){const e=new Uint8Array(r.length);for(let t=0;t<r.length;t++)e[t]=255&r.charCodeAt(t);return e}(n)}if(i.length<4)return"";const l=i.slice(4),y=new Uint8Array(l.length);for(let r=0;r<l.length;r++)y[r]=l[r]^e[r%16];if(function(r){return r.length>=2&&31===r[0]&&139===r[1]}(y)){console.log("[kgLyricDecoder] 检测到 gzip 压缩数据，尝试解压");try{return await async function(){return new Promise((r,e)=>{console.log("[kgLyricDecoder] 小程序环境不支持 gzip 解压，需要后端处理"),e(new Error("GZIP_NOT_SUPPORTED"))})}()}catch(o){return console.error("[kgLyricDecoder] gzip 解压失败:",o),""}}return t(y)}catch(i){return console.error("[kgLyricDecoder] 解码 KRC 歌词失败:",i),""}}function c(r){if(!r||"string"!=typeof r)return!1;let e=0;for(let t=0;t<Math.min(r.length,100);t++){const n=r.charCodeAt(t);n<32&&9!==n&&10!==n&&13!==n&&e++}return e>10}exports.isKgCompressedLyric=c,exports.tryDecodeKgLyric=async function(e){if(!e)return{lyric:"",tlyric:"",rlyric:"",lxlyric:""};if(c(e)){console.log("[kgLyricDecoder] 检测到酷狗压缩格式歌词");const c=await n(e);return c?function(e){if(!e)return{lyric:"",tlyric:"",rlyric:"",lxlyric:""};let n=e.replace(/\r/g,"");const c=/^.*\[id:\$\w+\]\n/;c.test(n)&&(n=n.replace(c,""));let o="",i="";const l=n.match(/\[language:([\w=\\/+]+)\]/);if(l){n=n.replace(/\[language:[\w=\\/+]+\]\n/,"");try{const e=r.index.base64ToArrayBuffer(l[1]),n=JSON.parse(t(new Uint8Array(e)));if(n.content)for(const r of n.content)switch(r.type){case 0:i=r.lyricContent;break;case 1:o=r.lyricContent}}catch(s){console.log("[kgLyricDecoder] 解析翻译信息失败:",s)}}let y=0,a=n.replace(/\[((\d+),\d+)\].*/g,r=>{const e=r.match(/\[((\d+),\d+)\].*/);if(!e)return r;let t=parseInt(e[2]);const n=t%1e3;t=Math.floor(t/1e3);const c=`${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}.${n}`;return i&&i[y]&&(i[y]=`[${c}]${i[y].join("")||""}`),o&&o[y]&&(o[y]=`[${c}]${o[y].join("")||""}`),y++,r.replace(e[1],c)});return Array.isArray(i)&&(i=i.join("\n")),Array.isArray(o)&&(o=o.join("\n")),a=a.replace(/<(\d+,\d+),\d+>/g,"<$1>"),{lyric:a.replace(/<\d+,\d+>/g,""),tlyric:o||"",rlyric:i||"",lxlyric:a}}(c):{lyric:"",tlyric:"",rlyric:"",lxlyric:""}}return{lyric:e,tlyric:"",rlyric:"",lxlyric:e}};
