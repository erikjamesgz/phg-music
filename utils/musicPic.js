"use strict";const l=require("../common/vendor.js"),e=require("./cache.js"),i=new Map,o={wy:{getPicUrl(l){var e,i;return(null==(e=l.al)?void 0:e.picUrl)||(null==(i=l.album)?void 0:i.picUrl)||l.img||null}},tx:{getPicUrl(l){var e,i,o,n;const r=l.albumId||(null==(e=l.al)?void 0:e.id)||(null==(i=l.album)?void 0:i.id);return r?`https://y.gtimg.cn/music/photo_new/T002R500x500M000${r}.jpg`:l.img||(null==(o=l.al)?void 0:o.picUrl)||(null==(n=l.album)?void 0:n.picUrl)||null}},kg:{getPicUrl(l){var e,i;return l.img||(null==(e=l.al)?void 0:e.picUrl)||(null==(i=l.album)?void 0:i.picUrl)||null},fetchPicUrl:async e=>new Promise((i,o)=>{var n,r;const t=e.hash||e.songmid,u=e.albumId||(null==(n=e.album)?void 0:n.id),c=e.audioId,a=e.songmid;if(console.log("[KuGouPic] 开始获取图片:",{hash:t,songmid:a,audioId:c,albumId:u,name:e.name}),!t&&!c&&!a)return console.log("[KuGouPic] 缺少必要参数"),void i(null);let s;s=a&&32===a.length?c?c.split("_")[0]:"":a||t;const d={appid:1001,area_code:"1",behavior:"play",clientver:"9020",need_hash_offset:1,relate:1,resource:[{album_audio_id:s,album_id:u||0,hash:t||a,id:0,name:`${e.singer||(null==(r=e.artists)?void 0:r.map(l=>l.name).join("/"))||"未知歌手"} - ${e.name}.mp3`,type:"audio"}],token:"",userid:2626431536,vip:1};console.log("[KuGouPic] 请求参数:",JSON.stringify(d)),l.index.request({url:"http://media.store.kugou.com/v1/get_res_privilege",method:"POST",header:{"KG-RC":1,"KG-THash":"expand_search_manager.cpp:852736169:451","User-Agent":"KuGou2012-9020-ExpandSearchManager","Content-Type":"application/json"},data:d,success:l=>{var e;if(console.log("[KuGouPic] 响应:",l.statusCode,JSON.stringify(l.data).substring(0,500)),l.data&&0===l.data.error_code&&l.data.data&&l.data.data[0]){const e=l.data.data[0].info,o=e.imgsize?e.image.replace("{size}",e.imgsize[0]):e.image;console.log("[KuGouPic] 获取到图片:",o),i(o)}else console.log("[KuGouPic] 获取图片失败:",null==(e=l.data)?void 0:e.error_code),i(null)},fail:l=>{console.log("[KuGouPic] 请求失败:",l),i(null)}})})},kw:{getPicUrl(l){var e,i;return l.img||(null==(e=l.al)?void 0:e.picUrl)||(null==(i=l.album)?void 0:i.picUrl)||null},fetchPicUrl:async e=>new Promise((i,o)=>{const n=e.songmid||e.id;if(console.log("[KuWoPic] 开始获取图片:",{songmid:n,name:e.name}),!n)return console.log("[KuWoPic] 缺少 songmid"),void i(null);const r=`http://artistpicserver.kuwo.cn/pic.web?corp=kuwo&type=rid_pic&pictype=500&size=500&rid=${n}`;console.log("[KuWoPic] 请求API:",r),l.index.request({url:r,method:"GET",success:l=>{if(console.log("[KuWoPic] API响应:",l.statusCode,l.data),200===l.statusCode&&l.data){let e=l.data;"string"==typeof e&&/^http/.test(e)?(console.log("[KuWoPic] 获取到真实图片URL:",e),i(e)):(console.log("[KuWoPic] 返回的不是有效图片URL:",e),i(null))}else console.log("[KuWoPic] 获取图片失败"),i(null)},fail:l=>{console.log("[KuWoPic] 请求失败:",l),i(null)}})})},mg:{getPicUrl(l){var e,i;return l.img||(null==(e=l.al)?void 0:e.picUrl)||(null==(i=l.album)?void 0:i.picUrl)||null},fetchPicUrl:async e=>new Promise((i,o)=>{const n=e.songmid||e.id;n?l.index.request({url:`http://music.migu.cn/v3/api/music/audioPlayer/getSongPic?songId=${n}`,header:{Referer:"http://music.migu.cn/v3/music/player/audio?from=migu"},success:l=>{if(l.data&&"000000"===l.data.returnCode){let e=l.data.largePic||l.data.mediumPic||l.data.smallPic;e&&!/https?:/.test(e)&&(e="http:"+e),i(e)}else i(null)},fail:()=>{i(null)}}):i(null)})},bd:{getPicUrl(l){var e,i;return l.img||(null==(e=l.al)?void 0:e.picUrl)||(null==(i=l.album)?void 0:i.picUrl)||null}}};function n(l,i){var n,r,t;if(!l)return null;const u=(null==(n=l.meta)?void 0:n.picUrl)||(null==(r=l.al)?void 0:r.picUrl)||(null==(t=l.album)?void 0:t.picUrl)||l.img||l.pic;if(u)return u;const c=i||l.sourceId||l.source;if(!c)return null;const a=l.id||l.songmid,s=e.getCachedPicUrl(a,c);if(s)return s;if(o[c]){const i=o[c].getPicUrl(l);if(i)return e.setCachedPicUrl(a,c,i),i}return null}exports.fetchSongPicUrl=async function(l,r){if(!l)return null;const t=n(l,r);if(t)return t;const u=r||l.sourceId||l.source,c=l.id||l.songmid,a=`${u}_${c}`;if(i.has(a))return i.get(a);if(!u||!o[u]||!o[u].fetchPicUrl)return null;const s=(async()=>{try{const i=await o[u].fetchPicUrl(l);return i&&e.setCachedPicUrl(c,u,i),i}catch(n){return console.error("[fetchSongPicUrl] 获取图片失败:",n),null}finally{i.delete(a)}})();return i.set(a,s),s},exports.getSongPicUrl=n;
