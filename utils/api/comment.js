"use strict";const e=require("../../common/vendor.js"),t=require("../crypto/wy.js"),o=require("../crypto/kg.js"),n=[["å¤§ç¬‘","ðŸ˜ƒ"],["å¯çˆ±","ðŸ˜Š"],["æ†¨ç¬‘","â˜ºï¸"],["è‰²","ðŸ˜"],["äº²äº²","ðŸ˜™"],["æƒŠæ","ðŸ˜±"],["æµæ³ª","ðŸ˜­"],["äº²","ðŸ˜š"],["å‘†","ðŸ˜³"],["å“€ä¼¤","ðŸ˜”"],["å‘²ç‰™","ðŸ˜"],["åèˆŒ","ðŸ˜"],["æ’‡å˜´","ðŸ˜’"],["æ€’","ðŸ˜¡"],["å¥¸ç¬‘","ðŸ˜"],["æ±—","ðŸ˜“"],["ç—›è‹¦","ðŸ˜–"],["æƒ¶æ","ðŸ˜°"],["ç”Ÿç—…","ðŸ˜¨"],["å£ç½©","ðŸ˜·"],["å¤§å“­","ðŸ˜‚"],["æ™•","ðŸ˜µ"],["å‘æ€’","ðŸ‘¿"],["å¼€å¿ƒ","ðŸ˜„"],["é¬¼è„¸","ðŸ˜œ"],["çš±çœ‰","ðŸ˜ž"],["æµæ„Ÿ","ðŸ˜¢"],["çˆ±å¿ƒ","â¤ï¸"],["å¿ƒç¢Ž","ðŸ’”"],["é’Ÿæƒ…","ðŸ’˜"],["æ˜Ÿæ˜Ÿ","â­ï¸"],["ç”Ÿæ°”","ðŸ’¢"],["ä¾¿ä¾¿","ðŸ’©"],["å¼º","ðŸ‘"],["å¼±","ðŸ‘Ž"],["æ‹œ","ðŸ™"],["ç‰µæ‰‹","ðŸ‘«"],["è·³èˆž","ðŸ‘¯â€â™€ï¸"],["ç¦æ­¢","ðŸ™…â€â™€ï¸"],["è¿™è¾¹","ðŸ’â€â™€ï¸"],["çˆ±æ„","ðŸ’"],["ç¤ºçˆ±","ðŸ‘©â€â¤ï¸â€ðŸ‘¨"],["å˜´å”‡","ðŸ‘„"],["ç‹—","ðŸ¶"],["çŒ«","ðŸ±"],["çŒª","ðŸ·"],["å…”å­","ðŸ°"],["å°é¸¡","ðŸ¤"],["å…¬é¸¡","ðŸ”"],["å¹½çµ","ðŸ‘»"],["åœ£è¯ž","ðŸŽ…"],["å¤–æ˜Ÿ","ðŸ‘½"],["é’»çŸ³","ðŸ’Ž"],["ç¤¼ç‰©","ðŸŽ"],["ç”·å­©","ðŸ‘¦"],["å¥³å­©","ðŸ‘§"],["è›‹ç³•","ðŸŽ‚"],["18","ðŸ”ž"],["åœˆ","â­•"],["å‰","âŒ"]],r=e=>{for(const t of n)e=e.replaceAll(`[${t[0]}]`,t[1]);return e},m=e=>{if(!e)return"";const t=Date.now()-e;if(t<864e5&&t>0){const e=Math.floor(t/36e5);if(e>0)return`${e}å°æ—¶å‰`;const o=Math.floor(t/6e4);return o>0?`${o}åˆ†é’Ÿå‰`:"åˆšåˆš"}const o=new Date(e);return`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")} ${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}`},a=e=>e?String(e).length<10?null:parseInt(e+"000"):null,i=e=>e.map(e=>{var t,o;let n={id:e.commentId,text:e.content?r(e.content):"",time:e.time?e.time:"",timeStr:e.time?m(e.time):"",location:(null==(t=e.ipLocation)?void 0:t.location)||"",userName:e.user.nickname,avatar:e.user.avatarUrl,userId:e.user.userId,likedCount:e.likedCount,reply:[]},a=e.beReplied&&e.beReplied[0];return a&&(n.reply=[{id:a.beRepliedCommentId,text:a.content?r(a.content):"",time:"",timeStr:"",location:(null==(o=a.ipLocation)?void 0:o.location)||"",userName:a.user.nickname,avatar:a.user.avatarUrl,userId:a.user.userId,likedCount:null}]),n}),s=(e,t=!1)=>{const o={e400846:"ðŸ˜˜",e400874:"ðŸ˜´",e400825:"ðŸ˜ƒ",e400847:"ðŸ˜™",e400835:"ðŸ˜",e400873:"ðŸ˜³",e400836:"ðŸ˜Ž",e400867:"ðŸ˜­",e400832:"ðŸ˜Š",e400837:"ðŸ˜",e400875:"ðŸ˜«",e400831:"ðŸ˜‰",e400855:"ðŸ˜¡",e400823:"ðŸ˜„",e400862:"ðŸ˜¨",e400844:"ðŸ˜–",e400841:"ðŸ˜“",e400830:"ðŸ˜ˆ",e400828:"ðŸ˜†",e400833:"ðŸ˜‹",e400822:"ðŸ˜€",e400843:"ðŸ˜•",e400829:"ðŸ˜‡",e400824:"ðŸ˜‚",e400834:"ðŸ˜Œ",e400877:"ðŸ˜·",e400132:"ðŸ‰",e400181:"ðŸº",e401067:"â˜•ï¸",e400186:"ðŸ¥§",e400343:"ðŸ·",e400116:"ðŸŒ¹",e400126:"ðŸƒ",e400613:"ðŸ’‹",e401236:"â¤ï¸",e400622:"ðŸ’”",e400637:"ðŸ’£",e400643:"ðŸ’©",e400773:"ðŸ”ª",e400102:"ðŸŒ›",e401328:"ðŸŒž",e400420:"ðŸ‘",e400914:"ðŸ™Œ",e400408:"ðŸ‘",e400414:"ðŸ‘Ž",e401121:"âœ‹",e400396:"ðŸ‘‹",e400384:"ðŸ‘‰",e401115:"âœŠ",e400402:"ðŸ‘Œ",e400905:"ðŸ™ˆ",e400906:"ðŸ™‰",e400907:"ðŸ™Š",e400562:"ðŸ‘»",e400932:"ðŸ™",e400644:"ðŸ’ª",e400611:"ðŸ’‰",e400185:"ðŸŽ",e400655:"ðŸ’°",e400325:"ðŸ¥",e400612:"ðŸ’Š",e400198:"ðŸŽ‰",e401685:"âš¡ï¸",e400631:"ðŸ’",e400768:"ðŸ”¥",e400432:"ðŸ‘‘"},n=e=>{let t=/^\[em\](e\d+)\[\/em\]$/,n=e.match(/\[em\]e\d+\[\/em\]/g);if(!n)return e;n=Array.from(new Set(n));for(const r of n){let n=r.replace(t,"$1");e=e.replace(new RegExp(r.replace("[em]","\\[em\\]").replace("[/em]","\\[\\/em\\]"),"g"),o[n]||"")}return e},r=e=>e?e.replace(/^@/,""):"";return e.map(e=>{let o=t?e.PubTime?a(e.PubTime):null:e.time?a(e.time):null,i=o?m(o):null;if(console.log("[filterTxComment] å¤„ç†è¯„è®ºé¡¹:",JSON.stringify(e)),console.log("[filterTxComment] isHot:",t),console.log("[filterTxComment] item.Nick:",e.Nick),console.log("[filterTxComment] item.rootcommentnick:",e.rootcommentnick),e.middlecommentcontent&&!t){let t=e.middlecommentcontent[0];t.avatarurl=e.avatarurl,t.praisenum=e.praisenum,e.avatarurl=null,e.praisenum=null,e.middlecommentcontent.reverse()}let s=t?e.Content:e.rootcommentcontent,l=t?e.Nick:e.rootcommentnick;console.log("[filterTxComment] content:",s),console.log("[filterTxComment] nick:",l),console.log("[filterTxComment] nickæ˜¯å¦åŒ…å«@:",!!l&&l.includes("@"));const c={id:t?`${e.SeqNo}_${e.CmId}`:`${e.rootcommentid}_${e.commentid}`,rootId:t?e.SeqNo:e.rootcommentid,text:s?n(s).replace(/\\n/g,"\n"):"",time:e.rootcommentid==e.commentid?o:null,timeStr:e.rootcommentid==e.commentid?i:null,userName:r(l),avatar:e.avatarurl||e.Avatar||"",userId:t?e.EncryptUin:e.encrypt_rootcommentuin,likedCount:e.praisenum||e.PraiseNum||0,images:e.Pic?[e.Pic]:[],location:e.Location||"",reply:(t?e.SubComments:e.middlecommentcontent)?(t?e.SubComments:e.middlecommentcontent).map(s=>{console.log("[filterTxComment] å¤„ç†å­è¯„è®º:",JSON.stringify(s)),console.log("[filterTxComment] å­è¯„è®ºPubTime:",s.PubTime),console.log("[filterTxComment] å­è¯„è®ºtime:",s.time),console.log("[filterTxComment] å­è¯„è®ºSeqNo:",s.SeqNo),console.log("[filterTxComment] å­è¯„è®ºcommentid:",s.commentid),console.log("[filterTxComment] ä¸»è¯„è®ºcommentid:",e.commentid);let l=null,c=null;return t?s.PubTime&&(l=a(s.PubTime),c=m(l)):(l=s.subcommentid==e.commentid?o:null,c=s.subcommentid==e.commentid?i:null),console.log("[filterTxComment] å­è¯„è®ºè®¡ç®—åŽæ—¶é—´:",l),console.log("[filterTxComment] å­è¯„è®ºè®¡ç®—åŽæ—¶é—´å­—ç¬¦ä¸²:",c),{id:`sub_${t?e.SeqNo:e.rootcommentid}_${s.CmId||s.subcommentid}`,text:n(s.Content||s.subcommentcontent).replace(/\\n/g,"\n"),time:l,timeStr:c,userName:r(s.Nick||s.replynick),avatar:s.Avatar||s.avatarurl||"",userId:s.EncryptUin||s.encrypt_replyuin,likedCount:s.PraiseNum||s.praisenum||0,images:s.Pic?[s.Pic]:[],location:""}}):[]};return console.log("[filterTxComment] å­è¯„è®ºæ•°é‡:",c.reply.length),console.log("[filterTxComment] å­è¯„è®ºæ•°æ®:",JSON.stringify(c.reply)),c})},l=e=>e.map(e=>{var t;let o={id:e.id,text:e.content||"",images:e.images?e.images.map(e=>e.url):[],location:e.location||"",time:e.addtime,timeStr:m(new Date(e.addtime).getTime()),userName:e.user_name,avatar:e.user_pic,userId:e.user_id,likedCount:(null==(t=e.like)?void 0:t.likenum)||0,replyNum:e.reply_num||0,reply:[]};return e.pcontent&&(o.reply=[{id:`reply_${e.id}`,text:e.pcontent,time:null,timeStr:"",userName:e.puser,avatar:"",userId:e.puser_id,likedCount:null,replyNum:null,location:""}]),o}),c=e=>e?e.map(e=>({id:e.id,text:e.msg,time:e.time,timeStr:m(1e3*Number(e.time)),userName:e.u_name,avatar:e.u_pic,userId:e.u_id,likedCount:e.like_num,location:"",images:e.mpic?[decodeURIComponent(e.mpic)]:[],reply:e.child_comments?e.child_comments.map(e=>({id:e.id,text:e.msg,time:e.time,timeStr:m(1e3*Number(e.time)),userName:e.u_name,avatar:e.u_pic,userId:e.u_id,likedCount:e.like_num,location:"",images:e.mpic?[e.mpic]:[]})):[]})):[],g=e=>e?e.map(e=>({id:e.commentId,text:e.commentInfo,time:e.commentTime,timeStr:m(new Date(e.commentTime).getTime()),userName:e.user.nickName,avatar:e.user.middleIcon||e.user.bigIcon||e.user.smallIcon,userId:e.user.userId,likedCount:e.opNumItem.thumbNum,replyNum:e.replyTotalCount,location:"",reply:e.replyComments&&e.replyComments.length>0?e.replyComments.map(e=>({id:e.replyId,text:e.replyInfo,time:e.replyTime,timeStr:m(new Date(e.replyTime).getTime()),userName:e.user.nickName,avatar:e.user.middleIcon||e.user.bigIcon||e.user.smallIcon,userId:e.user.userId,likedCount:null,replyNum:null,location:""})):[]})):[],d=async t=>(console.log("[getTxMusicInfo] èŽ·å–QQéŸ³ä¹æ­Œæ›²ä¿¡æ¯:",t),new Promise((o,n)=>{e.index.request({url:"https://u.y.qq.com/cgi-bin/musicu.fcg",method:"POST",header:{"User-Agent":"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0)","Content-Type":"application/json"},data:{comm:{ct:"19",cv:"1859",uin:"0"},req:{module:"music.pf_song_detail_svr",method:"get_song_detail_yqq",param:{song_type:0,song_mid:t}}},success:e=>{var t;if(console.log("[getTxMusicInfo] å“åº”:",e.statusCode),200===e.statusCode&&e.data){const r=e.data;if(0!==r.code||0!==r.req.code)return void n(new Error("èŽ·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥"));const m=r.req.data.track_info;o({songId:m.id,songmid:m.mid,name:m.title,singer:(null==(t=m.singer)?void 0:t.map(e=>e.name).join("ã€"))||""})}else n(new Error("è¯·æ±‚å¤±è´¥"))},fail:e=>{console.error("[getTxMusicInfo] è¯·æ±‚å¤±è´¥:",e),n(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"))}})})),u=async n=>{try{const r={id:n.id,name:n.name,singer:n.singer,source:n.source,songmid:n.songmid,hash:n.hash,copyrightId:n.copyrightId};let m;switch(r.source){case"wy":m=await(async(o,n=1,r=20)=>{console.log("[getWyComment] èŽ·å–ç½‘æ˜“äº‘éŸ³ä¹è¯„è®º:",o);const m="R_SO_4_"+o.songmid,a=t.weapi({cursor:Date.now(),offset:(n-1)*r,orderType:1,pageNo:n,pageSize:r,rid:m,threadId:m});return new Promise((t,o)=>{e.index.request({url:"https://music.163.com/weapi/comment/resource/comments/get",method:"POST",header:{"User-Agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36",origin:"https://music.163.com",Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html","Content-Type":"application/x-www-form-urlencoded"},data:`params=${encodeURIComponent(a.params)}&encSecKey=${a.encSecKey}`,success:e=>{var m,a;if(console.log("[getWyComment] å“åº”:",e.statusCode),console.log("[getWyComment] å®Œæ•´æ•°æ®:",JSON.stringify(e.data)),200===e.statusCode&&e.data){const s=e.data;if(200!==s.code)return void o(new Error(s.message||"èŽ·å–è¯„è®ºå¤±è´¥"));const l=(null==(m=s.data)?void 0:m.totalCount)||s.total||0,c=i((null==(a=s.data)?void 0:a.comments)||s.comments||[]);console.log("[getWyComment] è¯„è®ºæ€»æ•°:",l),console.log("[getWyComment] è¯„è®ºåˆ—è¡¨é•¿åº¦:",c.length),console.log("[getWyComment] maxPage:",Math.ceil(l/r)||1),t({source:"wy",comments:c,total:l,page:n,limit:r,maxPage:Math.ceil(l/r)||1})}else o(new Error("è¯·æ±‚å¤±è´¥"))},fail:e=>{console.error("[getWyComment] è¯·æ±‚å¤±è´¥:",e),o(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"))}})})})(r,n.page||1,n.limit||20);break;case"tx":m=await(async(t,o=1,n=20)=>{console.log("[getTxComment] èŽ·å–QQéŸ³ä¹è¯„è®º:",t);try{const r=await d(t.songmid);return console.log("[getTxComment] èŽ·å–åˆ°songId:",r.songId),new Promise((t,m)=>{e.index.request({url:"http://c.y.qq.com/base/fcgi-bin/fcg_global_comment_h5.fcg",method:"POST",header:{"User-Agent":"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0)",Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html","Content-Type":"application/x-www-form-urlencoded"},data:`uin=0&format=json&cid=205360772&reqtype=2&biztype=1&topid=${r.songId}&cmd=8&needmusiccrit=1&pagenum=${o-1}&pagesize=${n}`,success:e=>{var r,a;if(console.log("[getTxComment] å“åº”:",e.statusCode),console.log("[getTxComment] å®Œæ•´æ•°æ®:",JSON.stringify(e.data)),200===e.statusCode&&e.data){const i=e.data;if(0!==i.code)return void m(new Error(i.msg||"èŽ·å–è¯„è®ºå¤±è´¥"));const l=(null==(r=i.comment)?void 0:r.commenttotal)||0,c=s((null==(a=i.comment)?void 0:a.commentlist)||[],!1);console.log("[getTxComment] è¯„è®ºæ€»æ•°:",l),console.log("[getTxComment] è¯„è®ºåˆ—è¡¨:",c),t({source:"tx",comments:c,total:l,page:o,limit:n,maxPage:Math.ceil(l/n)||1})}else m(new Error("è¯·æ±‚å¤±è´¥"))},fail:e=>{console.error("[getTxComment] è¯·æ±‚å¤±è´¥:",e),m(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"))}})})}catch(r){throw console.error("[getTxComment] èŽ·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥:",r),r}})(r,n.page||1,n.limit||20);break;case"kg":m=await(async(t,n=1,r=20)=>{console.log("[getKgComment] èŽ·å–é…·ç‹—éŸ³ä¹è¯„è®º:",t);const m=`dfid=0&mid=16249512204336365674023395779019&clienttime=${Date.now()}&uuid=0&extdata=${t.hash}&appid=1005&code=fc4be23b4e972707f36b8a828a93ba8a&schash=${t.hash}&clientver=11409&p=${n}&clienttoken=&pagesize=${r}&ver=10&kugouid=0`,a=o.signatureParams(m,"android");return new Promise((t,o)=>{e.index.request({url:`http://m.comment.service.kugou.com/r/v1/rank/newest?${m}&signature=${a}`,method:"GET",header:{"User-Agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 Edg/107.0.1418.24",Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"},success:e=>{if(console.log("[getKgComment] å“åº”:",e.statusCode),console.log("[getKgComment] å®Œæ•´æ•°æ®:",JSON.stringify(e.data)),200===e.statusCode&&e.data){const m=e.data;if(1!==m.status||0!==m.err_code)return void o(new Error(m.msg||"èŽ·å–è¯„è®ºå¤±è´¥"));const a=m.count||0,i=l(m.list||[]);console.log("[getKgComment] è¯„è®ºæ€»æ•°:",a),console.log("[getKgComment] è¯„è®ºåˆ—è¡¨é•¿åº¦:",i.length),console.log("[getKgComment] å­è¯„è®ºæ•°é‡:",i.filter(e=>e.reply&&e.reply.length>0).length),console.log("[getKgComment] maxPage:",Math.ceil(a/r)||1),t({source:"kg",comments:i,total:a,page:n,limit:r,maxPage:Math.ceil(a/r)||1})}else o(new Error("è¯·æ±‚å¤±è´¥"))},fail:e=>{console.error("[getKgComment] è¯·æ±‚å¤±è´¥:",e),o(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"))}})})})(r,n.page||1,n.limit||20);break;case"kw":m=await(async(t,o=1,n=20)=>(console.log("[getKwComment] èŽ·å–é…·æˆ‘éŸ³ä¹è¯„è®º:",t),new Promise((r,m)=>{e.index.request({url:`http://ncomment.kuwo.cn/com.s?f=web&type=get_comment&aapiver=1&prod=kwplayer_ar_10.5.2.0&digest=15&sid=${t.songmid}&start=${n*(o-1)}&msgflag=1&count=${n}&newver=3&uid=0`,method:"GET",header:{"User-Agent":"Dalvik/2.1.0 (Linux; U; Android 9;)",Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"},success:e=>{if(console.log("[getKwComment] å“åº”:",e.statusCode),console.log("[getKwComment] å®Œæ•´æ•°æ®:",JSON.stringify(e.data)),200===e.statusCode&&e.data){const t=e.data;if("200"!==t.code)return void m(new Error("èŽ·å–è¯„è®ºå¤±è´¥"));const a=t.comments_counts||0,i=c(t.comments||[]);console.log("[getKwComment] è¯„è®ºæ€»æ•°:",a),console.log("[getKwComment] è¯„è®ºåˆ—è¡¨:",i),r({source:"kw",comments:i,total:a,page:o,limit:n,maxPage:Math.ceil(a/n)||1})}else m(new Error("è¯·æ±‚å¤±è´¥"))},fail:e=>{console.error("[getKwComment] è¯·æ±‚å¤±è´¥:",e),m(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"))}})})))(r,n.page||1,n.limit||20);break;case"mg":m=await(async(t,o=1,n=20)=>(console.log("[getMgComment] èŽ·å–å’ªå’•éŸ³ä¹è¯„è®º:",t),new Promise((r,m)=>{e.index.request({url:`https://app.c.nf.migu.cn/MIGUM3.0/user/comment/stack/v1.0?pageSize=${n}&queryType=1&resourceId=${t.songmid}&resourceType=2&commentId=`,method:"GET",header:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1",Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"},success:e=>{if(console.log("[getMgComment] å“åº”:",e.statusCode),console.log("[getMgComment] å®Œæ•´æ•°æ®:",JSON.stringify(e.data)),200===e.statusCode&&e.data){const t=e.data;if("000000"!==t.code)return void m(new Error("èŽ·å–è¯„è®ºå¤±è´¥"));const a=parseInt(t.data.commentNums)||0,i=g(t.data.comments||[]);console.log("[getMgComment] è¯„è®ºæ€»æ•°:",a),console.log("[getMgComment] è¯„è®ºåˆ—è¡¨:",i),r({source:"mg",comments:i,total:a,page:o,limit:n,maxPage:Math.ceil(a/n)||1})}else m(new Error("è¯·æ±‚å¤±è´¥"))},fail:e=>{console.error("[getMgComment] è¯·æ±‚å¤±è´¥:",e),m(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"))}})})))(r,n.page||1,n.limit||20);break;default:throw new Error("ä¸æ”¯æŒçš„éŸ³ä¹æº")}return m}catch(r){throw console.error("[getMusicComment] èŽ·å–è¯„è®ºå¤±è´¥:",r),r}};exports.getHotComment=async n=>{try{const r={id:n.id,name:n.name,singer:n.singer,source:n.source,songmid:n.songmid,hash:n.hash,copyrightId:n.copyrightId};let m;switch(r.source){case"wy":m=await(async(o,n=1,r=20)=>{console.log("[getWyHotComment] èŽ·å–ç½‘æ˜“äº‘éŸ³ä¹çƒ­é—¨è¯„è®º:",o);const m="R_SO_4_"+o.songmid,a=t.weapi({rid:m,limit:r,offset:r*(n-1),beforeTime:Date.now().toString()});return new Promise((t,o)=>{e.index.request({url:"https://music.163.com/weapi/v1/resource/hotcomments/"+m,method:"POST",header:{"User-Agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36",origin:"https://music.163.com",Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html","Content-Type":"application/x-www-form-urlencoded"},data:`params=${encodeURIComponent(a.params)}&encSecKey=${a.encSecKey}`,success:e=>{if(console.log("[getWyHotComment] å“åº”:",e.statusCode),console.log("[getWyHotComment] å®Œæ•´æ•°æ®:",JSON.stringify(e.data)),200===e.statusCode&&e.data){const m=e.data;if(200!==m.code)return void o(new Error(m.message||"èŽ·å–è¯„è®ºå¤±è´¥"));const a=m.total||0,s=i(m.hotComments||[]);console.log("[getWyHotComment] è¯„è®ºæ€»æ•°:",a),console.log("[getWyHotComment] è¯„è®ºåˆ—è¡¨é•¿åº¦:",s.length),console.log("[getWyHotComment] maxPage:",Math.ceil(a/r)||1),t({source:"wy",comments:s,total:a,page:n,limit:r,maxPage:Math.ceil(a/r)||1})}else o(new Error("è¯·æ±‚å¤±è´¥"))},fail:e=>{console.error("[getWyHotComment] è¯·æ±‚å¤±è´¥:",e),o(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"))}})})})(r,n.page||1,n.limit||20);break;case"tx":m=await(async(t,o=1,n=20)=>{console.log("[getTxHotComment] èŽ·å–QQéŸ³ä¹çƒ­é—¨è¯„è®º:",t);try{const r=await d(t.songmid);return console.log("[getTxHotComment] èŽ·å–åˆ°songId:",r.songId),new Promise((t,m)=>{e.index.request({url:"https://u.y.qq.com/cgi-bin/musicu.fcg",method:"POST",header:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36 Edg/113.0.0.0",Referer:"https://y.qq.com/",Origin:"https://y.qq.com","Content-Type":"application/json"},data:{comm:{cv:4747474,ct:24,format:"json",inCharset:"utf-8",outCharset:"utf-8",notice:0,platform:"yqq.json",needNewCode:1,uin:0},req:{module:"music.globalComment.CommentRead",method:"GetHotCommentList",param:{BizType:1,BizId:String(r.songId),LastCommentSeqNo:"",PageSize:n,PageNum:o-1,HotType:1,WithAirborne:0,PicEnable:1}}},success:e=>{if(console.log("[getTxHotComment] å“åº”:",e.statusCode),console.log("[getTxHotComment] å®Œæ•´æ•°æ®:",JSON.stringify(e.data)),200===e.statusCode&&e.data){const r=e.data;if(0!==r.code||0!==r.req.code)return void m(new Error("èŽ·å–çƒ­é—¨è¯„è®ºå¤±è´¥"));const a=r.req.data.CommentList,i=a.Total||0,l=s(a.Comments||[],!0);console.log("[getTxHotComment] è¯„è®ºæ€»æ•°:",i),console.log("[getTxHotComment] è¯„è®ºåˆ—è¡¨:",l),console.log("[getTxHotComment] å­è¯„è®ºæ•°é‡:",l.filter(e=>e.reply&&e.reply.length>0).length),t({source:"tx",comments:l,total:i,page:o,limit:n,maxPage:Math.ceil(i/n)||1})}else m(new Error("è¯·æ±‚å¤±è´¥"))},fail:e=>{console.error("[getTxHotComment] è¯·æ±‚å¤±è´¥:",e),m(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"))}})})}catch(r){throw console.error("[getTxHotComment] èŽ·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥:",r),r}})(r,n.page||1,n.limit||20);break;case"kg":m=await(async(t,n=1,r=20)=>{console.log("[getKgHotComment] èŽ·å–é…·ç‹—éŸ³ä¹çƒ­é—¨è¯„è®º:",t);const m=`dfid=0&mid=16249512204336365674023395779019&clienttime=${Date.now()}&uuid=0&extdata=${t.hash}&appid=1005&code=fc4be23b4e972707f36b8a828a93ba8a&schash=${t.hash}&clientver=11409&p=${n}&clienttoken=&pagesize=${r}&ver=10&kugouid=0`,a=o.signatureParams(m,"android");return new Promise((t,o)=>{e.index.request({url:`http://m.comment.service.kugou.com/r/v1/rank/topliked?${m}&signature=${a}`,method:"GET",header:{"User-Agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 Edg/107.0.1418.24",Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"},success:e=>{if(console.log("[getKgHotComment] å“åº”:",e.statusCode),console.log("[getKgHotComment] å®Œæ•´æ•°æ®:",JSON.stringify(e.data)),200===e.statusCode&&e.data){const m=e.data;if(1!==m.status||0!==m.err_code)return void o(new Error(m.msg||"èŽ·å–è¯„è®ºå¤±è´¥"));const a=m.count||0,i=l(m.list||[]);console.log("[getKgHotComment] è¯„è®ºæ€»æ•°:",a),console.log("[getKgHotComment] è¯„è®ºåˆ—è¡¨é•¿åº¦:",i.length),console.log("[getKgHotComment] maxPage:",Math.ceil(a/r)||1),t({source:"kg",comments:i,total:a,page:n,limit:r,maxPage:Math.ceil(a/r)||1})}else o(new Error("è¯·æ±‚å¤±è´¥"))},fail:e=>{console.error("[getKgHotComment] è¯·æ±‚å¤±è´¥:",e),o(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"))}})})})(r,n.page||1,n.limit||20);break;case"kw":m=await(async(t,o=1,n=20)=>(console.log("[getKwHotComment] èŽ·å–é…·æˆ‘éŸ³ä¹çƒ­é—¨è¯„è®º:",t),new Promise((r,m)=>{e.index.request({url:`http://ncomment.kuwo.cn/com.s?f=web&type=get_rec_comment&aapiver=1&prod=kwplayer_ar_10.5.2.0&digest=15&sid=${t.songmid}&start=${n*(o-1)}&msgflag=1&count=${n}&newver=3&uid=0`,method:"GET",header:{"User-Agent":"Dalvik/2.1.0 (Linux; U; Android 9;)",Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"},success:e=>{if(console.log("[getKwHotComment] å“åº”:",e.statusCode),console.log("[getKwHotComment] å®Œæ•´æ•°æ®:",JSON.stringify(e.data)),200===e.statusCode&&e.data){const t=e.data;if("200"!==t.code)return void m(new Error("èŽ·å–çƒ­é—¨è¯„è®ºå¤±è´¥"));const a=t.hot_comments_counts||0,i=c(t.hot_comments||[]);console.log("[getKwHotComment] è¯„è®ºæ€»æ•°:",a),console.log("[getKwHotComment] è¯„è®ºåˆ—è¡¨:",i),r({source:"kw",comments:i,total:a,page:o,limit:n,maxPage:Math.ceil(a/n)||1})}else m(new Error("è¯·æ±‚å¤±è´¥"))},fail:e=>{console.error("[getKwHotComment] è¯·æ±‚å¤±è´¥:",e),m(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"))}})})))(r,n.page||1,n.limit||20);break;case"mg":m=await(async(t,o=1,n=20)=>(console.log("[getMgHotComment] èŽ·å–å’ªå’•éŸ³ä¹çƒ­é—¨è¯„è®º:",t),new Promise((r,m)=>{e.index.request({url:`https://app.c.nf.migu.cn/MIGUM3.0/user/comment/stack/v1.0?pageSize=${n}&queryType=2&resourceId=${t.songmid}&resourceType=2&hotCommentStart=${(o-1)*n}`,method:"GET",header:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1",Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"},success:e=>{if(console.log("[getMgHotComment] å“åº”:",e.statusCode),console.log("[getMgHotComment] å®Œæ•´æ•°æ®:",JSON.stringify(e.data)),200===e.statusCode&&e.data){const t=e.data;if("000000"!==t.code)return void m(new Error("èŽ·å–çƒ­é—¨è¯„è®ºå¤±è´¥"));const a=parseInt(t.data.cfgHotCount)||0,i=g(t.data.hotComments||[]);console.log("[getMgHotComment] è¯„è®ºæ€»æ•°:",a),console.log("[getMgHotComment] è¯„è®ºåˆ—è¡¨:",i),r({source:"mg",comments:i,total:a,page:o,limit:n,maxPage:Math.ceil(a/n)||1})}else m(new Error("è¯·æ±‚å¤±è´¥"))},fail:e=>{console.error("[getMgHotComment] è¯·æ±‚å¤±è´¥:",e),m(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"))}})})))(r,n.page||1,n.limit||20);break;default:throw new Error("ä¸æ”¯æŒçš„éŸ³ä¹æº")}return m}catch(r){throw console.error("[getHotComment] èŽ·å–è¯„è®ºå¤±è´¥:",r),r}},exports.getNewComment=async e=>u(e);
