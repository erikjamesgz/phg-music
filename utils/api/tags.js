"use strict";const e=require("../../common/vendor.js");exports.flattenTags=function(e){if(!e||0===e.length)return[{id:"",name:"推荐"}];const o=[{id:"",name:"推荐"}];return e.forEach(e=>{e.list&&e.list.length>0&&o.push(...e.list)}),o},exports.getTagsBySource=async function(o){switch(console.log("[Tags] 获取标签:",o),o){case"kw":return async function(){return console.log("[Tags] 获取酷我音乐标签"),new Promise((o,s)=>{e.index.request({url:"http://wapi.kuwo.cn/api/pc/classify/playlist/getTagList?cmd=rcm_keyword_playlist&user=0&prod=kwplayer_pc_9.0.5.0&vipver=9.0.5.0&source=kwplayer_pc_9.0.5.0&loginUid=0&loginSid=0&appUid=76039576",method:"GET",success:e=>{if(console.log("[Tags] 酷我音乐响应:",e.statusCode),200===e.statusCode&&e.data){const t=e.data;if(200!==t.code)return console.log("[Tags] 酷我音乐返回码错误:",t.code),void s(new Error("获取标签失败"));const a=t.data||[],n=[];a.forEach(e=>{const o=e.data||[];n.push({name:e.name||"分类",list:o.map(e=>({id:`${e.id}-${e.digest}`,name:e.name,source:"kw"}))})}),console.log("[Tags] 酷我音乐标签数量:",n.length),o(n)}else s(new Error("请求失败"))},fail:e=>{console.error("[Tags] 酷我音乐请求失败:",e),s(new Error("网络请求失败"))}})})}();case"kg":return async function(){return console.log("[Tags] 获取酷狗音乐标签"),new Promise((o,s)=>{e.index.request({url:"http://www2.kugou.kugou.com/yueku/v9/special/getSpecial?is_smarty=1&",method:"GET",success:e=>{var t;if(console.log("[Tags] 酷狗音乐响应:",e.statusCode),200===e.statusCode&&e.data){const a=e.data;if(1!==a.status)return console.log("[Tags] 酷狗音乐返回码错误:",a.status),void s(new Error("获取标签失败"));const n=(null==(t=a.data)?void 0:t.tagids)||{},r=[];for(const e of Object.keys(n)){const o=n[e].data||[];r.push({name:e,list:o.map(e=>({id:String(e.id),name:e.name,source:"kg"}))})}console.log("[Tags] 酷狗音乐标签数量:",r.length),o(r)}else s(new Error("请求失败"))},fail:e=>{console.error("[Tags] 酷狗音乐请求失败:",e),s(new Error("网络请求失败"))}})})}();case"tx":return async function(){return console.log("[Tags] 获取QQ音乐标签"),new Promise((o,s)=>{e.index.request({url:"https://u.y.qq.com/cgi-bin/musicu.fcg?loginUin=0&hostUin=0&format=json&inCharset=utf-8&outCharset=utf-8&notice=0&platform=wk_v15.json&needNewCode=0&data=%7B%22tags%22%3A%7B%22method%22%3A%22get_all_categories%22%2C%22param%22%3A%7B%22qq%22%3A%22%22%7D%2C%22module%22%3A%22playlist.PlaylistAllCategoriesServer%22%7D%7D",method:"GET",success:e=>{var t,a;if(console.log("[Tags] QQ音乐响应:",e.statusCode),200===e.statusCode&&e.data){const n=e.data;if(0!==n.code)return console.log("[Tags] QQ音乐返回码错误:",n.code),void s(new Error("获取标签失败"));const r=(null==(a=null==(t=n.tags)?void 0:t.data)?void 0:a.v_group)||[],l=[];r.forEach(e=>{const o=e.v_item||[];l.push({name:e.group_name,list:o.map(e=>({id:String(e.id),name:e.name,source:"tx"}))})}),console.log("[Tags] QQ音乐标签数量:",l.length),o(l)}else s(new Error("请求失败"))},fail:e=>{console.error("[Tags] QQ音乐请求失败:",e),s(new Error("网络请求失败"))}})})}();case"wy":return async function(){return console.log("[Tags] 获取网易云音乐标签"),new Promise((o,s)=>{e.index.request({url:"https://music.163.com/api/playlist/catalogue",method:"GET",header:{Referer:"https://music.163.com/"},success:e=>{if(console.log("[Tags] 网易云音乐响应:",e.statusCode),200===e.statusCode&&e.data){const t=e.data;if(200!==t.code)return console.log("[Tags] 网易云音乐返回码错误:",t.code),void s(new Error("获取标签失败"));const a=t.categories||{},n=t.sub||[],r=[],l={};for(const e of n)l[e.category]||(l[e.category]=[]),l[e.category].push({id:e.name,name:e.name,source:"wy"});for(const e of Object.keys(a))r.push({name:a[e],list:l[e]||[]});console.log("[Tags] 网易云音乐标签数量:",r.length),o(r)}else s(new Error("请求失败"))},fail:e=>{console.error("[Tags] 网易云音乐请求失败:",e),s(new Error("网络请求失败"))}})})}();case"mg":return async function(){return console.log("[Tags] 获取咪咕音乐标签"),new Promise((o,s)=>{e.index.request({url:"https://app.c.nf.migu.cn/pc/v1.0/template/musiclistplaza-taglist/release",method:"GET",header:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1",Referer:"https://m.music.migu.cn/"},dataType:"json",success:e=>{if(console.log("[Tags] 咪咕音乐响应:",e.statusCode),200===e.statusCode&&e.data){const t=e.data;if(console.log("[Tags] 咪咕音乐返回数据code:",t.code),console.log("[Tags] 咪咕音乐返回数据data类型:",typeof t.data),console.log("[Tags] 咪咕音乐返回数据data是否为数组:",Array.isArray(t.data)),"000000"!==t.code)return console.log("[Tags] 咪咕音乐返回码错误:",t.code),void s(new Error("获取标签失败"));const a=t.data||[];if(console.log("[Tags] 咪咕音乐原始数据长度:",a.length),console.log("[Tags] 咪咕音乐原始数据前500字符:",JSON.stringify(a).substring(0,500)),Array.isArray(a)||(console.log("[Tags] data.data不是数组，尝试其他路径"),console.log("[Tags] data keys:",Object.keys(t))),0===a.length)return void o([]);const n=[];a.forEach((e,o)=>{var s,t;if(console.log(`[Tags] 处理第${o}个分组:`,(null==(s=e.header)?void 0:s.title)||"无标题"),!e.content||!Array.isArray(e.content))return void console.log(`[Tags] 第${o}个分组无content或content不是数组`);const a=e.content.map(({texts:e})=>!e||e.length<2?(console.log("[Tags] texts格式不正确:",e),null):{id:String(e[1]),name:e[0],source:"mg"}).filter(e=>null!==e);console.log(`[Tags] 第${o}个分组标签数量:`,a.length),a.length>0&&n.push({name:(null==(t=e.header)?void 0:t.title)||(0===o?"热门":"分类"),list:a})}),console.log("[Tags] 咪咕音乐标签分组数量:",n.length),o(n)}else s(new Error("请求失败"))},fail:e=>{console.error("[Tags] 咪咕音乐请求失败:",e),s(new Error("网络请求失败"))}})})}();default:throw new Error(`不支持的音源: ${o}`)}};
