"use strict";const e=require("../../common/vendor.js"),t=require("../crypto/wy.js");async function a(t){console.log("[Kugou] 通过酷狗码获取歌单:",t);return new Promise((a,s)=>{e.index.request({url:"http://t.kugou.com/command/",method:"POST",header:{"Content-Type":"application/json","KG-RC":"1","KG-THash":"network_super_call.cpp:3676261689:379","User-Agent":""},data:{appid:1001,clientver:9020,mid:"21511157a05844bd085308bc76ef3343",clienttime:640612895,key:"36164c4015e704673c588ee202b9ecb8",data:t},success:t=>{var n;if(console.log("[Kugou] 酷狗码响应:",t.statusCode),200===t.statusCode&&t.data){const r=t.data;if(console.log("[Kugou] 酷狗码返回状态:",r.status),1!==r.status)return void s(new Error("获取歌单信息失败"));const l=null==(n=r.data)?void 0:n.info;if(!l)return void s(new Error("歌单信息为空"));console.log("[Kugou] 歌单类型:",l.type,"歌单ID:",l.id),2===l.type||4===l.type?l.userid&&l.id?async function(t,a,o,s={}){console.log("[Kugou] 通过userid获取歌单:",t,a,o);const n="http://www2.kugou.kugou.com/apps/kucodeAndShare/app/";return new Promise((r,l)=>{e.index.request({url:n,method:"POST",header:{"Content-Type":"application/json","KG-RC":"1","KG-THash":"network_super_call.cpp:3676261689:379","User-Agent":""},data:{appid:1001,clientver:9020,mid:"21511157a05844bd085308bc76ef3343",clienttime:640612895,key:"36164c4015e704673c588ee202b9ecb8",data:{id:t,type:3,userid:a,collect_type:0,page:1,pagesize:o||1e3}},success:async t=>{if(console.log("[Kugou] userid API响应:",t.statusCode),200===t.statusCode&&t.data){const n=t.data;if(1!==n.status)return void l(new Error("获取歌单失败"));const c=n.data||[];console.log("[Kugou] 获取到歌曲数量:",c.length);const u=await async function(t){if(console.log("[Kugou] 获取歌曲详细信息，歌曲数量:",t.length),!t||0===t.length)return{};const a="http://gateway.kugou.com/v3/album_audio/audio",o=100,i=[];for(let e=0;e<t.length;e+=o){const a=t.slice(e,e+o).map(e=>({hash:e.hash||e.id}));i.push(a)}console.log("[Kugou] 分批获取专辑信息，总批次数:",i.length);const s=i.map((t,o)=>new Promise((o,i)=>{const s={area_code:"1",show_privilege:1,show_album_info:"1",is_publish:"",appid:1005,clientver:11451,mid:"1",dfid:"-",clienttime:Date.now(),key:"OIlwieks28dk2k092lksi2UIkp",fields:"album_info,author_name,audio_info,ori_audio_name,base,songname,classification",data:t};e.index.request({url:a,method:"POST",data:s,header:{"Content-Type":"application/json","KG-THash":"13a3164","KG-RC":"1","KG-Fake":"0","KG-RF":"00869891","User-Agent":"Android712-AndroidPhone-11451-376-0-FeeCacheUpdate-wifi","x-router":"kmr.service.kugou.com"},success:e=>{if(200===e.statusCode&&e.data){let t=[];if(Array.isArray(e.data))t=e.data;else if(e.data.data&&Array.isArray(e.data.data))t=e.data.data;else if(1===e.data.status&&e.data.data)t=Array.isArray(e.data.data)?e.data.data:[];else if("object"==typeof e.data){const a=Object.keys(e.data);for(const o of a)if(Array.isArray(e.data[o])){t=e.data[o];break}}const a=t.filter(e=>Array.isArray(e));a.length===t.length&&t.length>1?(t=[],a.forEach(e=>{t.push(...e)})):t.length>0&&Array.isArray(t[0])&&(t=t[0]),o(t)}else o([])},fail:e=>{o([])}})})),n=(await Promise.all(s)).flat(),r={};return n.forEach(e=>{var t;if(e&&e.audio_info){const a=e.audio_info.hash,o=(null==(t=e.album_info)?void 0:t.album_name)||"";r[a]=o}}),r}(c);console.log("[Kugou] 获取到专辑信息数量:",Object.keys(u).length);const m=c.map(e=>{const t=e.duration||0,a=Math.floor(t/1e3);let o=e.filename?e.filename.replace(/\.mp3$/,""):"",s=e.singername||"";if(!s&&o&&o.includes(" - ")){const e=o.split(" - ");e.length>=2&&(s=e[0],o=e.slice(1).join(" - "))}const n=u[e.hash]||e.album_name||e.album||"";return{id:e.hash,name:o,singer:s,ar:s?s.split("、").map(e=>({name:e})):[],album:n,al:{name:n,picUrl:""},albumName:n,albumPic:"",hash:e.hash,songmid:e.hash,source:"kg",interval:i(a),dt:t,img:"",quality:e.bitrate>=320?"HQ":"128k"}}),d=s.name||"我喜欢的音乐",g=s.img||"",p=s.username||a;r({list:m,page:1,limit:o||1e3,total:m.length,source:"kg",info:{name:d,img:g,desc:"",author:p,play_count:"0"}})}else l(new Error("请求失败"))},fail:e=>{l(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}(l.id,l.userid,l.count,l).then(a).catch(s):l.id?o(l.id).then(a).catch(s):s(new Error("无法获取歌单ID")):1===l.type?s(new Error("这是单曲，不是歌单")):s(new Error("不支持的歌单类型: "+l.type))}else s(new Error("请求失败"))},fail:e=>{s(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}async function o(t){console.log("[Kugou] 通过specialid获取歌单:",t);const a=`http://www2.kugou.kugou.com/yueku/v9/special/single/${t}-5-9999.html`;return new Promise((t,o)=>{e.index.request({url:a,method:"GET",success:e=>{if(console.log("[Kugou] 响应状态:",e.statusCode),200===e.statusCode&&e.data){const i=e.data;let s=i.match(/global\.data\s*=\s*(\[.+?\]);/s);s||(s=i.match(/global\.data\s*=\s*(\[.+?\])\s*$/m)),s||(s=i.match(/var\s+global\s*=\s*{[\s\S]*?data\s*:\s*(\[.+?\])/));let n=i.match(/global\s*=\s*{[\s\S]*?name\s*:\s*["']([^"']+)["'][\s\S]*?pic\s*:\s*["']([^"']+)["']/);if(n||(n=i.match(/name\s*:\s*["']([^"']+)["'][\s\S]*?pic\s*:\s*["']([^"']+)["']/)),!s)return void o(new Error("未匹配到歌曲数据"));try{const e=JSON.parse(s[1]);console.log("[Kugou] 歌曲数量:",e.length);let a="",o="";n&&(a=n[1],o=n[2]);const i=function(e){const t=e=>{if(!e)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`};return e.map(e=>{const a=e.duration||0,o=Math.floor(a/1e3);let i=e.songname||e.name,s=e.singername||e.singer;if(!s&&i&&i.includes(" - ")){const e=i.split(" - ");e.length>=2&&(s=e[0],i=e.slice(1).join(" - "))}return{id:e.hash||e.id,name:i,singer:s,ar:s?s.split("、").map(e=>({name:e})):[],album:e.album_name||e.album,al:{name:e.album_name||e.album,picUrl:e.album_img||e.img},albumName:e.album_name||e.album,albumPic:e.album_img||e.img,hash:e.hash,songmid:e.hash,source:"kg",interval:t(o),dt:a,img:e.album_img||e.img,quality:e.islossless?"SQ":e.is320?"HQ":"128k"}})}(e);t({list:i,page:1,limit:1e4,total:i.length,source:"kg",info:{name:a||"未知歌单",img:o||"",desc:"",author:e.length>0&&e[0].nickname||"",play_count:e.length>0?l(e[0].play_count||e[0].total_play_count):"0"}})}catch(a){o(new Error("解析歌单数据失败"))}}else o(new Error("请求失败"))},fail:e=>{o(new Error("网络请求失败"))}})})}function i(e){if(!e)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}async function s(t,a=1,o=0,i=0){if(i>2)return Promise.reject(new Error("try max num"));const n="https://u.y.qq.com/cgi-bin/musicu.fcg",r={comm:{uin:"0",mina:1,appid:"wxada7aab80ba27074",ct:25},playlist:{module:"srf_diss_info.DissInfoServer",method:"CgiGetDiss",param:{disstid:parseInt(t),tag:1,userinfo:1,song_begin:o,onlysonglist:0,orderlist:1}}};return new Promise((l,c)=>{console.log("[QQ] 请求URL:",n),console.log("[QQ] 请求数据:",JSON.stringify(r)),e.index.request({url:n,method:"POST",header:{"Content-Type":"application/json","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1",Referer:"https://servicewechat.com/wxada7aab80ba27074/136/page-frame.html"},data:r,success:e=>{var n;if(console.log("[QQ] 响应状态:",e.statusCode),200===e.statusCode&&e.data){const r=e.data;if(console.log("[QQ] data.code:",r.code),console.log("[QQ] playlist.code:",null==(n=r.playlist)?void 0:n.code),0!==r.code)return console.log("[QQ] 返回码错误，重试...:",r.code),s(t,a,o,i+1).then(l).catch(c);if(!r.playlist||0!==r.playlist.code)return console.log("[QQ] playlist错误:",r.playlist),void c(new Error("获取歌单失败"));const u=r.playlist.data;if(!u||0!==u.code)return console.log("[QQ] 数据错误:",null==u?void 0:u.msg),void c(new Error("获取歌单失败: "+((null==u?void 0:u.msg)||"未知错误")));const m=u.dirinfo,d=u.songlist||[];console.log("[QQ] 歌单名称:",m.title),console.log("[QQ] 歌曲数量:",d.length);const g=e=>e?e>1e8?parseInt(e/1e7)/10+"亿":e>1e4?parseInt(e/1e3)/10+"万":e.toString():"0",p=e=>{if(!e)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`},h=d.map(e=>{var t,a;const o=e.singer||[],i=e.album||{};return{id:e.mid,name:e.name,singer:o.map(e=>e.name).join("、"),ar:o.map(e=>({name:e.name,mid:e.mid})),album:i.name||"",al:{name:i.name||"",picUrl:i.pmid?`https://y.gtimg.cn/music/photo_new/T002R300x300M000${i.pmid}.jpg`:""},albumName:i.name||"",albumPic:i.pmid?`https://y.gtimg.cn/music/photo_new/T002R300x300M000${i.pmid}.jpg`:"",songmid:e.mid,mid:e.mid,source:"tx",interval:p(e.interval),dt:1e3*e.interval,img:i.pmid?`https://y.gtimg.cn/music/photo_new/T002R500x500M000${i.pmid}.jpg`:o.length?`https://y.gtimg.cn/music/photo_new/T001R500x500M000${o[0].mid}.jpg`:"",quality:(null==(t=e.file)?void 0:t.size_flac)?"SQ":(null==(a=e.file)?void 0:a.size_320mp3)?"HQ":"128k",file:e.file}});l({list:h,page:a,limit:d.length,total:m.songnum||d.length,source:"tx",info:{name:m.title||"未知歌单",img:m.picurl||"",desc:m.desc||"",author:m.host_nick||"",play_count:g(m.listennum)}})}else c(new Error("请求失败"))},fail:e=>{c(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}async function n(a){console.log("[Netease] 获取歌曲详情, ids数量:",a.length);const o=t.weapi({c:"["+a.map(e=>'{"id":'+e+"}").join(",")+"]",ids:"["+a.join(",")+"]"});return new Promise((t,a)=>{e.index.request({url:"https://music.163.com/weapi/v3/song/detail",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded",Referer:"https://music.163.com/","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"},data:`params=${encodeURIComponent(o.params)}&encSecKey=${encodeURIComponent(o.encSecKey)}`,success:e=>{if(console.log("[Netease] 歌曲详情响应状态:",e.statusCode),200===e.statusCode&&e.data){const o=e.data;if(200!==o.code)return void a(new Error("获取歌曲详情失败"));const i=o.songs||[],s=o.privileges||[],n=e=>{if(!e)return"0:00";return`${Math.floor(e/6e4)}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}`},r=i.map((e,t)=>{const a=s.find(t=>t.id===e.id)||s[t],o=e.ar||[],i=e.al||{};return{id:e.id,name:e.name,singer:o.map(e=>e.name).join("、"),ar:o,album:i.name,al:{name:i.name,picUrl:i.picUrl},albumName:i.name,albumPic:i.picUrl,songmid:e.id,source:"wy",interval:n(e.dt),dt:e.dt,img:i.picUrl,quality:(null==a?void 0:a.maxbr)>=999e3?"SQ":(null==a?void 0:a.maxbr)>=32e4?"HQ":"128k"}});t(r)}else a(new Error("请求失败"))},fail:e=>{a(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}async function r(t,a=1,o=0){var i,s,n;if(o>2)return Promise.reject(new Error("try max num"));let l=t;if(/\/playlist[/?]/.test(t)){const e=t.match(/(?:playlistId|id)=(\d+)/);e&&(l=e[1])}const c=`https://app.c.nf.migu.cn/MIGUM3.0/resource/playlist/song/v2.0?pageNo=${a}&pageSize=50&playlistId=${l}`,u=`https://c.musicapp.migu.cn/MIGUM3.0/resource/playlist/v2.0?playlistId=${l}`,m={"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1",Referer:"https://m.music.migu.cn/"};console.log("[Migu] 请求歌曲列表URL:",c),console.log("[Migu] 请求歌单信息URL:",u);const d=e=>{if(!e)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`};try{const[l,p]=await Promise.all([new Promise((t,a)=>{e.index.request({url:c,method:"GET",header:m,success:e=>{console.log("[Migu] 歌曲列表响应:",e.statusCode),200===e.statusCode&&e.data?t(e.data):a(new Error("获取歌曲列表失败"))},fail:a})}),new Promise((t,a)=>{e.index.request({url:u,method:"GET",header:m,success:e=>{console.log("[Migu] 歌单信息响应:",e.statusCode),200===e.statusCode&&e.data?t(e.data):a(new Error("获取歌单信息失败"))},fail:a})})]);if(console.log("[Migu] listData.code:",l.code),console.log("[Migu] infoData.code:",p.code),"000000"!==l.code)return console.log("[Migu] 歌曲列表返回码错误，重试..."),r(t,a,o+1);if("000000"!==p.code)return console.log("[Migu] 歌单信息返回码错误，重试..."),r(t,a,o+1);const h=(null==(i=l.data)?void 0:i.songList)||[],f=p.data||{};console.log("[Migu] 歌曲数量:",h.length),console.log("[Migu] 歌单名称:",f.title);const y=h.map(e=>{const t=e.singerList||[],a=t.map(e=>e.name).join("、"),o=[],i={},s=e.audioFormats||[];s.forEach(e=>{"PQ"===e.formatType?(o.push({type:"128k",size:e.asize}),i["128k"]={size:e.asize}):"HQ"===e.formatType?(o.push({type:"320k",size:e.asize}),i["320k"]={size:e.asize}):"SQ"===e.formatType&&(o.push({type:"flac",size:e.asize}),i.flac={size:e.asize})});let n="";return e.img1?n=e.img1.startsWith("http")?e.img1:`https://d.musicapp.migu.cn${e.img1}`:e.img2?n=e.img2.startsWith("http")?e.img2:`https://d.musicapp.migu.cn${e.img2}`:e.img3&&(n=e.img3.startsWith("http")?e.img3:`https://d.musicapp.migu.cn${e.img3}`),{id:e.copyrightId||e.songId,name:e.songName||e.name,singer:a,ar:t,album:e.album,al:{name:e.album,picUrl:n},albumName:e.album,albumPic:n,songmid:e.songId,copyrightId:e.copyrightId,source:"mg",interval:d(e.duration),dt:1e3*e.duration,img:n,types:o,_types:i,typeUrl:{},quality:s.some(e=>"SQ"===e.formatType)?"SQ":s.some(e=>"HQ"===e.formatType)?"HQ":"128k"}}),w=f.opNumItem||{};return{list:y,page:a,limit:50,total:(null==(s=l.data)?void 0:s.totalCount)||y.length,source:"mg",info:{name:f.title||"未知歌单",img:(null==(n=f.imgItem)?void 0:n.img)||f.originalImgUrl||"",desc:f.summary||"",author:f.ownerName||"",play_count:(g=w.playNum,g?g>1e8?parseInt(g/1e7)/10+"亿":g>1e4?parseInt(g/1e3)/10+"万":g.toString():"0")}}}catch(p){if(console.error("[Migu] 请求失败:",p),o<2)return r(t,a,o+1);throw p}var g}function l(e){return e?"string"==typeof e?e:e>=1e8?(e/1e8).toFixed(1)+"亿":e>=1e4?(e/1e4).toFixed(1)+"万":e.toString():"0"}exports.getListDetailDirect=async function(t,i,l=1){switch(console.log("[songlist-direct] 获取歌单详情:",t,i,l),t){case"kw":return async function(t,a=1){let o=t;if(t.includes("__")){const e=t.split("__");e[0].replace("digest-",""),o=e[1]}const i=`http://nplserver.kuwo.cn/pl.svc?op=getlistinfo&pid=${o}&pn=${a-1}&rn=1000&encode=utf8&keyset=pl2012&identity=kuwo&pcmp4=1&vipver=MUSIC_9.0.5.0_W1&newver=1`;return new Promise((t,s)=>{e.index.request({url:i,method:"GET",success:e=>{if(200===e.statusCode&&e.data){const i=e.data;if("ok"!==i.result)return void s(new Error("获取歌单失败"));i.musiclist&&0!==i.musiclist.length||(console.log("[Kuwo] 歌单为空或不存在:",o),console.log("[Kuwo] 歌单信息:",{title:i.title,ispub:i.ispub,total:i.total,validtotal:i.validtotal}));const n=e=>e?e>1e8?parseInt(e/1e7)/10+"亿":e>1e4?parseInt(e/1e3)/10+"万":e.toString():"0",r=e=>e?`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`:"0:00",l=(i.musiclist||[]).map(e=>{var t;const a=[],o={};if(e.N_MINFO){const i=e.N_MINFO.split(";");for(let e of i){const i=e.match(/level:(\w+),bitrate:(\d+),format:(\w+),size:([\w.]+)/);if(i){const e=i[2],s=null==(t=i[4])?void 0:t.toUpperCase();switch(e){case"4000":a.push({type:"flac24bit",size:s}),o.flac24bit={size:s};break;case"2000":a.push({type:"flac",size:s}),o.flac={size:s};break;case"320":a.push({type:"320k",size:s}),o["320k"]={size:s};break;case"128":a.push({type:"128k",size:s}),o["128k"]={size:s}}}}}return a.reverse(),{id:e.id,name:e.name,singer:e.artist,ar:e.artist?e.artist.split("、").map(e=>({name:e})):[],album:e.album,al:{name:e.album,picUrl:e.albumPic||e.pic},albumName:e.album,albumPic:e.albumPic||e.pic,songmid:e.id,source:"kw",interval:r(e.duration),dt:1e3*e.duration,img:e.albumPic||e.pic,types:a,_types:o,typeUrl:{},quality:a.some(e=>"flac"===e.type||"flac24bit"===e.type)?"SQ":a.some(e=>"320k"===e.type)?"HQ":"128k"}});t({list:l,page:a,limit:i.rn||1e3,total:i.total||l.length,source:"kw",info:{name:i.title||"未知歌单",img:i.pic||"",desc:i.info||"",author:i.uname||"",play_count:n(i.playnum)}})}else s(new Error("请求失败"))},fail:e=>{s(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}(i,l);case"kg":return async function(e,t=1,i=0){if(i>2)return Promise.reject(new Error("try max num"));if(console.log("[Kugou] 获取歌单详情, id:",e),/^\d+$/.test(e))return console.log("[Kugou] 检测到酷狗码，使用酷狗码接口"),a(e);if(e.startsWith("id_")){const t=e.replace("id_","");return console.log("[Kugou] 移除id_前缀:",t),o(t)}return console.log("[Kugou] 作为specialid处理"),o(e)}(i,l);case"tx":return s(i,l);case"wy":return async function(t,a=1){const o=1e3,i=(a-1)*o,s=`https://music.163.com/api/v3/playlist/detail?id=${t}`;return console.log("[Netease] 请求歌单详情URL:",s),new Promise((t,r)=>{e.index.request({url:s,method:"GET",header:{Referer:"https://music.163.com/","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"},success:async e=>{var s,l;if(console.log("[Netease] 歌单详情响应状态:",e.statusCode),200===e.statusCode&&e.data){const u=e.data;if(200!==u.code)return console.log("[Netease] 返回码错误:",u.code),void r(new Error("获取歌单失败"));const m=u.playlist||{},d=m.trackIds||[],g=m.tracks||[];console.log("[Netease] 歌单歌曲总数:",m.trackCount),console.log("[Netease] trackIds数量:",d.length),console.log("[Netease] tracks数量:",g.length);const p=d.slice(i,i+o).map(e=>e.id);console.log("[Netease] 当前页需要获取的歌曲数:",p.length);let h=[];if(1===a&&g.length>=p.length){console.log("[Netease] 使用返回的 tracks 数据");const e=e=>e?`${Math.floor(e/6e4)}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}`:"0:00";h=g.map(t=>{const a=t.ar||[],o=t.al||{};return{id:t.id,name:t.name,singer:a.map(e=>e.name).join("、"),ar:a,album:o.name,al:{name:o.name,picUrl:o.picUrl},albumName:o.name,albumPic:o.picUrl,songmid:t.id,source:"wy",interval:e(t.dt),dt:t.dt,img:o.picUrl,quality:"128k"}})}else if(p.length>0){console.log("[Netease] 需要获取歌曲详情");const e=500;for(let t=0;t<p.length;t+=e){const a=p.slice(t,t+e);console.log(`[Netease] 获取第 ${Math.floor(t/e)+1} 批歌曲, 数量: ${a.length}`);try{const e=await n(a);h=h.concat(e)}catch(c){console.error("[Netease] 获取歌曲详情失败:",c)}}}console.log("[Netease] 最终歌曲数量:",h.length),t({list:h,page:a,limit:o,total:m.trackCount||d.length,source:"wy",info:{name:m.name||"未知歌单",img:m.coverImgUrl||"",desc:m.description||"",author:(null==(s=m.creator)?void 0:s.nickname)||"",play_count:(l=m.playCount,l?l>1e8?parseInt(l/1e7)/10+"亿":l>1e4?parseInt(l/1e3)/10+"万":l.toString():"0")}})}else r(new Error("请求失败"))},fail:e=>{r(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}(i,l);case"mg":return r(i,l);default:throw new Error(`不支持的音源: ${t}`)}};
