"use strict";const e=require("../../common/vendor.js"),t=require("../crypto/wy.js");async function o(t){console.log("[Kugou] 通过酷狗码获取歌单:",t);return new Promise((o,n)=>{e.index.request({url:"http://t.kugou.com/command/",method:"POST",header:{"Content-Type":"application/json","KG-RC":"1","KG-THash":"network_super_call.cpp:3676261689:379","User-Agent":""},data:{appid:1001,clientver:9020,mid:"21511157a05844bd085308bc76ef3343",clienttime:640612895,key:"36164c4015e704673c588ee202b9ecb8",data:t},success:t=>{var s;if(console.log("[Kugou] 酷狗码响应:",t.statusCode),200===t.statusCode&&t.data){const r=t.data;if(console.log("[Kugou] 酷狗码返回状态:",r.status),1!==r.status)return void n(new Error("获取歌单信息失败"));const l=null==(s=r.data)?void 0:s.info;if(!l)return void n(new Error("歌单信息为空"));console.log("[Kugou] 歌单类型:",l.type,"歌单ID:",l.id),2===l.type||4===l.type?l.userid&&l.id?async function(t,o,a,n={}){console.log("[Kugou] 通过userid获取歌单:",t,o,a);const s="http://www2.kugou.kugou.com/apps/kucodeAndShare/app/";return new Promise((r,l)=>{e.index.request({url:s,method:"POST",header:{"Content-Type":"application/json","KG-RC":"1","KG-THash":"network_super_call.cpp:3676261689:379","User-Agent":""},data:{appid:1001,clientver:9020,mid:"21511157a05844bd085308bc76ef3343",clienttime:640612895,key:"36164c4015e704673c588ee202b9ecb8",data:{id:t,type:3,userid:o,collect_type:0,page:1,pagesize:a||1e3}},success:e=>{if(console.log("[Kugou] userid API响应:",e.statusCode),200===e.statusCode&&e.data){const t=e.data;if(1!==t.status)return void l(new Error("获取歌单失败"));const s=t.data||[];console.log("[Kugou] 获取到歌曲数量:",s.length);const c=s.map(e=>{const t=e.duration||0,o=Math.floor(t/1e3);return{id:e.hash,name:e.filename?e.filename.replace(/\.mp3$/,""):"",singer:e.singername||"",ar:e.singername?e.singername.split("、").map(e=>({name:e})):[],album:"",al:{name:"",picUrl:""},albumName:"",albumPic:"",hash:e.hash,songmid:e.hash,source:"kg",interval:i(o),dt:t,img:"",quality:e.bitrate>=320?"HQ":"128k"}}),u=n.name||"我喜欢的音乐",m=n.img||"",d=n.username||o;r({list:c,page:1,limit:a||1e3,total:c.length,source:"kg",info:{name:u,img:m,desc:"",author:d,play_count:"0"}})}else l(new Error("请求失败"))},fail:e=>{l(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}(l.id,l.userid,l.count,l).then(o).catch(n):l.id?a(l.id).then(o).catch(n):n(new Error("无法获取歌单ID")):1===l.type?n(new Error("这是单曲，不是歌单")):n(new Error("不支持的歌单类型: "+l.type))}else n(new Error("请求失败"))},fail:e=>{n(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}async function a(t){console.log("[Kugou] 通过specialid获取歌单:",t);const o=`http://www2.kugou.kugou.com/yueku/v9/special/single/${t}-5-9999.html`;return new Promise((t,a)=>{e.index.request({url:o,method:"GET",success:e=>{if(console.log("[Kugou] 响应状态:",e.statusCode),200===e.statusCode&&e.data){const i=e.data;let n=i.match(/global\.data\s*=\s*(\[.+?\]);/s);n||(n=i.match(/global\.data\s*=\s*(\[.+?\])\s*$/m)),n||(n=i.match(/var\s+global\s*=\s*{[\s\S]*?data\s*:\s*(\[.+?\])/));let s=i.match(/global\s*=\s*{[\s\S]*?name\s*:\s*["']([^"']+)["'][\s\S]*?pic\s*:\s*["']([^"']+)["']/);if(s||(s=i.match(/name\s*:\s*["']([^"']+)["'][\s\S]*?pic\s*:\s*["']([^"']+)["']/)),!n)return void a(new Error("未匹配到歌曲数据"));try{const e=JSON.parse(n[1]);console.log("[Kugou] 歌曲数量:",e.length);let o="",a="";s&&(o=s[1],a=s[2]);const i=function(e){const t=e=>{if(!e)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`};return e.map(e=>{const o=e.duration||0,a=Math.floor(o/1e3);return{id:e.hash||e.id,name:e.songname||e.name,singer:e.singername||e.singer,ar:e.singername?e.singername.split("、").map(e=>({name:e})):[],album:e.album_name||e.album,al:{name:e.album_name||e.album,picUrl:e.album_img||e.img},albumName:e.album_name||e.album,albumPic:e.album_img||e.img,hash:e.hash,songmid:e.hash,source:"kg",interval:t(a),dt:o,img:e.album_img||e.img,quality:e.islossless?"SQ":e.is320?"HQ":"128k"}})}(e);t({list:i,page:1,limit:1e4,total:i.length,source:"kg",info:{name:o||"未知歌单",img:a||"",desc:"",author:e.length>0&&e[0].nickname||"",play_count:e.length>0?l(e[0].play_count||e[0].total_play_count):"0"}})}catch(o){a(new Error("解析歌单数据失败"))}}else a(new Error("请求失败"))},fail:e=>{a(new Error("网络请求失败"))}})})}function i(e){if(!e)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}async function n(t,o=1,a=0,i=0){if(i>2)return Promise.reject(new Error("try max num"));const s="https://u.y.qq.com/cgi-bin/musicu.fcg",r={comm:{uin:"0",mina:1,appid:"wxada7aab80ba27074",ct:25},playlist:{module:"srf_diss_info.DissInfoServer",method:"CgiGetDiss",param:{disstid:parseInt(t),tag:1,userinfo:1,song_begin:a,onlysonglist:0,orderlist:1}}};return new Promise((l,c)=>{console.log("[QQ] 请求URL:",s),console.log("[QQ] 请求数据:",JSON.stringify(r)),e.index.request({url:s,method:"POST",header:{"Content-Type":"application/json","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1",Referer:"https://servicewechat.com/wxada7aab80ba27074/136/page-frame.html"},data:r,success:e=>{var s;if(console.log("[QQ] 响应状态:",e.statusCode),200===e.statusCode&&e.data){const r=e.data;if(console.log("[QQ] data.code:",r.code),console.log("[QQ] playlist.code:",null==(s=r.playlist)?void 0:s.code),0!==r.code)return console.log("[QQ] 返回码错误，重试...:",r.code),n(t,o,a,i+1).then(l).catch(c);if(!r.playlist||0!==r.playlist.code)return console.log("[QQ] playlist错误:",r.playlist),void c(new Error("获取歌单失败"));const u=r.playlist.data;if(!u||0!==u.code)return console.log("[QQ] 数据错误:",null==u?void 0:u.msg),void c(new Error("获取歌单失败: "+((null==u?void 0:u.msg)||"未知错误")));const m=u.dirinfo,d=u.songlist||[];console.log("[QQ] 歌单名称:",m.title),console.log("[QQ] 歌曲数量:",d.length);const g=e=>e?e>1e8?parseInt(e/1e7)/10+"亿":e>1e4?parseInt(e/1e3)/10+"万":e.toString():"0",p=e=>{if(!e)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`},h=d.map(e=>{var t,o;const a=e.singer||[],i=e.album||{};return{id:e.mid,name:e.name,singer:a.map(e=>e.name).join("、"),ar:a.map(e=>({name:e.name,mid:e.mid})),album:i.name||"",al:{name:i.name||"",picUrl:i.pmid?`https://y.gtimg.cn/music/photo_new/T002R300x300M000${i.pmid}.jpg`:""},albumName:i.name||"",albumPic:i.pmid?`https://y.gtimg.cn/music/photo_new/T002R300x300M000${i.pmid}.jpg`:"",songmid:e.mid,mid:e.mid,source:"tx",interval:p(e.interval),dt:1e3*e.interval,img:i.pmid?`https://y.gtimg.cn/music/photo_new/T002R500x500M000${i.pmid}.jpg`:a.length?`https://y.gtimg.cn/music/photo_new/T001R500x500M000${a[0].mid}.jpg`:"",quality:(null==(t=e.file)?void 0:t.size_flac)?"SQ":(null==(o=e.file)?void 0:o.size_320mp3)?"HQ":"128k",file:e.file}});l({list:h,page:o,limit:d.length,total:m.songnum||d.length,source:"tx",info:{name:m.title||"未知歌单",img:m.picurl||"",desc:m.desc||"",author:m.host_nick||"",play_count:g(m.listennum)}})}else c(new Error("请求失败"))},fail:e=>{c(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}async function s(o){console.log("[Netease] 获取歌曲详情, ids数量:",o.length);const a=t.weapi({c:"["+o.map(e=>'{"id":'+e+"}").join(",")+"]",ids:"["+o.join(",")+"]"});return new Promise((t,o)=>{e.index.request({url:"https://music.163.com/weapi/v3/song/detail",method:"POST",header:{"Content-Type":"application/x-www-form-urlencoded",Referer:"https://music.163.com/","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"},data:`params=${encodeURIComponent(a.params)}&encSecKey=${encodeURIComponent(a.encSecKey)}`,success:e=>{if(console.log("[Netease] 歌曲详情响应状态:",e.statusCode),200===e.statusCode&&e.data){const a=e.data;if(200!==a.code)return void o(new Error("获取歌曲详情失败"));const i=a.songs||[],n=a.privileges||[],s=e=>{if(!e)return"0:00";return`${Math.floor(e/6e4)}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}`},r=i.map((e,t)=>{const o=n.find(t=>t.id===e.id)||n[t],a=e.ar||[],i=e.al||{};return{id:e.id,name:e.name,singer:a.map(e=>e.name).join("、"),ar:a,album:i.name,al:{name:i.name,picUrl:i.picUrl},albumName:i.name,albumPic:i.picUrl,songmid:e.id,source:"wy",interval:s(e.dt),dt:e.dt,img:i.picUrl,quality:(null==o?void 0:o.maxbr)>=999e3?"SQ":(null==o?void 0:o.maxbr)>=32e4?"HQ":"128k"}});t(r)}else o(new Error("请求失败"))},fail:e=>{o(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}async function r(t,o=1,a=0){var i,n,s;if(a>2)return Promise.reject(new Error("try max num"));let l=t;if(/\/playlist[/?]/.test(t)){const e=t.match(/(?:playlistId|id)=(\d+)/);e&&(l=e[1])}const c=`https://app.c.nf.migu.cn/MIGUM3.0/resource/playlist/song/v2.0?pageNo=${o}&pageSize=50&playlistId=${l}`,u=`https://c.musicapp.migu.cn/MIGUM3.0/resource/playlist/v2.0?playlistId=${l}`,m={"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1",Referer:"https://m.music.migu.cn/"};console.log("[Migu] 请求歌曲列表URL:",c),console.log("[Migu] 请求歌单信息URL:",u);const d=e=>{if(!e)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`};try{const[l,p]=await Promise.all([new Promise((t,o)=>{e.index.request({url:c,method:"GET",header:m,success:e=>{console.log("[Migu] 歌曲列表响应:",e.statusCode),200===e.statusCode&&e.data?t(e.data):o(new Error("获取歌曲列表失败"))},fail:o})}),new Promise((t,o)=>{e.index.request({url:u,method:"GET",header:m,success:e=>{console.log("[Migu] 歌单信息响应:",e.statusCode),200===e.statusCode&&e.data?t(e.data):o(new Error("获取歌单信息失败"))},fail:o})})]);if(console.log("[Migu] listData.code:",l.code),console.log("[Migu] infoData.code:",p.code),"000000"!==l.code)return console.log("[Migu] 歌曲列表返回码错误，重试..."),r(t,o,a+1);if("000000"!==p.code)return console.log("[Migu] 歌单信息返回码错误，重试..."),r(t,o,a+1);const h=(null==(i=l.data)?void 0:i.songList)||[],f=p.data||{};console.log("[Migu] 歌曲数量:",h.length),console.log("[Migu] 歌单名称:",f.title);const y=h.map(e=>{const t=e.singer||[],o=t.map(e=>e.name).join("、"),a=[],i={},n=e.audioFormats||[];n.forEach(e=>{"PQ"===e.formatType?(a.push({type:"128k",size:e.asize}),i["128k"]={size:e.asize}):"HQ"===e.formatType?(a.push({type:"320k",size:e.asize}),i["320k"]={size:e.asize}):"SQ"===e.formatType&&(a.push({type:"flac",size:e.asize}),i.flac={size:e.asize})});let s="";return e.img1?s=e.img1.startsWith("http")?e.img1:`https://d.musicapp.migu.cn${e.img1}`:e.img2?s=e.img2.startsWith("http")?e.img2:`https://d.musicapp.migu.cn${e.img2}`:e.img3&&(s=e.img3.startsWith("http")?e.img3:`https://d.musicapp.migu.cn${e.img3}`),{id:e.copyrightId||e.songId,name:e.songName||e.name,singer:o,ar:t,album:e.album,al:{name:e.album,picUrl:s},albumName:e.album,albumPic:s,songmid:e.songId,copyrightId:e.copyrightId,source:"mg",interval:d(e.duration),dt:1e3*e.duration,img:s,types:a,_types:i,typeUrl:{},quality:n.some(e=>"SQ"===e.formatType)?"SQ":n.some(e=>"HQ"===e.formatType)?"HQ":"128k"}}),w=f.opNumItem||{};return{list:y,page:o,limit:50,total:(null==(n=l.data)?void 0:n.totalCount)||y.length,source:"mg",info:{name:f.title||"未知歌单",img:(null==(s=f.imgItem)?void 0:s.img)||f.originalImgUrl||"",desc:f.summary||"",author:f.ownerName||"",play_count:(g=w.playNum,g?g>1e8?parseInt(g/1e7)/10+"亿":g>1e4?parseInt(g/1e3)/10+"万":g.toString():"0")}}}catch(p){if(console.error("[Migu] 请求失败:",p),a<2)return r(t,o,a+1);throw p}var g}function l(e){return e?"string"==typeof e?e:e>=1e8?(e/1e8).toFixed(1)+"亿":e>=1e4?(e/1e4).toFixed(1)+"万":e.toString():"0"}exports.getListDetailDirect=async function(t,i,l=1){switch(console.log("[songlist-direct] 获取歌单详情:",t,i,l),t){case"kw":return async function(t,o=1){let a=t;if(t.includes("__")){const e=t.split("__");e[0].replace("digest-",""),a=e[1]}const i=`http://nplserver.kuwo.cn/pl.svc?op=getlistinfo&pid=${a}&pn=${o-1}&rn=1000&encode=utf8&keyset=pl2012&identity=kuwo&pcmp4=1&vipver=MUSIC_9.0.5.0_W1&newver=1`;return new Promise((t,n)=>{e.index.request({url:i,method:"GET",success:e=>{if(200===e.statusCode&&e.data){const i=e.data;if("ok"!==i.result)return void n(new Error("获取歌单失败"));i.musiclist&&0!==i.musiclist.length||(console.log("[Kuwo] 歌单为空或不存在:",a),console.log("[Kuwo] 歌单信息:",{title:i.title,ispub:i.ispub,total:i.total,validtotal:i.validtotal}));const s=e=>e?e>1e8?parseInt(e/1e7)/10+"亿":e>1e4?parseInt(e/1e3)/10+"万":e.toString():"0",r=e=>e?`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`:"0:00",l=(i.musiclist||[]).map(e=>{var t;const o=[],a={};if(e.N_MINFO){const i=e.N_MINFO.split(";");for(let e of i){const i=e.match(/level:(\w+),bitrate:(\d+),format:(\w+),size:([\w.]+)/);if(i){const e=i[2],n=null==(t=i[4])?void 0:t.toUpperCase();switch(e){case"4000":o.push({type:"flac24bit",size:n}),a.flac24bit={size:n};break;case"2000":o.push({type:"flac",size:n}),a.flac={size:n};break;case"320":o.push({type:"320k",size:n}),a["320k"]={size:n};break;case"128":o.push({type:"128k",size:n}),a["128k"]={size:n}}}}}return o.reverse(),{id:e.id,name:e.name,singer:e.artist,ar:e.artist?e.artist.split("、").map(e=>({name:e})):[],album:e.album,al:{name:e.album,picUrl:e.albumPic||e.pic},albumName:e.album,albumPic:e.albumPic||e.pic,songmid:e.id,source:"kw",interval:r(e.duration),dt:1e3*e.duration,img:e.albumPic||e.pic,types:o,_types:a,typeUrl:{},quality:o.some(e=>"flac"===e.type||"flac24bit"===e.type)?"SQ":o.some(e=>"320k"===e.type)?"HQ":"128k"}});t({list:l,page:o,limit:i.rn||1e3,total:i.total||l.length,source:"kw",info:{name:i.title||"未知歌单",img:i.pic||"",desc:i.info||"",author:i.uname||"",play_count:s(i.playnum)}})}else n(new Error("请求失败"))},fail:e=>{n(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}(i,l);case"kg":return async function(e,t=1,i=0){if(i>2)return Promise.reject(new Error("try max num"));if(console.log("[Kugou] 获取歌单详情, id:",e),/^\d+$/.test(e))return console.log("[Kugou] 检测到酷狗码，使用酷狗码接口"),o(e);if(e.startsWith("id_")){const t=e.replace("id_","");return console.log("[Kugou] 移除id_前缀:",t),a(t)}return console.log("[Kugou] 作为specialid处理"),a(e)}(i,l);case"tx":return n(i,l);case"wy":return async function(t,o=1){const a=1e3,i=(o-1)*a,n=`https://music.163.com/api/v3/playlist/detail?id=${t}`;return console.log("[Netease] 请求歌单详情URL:",n),new Promise((t,r)=>{e.index.request({url:n,method:"GET",header:{Referer:"https://music.163.com/","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"},success:async e=>{var n,l;if(console.log("[Netease] 歌单详情响应状态:",e.statusCode),200===e.statusCode&&e.data){const u=e.data;if(200!==u.code)return console.log("[Netease] 返回码错误:",u.code),void r(new Error("获取歌单失败"));const m=u.playlist||{},d=m.trackIds||[],g=m.tracks||[];console.log("[Netease] 歌单歌曲总数:",m.trackCount),console.log("[Netease] trackIds数量:",d.length),console.log("[Netease] tracks数量:",g.length);const p=d.slice(i,i+a).map(e=>e.id);console.log("[Netease] 当前页需要获取的歌曲数:",p.length);let h=[];if(1===o&&g.length>=p.length){console.log("[Netease] 使用返回的 tracks 数据");const e=e=>e?`${Math.floor(e/6e4)}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}`:"0:00";h=g.map(t=>{const o=t.ar||[],a=t.al||{};return{id:t.id,name:t.name,singer:o.map(e=>e.name).join("、"),ar:o,album:a.name,al:{name:a.name,picUrl:a.picUrl},albumName:a.name,albumPic:a.picUrl,songmid:t.id,source:"wy",interval:e(t.dt),dt:t.dt,img:a.picUrl,quality:"128k"}})}else if(p.length>0){console.log("[Netease] 需要获取歌曲详情");const e=500;for(let t=0;t<p.length;t+=e){const o=p.slice(t,t+e);console.log(`[Netease] 获取第 ${Math.floor(t/e)+1} 批歌曲, 数量: ${o.length}`);try{const e=await s(o);h=h.concat(e)}catch(c){console.error("[Netease] 获取歌曲详情失败:",c)}}}console.log("[Netease] 最终歌曲数量:",h.length),t({list:h,page:o,limit:a,total:m.trackCount||d.length,source:"wy",info:{name:m.name||"未知歌单",img:m.coverImgUrl||"",desc:m.description||"",author:(null==(n=m.creator)?void 0:n.nickname)||"",play_count:(l=m.playCount,l?l>1e8?parseInt(l/1e7)/10+"亿":l>1e4?parseInt(l/1e3)/10+"万":l.toString():"0")}})}else r(new Error("请求失败"))},fail:e=>{r(new Error("网络请求失败: "+(e.errMsg||"未知错误")))}})})}(i,l);case"mg":return r(i,l);default:throw new Error(`不支持的音源: ${t}`)}};
