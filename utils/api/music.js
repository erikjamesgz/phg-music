"use strict";const l=require("../../common/vendor.js"),r=require("../config.js"),c=require("../lyricCache.js"),i=new Map;exports.getMusicUrl=function(e){var o;const t=(null==(o=e.musicInfo)?void 0:o.id)||e.id,s=`${e.source}_${t}_${e.quality||"320k"}`;if(i.has(s))return console.log("[getMusicUrl] 复用正在进行的请求:",s),i.get(s);const n=new Promise((i,o)=>{console.log("[getMusicUrl] 创建新请求:",s),l.index.request({url:`${r.getServerUrl()}/api/music/url`,method:"POST",data:e,header:{"Content-Type":"application/json"},success:async r=>{var t,s,n,a,u;if(200===r.statusCode&&r.data&&200===r.data.code){const o=r.data.data,u=(null==(t=e.musicInfo)?void 0:t.id)||e.id,y=e.source;if(console.log("[getMusicUrl] API返回数据:",{id:u,source:y,hasUrl:!!o.url,hasLyric:!!o.lyric,hasTlyric:!!o.tlyric,hasRlyric:!!o.rlyric,hasLxlyric:!!o.lxlyric,lyricLength:null==(s=o.lyric)?void 0:s.length,tlyricLength:null==(n=o.tlyric)?void 0:n.length,hasFallback:!!o.fallback}),o.fallback&&o.fallback.toggled){const r=o.fallback.originalSource,c=o.fallback.newSource;o.fallback.matchedSong;const i={tx:"QQ音乐",wy:"网易云音乐",kg:"酷狗音乐",kw:"酷我音乐",mg:"咪咕音乐"},e=i[r]||r,t=i[c]||c;console.log(`[getMusicUrl] 换源播放: ${e} -> ${t}`),l.index.showToast({title:`已从${e}换源到${t}`,icon:"none",duration:2500})}if(o&&(o.lyric||o.tlyric||o.rlyric||o.lxlyric)){const l={lyric:o.lyric||"",tlyric:o.tlyric||"",rlyric:o.rlyric||"",lxlyric:o.lxlyric||""};if(l.lyric||l.tlyric||l.rlyric||l.lxlyric){const r=(null==(a=o.fallback)?void 0:a.newSource)||y;await c.setCachedLyric(u,r,l),console.log("[getMusicUrl] 歌词已缓存:",u,r)}}else console.log("[getMusicUrl] API没有返回歌词:",u,y);i(o)}else o(new Error((null==(u=r.data)?void 0:u.msg)||"获取播放URL失败"))},fail:l=>{o(new Error(l.errMsg||"网络请求失败"))}})}).finally(()=>{i.delete(s),console.log("[getMusicUrl] 请求完成，移除 pending:",s)});return i.set(s,n),n};
