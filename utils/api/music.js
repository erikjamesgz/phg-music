"use strict";const l=require("../../common/vendor.js"),e=require("../config.js"),r=require("../musicParams.js"),i=require("../lyricCache.js"),c=new Map;let o=0,s={requestId:0,requestKey:"",timestamp:0};exports.getMusicUrl=function(t,n="320k"){var u,a,d;let g=t;if(t.musicInfo||(g=r.buildMusicRequestParams(t,n),console.log("[getMusicUrl] 从歌曲对象构建请求参数:",{songId:t.id,songmid:t.songmid,source:t.source,hasRequestParams:!!g,requestParamsSource:null==g?void 0:g.source,interval:null==(u=null==g?void 0:g.musicInfo)?void 0:u.interval})),!g)return console.error("[getMusicUrl] requestParams 为 null，无法继续"),Promise.reject(new Error("请求参数构建失败"));if(g.musicInfo&&!g.musicInfo.interval){const l=t;g.musicInfo.interval=r.formatDuration(l.dt||l.duration||l.interval),console.log("[getMusicUrl] 补充 interval 字段:",g.musicInfo.interval)}const y=(null==(a=g.musicInfo)?void 0:a.id)||g.id,m=`${g.source}_${y}_${g.quality||n}`,f=++o;if(s={requestId:f,requestKey:m,timestamp:Date.now()},console.log("[getMusicUrl] 新请求:",{requestId:f,requestKey:m,interval:null==(d=g.musicInfo)?void 0:d.interval}),c.has(m))return console.log("[getMusicUrl] 复用正在进行的请求:",m),c.get(m);const v=new Promise((r,o)=>{var t;let n=null,u=!1;n=setTimeout(()=>{u||(console.log("[getMusicUrl] 请求超时:",m),s.requestId===f&&(u=!0,c.delete(m),o(new Error("请求超时，请重试"))))},15e3),console.log("[getMusicUrl] 创建新请求:",m,"interval:",null==(t=g.musicInfo)?void 0:t.interval),console.log("[getMusicUrl] 实际发送的请求参数:",JSON.stringify(g)),l.index.request({url:`${e.getServerUrl()}/api/music/url`,method:"POST",data:g,header:{"Content-Type":"application/json"},success:async l=>{var e,c,t,a,d;if(s.requestId===f){if(!u)if(u=!0,n&&clearTimeout(n),200===l.statusCode&&l.data&&200===l.data.code){const o=l.data.data,s=(null==(e=g.musicInfo)?void 0:e.id)||g.id,n=g.source;if(console.log("[getMusicUrl] API返回数据:",{id:s,source:n,hasUrl:!!o.url,hasLyric:!!o.lyric,hasTlyric:!!o.tlyric,hasRlyric:!!o.rlyric,hasLxlyric:!!o.lxlyric,lyricLength:null==(c=o.lyric)?void 0:c.length,tlyricLength:null==(t=o.tlyric)?void 0:t.length,hasFallback:!!o.fallback}),o.fallback&&o.fallback.toggled){const l=o.fallback.originalSource,e=o.fallback.newSource,r=o.fallback.matchedSong,i={tx:"QQ音乐",wy:"网易云音乐",kg:"酷狗音乐",kw:"酷我音乐",mg:"咪咕音乐"},c=i[l]||l,s=i[e]||e;console.log(`[getMusicUrl] 换源播放: ${c} -> ${s}`),console.log("[getMusicUrl] 换源详情:",{originalSource:l,newSource:e,matchedSongId:null==r?void 0:r.id,matchedSongSongmid:null==r?void 0:r.songmid})}if(o&&(o.lyric||o.tlyric||o.rlyric||o.lxlyric)){const l={lyric:o.lyric||"",tlyric:o.tlyric||"",rlyric:o.rlyric||"",lxlyric:o.lxlyric||""};if(l.lyric||l.tlyric||l.rlyric||l.lxlyric){const e=(null==(a=o.fallback)?void 0:a.newSource)||n;await i.setCachedLyric(s,e,l),console.log("[getMusicUrl] 歌词已缓存:",s,e)}}else console.log("[getMusicUrl] API没有返回歌词:",s,n);r({url:o.url,lyric:o.lyric||"",tlyric:o.tlyric||"",rlyric:o.rlyric||"",lxlyric:o.lxlyric||"",fallback:o.fallback||null})}else o(new Error((null==(d=l.data)?void 0:d.msg)||"获取播放URL失败"))}else console.log("[getMusicUrl] 忽略过期响应:",{currentRequestId:f,lastRequestId:s.requestId})},fail:l=>{s.requestId===f?u||(u=!0,n&&clearTimeout(n),o(new Error(l.errMsg||"网络请求失败"))):console.log("[getMusicUrl] 忽略过期错误:",{currentRequestId:f,lastRequestId:s.requestId})}})}).finally(()=>{c.delete(m),console.log("[getMusicUrl] 请求完成，移除 pending:",m)});return c.set(m,v),v};
