"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/api/comment.js");Math||(l+o)();const l=()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js",o=()=>"./CommentFloor.js",u={__name:"MusicComment",props:{show:{type:Boolean,default:!1},musicInfo:{type:Object,required:!0}},emits:["close"],setup(l,{emit:o}){const u=l,t=o,i=e.ref(!1),v=()=>{i.value="true"===e.index.getStorageSync("darkMode"),console.log("[MusicComment] 刷新暗黑模式:",i.value)};e.onMounted(()=>{i.value="true"===e.index.getStorageSync("darkMode"),console.log("[MusicComment] 初始化暗黑模式:",i.value),e.index.$on("darkModeChanged",v)});const s=e.ref(!1),n=e.ref({name:"",singer:"",source:"",songmid:"",hash:"",copyrightId:""}),r=e.ref("hot"),g=e.ref(0),m=e.ref({isLoading:!1,isLoadError:!1,page:1,total:0,maxPage:1,limit:20,list:[]}),c=e.ref({isLoading:!1,isLoadError:!1,page:1,total:0,maxPage:1,limit:20,list:[]}),d=()=>{t("close")},p=()=>{c.value.page=1,c.value.total=0,c.value.maxPage=1,c.value.list=[],m.value.page=1,m.value.total=0,m.value.maxPage=1,m.value.list=[],h(1,c.value.limit),L(1,m.value.limit)},h=async(e,l)=>{c.value.isLoadError=!1,c.value.isLoading=!0;try{const o=await a.getHotComment({id:n.value.id,name:n.value.name,singer:n.value.singer,source:n.value.source,songmid:n.value.songmid,hash:n.value.hash,copyrightId:n.value.copyrightId,page:e,limit:l});c.value.isLoading=!1,c.value.total=o.total,c.value.maxPage=o.maxPage,c.value.page=e,c.value.list=1===e?o.comments:[...c.value.list,...o.comments],g.value=0}catch(o){console.error("[MusicComment] 获取热门评论失败:",o),c.value.isLoadError=!0,c.value.isLoading=!1}},L=async(e,l)=>{m.value.isLoadError=!1,m.value.isLoading=!0;try{const o=await a.getNewComment({id:n.value.id,name:n.value.name,singer:n.value.singer,source:n.value.source,songmid:n.value.songmid,hash:n.value.hash,copyrightId:n.value.copyrightId,page:e,limit:l});m.value.isLoading=!1,m.value.total=o.total,m.value.maxPage=o.maxPage,m.value.page=e,m.value.list=1===e?o.comments:[...m.value.list,...o.comments],g.value=0}catch(o){console.error("[MusicComment] 获取最新评论失败:",o),m.value.isLoadError=!0,m.value.isLoading=!1}},x=e=>{s.value&&r.value!==e&&(r.value=e,g.value=0)},f=()=>{"hot"===r.value?c.value.page<c.value.maxPage&&!c.value.isLoading&&h(c.value.page+1,c.value.limit):m.value.page<m.value.maxPage&&!m.value.isLoading&&L(m.value.page+1,m.value.limit)};return e.watch(()=>u.show,e=>{e&&(()=>{if(n.value=u.musicInfo,!n.value)return console.log("[MusicComment] musicInfo为空，无法显示评论"),void(s.value=!1);"local"!==n.value.source?(s.value=!0,c.value.page=1,c.value.total=0,c.value.maxPage=1,c.value.list=[],m.value.page=1,m.value.total=0,m.value.maxPage=1,m.value.list=[],h(1,c.value.limit),L(1,m.value.limit)):s.value=!1})()}),(a,o)=>e.e({a:l.show},l.show?e.e({b:e.t(n.value.name),c:e.p({type:"fas",name:"rotate-right",size:"16",color:"#00d7cd"}),d:e.o(p),e:e.p({type:"fas",name:"xmark",size:"16",color:"#999"}),f:e.o(d),g:s.value},s.value?e.e({h:e.t(c.value.total),i:"hot"===r.value?1:"",j:e.o(e=>x("hot")),k:m.value.total>0},m.value.total>0?{l:e.t(m.value.total)}:{},{m:"new"===r.value?1:"",n:e.o(e=>x("new")),o:"hot"===r.value},"hot"===r.value?e.e({p:c.value.isLoadError},c.value.isLoadError?{q:e.o(e=>h(c.value.page,c.value.limit))}:c.value.isLoading&&0===c.value.list.length?{}:c.value.list.length>0?{t:e.p({comments:c.value.list})}:{},{r:c.value.isLoading&&0===c.value.list.length,s:c.value.list.length>0,v:c.value.list.length>0&&c.value.page<c.value.maxPage},c.value.list.length>0&&c.value.page<c.value.maxPage?{w:e.t(c.value.isLoading?"加载中...":"上拉加载更多")}:{}):{},{x:"new"===r.value},"new"===r.value?e.e({y:m.value.isLoadError},m.value.isLoadError?{z:e.o(e=>L(m.value.page,m.value.limit))}:m.value.isLoading&&0===m.value.list.length?{}:m.value.list.length>0?{C:e.p({comments:m.value.list})}:{},{A:m.value.isLoading&&0===m.value.list.length,B:m.value.list.length>0,D:m.value.list.length>0&&m.value.page<m.value.maxPage},m.value.list.length>0&&m.value.page<m.value.maxPage?{E:e.t(m.value.isLoading?"加载中...":"上拉加载更多")}:{}):{},{F:g.value,G:e.o(f)}):{},{H:i.value?1:"",I:e.o(()=>{}),J:e.o(d)}):{})}},t=e._export_sfc(u,[["__scopeId","data-v-99fdfd2b"]]);wx.createComponent(t);
