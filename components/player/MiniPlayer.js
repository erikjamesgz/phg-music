"use strict";const e=require("../../common/vendor.js"),a=require("../../store/modules/list.js"),t=require("../../store/modules/player.js"),l=require("../../utils/system.js"),i=require("../../utils/api/music.js"),r=require("../../utils/musicUrlCache.js"),n=require("../../utils/lyricCache.js"),u=require("../../utils/lyric.js"),o=require("../../utils/kgLyricDecoder.js"),s=require("../../utils/musicPic.js");Math||c();const c=()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js",d={__name:"MiniPlayer",setup(c){e.useCssVars(e=>({f8e121a4:H.value}));let d=null;try{d=e.getCurrentInstance()}catch(Y){console.log("[MiniPlayer] getCurrentInstance failed:",Y)}const m=()=>d,v=e.computed(()=>t.playerStore.getState().currentSong),g=e.computed(()=>t.playerStore.getState().playing),y=e.computed(()=>t.playerStore.getState().playMode),p=e.computed(()=>t.playerStore.getState().playlist),h=e.computed(()=>t.playerStore.getState().currentTime),f=e.computed(()=>t.playerStore.getState().duration),S=e.ref(0),x=e.ref(0),w=e.ref(!1);e.ref(null);const b=e.ref(!1);e.ref(null);const I=e.ref(!1),k=e.ref(""),C=e.ref([]),j=e.ref(""),q=e.ref(""),P=()=>{try{const a=e.index.createSelectorQuery().in(m());a.select(".mini-player__marquee").boundingClientRect(),a.select(".mini-player__marquee-content").boundingClientRect(),a.exec(e=>{if(!e||!e[0]||!e[1])return;const a=e[0],t=e[1];let l=t.width;b.value&&(l=t.width/2),b.value=l>a.width+5})}catch(Y){}},_=()=>{try{const a=e.index.createSelectorQuery().in(m());a.select(".mini-player__status-marquee").boundingClientRect(),a.select(".mini-player__status-content").boundingClientRect(),a.exec(e=>{if(!e||!e[0]||!e[1])return;const a=e[0],t=e[1];let l=t.width;I.value&&(l=t.width/2),I.value=l>a.width+5})}catch(Y){}},T=async e=>{if(!e)return void(k.value="");const a=e.sourceId||e.source;let t=s.getSongPicUrl(e,a);t?k.value=t:(k.value="",t=await s.fetchSongPicUrl(e,a),t&&(k.value=t))};e.watch(()=>{var e;return null==(e=v.value)?void 0:e.id},async(e,a)=>{b.value=!1,setTimeout(P,200),e!==a&&await T(v.value)},{immediate:!0}),e.watch(()=>v.value,async e=>{e&&e.id&&!k.value&&await T(e)},{immediate:!0}),e.watch(()=>q.value,(e,a)=>{e!==a&&(I.value=!1,setTimeout(_,300))});const U=()=>{if("false"!==e.index.getStorageSync("followSystem")){const a=e.index.getSystemInfoSync();w.value="dark"===a.theme}else w.value="true"===e.index.getStorageSync("darkMode")},L=e.ref(!1),M=e.ref(0),N=e.computed(()=>!f.value||f.value<=0?0:h.value/f.value*100),$=e.computed(()=>L.value?M.value:f.value>0?h.value/f.value*100:0);e.computed(()=>p.value.length),e.computed(()=>({width:`${N.value}%`}));const D=e.computed(()=>k.value||""),Q=e.computed(()=>{var e;return!!(null==(e=v.value)?void 0:e.id)}),R=()=>{const e=t.playerStore.getState();let a=e.lyric||"",l=e.lxlyric||"";if(o.isKgCompressedLyric(a))try{a=o.tryDecodeKgLyric(a).lyric||a}catch(Y){}if(o.isKgCompressedLyric(l))try{const e=o.tryDecodeKgLyric(l);l=e.lxlyric||l,!a&&e.lyric&&(a=e.lyric)}catch(Y){}const i=l||a;i!==j.value&&(j.value=i,C.value=i?u.parseLyric(i):[])},K=()=>{const e=t.playerStore.getState();if(e.statusText)return void(q.value=e.statusText);const a=e.currentTime;if(a&&C.value.length>0){const e=u.getCurrentLyricIndex(C.value,a);if(e>=0&&e<C.value.length)return void(q.value=C.value[e].text||"")}q.value=""},z=e.computed(()=>q.value);e.watch(()=>t.playerStore.getState().lyric,R,{immediate:!0}),e.watch(()=>t.playerStore.getState().lxlyric,R),e.watch(()=>t.playerStore.getState().currentTime,K),e.watch(()=>t.playerStore.getState().statusText,K,{immediate:!0});const A=e.computed(()=>{var e;try{const a=getCurrentPages(),t=a[a.length-1];if(!t)return!1;const l=t.route||(null==(e=t.$page)?void 0:e.route)||"";return["pages/index/index","pages/search/index","pages/playlist/index","pages/my/index"].some(e=>l.includes(e))}catch(Y){return!1}}),H=e.ref("0px"),W=()=>{var e;try{const a=getCurrentPages(),t=a[a.length-1],l=(null==t?void 0:t.route)||(null==(e=null==t?void 0:t.$page)?void 0:e.route)||"",i=["pages/index/index","pages/search/index","pages/playlist/index","pages/my/index"].some(e=>l.includes(e));H.value=i?`${x.value}px`:"20px"}catch(Y){H.value="20px"}},V=()=>{t.playerStore.togglePlay()},B=async()=>{const l="random"===y.value?"random":"singleLoop"===y.value?"singleLoop":"listLoop";"singleLoop"===y.value&&t.playerStore.setPlayMode("listLoop");const i=a.listStore.getNextSong(l,!1);i&&i.musicInfo?await E(i):e.index.showToast({title:"已经是最后一首了",icon:"none"})},E=async l=>{var u,o,s,c,d,m,v,g,y,p;const h=l.musicInfo,f=l.listId,S=l.isTempPlay;try{const e="128k",l=await r.getCachedMusicUrl(h.id,e);let x=l,w=null;if(l){const e=h.source||"tx";w=await n.getCachedLyric(h.id,e)||{}}else{const a=h.source||"tx";let l=h.id,n={};switch(a){case"tx":l=h.songmid||h.id,n={source:"tx",musicInfo:{id:l,name:h.name,singer:h.singer||(h.ar?h.ar.map(e=>e.name).join("/"):""),source:"tx",interval:h.dt||h.duration||"",meta:{songId:l,albumName:(null==(u=h.al)?void 0:u.name)||h.albumName||""}},quality:e};break;case"mg":l=h.songmid||h.songId||h.id;const t=h.copyrightId||h.id;n={source:"mg",songmid:l,id:t,musicInfo:{songmid:l,copyrightId:t,name:h.name,singer:h.singer||(h.ar?h.ar.map(e=>e.name).join("/"):""),album:(null==(o=h.al)?void 0:o.name)||h.albumName||""},quality:e};break;case"kg":l=h.hash||h.id,n={source:"kg",musicInfo:{id:l,name:h.name,singer:h.singer||(h.ar?h.ar.map(e=>e.name).join("/"):""),source:"kg",interval:h.dt||h.duration||"",meta:{songId:l,albumName:(null==(s=h.al)?void 0:s.name)||h.albumName||"",hash:h.hash||h.id}},quality:e};break;case"kw":n={source:"kw",musicInfo:{id:h.id,name:h.name,singer:h.singer||(h.ar?h.ar.map(e=>e.name).join("/"):""),source:"kw",interval:h.dt||h.duration||"",meta:{songId:h.id,albumName:(null==(c=h.al)?void 0:c.name)||h.albumName||""}},quality:e};break;case"wy":n={source:"wy",musicInfo:{id:h.id,name:h.name,singer:h.singer||(h.ar?h.ar.map(e=>e.name).join("/"):""),source:"wy",interval:h.dt||h.duration||"",meta:{songId:h.id,albumName:(null==(d=h.al)?void 0:d.name)||h.albumName||""}},quality:e};break;default:n={source:a,musicInfo:{id:h.id,name:h.name,singer:h.singer||(h.ar?h.ar.map(e=>e.name).join("/"):""),source:a,interval:h.dt||h.duration||"",meta:{songId:h.id,albumName:(null==(m=h.al)?void 0:m.name)||h.albumName||""}},quality:e}}t.playerStore.setStatusText("正在获取播放链接...",0);const v=await i.getMusicUrl(n);if(t.playerStore.clearStatusText(),v.fallback&&v.fallback.toggled){const e={tx:"QQ音乐",wy:"网易云音乐",kg:"酷狗音乐",kw:"酷我音乐",mg:"咪咕音乐"},a=e[v.fallback.originalSource]||v.fallback.originalSource,l=e[v.fallback.newSource]||v.fallback.newSource;t.playerStore.setStatusText(`已从${a}换源到${l}`,3e3)}x=v.url,await r.setCachedMusicUrl(h.id,e,x),w={lyric:v.lyric||"",tlyric:v.tlyric||"",rlyric:v.rlyric||"",lxlyric:v.lxlyric||""}}const b={...h,url:x,playUrl:x,quality:e,lyric:w.lyric||"",tlyric:w.tlyric||"",rlyric:w.rlyric||"",lxlyric:w.lxlyric||"",img:h.img||h.picUrl||(null==(v=h.al)?void 0:v.picUrl)||(null==(g=h.album)?void 0:g.picUrl)||h.albumPic||"",picUrl:h.picUrl||h.img||(null==(y=h.al)?void 0:y.picUrl)||(null==(p=h.album)?void 0:p.picUrl)||h.albumPic||"",al:h.al||{picUrl:h.img||h.picUrl||""}};a.listStore.setPlayMusicInfo(f,b,S),a.listStore.addPlayedList({listId:f,musicInfo:b,isTempPlay:S}),await t.playerStore.playSong(b)}catch(x){console.error("[MiniPlayer] 播放失败:",x),e.index.showToast({title:"播放失败: "+(x.message||"未知错误"),icon:"none"})}},X=()=>{e.index.navigateTo({url:"/pages/player/index"})},F=e=>{L.value=!0,O(e)},G=e=>{L.value&&O(e)},J=()=>{L.value&&(L.value=!1,t.playerStore.seek(M.value))},O=a=>{const t=a.touches[0],l=e.index.createSelectorQuery().in(m());l.select(".mini-player__progress").boundingClientRect(),l.exec(e=>{if(e[0]){const a=e[0],l=t.clientX-a.left,i=Math.min(Math.max(l/a.width*100,0),100);M.value=i}})};e.watch(()=>Q.value,a=>{let t=0;if(a){const a=140*(e.index.getSystemInfoSync().windowWidth/750);t=A.value?a:a+20}e.index.$emit("miniPlayerHeightChange",{height:t,isShowing:a})},{immediate:!0});return e.onMounted(()=>{(()=>{try{const e=l.getDeviceInfo();if(e.safeArea){const{bottom:a,height:t}=e.safeArea;S.value=e.screenHeight-a}const a=e.windowWidth/750*140;x.value=a}catch(e){console.error("获取系统信息失败:",e)}})(),U(),W(),setTimeout(P,300),setTimeout(_,350);const a=getCurrentPages(),t=a[a.length-1];if(t){const a=t.onShow;t.onShow=()=>{U(),W(),(()=>{var a;const t=Q.value;let l=0;if(t){const t=e.index.getSystemInfoSync().windowWidth/750*140;let i=!1;try{const e=getCurrentPages(),t=e[e.length-1],l=(null==t?void 0:t.route)||(null==(a=null==t?void 0:t.$page)?void 0:a.route)||"";i=["pages/index/index","pages/search/index","pages/playlist/index","pages/my/index"].some(e=>l.includes(e))}catch(Y){}l=i?t:t+20,W()}e.index.$emit("miniPlayerHeightChange",{height:l,isShowing:t})})(),a&&a.call(t)}}}),(a,t)=>{var l,i,r,n,u,o;return e.e({a:Q.value},Q.value?e.e({b:D.value,c:e.t((null==(l=v.value)?void 0:l.name)||"夏日微风"),d:e.t((null==(i=v.value)?void 0:i.ar)?v.value.ar.map(e=>e.name).join("/"):(null==(r=v.value)?void 0:r.artists)?v.value.artists.map(e=>e.name).join("/"):"海洋之声"),e:b.value},(b.value,{}),{f:b.value},b.value?{g:e.t((null==(n=v.value)?void 0:n.name)||"夏日微风")}:{},{h:b.value},(b.value,{}),{i:b.value},b.value?{j:e.t((null==(u=v.value)?void 0:u.ar)?v.value.ar.map(e=>e.name).join("/"):(null==(o=v.value)?void 0:o.artists)?v.value.artists.map(e=>e.name).join("/"):"海洋之声")}:{},{k:b.value?1:"",l:z.value},z.value?e.e({m:e.t(z.value),n:I.value},(I.value,{}),{o:I.value},I.value?{p:e.t(z.value)}:{},{q:I.value?1:""}):{},{r:e.p({name:g.value?"pause":"play",size:"16",color:"#ffffff"}),s:e.o(V),t:e.p({name:"forward-step",size:"16",color:"#999999"}),v:e.o(B),w:L.value?M.value+"%":$.value+"%",x:L.value?M.value+"%":$.value+"%",y:e.o(F),z:e.o(G),A:e.o(J),B:e.o(()=>{}),C:w.value?1:"",D:e.o(X),E:e.s(a.__cssVars())}):{})}}},m=e._export_sfc(d,[["__scopeId","data-v-98afed2d"]]);wx.createComponent(m);
