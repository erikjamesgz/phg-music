"use strict";const e=require("../../common/vendor.js"),t=require("../../store/modules/list.js"),l=require("../../store/modules/player.js"),a=require("../../utils/system.js"),i=require("../../utils/lyric.js"),n=require("../../utils/kgLyricDecoder.js"),r=require("../../utils/musicPic.js");Math||o();const o=()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js",u={__name:"MiniPlayer",setup(o){e.useCssVars(e=>({"03c47576":Q.value}));let u=null;try{u=e.getCurrentInstance()}catch(Y){console.log("[MiniPlayer] getCurrentInstance failed:",Y)}const s=()=>u,c=e.computed(()=>l.playerStore.getState().currentSong),v=e.computed(()=>l.playerStore.getState().playing),d=e.computed(()=>l.playerStore.getState().playMode),y=e.computed(()=>l.playerStore.getState().playlist),g=e.computed(()=>l.playerStore.getState().currentTime),p=e.computed(()=>l.playerStore.getState().duration),m=e.ref(0),h=e.ref(0),f=e.ref(!1);e.ref(null);const S=e.ref(!1);e.ref(null);const x=e.ref(!1),w=e.ref(""),L=e.ref([]),P=e.ref("");e.ref("");const C=e.ref(!1),M=e.ref(!1),_=()=>{try{const t=e.index.createSelectorQuery().in(s());t.select(".mini-player__marquee").boundingClientRect(),t.select(".mini-player__marquee-content").boundingClientRect(),t.exec(e=>{if(!e||!e[0]||!e[1])return;const t=e[0],l=e[1];let a=l.width;S.value&&(a=l.width/2),S.value=a>t.width+5})}catch(Y){}},I=()=>{try{const t=e.index.createSelectorQuery().in(s());t.select(".mini-player__status-marquee").boundingClientRect(),t.select(".mini-player__status-content").boundingClientRect(),t.exec(e=>{if(!e||!e[0]||!e[1])return;const t=e[0],l=e[1];let a=l.width;x.value&&(a=l.width/2),x.value=a>t.width+5})}catch(Y){}},T=async e=>{if(!e)return void(w.value="");const t=e.sourceId||e.source;let l=r.getSongPicUrl(e,t);l?w.value=l:(w.value="",l=await r.fetchSongPicUrl(e,t),l&&(w.value=l))};e.watch(()=>{var e;return null==(e=c.value)?void 0:e.id},async(e,t)=>{S.value=!1,setTimeout(_,200),C.value=!1,M.value=!1,e!==t&&await T(c.value)},{immediate:!0}),e.watch(()=>c.value,async e=>{e&&e.id&&!w.value&&await T(e)},{immediate:!0}),e.watch(()=>G.value,(e,t)=>{e!==t&&(x.value=!1,setTimeout(I,300))});const j=()=>{if("false"!==e.index.getStorageSync("followSystem")){const t=e.index.getSystemInfoSync();f.value="dark"===t.theme}else f.value="true"===e.index.getStorageSync("darkMode")},q=e.ref(!1),b=e.ref(0),$=e.computed(()=>!p.value||p.value<=0?0:g.value/p.value*100),k=e.computed(()=>q.value?b.value:p.value>0?g.value/p.value*100:0);e.computed(()=>y.value.length),e.computed(()=>({width:`${$.value}%`}));const D=e.computed(()=>w.value||""),U=e.computed(()=>{var e;return!!(null==(e=c.value)?void 0:e.id)}),R=()=>{var t,a,r,o;const u=l.playerStore.getState();console.log("[MiniPlayer] updateCachedLyrics 调用:",{lyricLength:null==(t=u.lyric)?void 0:t.length,tlyricLength:null==(a=u.tlyric)?void 0:a.length,lxlyricLength:null==(r=u.lxlyric)?void 0:r.length,cachedLength:L.value.length});const s={lyric:u.lyric||"",tlyric:u.tlyric||"",rlyric:u.rlyric||"",lxlyric:u.lxlyric||""},{lyric:c,tlyric:v,rlyric:d,lxlyric:y}=i.extractLyricsFromMusicData(s);let g=c||"",p=y||"";if(n.isKgCompressedLyric(g))try{g=n.tryDecodeKgLyric(g).lyric||g}catch(Y){}if(n.isKgCompressedLyric(p))try{const e=n.tryDecodeKgLyric(p);p=e.lxlyric||p,!g&&e.lyric&&(g=e.lyric)}catch(Y){}const m=p||g;console.log("[MiniPlayer] updateCachedLyrics finalLyric:",{length:null==m?void 0:m.length,lastLyricLength:null==(o=P.value)?void 0:o.length,isSame:m===P.value}),m!==P.value&&(P.value=m,m?(L.value=i.parseLyric(m),console.log("[MiniPlayer] 解析歌词成功，行数:",L.value.length),M.value=!0,e.nextTick$1(()=>{z()})):(L.value=[],console.log("[MiniPlayer] 歌词为空，清空缓存"),M.value=!0,e.nextTick$1(()=>{z()})))},G=e.ref(""),K=e.ref(!1),z=()=>{const e=l.playerStore.getState();if(e.statusText)return G.value=e.statusText,K.value=!0,void(M.value=!1);if(K.value=!1,e.playing&&!C.value&&(C.value=!0,M.value=!0),e.playing&&!M.value&&(M.value=!0),M.value){if(!(L.value.length>0))return void(G.value="暂无歌词")}const t=e.currentTime;if(t&&L.value.length>0){const e=i.getCurrentLyricIndex(L.value,t);if(e>=0&&e<L.value.length)return void(G.value=L.value[e].text||"")}G.value=""},A=e.computed(()=>G.value);e.watch(()=>l.playerStore.getState().lyric,R,{immediate:!0}),e.watch(()=>l.playerStore.getState().lxlyric,R),e.watch(()=>l.playerStore.getState().currentTime,z),e.watch(()=>l.playerStore.getState().statusText,(e,t)=>{z()},{immediate:!0});const H=e.computed(()=>{var e;try{const t=getCurrentPages(),l=t[t.length-1];if(!l)return!1;const a=l.route||(null==(e=l.$page)?void 0:e.route)||"";return["pages/index/index","pages/search/index","pages/playlist/index","pages/my/index"].some(e=>a.includes(e))}catch(Y){return!1}}),Q=e.ref("0px"),W=()=>{var e;try{const t=getCurrentPages(),l=t[t.length-1],a=(null==l?void 0:l.route)||(null==(e=null==l?void 0:l.$page)?void 0:e.route)||"",i=["pages/index/index","pages/search/index","pages/playlist/index","pages/my/index"].some(e=>a.includes(e));Q.value=i?`${h.value}px`:"20px"}catch(Y){Q.value="20px"}},N=()=>{l.playerStore.togglePlay()},V=async()=>{if(l.playerStore.getState().isGettingUrl){console.log("[MiniPlayer] 正在获取播放链接，只更新待播放歌曲");const e="random"===d.value?"random":"singleLoop"===d.value?"singleLoop":"listLoop";"singleLoop"===d.value&&l.playerStore.setPlayMode("listLoop");const a=t.listStore.getNextSong(e,!1);return void(a&&a.musicInfo&&(console.log("[MiniPlayer] 更新待播放歌曲:",a.musicInfo.name),l.playerStore.updatePendingSong(a.musicInfo)))}l.playerStore.setGettingUrl(!0);const a="random"===d.value?"random":"singleLoop"===d.value?"singleLoop":"listLoop";"singleLoop"===d.value&&l.playerStore.setPlayMode("listLoop");const i=t.listStore.getNextSong(a,!1);if(!i||!i.musicInfo)return console.log("[MiniPlayer] 没有下一首歌曲"),l.playerStore.setGettingUrl(!1),void e.index.showToast({title:"已经是最后一首了",icon:"none"});await B(i)},B=async a=>{const i=a.musicInfo,n=a.listId,r=a.isTempPlay;try{t.listStore.setPlayMusicInfo(n,i,r),t.listStore.addPlayedList({listId:n,musicInfo:i,isTempPlay:r}),await l.playerStore.playSong(i)}catch(o){console.error("[MiniPlayer] 播放失败:",o),l.playerStore.setGettingUrl(!1),e.index.showToast({title:"播放失败: "+(o.message||"未知错误"),icon:"none"})}},E=()=>{e.index.navigateTo({url:"/pages/player/index"})},F=e=>{q.value=!0,O(e)},X=e=>{q.value&&O(e)},J=()=>{q.value&&(q.value=!1,l.playerStore.seek(b.value))},O=t=>{const l=t.touches[0],a=e.index.createSelectorQuery().in(s());a.select(".mini-player__progress").boundingClientRect(),a.exec(e=>{if(e[0]){const t=e[0],a=l.clientX-t.left,i=Math.min(Math.max(a/t.width*100,0),100);b.value=i}})};e.watch(()=>U.value,t=>{let l=0;if(t){const t=140*(e.index.getSystemInfoSync().windowWidth/750);l=H.value?t:t+20}e.index.$emit("miniPlayerHeightChange",{height:l,isShowing:t})},{immediate:!0});return e.onMounted(()=>{(()=>{try{const e=a.getDeviceInfo();if(e.safeArea){const{bottom:t,height:l}=e.safeArea;m.value=e.screenHeight-t}const t=e.windowWidth/750*140;h.value=t}catch(e){console.error("获取系统信息失败:",e)}})(),j(),W(),setTimeout(_,300),setTimeout(I,350);const t=getCurrentPages(),l=t[t.length-1];if(l){const t=l.onShow;l.onShow=()=>{j(),W(),(()=>{var t;const l=U.value;let a=0;if(l){const l=e.index.getSystemInfoSync().windowWidth/750*140;let i=!1;try{const e=getCurrentPages(),l=e[e.length-1],a=(null==l?void 0:l.route)||(null==(t=null==l?void 0:l.$page)?void 0:t.route)||"";i=["pages/index/index","pages/search/index","pages/playlist/index","pages/my/index"].some(e=>a.includes(e))}catch(Y){}a=i?l:l+20,W()}e.index.$emit("miniPlayerHeightChange",{height:a,isShowing:l})})(),t&&t.call(l)}}}),(t,l)=>{var a,i,n,r,o,u;return e.e({a:U.value},U.value?e.e({b:D.value,c:e.t((null==(a=c.value)?void 0:a.name)||"夏日微风"),d:e.t((null==(i=c.value)?void 0:i.ar)?c.value.ar.map(e=>e.name).join("/"):(null==(n=c.value)?void 0:n.artists)?c.value.artists.map(e=>e.name).join("/"):"海洋之声"),e:S.value},(S.value,{}),{f:S.value},S.value?{g:e.t((null==(r=c.value)?void 0:r.name)||"夏日微风")}:{},{h:S.value},(S.value,{}),{i:S.value},S.value?{j:e.t((null==(o=c.value)?void 0:o.ar)?c.value.ar.map(e=>e.name).join("/"):(null==(u=c.value)?void 0:u.artists)?c.value.artists.map(e=>e.name).join("/"):"海洋之声")}:{},{k:S.value?1:"",l:A.value},A.value?e.e({m:e.t(A.value),n:x.value},(x.value,{}),{o:x.value},x.value?{p:e.t(A.value)}:{},{q:x.value?1:""}):{},{r:e.p({name:v.value?"pause":"play",size:"16",color:"#ffffff"}),s:e.o(N),t:e.p({name:"forward-step",size:"16",color:"#999999"}),v:e.o(V),w:q.value?b.value+"%":k.value+"%",x:q.value?b.value+"%":k.value+"%",y:e.o(F),z:e.o(X),A:e.o(J),B:e.o(()=>{}),C:f.value?1:"",D:e.o(E),E:e.s(t.__cssVars())}):{})}}},s=e._export_sfc(u,[["__scopeId","data-v-005ba02b"]]);wx.createComponent(s);
