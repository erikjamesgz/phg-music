"use strict";const e=require("../../common/vendor.js"),l=require("../../services/api.js");Math||a();const a=()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js",o={__name:"MusicToggleModal",props:{visible:{type:Boolean,default:!1},originalSong:{type:Object,default:null},listId:{type:String,default:""},darkMode:{type:Boolean,default:!1}},emits:["close","confirm","preview"],setup(a,{emit:o}){const n=a,i=o,t=e.ref([{id:"kw",name:"酷我"},{id:"kg",name:"酷狗"},{id:"tx",name:"QQ"},{id:"wy",name:"网易"},{id:"mg",name:"咪咕"}]),r=e.ref(""),s=e.ref([]),u=e.ref({}),g=e.ref(!1),c=e.ref(!1),m=e.ref(null),d=e.ref(!1);e.watch([()=>n.visible,()=>n.originalSong],([e,l])=>{console.log("[MusicToggleModal] visible变化:",e,"originalSong:",null==l?void 0:l.name),e&&l&&!d.value&&(console.log("[MusicToggleModal] 触发搜索"),d.value=!0,t.value=[{id:"kw",name:"酷我"},{id:"kg",name:"酷狗"},{id:"tx",name:"QQ"},{id:"wy",name:"网易"},{id:"mg",name:"咪咕"}],v())},{immediate:!0}),e.watch(()=>n.visible,e=>{e||(d.value=!1)});const v=async()=>{if(n.originalSong){g.value=!0,c.value=!1,s.value=[],u.value={},m.value=null,r.value="";try{const{name:e,singer:l}=n.originalSong,a=`${e} ${b(l||n.originalSong.artists)}`.trim();console.log("[MusicToggleModal] 开始搜索:",a);const o=t.value.map(async e=>{try{const l=await M(e.id,a);return l&&l.length>0?(u.value[e.id]=l,{source:e.id,list:l}):null}catch(l){return console.error(`[MusicToggleModal] ${e.name}搜索失败:`,l),null}}),i=(await Promise.all(o)).filter(e=>null!==e);console.log("[MusicToggleModal] 搜索结果:",i.length,"个音源有数据"),i.length>0&&(r.value=i[0].source,s.value=i[0].list);const g=t.value.filter(e=>u.value[e.id]&&u.value[e.id].length>0);console.log("[MusicToggleModal] 有结果的音源:",g.map(e=>e.name)),g.length>0&&(t.value=g)}catch(e){console.error("[MusicToggleModal] 搜索失败:",e),c.value=!0}finally{g.value=!1}}},M=async(e,a)=>{try{console.log(`[MusicToggleModal] 开始搜索音源: ${e}, 关键词: ${a}`);const o=await l.searchApi.searchSongs(a,e,1,25);if(console.log(`[MusicToggleModal] ${e} 搜索结果:`,o),o&&o.list&&o.list.length>0){console.log(`[MusicToggleModal] ${e} 找到 ${o.list.length} 首歌曲`);const l=p(o.list,n.originalSong);return console.log(`[MusicToggleModal] ${e} 排序后 ${l.length} 首歌曲`),l}return console.log(`[MusicToggleModal] ${e} 没有搜索结果`),[]}catch(o){return console.error(`[MusicToggleModal] 搜索${e}失败:`,o),console.error("[MusicToggleModal] 错误详情:",o.message),[]}},p=(e,l)=>{const{name:a,singer:o,albumName:n,interval:i,duration:t}=l,r=e=>e?"string"==typeof e?e:Array.isArray(e)?e.map(e=>"string"==typeof e?e:e.name).join("、"):e.name||"":"",s=r(o||l.artists),u=n||l.album&&l.album.name||"",g=i||T(t),c=e=>"string"!=typeof e?String(e||""):e.replace(/\s|'|\.|,|，|&|"|、|\(|\)|（|）|`|~|-|<|>|\||\/|\]|\[!！/g,"").toLowerCase(),m=c(a),d=c(s),v=e=>{if(!e)return 0;const l=String(e).split(":");let a=0,o=1;for(;l.length;)a+=parseInt(l.pop())*o,o*=60;return a},M=v(g),p=e=>{let l=0;const a=c(e.name),o=c(r(e.singer||e.artists)),n=c(e.albumName||e.album&&e.album.name||""),i=v(e.interval||T(e.duration));if(a===m?l+=100:(a.includes(m)||m.includes(a))&&(l+=50),o===d?l+=80:(o.includes(d)||d.includes(o))&&(l+=40),n&&u&&(n===c(u)?l+=30:(n.includes(c(u))||c(u).includes(n))&&(l+=15)),M>0&&i>0){const e=Math.abs(M-i);e<5?l+=20:e<10&&(l+=10)}return l},f=e.map(e=>({...e,matchScore:p(e)}));return f.sort((e,l)=>l.matchScore-e.matchScore),f.slice(0,15)},f=()=>{m.value&&m.value.id!==n.originalSong.id&&(console.log("[MusicToggleModal] 确认换源:",{from:n.originalSong,to:m.value}),i("confirm",{originalSong:n.originalSong,newSong:m.value,listId:n.listId}),h())},h=()=>{i("close")},y=()=>{v()},S=e=>e?"string"==typeof e?e:Array.isArray(e)?e.map(e=>"string"==typeof e?e:e.name).filter(Boolean).join(" / "):e.name||"未知歌手":"未知歌手",b=e=>e?"string"==typeof e?e:Array.isArray(e)?e.map(e=>"string"==typeof e?e:e.name).filter(Boolean).join(" "):e.name||"":"",T=e=>{if(!e&&0!==e)return"00:00";let l=Math.floor(e/1e3);isNaN(l)&&(l=0);const a=l%60;return`${Math.floor(l/60).toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},w=e=>({kw:"酷我",kg:"酷狗",tx:"QQ",wy:"网易",mg:"咪咕"}[e]||e);return(l,o)=>e.e({a:a.visible},a.visible?e.e({b:e.p({type:"fas",name:"xmark",size:"20",color:"#999"}),c:e.o(h),d:!g.value&&t.value.length>0},!g.value&&t.value.length>0?{e:e.f(t.value,(l,a,o)=>({a:e.t(l.name),b:l.id,c:r.value===l.id?1:"",d:e.o(e=>{return a=l.id,r.value=a,s.value=u.value[a]||[],void console.log("[MusicToggleModal] 切换到音源:",a,"结果数:",s.value.length);var a},l.id)}))}:{},{f:g.value},g.value?{}:c.value?{h:e.o(y)}:!g.value&&s.value.length>0?{j:e.f(s.value,(l,a,o)=>{var n;return e.e({a:e.t(l.name),b:e.t(S(l.singer||l.artists)),c:l.albumName||l.album&&l.album.name},l.albumName||l.album&&l.album.name?{d:e.t(l.albumName||(null==(n=l.album)?void 0:n.name))}:{},{e:e.t(w(l.source)),f:e.t(l.interval||T(l.duration)),g:"4b5696e1-1-"+o,h:e.o(e=>(e=>{console.log("[MusicToggleModal] 预览歌曲:",e.name),i("preview",e)})(l),l.id||a),i:"4b5696e1-2-"+o,j:e.o(a=>(l=>{var a;console.log("[MusicToggleModal] 显示歌曲详情:",l),e.index.showModal({title:"歌曲详情",content:`歌名: ${l.name}\n歌手: ${S(l.singer||l.artists)}\n专辑: ${l.albumName||(null==(a=l.album)?void 0:a.name)||"未知"}\n音源: ${w(l.source)}\n时长: ${l.interval||T(l.duration)}`,showCancel:!1})})(l),l.id||a),k:l.id||a,l:m.value&&m.value.id===l.id?1:"",m:e.o(e=>(e=>{m.value=e,console.log("[MusicToggleModal] 选中歌曲:",e.name,e.source)})(l),l.id||a)})}),k:e.p({type:"fas",name:"play",size:"16",color:"#666"}),l:e.p({type:"fas",name:"circle-info",size:"16",color:"#666"})}:(g.value||c.value||s.value.length,{}),{g:c.value,i:!g.value&&s.value.length>0,m:!g.value&&!c.value&&0===s.value.length,n:a.originalSong},a.originalSong?e.e({o:e.t(a.originalSong.name),p:e.t(w(a.originalSong.source)),q:e.t(a.originalSong.interval||T(a.originalSong.duration)),r:e.t(S(a.originalSong.singer||a.originalSong.artists)),s:m.value},m.value?{t:e.t(m.value.name),v:e.t(w(m.value.source)),w:e.t(m.value.interval||T(m.value.duration)),x:e.t(S(m.value.singer||m.value.artists))}:{},{y:m.value&&m.value.id!==a.originalSong.id?"":1,z:e.o(f)}):{},{A:a.darkMode?1:"",B:e.o(()=>{}),C:e.o(h)}):{})}},n=e._export_sfc(o,[["__scopeId","data-v-4b5696e1"]]);wx.createComponent(n);
