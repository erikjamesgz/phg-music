"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/api/music.js"),l=require("../../utils/audioCache.js"),t=require("../../utils/playInfoStorage.js"),a=require("../../utils/musicSwitchSourceStorage.js"),n=require("./list.js"),r=require("./user.js"),i=require("./system.js"),s=require("../../utils/lyricCache.js"),c=e=>{if("string"==typeof e&&e.includes(":"))return e;if("number"==typeof e){return`${Math.floor(e/6e4)}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}`}return"0:00"},u={[n.PLAY_MODE.listLoop]:"repeat",[n.PLAY_MODE.random]:"shuffle",[n.PLAY_MODE.list]:"arrow-right-arrow-left",[n.PLAY_MODE.singleLoop]:"rotate-right",[n.PLAY_MODE.none]:"ban"},d=e.reactive({currentSong:{id:0,name:"暂无播放歌曲",ar:[{name:"未知歌手"}],al:{picUrl:"/static/images/default-cover.png"},album:{picUrl:"/static/images/default-cover.png",name:"未知专辑"},img:"/static/images/default-cover.png",pic:"/static/images/default-cover.png",source:"",sourceId:""},playlist:[],playHistory:[],playMode:n.PLAY_MODE.listLoop,playing:!1,currentTime:0,duration:0,audioContext:null,audioQuality:"standard",showMiniPlayer:!0,showFullPlayer:!1,isLoading:!1,error:null,lyric:"",tlyric:"",rlyric:"",lxlyric:"",onPlayEndedCallback:null,lastSaveTime:0,isPreloading:!1,cacheSize:512,enablePreload:!0,lastStatsTime:0,retryNum:0,playNextRetryCount:0,loadTimeout:null,isRefreshingUrl:!1,lastRefreshSongId:null,statusText:""});function g(e){const o=(e=Math.floor(e))%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}const y={get state(){return e.readonly(d)},getState:()=>d,setState(e){Object.assign(d,e)},setStatusText(e,o=3e3){d.statusText=e,o>0&&setTimeout(()=>{d.statusText===e&&(d.statusText="")},o)},clearStatusText(){d.statusText=""},get progressPercent(){return d.duration?Math.floor(d.currentTime/d.duration*100):0},get formattedCurrentTime(){return g(d.currentTime)},get formattedDuration(){return g(d.duration)},get hasPrev(){return d.playlist.length>1},get hasNext(){return d.playlist.length>1},initAudioContext(){d.audioContext||(d.audioContext=e.index.getBackgroundAudioManager(),console.log("[initAudioContext] 使用 BackgroundAudioManager"))},setupAudioEventListeners(){const o=d.audioContext;o&&(o.onPlay(()=>{console.log("[BackgroundAudio] onPlay"),d.playing=!0,this.clearLoadTimeout(),this.clearStatusText(),d.playNextRetryCount=0}),o.onPause(()=>{console.log("[BackgroundAudio] onPause"),d.playing=!1}),o.onStop(()=>{console.log("[BackgroundAudio] onStop"),d.playing=!1,d.currentTime=0}),o.onEnded(()=>{console.log("[BackgroundAudio] onEnded"),console.log("[playerStore] this.handlePlayEnded 类型:",typeof this.handlePlayEnded),"function"==typeof this.handlePlayEnded?this.handlePlayEnded():console.error("[playerStore] handlePlayEnded 不是函数!")}),o.onTimeUpdate(()=>{var e;d.currentTime=o.currentTime,d.duration=o.duration;const l=Date.now();if(!d.lastSaveTime||l-d.lastSaveTime>5e3){d.lastSaveTime=l;let o=n.listStore.state.playInfo.playerListId||n.LIST_IDS.DEFAULT,a=n.listStore.state.playInfo.playIndex??0;o===n.LIST_IDS.TEMP&&(null==(e=n.listStore.state.tempList.meta)?void 0:e.id)&&(o=n.listStore.state.tempList.meta.id),t.savePlayInfo({time:Math.floor(d.currentTime),maxTime:Math.floor(d.duration),listId:o,index:a})}if(d.enablePreload&&d.duration>10){const e=d.duration-d.currentTime;e<10&&e>5&&!d.isPreloading&&this.preloadNextSong()}const a=Date.now();(!d.lastStatsTime||a-d.lastStatsTime>3e4)&&(d.lastStatsTime=a,r.userStore.increaseListenTime(.5))}),o.onPrev(()=>{console.log("[BackgroundAudio] onPrev"),this.playPrev()}),o.onNext(()=>{console.log("[BackgroundAudio] onNext"),this.playNext()}),o.onError(o=>{console.error("[BackgroundAudio] onError:",o),d.error=o.errMsg||"播放错误",d.isLoading=!1,d.playing=!1,this.setStatusText("播放出错，正在重试...",0),this.clearLoadTimeout(),console.log("[BackgroundAudio] onError - 错误码:",o.errCode),1!==o.errCode&&d.retryNum<2?(console.log("[BackgroundAudio] onError - 准备刷新URL"),this.refreshMusicUrl()):(e.index.showToast({title:"播放失败，正在切换下一首...",icon:"none"}),setTimeout(()=>{this.handlePlayEndedDefault()},1500))}))},setCurrentSong(e,o=!0){e&&(console.log("[setCurrentSong] 设置歌曲:",e.name,"ID:",e.id,"showLoading:",o),d.currentSong=e,d.isLoading=o,d.error=null,d.playing=!1)},async playSong(i){var s,c,u,g,y,p,m,S,h,f,x,L,M,I,P,T,v,C,U,E,b,A,w;if(!i)return void console.error("[playSong] song is null or undefined");console.log("[playSong] ========== 开始播放歌曲 =========="),console.log("[playSong] 歌曲ID:",i.id),console.log("[playSong] 歌曲名称:",i.name),d.currentSong&&d.currentSong.id!==i.id&&e.index.$emit("songChanging"),this.initAudioContext(),console.log("[playSong] 检查是否同一首歌:"),console.log("[playSong] state.currentSong?.id:",null==(s=d.currentSong)?void 0:s.id),console.log("[playSong] song.id:",i.id),console.log("[playSong] song.url:",i.url?"有":"无");const k=d.currentSong&&d.currentSong.id===i.id&&!i.url;if(console.log("[playSong] isSameSong:",k),k){if(console.log("[playSong] 是同一首歌，检查是否需要继续播放"),d.playing)return void console.log("[playSong] 当前正在播放同一首歌，不做任何操作");if(d.audioContext&&d.audioContext.src)return console.log("[playSong] 当前暂停中，继续播放"),void d.audioContext.play()}if(d.audioContext&&(d.playing||d.audioContext.src)){console.log("[playSong] 停止当前播放的歌曲");try{d.audioContext.stop()}catch(D){console.log("[playSong] 停止当前播放的歌曲失败（可能已停止）:",D.message)}}d.currentSong=i,d.isLoading=!0,d.error=null,d.retryNum=0,d.lastRefreshSongId=i.id,this.clearLoadTimeout(),console.log("[playSong] state.currentSong.id:",null==(c=d.currentSong)?void 0:c.id),console.log("[playSong] state.currentSong.img:",null==(u=d.currentSong)?void 0:u.img),console.log("[playSong] state.currentSong.picUrl:",null==(g=d.currentSong)?void 0:g.picUrl),console.log("[playSong] state.currentSong.al?.picUrl:",null==(p=null==(y=d.currentSong)?void 0:y.al)?void 0:p.picUrl),d.lyric=i.lyric||"",d.tlyric=i.tlyric||"",d.rlyric=i.rlyric||"",d.lxlyric=i.lxlyric||"",console.log("[playSong] 保存歌词信息到state:",{lyricLength:null==(m=d.lyric)?void 0:m.length,tlyricLength:null==(S=d.tlyric)?void 0:S.length,rlyricLength:null==(h=d.rlyric)?void 0:h.length,lxlyricLength:null==(f=d.lxlyric)?void 0:f.length});try{let e=null;const s={standard:"320k",high:"flac",lossless:"flac24bit",low:"128k"}[d.audioQuality]||"320k",c=String(i.id).replace(/^(tx|wy|kg|kw|mg)_/,"")||i.id,u=a.getMusicSwitchSourceById(c);if(u&&u.newSource){console.log("[playSong] 发现保存的换源信息, 原source:",i.source,"换源后:",u.newSource),i.source=u.newSource,u.newSongId&&(i.id=u.newSongId),u.newSongName&&(i.name=u.newSongName),u.newSongSinger&&(i.singer=u.newSongSinger);const e={tx:"QQ音乐",wy:"网易云音乐",kg:"酷狗音乐",kw:"酷我音乐",mg:"咪咕音乐"}[u.newSource]||u.newSource;this.setStatusText(`已恢复换源: ${e}`,3e3)}if(!e){const o=await l.getCachedMusicUrl(i.id,s);o&&(console.log("[playSong] 使用缓存的播放URL:",o),e=o)}if(e||!i.url&&!i.playUrl||(e=i.url||i.playUrl,console.log("[playSong] 使用歌曲自带的URL:",e),await l.setCachedMusicUrl(i.id,s,e),console.log("[playSong] 已将URL保存到缓存")),e){console.log("[playSong] 最终使用播放URL:",e),this.clearStatusText();const o=e;let l=(null==(x=i.al)?void 0:x.picUrl)||(null==(L=i.album)?void 0:L.picUrl)||i.img||"";l&&(l=l.replace(/^http:/,"https:")),console.log("[playSong] 设置背景音频属性:",{title:i.name||"未知歌曲",singer:this.formatArtists(i),coverImgUrl:l,epname:(null==(M=i.al)?void 0:M.name)||(null==(I=i.album)?void 0:I.name)||"未知专辑",src:o}),d.audioContext.title=i.name||"未知歌曲",d.audioContext.singer=this.formatArtists(i),d.audioContext.coverImgUrl=l,d.audioContext.epname=(null==(P=i.al)?void 0:P.name)||(null==(T=i.album)?void 0:T.name)||"未知专辑",d.audioContext.src=o,this.startLoadTimeout(),console.log("[playSong] 背景音频src已设置，开始播放"),d.showMiniPlayer=!0,d.isLoading=!1}else{console.log("[playSong] 歌曲没有已有URL，调用API获取"),console.log("[playSong] 用户选择的音质:",d.audioQuality),console.log("[playSong] 实际使用的音质:",s),this.setStatusText("正在获取播放链接...",0);const e=await o.getMusicUrl(i,s);if(console.log("[playSong] API获取成功"),console.log("[playSong] URL:",e.url),console.log("[playSong] 音质:",e.type),this.clearStatusText(),e.fallback&&e.fallback.toggled){const o={tx:"QQ音乐",wy:"网易云音乐",kg:"酷狗音乐",kw:"酷我音乐",mg:"咪咕音乐"},l=o[e.fallback.originalSource]||e.fallback.originalSource,t=o[e.fallback.newSource]||e.fallback.newSource;this.setStatusText(`已从${l}换源到${t}`,3e3)}await l.setCachedMusicUrl(i.id,s,e.url);const t=e.url;let a=(null==(v=i.al)?void 0:v.picUrl)||(null==(C=i.album)?void 0:C.picUrl)||i.img||"";a&&(a=a.replace(/^http:/,"https:")),console.log("[playSong] 设置背景音频属性:",{title:i.name||"未知歌曲",singer:this.formatArtists(i),coverImgUrl:a,epname:(null==(U=i.al)?void 0:U.name)||(null==(E=i.album)?void 0:E.name)||"未知专辑",src:t}),d.audioContext.title=i.name||"未知歌曲",d.audioContext.singer=this.formatArtists(i),d.audioContext.coverImgUrl=a,d.audioContext.epname=(null==(b=i.al)?void 0:b.name)||(null==(A=i.album)?void 0:A.name)||"未知专辑",d.audioContext.src=t,this.startLoadTimeout(),console.log("[playSong] 背景音频src已设置，开始播放")}this.addToHistory(i);const g=this.formatArtists(i);r.userStore.increaseListenCount(g),d.showMiniPlayer=!0,d.isLoading=!1;let y=n.listStore.state.playInfo.playerListId||n.LIST_IDS.DEFAULT,p=n.listStore.state.playInfo.playIndex??0;y===n.LIST_IDS.TEMP&&(null==(w=n.listStore.state.tempList.meta)?void 0:w.id)&&(y=n.listStore.state.tempList.meta.id),t.savePlayInfo({time:0,maxTime:0,listId:y,index:p})}catch(N){console.error("[playSong] 播放歌曲失败:",N),console.error("[playSong] 错误信息:",N.message),d.isLoading=!1,d.error=N.message||"播放失败",e.index.showToast({title:"播放失败: "+(N.message||"未知错误"),icon:"none",duration:2e3})}},pause(){console.log("[pause] 暂停播放"),d.audioContext&&d.audioContext.pause(),d.playing=!1},stop(){if(console.log("[stop] 停止播放"),d.audioContext)try{d.audioContext.stop()}catch(e){console.log("[stop] 停止失败:",e.message)}d.playing=!1,d.currentTime=0},resume(){console.log("[resume] 继续播放, 当前 playing 状态:",d.playing),d.audioContext&&!d.playing&&(d.audioContext.play(),d.playing=!0)},togglePlay(){d.playing?this.pause():this.resume()},togglePlayMode(){console.log("[playerStore] 切换播放模式");const e=(n.PLAY_MODE_LIST.indexOf(d.playMode)+1)%n.PLAY_MODE_LIST.length;return d.playMode=n.PLAY_MODE_LIST[e],console.log("[playerStore] 新播放模式:",d.playMode),d.playMode},getPlayModeIcon:()=>u[d.playMode]||u[n.PLAY_MODE.listLoop],playNext(){if(d.playlist.length<=1)return;let e=0;const o=d.playlist.findIndex(e=>e.id===d.currentSong.id);e=d.playMode===n.PLAY_MODE.random?Math.floor(Math.random()*d.playlist.length):(o+1)%d.playlist.length,this.playSong(d.playlist[e])},playPrev(){if(d.playlist.length<=1)return;let e=0;const o=d.playlist.findIndex(e=>e.id===d.currentSong.id);e=d.playMode===n.PLAY_MODE.random?Math.floor(Math.random()*d.playlist.length):(o-1+d.playlist.length)%d.playlist.length,this.playSong(d.playlist[e])},async handlePlayEnded(){var e,t,a;if(console.log("[playerStore] ========== 播放结束处理开始 =========="),console.log("[playerStore] 当前模式:",d.playMode),console.log("[playerStore] PLAY_MODE.singleLoop:",n.PLAY_MODE.singleLoop),console.log("[playerStore] 模式是否匹配 singleLoop:",d.playMode===n.PLAY_MODE.singleLoop),console.log("[playerStore] 当前歌曲:",null==(e=d.currentSong)?void 0:e.name,"ID:",null==(t=d.currentSong)?void 0:t.id),console.log("[playerStore] 是否有外部回调:",!!d.onPlayEndedCallback),d.onPlayEndedCallback)return console.log("[playerStore] 调用外部播放结束回调，传入模式:",d.playMode),void d.onPlayEndedCallback(d.playMode);if(d.playMode!==n.PLAY_MODE.none)try{if(console.log("[playerStore] 使用 listStore 处理下一首..."),console.log("[playerStore] LIST_IDS:",n.LIST_IDS),console.log("[playerStore] defaultList 长度:",n.listStore.state.defaultList.list.length),console.log("[playerStore] loveList 长度:",n.listStore.state.loveList.list.length),console.log("[playerStore] tempList 长度:",n.listStore.state.tempList.list.length),console.log("[playerStore] playInfo:",JSON.stringify(n.listStore.state.playInfo)),d.playMode===n.PLAY_MODE.singleLoop)return console.log("[playerStore] 单曲循环，重新播放当前歌曲"),void(d.audioContext&&(d.audioContext.seek(0),d.audioContext.play()));if(d.playMode===n.PLAY_MODE.list){console.log("[playerStore] 顺序播放模式，检查是否最后一首");const e=n.listStore.state.playInfo.playerListId;if(console.log("[playerStore] 当前列表ID:",e),!e)return void console.log("[playerStore] 没有当前列表ID，停止播放");const o=e===n.LIST_IDS.DEFAULT?n.listStore.state.defaultList.list:e===n.LIST_IDS.LOVE?n.listStore.state.loveList.list:n.listStore.state.tempList.list,l=n.listStore.state.playInfo.playerPlayIndex;if(console.log("[playerStore] 当前列表长度:",o.length,"当前索引:",l),l>=o.length-1)return void console.log("[playerStore] 已是最后一首，停止播放")}const e=d.playMode===n.PLAY_MODE.random?"random":"listLoop";console.log("[playerStore] 切换模式:",e),console.log("[playerStore] 调用 listStore.getNextSong...");const t=n.listStore.getNextSong(e,!0);if(console.log("[playerStore] getNextSong 返回:",t?"有数据":"无数据"),t&&t.musicInfo){console.log("[playerStore] 自动播放下一首:",t.musicInfo.name,"ID:",t.musicInfo.id),console.log("[playerStore] 下一首列表ID:",t.listId,"是否临时:",t.isTempPlay);const e=i.systemStore.getState().audioQuality||"128k",r=await l.getCachedMusicUrl(t.musicInfo.id,e);let c=r,u=null;if(r){const e=t.musicInfo.source||"tx";u=await s.getCachedLyric(t.musicInfo.id,e)||{}}else{const n=t.musicInfo.source||"tx",r="tx"===n&&t.musicInfo.songmid?t.musicInfo.songmid:t.musicInfo.id;console.log("[playerStore] handlePlayEnded 构建请求参数:"),console.log("[playerStore] musicInfo.source:",t.musicInfo.source),console.log("[playerStore] musicInfo.id:",t.musicInfo.id),console.log("[playerStore] musicInfo.songmid:",t.musicInfo.songmid),console.log("[playerStore] 使用的 songId:",r);const i={source:n,musicInfo:{id:r,name:t.musicInfo.name,singer:t.musicInfo.singer||(t.musicInfo.ar?t.musicInfo.ar.map(e=>e.name).join("/"):""),source:n,interval:t.musicInfo.dt||t.musicInfo.duration||"",meta:{songId:r,albumName:(null==(a=t.musicInfo.al)?void 0:a.name)||t.musicInfo.albumName||""}},quality:e};"kg"===n&&(i.musicInfo.meta.hash=t.musicInfo.hash||t.musicInfo.id),console.log("[playerStore] requestData:",JSON.stringify(i));const s=await o.getMusicUrl(i);c=s.url,await l.setCachedMusicUrl(t.musicInfo.id,e,c),u={lyric:s.lyric||"",tlyric:s.tlyric||"",rlyric:s.rlyric||"",lxlyric:s.lxlyric||""}}const d={...t.musicInfo,url:c,playUrl:c,quality:e,lyric:u.lyric||"",tlyric:u.tlyric||"",rlyric:u.rlyric||"",lxlyric:u.lxlyric||""};n.listStore.setPlayMusicInfo(t.listId,d,t.isTempPlay),n.listStore.addPlayedList({listId:t.listId,musicInfo:d,isTempPlay:t.isTempPlay}),this.playSong(d)}else console.log("[playerStore] 没有下一首歌曲可播放")}catch(r){console.error("[playerStore] 播放下一首失败:",r),this.handlePlayEndedWithRetry()}else console.log("[playerStore] 禁用模式，不自动播放下一首")},async handlePlayEndedWithRetry(){if(d.playNextRetryCount=(d.playNextRetryCount||0)+1,console.log("[playerStore] 播放下一首重试次数:",d.playNextRetryCount),d.playNextRetryCount>=5)return console.log("[playerStore] 重试次数已达上限，停止播放"),d.playNextRetryCount=0,void(d.playing=!1);if("singleLoop"===d.playMode)d.audioContext&&(d.audioContext.seek(0),d.audioContext.play());else await this.handlePlayEnded()},handlePlayEndedDefault(){switch(d.playMode){case"single":d.audioContext&&(d.audioContext.seek(0),d.audioContext.play());break;case"loop":default:this.playNext();break;case"random":this.playRandom()}},setOnPlayEndedCallback(e){d.onPlayEndedCallback=e},playRandom(){if(0===d.playlist.length)return;const e=Math.floor(Math.random()*d.playlist.length);this.playSong(d.playlist[e])},addToHistory(o){console.log("[playerStore] 添加到播放历史:",o.name);d.playHistory.some(e=>e.id===o.id)||(d.playHistory.unshift(o),d.playHistory.length>200&&d.playHistory.pop(),e.index.setStorageSync("playHistory",d.playHistory),console.log("[playerStore] 播放历史已更新，当前数量:",d.playHistory.length))},async refreshMusicUrl(){var t,a,n,r,i,s,u,g,y,p;const m=d.currentSong;if(m&&m.id)if(d.isRefreshingUrl)console.log("[refreshMusicUrl] 正在刷新URL，跳过");else if(d.retryNum>=2)console.log("[refreshMusicUrl] 重试次数已达上限（2次），不再重试");else{d.lastRefreshSongId!==m.id&&(console.log("[refreshMusicUrl] 歌曲已更换，重置重试次数"),d.retryNum=0,d.lastRefreshSongId=m.id),console.log("[refreshMusicUrl] 开始刷新URL，当前重试次数:",d.retryNum),d.isRefreshingUrl=!0;try{d.loadTimeout&&(clearTimeout(d.loadTimeout),d.loadTimeout=null);const S={standard:"320k",high:"flac",lossless:"flac24bit",low:"128k"}[d.audioQuality]||"320k";await this.clearMusicUrlCache(m.id,S),console.log("[refreshMusicUrl] 已清除URL缓存"),e.index.showToast({title:"正在刷新播放链接...",icon:"none",duration:1500});const h=m.source||"tx";let f,x;switch(console.log("[refreshMusicUrl] 歌曲信息:",{id:m.id,songmid:m.songmid,hash:m.hash,copyrightId:m.copyrightId,source:h}),h){case"tx":x=m.songmid||m.id,f={source:"tx",musicInfo:{id:x,name:m.name,singer:m.ar?m.ar.map(e=>e.name).join("/"):m.singer||"",source:"tx",interval:m.dt?c(m.dt):m.interval||"",meta:{songId:x,albumName:(null==(t=m.al)?void 0:t.name)||m.albumName||m.album||""}},quality:S};break;case"mg":x=m.songmid||m.songId||m.id;const e=m.copyrightId||m.id;f={source:"mg",songmid:x,id:e,musicInfo:{songmid:x,copyrightId:e,name:m.name,singer:m.ar?m.ar.map(e=>e.name).join("/"):m.singer||"",album:(null==(a=m.al)?void 0:a.name)||m.albumName||m.album||""},quality:S};break;case"kg":x=m.hash||m.id,f={source:"kg",musicInfo:{id:x,name:m.name,singer:m.ar?m.ar.map(e=>e.name).join("/"):m.singer||"",source:"kg",interval:m.dt?c(m.dt):m.interval||"",meta:{songId:x,albumName:(null==(n=m.al)?void 0:n.name)||m.albumName||m.album||"",hash:m.hash||m.id}},quality:S};break;case"kw":f={source:"kw",musicInfo:{id:m.id,name:m.name,singer:m.ar?m.ar.map(e=>e.name).join("/"):m.singer||"",source:"kw",interval:m.dt?c(m.dt):m.interval||"",meta:{songId:m.id,albumName:(null==(r=m.al)?void 0:r.name)||m.albumName||m.album||""}},quality:S};break;case"wy":f={source:"wy",musicInfo:{id:m.id,name:m.name,singer:m.ar?m.ar.map(e=>e.name).join("/"):m.singer||"",source:"wy",interval:m.dt?c(m.dt):m.interval||"",meta:{songId:m.id,albumName:(null==(i=m.al)?void 0:i.name)||m.albumName||m.album||""}},quality:S};break;default:f={source:h,musicInfo:{id:m.id,name:m.name,singer:m.ar?m.ar.map(e=>e.name).join("/"):m.singer||"",source:h,interval:m.dt?c(m.dt):m.interval||"",meta:{songId:m.id,albumName:(null==(s=m.al)?void 0:s.name)||m.albumName||m.album||""}},quality:S}}console.log("[refreshMusicUrl] 请求参数:",JSON.stringify(f));const L=await o.getMusicUrl(f);if(console.log("[refreshMusicUrl] 获取新URL成功:",L.url),await l.setCachedMusicUrl(m.id,S,L.url),d.retryNum++,d.isRefreshingUrl=!1,d.currentSong.id!==m.id)return void console.log("[refreshMusicUrl] 歌曲已更换，不更新播放");const M=L.url;if(d.audioContext){const e=(null==(u=m.al)?void 0:u.picUrl)||(null==(g=m.album)?void 0:g.picUrl)||m.img||"/static/images/default-cover.png";d.audioContext.title=m.name||"未知歌曲",d.audioContext.singer=this.formatArtists(m),d.audioContext.coverImgUrl=e,d.audioContext.epname=(null==(y=m.al)?void 0:y.name)||(null==(p=m.album)?void 0:p.name)||"未知专辑",d.audioContext.src=M,console.log("[refreshMusicUrl] 已更新背景音频src，等待自动播放")}console.log("[refreshMusicUrl] 刷新URL成功，当前重试次数:",d.retryNum),this.setStatusText("播放链接已刷新",2e3)}catch(S){console.error("[refreshMusicUrl] 刷新URL失败:",S),d.isRefreshingUrl=!1,d.retryNum<2?(console.log("[refreshMusicUrl] 准备再次尝试刷新URL"),setTimeout(()=>{this.refreshMusicUrl()},1e3)):e.index.showToast({title:"播放链接刷新失败",icon:"none"})}}else console.log("[refreshMusicUrl] 没有当前播放的歌曲")},async clearMusicUrlCache(o,l){try{const t=`${o}_${l}`;e.index.removeStorageSync(`music_url_${t}`),console.log("[clearMusicUrlCache] 已清除缓存:",t)}catch(t){console.error("[clearMusicUrlCache] 清除缓存失败:",t)}},startLoadTimeout(){d.loadTimeout&&clearTimeout(d.loadTimeout),d.loadTimeout=setTimeout(()=>{console.log("[startLoadTimeout] 加载超时，准备刷新URL"),this.setStatusText("播放加载超时，正在重试...",0),d.retryNum<2?this.refreshMusicUrl():(console.log("[startLoadTimeout] 重试次数用完，切到下一首"),this.handlePlayEndedDefault())},25e3),console.log("[startLoadTimeout] 已启动加载超时定时器（25秒）")},clearLoadTimeout(){d.loadTimeout&&(clearTimeout(d.loadTimeout),d.loadTimeout=null,console.log("[clearLoadTimeout] 已清除加载超时定时器"))},formatArtists(e){var o;return e?e.ar&&Array.isArray(e.ar)&&e.ar.length>0?e.ar.map(e=>e.name).join("/"):e.artists&&Array.isArray(e.artists)&&e.artists.length>0?e.artists.map(e=>e.name).join("/"):e.singer?e.singer:(null==(o=e.ar)?void 0:o.name)?e.ar.name:"未知歌手":"未知歌手"},setPlayMode(o){if([n.PLAY_MODE.listLoop,n.PLAY_MODE.random,n.PLAY_MODE.list,n.PLAY_MODE.singleLoop,n.PLAY_MODE.none].includes(o)){d.playMode=o,e.index.setStorageSync("playMode",o),console.log("[playerStore] 播放模式切换为:",o);const l={[n.PLAY_MODE.listLoop]:"列表循环",[n.PLAY_MODE.random]:"随机播放",[n.PLAY_MODE.list]:"顺序播放",[n.PLAY_MODE.singleLoop]:"单曲循环",[n.PLAY_MODE.none]:"播放已禁用"};this.setStatusText(l[o]||"已切换播放模式",2e3)}else console.warn("[playerStore] 无效的播放模式:",o)},seek(e){if(d.audioContext&&d.duration){const o=e/100*d.duration;d.audioContext.seek(o)}},toggleFullPlayer(){d.showFullPlayer=!d.showFullPlayer},playPlaylist(e){e&&0!==e.length&&(d.playlist=[...e],this.playSong(e[0]))},addToPlaylist(e){e&&0!==e.length&&(d.playlist=[...d.playlist,...e],d.currentSong||this.playSong(e[0]))},addToPlaylistAsNext(e){if(!e)return;const o=d.playlist.findIndex(e=>{var o;return e.id===(null==(o=d.currentSong)?void 0:o.id)}),l=[...d.playlist];-1!==o?l.splice(o+1,0,e):l.unshift(e),d.playlist=l},restoreState(){const o=e.index.getStorageSync("playMode");console.log("[playerStore] restoreState - 从本地存储读取的 playMode:",o,typeof o);const l=e.index.getStorageSync("playHistory"),t=e.index.getStorageSync("audioQuality"),a=e.index.getStorageSync("playerCacheSize"),r=e.index.getStorageSync("playerEnablePreload"),i={loop:n.PLAY_MODE.listLoop,sequence:n.PLAY_MODE.list,single:n.PLAY_MODE.singleLoop};o?(console.log("[playerStore] restoreState - playMode 存在，尝试恢复"),i[o]?(d.playMode=i[o],console.log("[playerStore] 恢复旧版播放模式:",o,"->",d.playMode)):Object.values(n.PLAY_MODE).includes(o)?(d.playMode=o,console.log("[playerStore] 恢复播放模式:",d.playMode)):(console.warn("[playerStore] 未知的播放模式:",o,"使用默认值"),d.playMode=n.PLAY_MODE.listLoop)):console.log("[playerStore] restoreState - playMode 为空，使用默认值:",n.PLAY_MODE.listLoop),l&&(d.playHistory=l),t&&(d.audioQuality=t),a&&(d.cacheSize=a),null!=r&&(d.enablePreload=r)},async preloadNextSong(){if(!d.enablePreload||d.isPreloading)return;const e=d.playlist.findIndex(e=>{var o;return e.id===(null==(o=d.currentSong)?void 0:o.id)});if(-1===e||e>=d.playlist.length-1)return;const t=d.playlist[e+1];if(!t||!t.id)return;const a={standard:"320k",high:"flac",lossless:"flac24bit",low:"128k"}[d.audioQuality]||"320k";if(await l.isMusicUrlCached(t.id,a))console.log("[preloadNextSong] 下一首已有缓存，跳过:",t.name);else{d.isPreloading=!0,console.log("[preloadNextSong] 开始预加载下一首:",t.name);try{await l.preloadNextMusic(t,o.getMusicUrl,a),console.log("[preloadNextSong] 预加载完成:",t.name)}catch(n){console.error("[preloadNextSong] 预加载失败:",n.message)}finally{d.isPreloading=!1}}},setCacheSize(o){"number"==typeof o&&o>0&&(d.cacheSize=o,e.index.setStorageSync("playerCacheSize",o),console.log("[playerStore] 缓存大小设置为:",o,"MB"))},setEnablePreload(o){d.enablePreload=!!o,e.index.setStorageSync("playerEnablePreload",d.enablePreload),console.log("[playerStore] 预加载设置为:",d.enablePreload)},async isSongCached(e,o){const t=o||{standard:"320k",high:"flac",lossless:"flac24bit",low:"128k"}[d.audioQuality]||"320k";return await l.isMusicUrlCached(e,t)},updateCurrentSong(e){e&&e.id?(console.log("[updateCurrentSong] 更新当前歌曲:",e.name,"ID:",e.id),d.currentSong={...d.currentSong,...e,currentTime:d.currentTime},d.lyric=e.lyric||"",d.tlyric=e.tlyric||"",d.rlyric=e.rlyric||"",d.lxlyric=e.lxlyric||"",console.log("[updateCurrentSong] 歌曲信息已更新")):console.error("[updateCurrentSong] 歌曲信息无效")}};exports.playerStore=y;
