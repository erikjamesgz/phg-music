"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/api/music.js"),l=require("../../utils/musicUrlCache.js"),t=require("../../utils/playInfoStorage.js"),n=require("../../utils/musicSwitchSourceStorage.js"),r=require("../../utils/musicParams.js"),i=require("./list.js"),a=require("./user.js"),s=require("./system.js"),c=require("../../utils/lyricCache.js"),u={[i.PLAY_MODE.listLoop]:"repeat",[i.PLAY_MODE.random]:"shuffle",[i.PLAY_MODE.list]:"arrow-right-arrow-left",[i.PLAY_MODE.singleLoop]:"rotate-right",[i.PLAY_MODE.none]:"ban"},g=e.reactive({currentSong:{id:0,name:"暂无播放歌曲",ar:[{name:"未知歌手"}],al:{picUrl:"/static/images/default-cover.png"},album:{picUrl:"/static/images/default-cover.png",name:"未知专辑"},img:"/static/images/default-cover.png",pic:"/static/images/default-cover.png",source:"",sourceId:""},originalSong:null,playlist:[],playHistory:[],playMode:i.PLAY_MODE.listLoop,playing:!1,currentTime:0,duration:0,audioContext:null,audioQuality:"standard",showMiniPlayer:!0,showFullPlayer:!1,isLoading:!1,error:null,lyric:"",tlyric:"",rlyric:"",lxlyric:"",onPlayEndedCallback:null,lastSaveTime:0,isPreloading:!1,cacheSize:512,enablePreload:!0,lastStatsTime:0,retryNum:0,playNextRetryCount:0,loadTimeout:null,quickCheckTimeout:null,isRefreshingUrl:!1,lastRefreshSongId:null,statusText:"",isUsingCachedUrl:!1,isGettingUrl:!1,pendingSong:null});function d(e){const o=(e=Math.floor(e))%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}const y={get state(){return e.readonly(g)},getState:()=>g,setState(e){Object.assign(g,e)},setStatusText(e,o=3e3){g.statusText=e,o>0&&setTimeout(()=>{g.statusText===e&&(g.statusText="")},o)},clearStatusText(){g.statusText=""},updatePendingSong(e){g.pendingSong=e,console.log("[playerStore] 更新待播放歌曲:",null==e?void 0:e.name)},setGettingUrl(e){g.isGettingUrl=e,console.log("[playerStore] 设置isGettingUrl:",e)},get progressPercent(){return g.duration?Math.floor(g.currentTime/g.duration*100):0},get formattedCurrentTime(){return d(g.currentTime)},get formattedDuration(){return d(g.duration)},get hasPrev(){return g.playlist.length>1},get hasNext(){return g.playlist.length>1},initAudioContext(){g.audioContext||(g.audioContext=e.index.getBackgroundAudioManager(),console.log("[initAudioContext] 使用 BackgroundAudioManager"))},setupAudioEventListeners(){const o=g.audioContext;o&&(o.onPlay(()=>{console.log("[BackgroundAudio] onPlay"),g.playing=!0,this.clearLoadTimeout(),this.clearQuickCheckTimeout(),this.clearStatusText(),g.playNextRetryCount=0,g.isUsingCachedUrl=!1}),o.onPause(()=>{console.log("[BackgroundAudio] onPause"),g.playing=!1}),o.onStop(()=>{console.log("[BackgroundAudio] onStop"),g.playing=!1,g.currentTime=0}),o.onEnded(()=>{console.log("[BackgroundAudio] onEnded"),console.log("[playerStore] this.handlePlayEnded 类型:",typeof this.handlePlayEnded),"function"==typeof this.handlePlayEnded?this.handlePlayEnded():console.error("[playerStore] handlePlayEnded 不是函数!")}),o.onTimeUpdate(()=>{var e;g.currentTime=o.currentTime,g.duration=o.duration;const l=Date.now();if(!g.lastSaveTime||l-g.lastSaveTime>5e3){g.lastSaveTime=l;let o=i.listStore.state.playInfo.playerListId||i.LIST_IDS.DEFAULT,n=i.listStore.state.playInfo.playIndex??0;o===i.LIST_IDS.TEMP&&(null==(e=i.listStore.state.tempList.meta)?void 0:e.id)&&(o=i.listStore.state.tempList.meta.id),t.savePlayInfo({time:Math.floor(g.currentTime),maxTime:Math.floor(g.duration),listId:o,index:n})}if(g.enablePreload&&g.duration>10){const e=g.duration-g.currentTime;e<10&&e>5&&!g.isPreloading&&this.preloadNextSong()}const n=Date.now();(!g.lastStatsTime||n-g.lastStatsTime>3e4)&&(g.lastStatsTime=n,a.userStore.increaseListenTime(.5))}),o.onPrev(()=>{console.log("[BackgroundAudio] onPrev"),this.playPrev()}),o.onNext(()=>{console.log("[BackgroundAudio] onNext"),this.playNext()}),o.onError(o=>{console.error("[BackgroundAudio] onError:",o),g.error=o.errMsg||"播放错误",g.isLoading=!1,g.playing=!1,this.setStatusText("播放出错，正在重试...",0),this.clearLoadTimeout(),console.log("[BackgroundAudio] onError - 错误码:",o.errCode),1!==o.errCode&&g.retryNum<2?(console.log("[BackgroundAudio] onError - 准备刷新URL"),this.refreshMusicUrl()):(e.index.showToast({title:"播放失败，正在切换下一首...",icon:"none"}),setTimeout(()=>{this.handlePlayEndedDefault()},1500))}))},setCurrentSong(e,o=!0){e&&(console.log("[setCurrentSong] 设置歌曲:",e.name,"ID:",e.id,"showLoading:",o),g.currentSong=e,g.isLoading=o,g.error=null,g.playing=!1)},async playSong(r){var s,c,u,d,y,S,p,h,m,f,L,x,M,k,I,U,T,C,P,v,w,b,E,A,D,_,N,R,O,Y;if(!r)return void console.error("[playSong] song is null or undefined");g.pendingSong&&g.pendingSong.id!==r.id&&(console.log("[playSong] 发现待播放歌曲，使用待播放歌曲:",g.pendingSong.name),r=g.pendingSong,g.pendingSong=null),console.log("[playSong] ========== 开始播放歌曲 =========="),console.log("[playSong] 歌曲ID:",r.id),console.log("[playSong] 歌曲名称:",r.name),g.originalSong&&g.originalSong.id===r.id||(g.originalSong={...r},console.log("[playSong] 保存原始歌曲信息:",r.name,"source:",r.source)),g.currentSong&&g.currentSong.id!==r.id&&e.index.$emit("songChanging"),this.initAudioContext(),console.log("[playSong] 检查是否同一首歌:"),console.log("[playSong] state.currentSong?.id:",null==(s=g.currentSong)?void 0:s.id),console.log("[playSong] song.id:",r.id),console.log("[playSong] song.url:",r.url?"有":"无");const Q=g.currentSong&&g.currentSong.id===r.id&&!r.url&&!r.playUrl;if(console.log("[playSong] isSameSong:",Q),Q){if(console.log("[playSong] 是同一首歌，检查是否需要继续播放"),g.playing)return void console.log("[playSong] 当前正在播放同一首歌，不做任何操作");if(g.audioContext&&g.audioContext.src)return console.log("[playSong] 当前暂停中，继续播放"),void g.audioContext.play()}if(g.audioContext&&(g.playing||g.audioContext.src)){console.log("[playSong] 停止当前播放的歌曲");try{g.audioContext.stop()}catch(q){console.log("[playSong] 停止当前播放的歌曲失败（可能已停止）:",q.message)}}g.currentSong=r,g.isLoading=!0,g.error=null,g.retryNum=0,g.lastRefreshSongId=r.id,g.isUsingCachedUrl=!1,this.clearLoadTimeout(),this.clearQuickCheckTimeout(),console.log("[playSong] state.currentSong.id:",null==(c=g.currentSong)?void 0:c.id),console.log("[playSong] state.currentSong.img:",null==(u=g.currentSong)?void 0:u.img),console.log("[playSong] state.currentSong.picUrl:",null==(d=g.currentSong)?void 0:d.picUrl),console.log("[playSong] state.currentSong.al?.picUrl:",null==(S=null==(y=g.currentSong)?void 0:y.al)?void 0:S.picUrl),g.lyric=r.lyric||"",g.tlyric=r.tlyric||"",g.rlyric=r.rlyric||"",g.lxlyric=r.lxlyric||"",console.log("[playSong] 保存歌词信息到state:",{lyricLength:null==(p=g.lyric)?void 0:p.length,tlyricLength:null==(h=g.tlyric)?void 0:h.length,rlyricLength:null==(m=g.rlyric)?void 0:m.length,lxlyricLength:null==(f=g.lxlyric)?void 0:f.length});try{let e=null;const s={standard:"320k",high:"flac",lossless:"flac24bit",low:"128k"}[g.audioQuality]||"320k",c=String(r.id).replace(/^(tx|wy|kg|kw|mg)_/,"")||r.id,u=n.getMusicSwitchSourceById(c);if(u&&u.newSource){console.log("[playSong] 发现保存的换源信息, 原source:",r.source,"换源后:",u.newSource),r.source=u.newSource,u.newSongId&&(r.id=u.newSongId),u.newSongName&&(r.name=u.newSongName),u.newSongSinger&&(r.singer=u.newSongSinger);const e={tx:"QQ音乐",wy:"网易云音乐",kg:"酷狗音乐",kw:"酷我音乐",mg:"咪咕音乐"}[u.newSource]||u.newSource;this.setStatusText(`已恢复换源: ${e}`,3e3)}if(e||!r.url&&!r.playUrl||(e=r.url||r.playUrl,console.log("[playSong] 使用歌曲自带的URL:",e),await l.setCachedMusicUrl(r.id,s,e,r.source),console.log("[playSong] 已将URL保存到缓存"),g.isUsingCachedUrl=!0),!e){const o=await l.getCachedMusicUrl(r.id,s,r.source);o&&(console.log("[playSong] 使用缓存的播放URL:",o),e=o,g.isUsingCachedUrl=!0)}if(e){console.log("[playSong] 最终使用播放URL:",e),this.setStatusText("尝试播放歌曲...",0);const o=e;let l=(null==(L=r.al)?void 0:L.picUrl)||(null==(x=r.album)?void 0:x.picUrl)||r.img||"";l&&(l=l.replace(/^http:/,"https:")),console.log("[playSong] 设置背景音频属性:",{title:r.name||"未知歌曲",singer:this.formatArtists(r),coverImgUrl:l,epname:(null==(M=r.al)?void 0:M.name)||(null==(k=r.album)?void 0:k.name)||"未知专辑",src:o}),g.audioContext.title=r.name||"未知歌曲",g.audioContext.singer=this.formatArtists(r),g.audioContext.coverImgUrl=l,g.audioContext.epname=(null==(I=r.al)?void 0:I.name)||(null==(U=r.album)?void 0:U.name)||"未知专辑",g.audioContext.src=o,this.startLoadTimeout(),g.isUsingCachedUrl&&this.startQuickCheckTimeout(),console.log("[playSong] 背景音频src已设置，开始播放"),g.currentSong={...g.currentSong,url:e,playUrl:e},console.log("[playSong] 已更新当前歌曲URL到state.currentSong（使用缓存URL）"),g.showMiniPlayer=!0,g.isLoading=!1,g.isGettingUrl=!1}else{console.log("[playSong] 歌曲没有已有URL，调用API获取"),console.log("[playSong] 用户选择的音质:",g.audioQuality),console.log("[playSong] 实际使用的音质:",s),this.setStatusText("正在获取播放链接...",0);const e=await o.getMusicUrl(r,s);if(console.log("[playSong] API获取成功"),console.log("[playSong] URL:",e.url),console.log("[playSong] 音质:",e.type),this.clearStatusText(),g.isGettingUrl=!1,e.fallback&&e.fallback.toggled){const o={tx:"QQ音乐",wy:"网易云音乐",kg:"酷狗音乐",kw:"酷我音乐",mg:"咪咕音乐"},l=o[e.fallback.originalSource]||e.fallback.originalSource,t=o[e.fallback.newSource]||e.fallback.newSource;this.setStatusText(`已从${l}换源到${t}`,3e3);const i={...r,source:e.fallback.newSource,_toggleMusicInfo:{originalSource:e.fallback.originalSource,newSource:e.fallback.newSource,matchedSong:e.fallback.matchedSong,toggleTime:Date.now()}};e.fallback.matchedSong&&(i.songmid=e.fallback.matchedSong.songmid||r.songmid,i.hash=e.fallback.matchedSong.hash||r.hash,i.copyrightId=e.fallback.matchedSong.copyrightId||r.copyrightId,i.id=e.fallback.matchedSong.id||r.id),g.currentSong=i,console.log("[playSong] 已更新歌曲换源信息");const a=String(r.id).replace(/^(tx|wy|kg|kw|mg)_/,"")||r.id,c={originalSource:e.fallback.originalSource,newSource:e.fallback.newSource,newSongId:(null==(T=e.fallback.matchedSong)?void 0:T.id)||r.id,newSongName:(null==(C=e.fallback.matchedSong)?void 0:C.name)||r.name,newSongSinger:(null==(P=e.fallback.matchedSong)?void 0:P.singer)||r.singer,quality:s};n.saveMusicSwitchSource(a,c),console.log("[playSong] 已保存换源信息到本地存储:",e.fallback.originalSource,"->",e.fallback.newSource)}const t=(null==(w=null==(v=e.fallback)?void 0:v.matchedSong)?void 0:w.id)||r.id,i=(null==(E=null==(b=e.fallback)?void 0:b.matchedSong)?void 0:E.source)||r.source;await l.setCachedMusicUrl(t,s,e.url,i),g.currentSong={...g.currentSong,url:e.url,playUrl:e.url},console.log("[playSong] 已更新当前歌曲URL到state.currentSong");const a=e.url;let c=(null==(A=r.al)?void 0:A.picUrl)||(null==(D=r.album)?void 0:D.picUrl)||r.img||"";c&&(c=c.replace(/^http:/,"https:")),console.log("[playSong] 设置背景音频属性:",{title:r.name||"未知歌曲",singer:this.formatArtists(r),coverImgUrl:c,epname:(null==(_=r.al)?void 0:_.name)||(null==(N=r.album)?void 0:N.name)||"未知专辑",src:a}),g.audioContext.title=r.name||"未知歌曲",g.audioContext.singer=this.formatArtists(r),g.audioContext.coverImgUrl=c,g.audioContext.epname=(null==(R=r.al)?void 0:R.name)||(null==(O=r.album)?void 0:O.name)||"未知专辑",g.audioContext.src=a,this.startLoadTimeout(),console.log("[playSong] 背景音频src已设置，开始播放")}this.addToHistory(r);const d=this.formatArtists(r);a.userStore.increaseListenCount(d),g.showMiniPlayer=!0,g.isLoading=!1;let y=i.listStore.state.playInfo.playerListId||i.LIST_IDS.DEFAULT,S=i.listStore.state.playInfo.playIndex??0;y===i.LIST_IDS.TEMP&&(null==(Y=i.listStore.state.tempList.meta)?void 0:Y.id)&&(y=i.listStore.state.tempList.meta.id),t.savePlayInfo({time:0,maxTime:0,listId:y,index:S}),this.loadLyricsForSong(r)}catch(j){console.error("[playSong] 播放歌曲失败:",j),console.error("[playSong] 错误信息:",j.message),g.isLoading=!1,g.error=j.message||"播放失败",g.isGettingUrl=!1,this.clearLoadTimeout(),this.clearQuickCheckTimeout(),console.log("[playSong] 播放失败，自动切换下一首"),this.handlePlayEnded()}},pause(){console.log("[pause] 暂停播放"),g.audioContext&&g.audioContext.pause(),g.playing=!1,g.isPlaying=!1},stop(){if(console.log("[stop] 停止播放"),g.audioContext)try{g.audioContext.stop()}catch(e){console.log("[stop] 停止失败:",e.message)}g.playing=!1,g.currentTime=0},resume(){console.log("[resume] 继续播放, 当前 playing 状态:",g.playing),g.audioContext&&!g.playing&&(g.audioContext.play(),g.playing=!0)},togglePlay(){g.playing?this.pause():this.resume()},togglePlayMode(){console.log("[playerStore] 切换播放模式");const e=(i.PLAY_MODE_LIST.indexOf(g.playMode)+1)%i.PLAY_MODE_LIST.length;return g.playMode=i.PLAY_MODE_LIST[e],console.log("[playerStore] 新播放模式:",g.playMode),g.playMode},getPlayModeIcon:()=>u[g.playMode]||u[i.PLAY_MODE.listLoop],playNext(){if(g.playlist.length<=1)return;let e=0;const o=g.playlist.findIndex(e=>e.id===g.currentSong.id);e=g.playMode===i.PLAY_MODE.random?Math.floor(Math.random()*g.playlist.length):(o+1)%g.playlist.length,this.playSong(g.playlist[e])},playPrev(){if(g.playlist.length<=1)return;let e=0;const o=g.playlist.findIndex(e=>e.id===g.currentSong.id);e=g.playMode===i.PLAY_MODE.random?Math.floor(Math.random()*g.playlist.length):(o-1+g.playlist.length)%g.playlist.length,this.playSong(g.playlist[e])},async handlePlayEnded(){var e,t,n;if(console.log("[playerStore] ========== 播放结束处理开始 =========="),console.log("[playerStore] 当前模式:",g.playMode),console.log("[playerStore] PLAY_MODE.singleLoop:",i.PLAY_MODE.singleLoop),console.log("[playerStore] 模式是否匹配 singleLoop:",g.playMode===i.PLAY_MODE.singleLoop),console.log("[playerStore] 当前歌曲:",null==(e=g.currentSong)?void 0:e.name,"ID:",null==(t=g.currentSong)?void 0:t.id),console.log("[playerStore] 是否有外部回调:",!!g.onPlayEndedCallback),g.onPlayEndedCallback)return console.log("[playerStore] 调用外部播放结束回调，传入模式:",g.playMode),void g.onPlayEndedCallback(g.playMode);if(g.playMode!==i.PLAY_MODE.none)try{if(console.log("[playerStore] 使用 listStore 处理下一首..."),console.log("[playerStore] LIST_IDS:",i.LIST_IDS),console.log("[playerStore] defaultList 长度:",i.listStore.state.defaultList.list.length),console.log("[playerStore] loveList 长度:",i.listStore.state.loveList.list.length),console.log("[playerStore] tempList 长度:",i.listStore.state.tempList.list.length),console.log("[playerStore] playInfo:",JSON.stringify(i.listStore.state.playInfo)),g.playMode===i.PLAY_MODE.singleLoop)return console.log("[playerStore] 单曲循环，重新播放当前歌曲"),void(g.audioContext&&(g.audioContext.seek(0),g.audioContext.play()));if(g.playMode===i.PLAY_MODE.list){console.log("[playerStore] 顺序播放模式，检查是否最后一首");const e=i.listStore.state.playInfo.playerListId;if(console.log("[playerStore] 当前列表ID:",e),!e)return void console.log("[playerStore] 没有当前列表ID，停止播放");const o=e===i.LIST_IDS.DEFAULT?i.listStore.state.defaultList.list:e===i.LIST_IDS.LOVE?i.listStore.state.loveList.list:i.listStore.state.tempList.list,l=i.listStore.state.playInfo.playerPlayIndex;if(console.log("[playerStore] 当前列表长度:",o.length,"当前索引:",l),l>=o.length-1)return console.log("[playerStore] 已是最后一首，停止播放"),g.playing=!1,g.isPlaying=!1,g.statusText="",this.clearLoadTimeout(),void this.clearQuickCheckTimeout()}const e=g.playMode===i.PLAY_MODE.random?"random":"listLoop";console.log("[playerStore] 切换模式:",e),console.log("[playerStore] 调用 listStore.getNextSong...");const t=i.listStore.getNextSong(e,!0);if(console.log("[playerStore] getNextSong 返回:",t?"有数据":"无数据"),t&&t.musicInfo){console.log("[playerStore] 自动播放下一首:",t.musicInfo.name,"ID:",t.musicInfo.id),console.log("[playerStore] 下一首列表ID:",t.listId,"是否临时:",t.isTempPlay);const e=s.systemStore.getState().audioQuality||"128k",a=await l.getCachedMusicUrl(t.musicInfo.id,e,t.musicInfo.source);let u=a,g=null;if(a){const e=t.musicInfo.source||"tx";g=await c.getCachedLyric(t.musicInfo.id,e)||{}}else{const i=t.musicInfo.source||"tx",a="tx"===i&&t.musicInfo.songmid?t.musicInfo.songmid:t.musicInfo.id;console.log("[playerStore] handlePlayEnded 构建请求参数:"),console.log("[playerStore] musicInfo.source:",t.musicInfo.source),console.log("[playerStore] musicInfo.id:",t.musicInfo.id),console.log("[playerStore] musicInfo.songmid:",t.musicInfo.songmid),console.log("[playerStore] 使用的 songId:",a);const s={source:i,musicInfo:{id:a,name:t.musicInfo.name,singer:t.musicInfo.singer||(t.musicInfo.ar?t.musicInfo.ar.map(e=>e.name).join("/"):""),source:i,interval:r.formatDuration(t.musicInfo.dt||t.musicInfo.duration||t.musicInfo.interval),meta:{songId:a,albumName:(null==(n=t.musicInfo.al)?void 0:n.name)||t.musicInfo.albumName||""}},quality:e};"kg"===i&&(s.musicInfo.meta.hash=t.musicInfo.hash||t.musicInfo.id),console.log("[playerStore] requestData:",JSON.stringify(s));const c=await o.getMusicUrl(s);u=c.url,await l.setCachedMusicUrl(t.musicInfo.id,e,u,t.musicInfo.source),g={lyric:c.lyric||"",tlyric:c.tlyric||"",rlyric:c.rlyric||"",lxlyric:c.lxlyric||""}}const d={...t.musicInfo,url:u,playUrl:u,quality:e,lyric:g.lyric||"",tlyric:g.tlyric||"",rlyric:g.rlyric||"",lxlyric:g.lxlyric||""};i.listStore.setPlayMusicInfo(t.listId,d,t.isTempPlay),i.listStore.addPlayedList({listId:t.listId,musicInfo:d,isTempPlay:t.isTempPlay}),this.playSong(d)}else console.log("[playerStore] 没有下一首歌曲可播放")}catch(a){console.error("[playerStore] 播放下一首失败:",a),this.handlePlayEndedWithRetry()}else console.log("[playerStore] 禁用模式，不自动播放下一首")},async handlePlayEndedWithRetry(){if(g.playNextRetryCount=(g.playNextRetryCount||0)+1,console.log("[playerStore] 播放下一首重试次数:",g.playNextRetryCount),g.playNextRetryCount>=5)return console.log("[playerStore] 重试次数已达上限，停止播放"),g.playNextRetryCount=0,void(g.playing=!1);if("singleLoop"===g.playMode)g.audioContext&&(g.audioContext.seek(0),g.audioContext.play());else await this.handlePlayEnded()},handlePlayEndedDefault(){switch(g.playMode){case"single":g.audioContext&&(g.audioContext.seek(0),g.audioContext.play());break;case"loop":default:this.playNext();break;case"random":this.playRandom()}},setOnPlayEndedCallback(e){g.onPlayEndedCallback=e},playRandom(){if(0===g.playlist.length)return;const e=Math.floor(Math.random()*g.playlist.length);this.playSong(g.playlist[e])},addToHistory(o){console.log("[playerStore] 添加到播放历史:",o.name);g.playHistory.some(e=>e.id===o.id)||(g.playHistory.unshift(o),g.playHistory.length>200&&g.playHistory.pop(),e.index.setStorageSync("playHistory",g.playHistory),console.log("[playerStore] 播放历史已更新，当前数量:",g.playHistory.length))},async refreshMusicUrl(){var t,a,s,c,u,d,S,p,h,m,f,L,x,M;let k=g.currentSong;if(k&&k.id)if(g.isRefreshingUrl)console.log("[refreshMusicUrl] 正在刷新URL，跳过");else{if(g.retryNum>=2){console.log("[refreshMusicUrl] 重试次数已达上限（2次），切换到下一首"),g.isRefreshingUrl=!1,g.retryNum=0;const e=i.listStore.getNextSong();return void(e&&e.musicInfo?(console.log("[refreshMusicUrl] 播放下一首:",e.musicInfo.name),y.playSong(e.musicInfo)):(console.log("[refreshMusicUrl] 没有下一首歌曲，停止播放"),y.pause()))}g.lastRefreshSongId!==k.id&&(console.log("[refreshMusicUrl] 歌曲已更换，重置重试次数"),g.retryNum=0,g.lastRefreshSongId=k.id),console.log("[refreshMusicUrl] 开始刷新URL，当前重试次数:",g.retryNum),g.isRefreshingUrl=!0,g.retryNum++;try{g.loadTimeout&&(clearTimeout(g.loadTimeout),g.loadTimeout=null);const e={standard:"320k",high:"flac",lossless:"flac24bit",low:"128k"}[g.audioQuality]||"320k";await this.clearMusicUrlCache(k.id,e,k.source),console.log("[refreshMusicUrl] 已清除URL缓存"),this.setStatusText("正在刷新播放链接...",0);let y=k;k._toggleMusicInfo&&k._toggleMusicInfo.newSource&&(console.log("[refreshMusicUrl] 使用换源后的歌曲信息:",{originalSource:k._toggleMusicInfo.originalSource,newSource:k._toggleMusicInfo.newSource}),y={...k,source:k._toggleMusicInfo.newSource,songmid:(null==(t=k._toggleMusicInfo.matchedSong)?void 0:t.songmid)||k.songmid,hash:(null==(a=k._toggleMusicInfo.matchedSong)?void 0:a.hash)||k.hash,copyrightId:(null==(s=k._toggleMusicInfo.matchedSong)?void 0:s.copyrightId)||k.copyrightId}),console.log("[refreshMusicUrl] 歌曲信息:",{id:y.id,songmid:y.songmid,hash:y.hash,copyrightId:y.copyrightId,source:y.source});const I=r.buildMusicRequestParams(y,e);if(!I)throw new Error("构建请求参数失败");console.log("[refreshMusicUrl] 请求参数:",JSON.stringify(I));const U=await o.getMusicUrl(I);if(console.log("[refreshMusicUrl] 获取新URL成功"),this.setStatusText("尝试播放歌曲...",0),U.fallback&&U.fallback.toggled){console.log("[refreshMusicUrl] 检测到换源:",{originalSource:U.fallback.originalSource,newSource:U.fallback.newSource});const e={...k,source:U.fallback.newSource,_toggleMusicInfo:{originalSource:U.fallback.originalSource,newSource:U.fallback.newSource,matchedSong:U.fallback.matchedSong,toggleTime:Date.now()}};U.fallback.matchedSong&&(e.songmid=U.fallback.matchedSong.songmid||k.songmid,e.hash=U.fallback.matchedSong.hash||k.hash,e.copyrightId=U.fallback.matchedSong.copyrightId||k.copyrightId,e.id=U.fallback.matchedSong.id||k.id),g.currentSong=e,console.log("[refreshMusicUrl] 已更新歌曲换源信息");const o=String(k.id).replace(/^(tx|wy|kg|kw|mg)_/,"")||k.id,l={originalSource:U.fallback.originalSource,newSource:U.fallback.newSource,newSongId:(null==(c=U.fallback.matchedSong)?void 0:c.id)||k.id,newSongName:(null==(u=U.fallback.matchedSong)?void 0:u.name)||k.name,newSongSinger:(null==(d=U.fallback.matchedSong)?void 0:d.singer)||k.singer,quality:g.audioQuality};n.saveMusicSwitchSource(o,l),console.log("[refreshMusicUrl] 已保存换源信息到本地存储:",U.fallback.originalSource,"->",U.fallback.newSource),k=e,i.listStore.updateSongInList(e)}const T=(null==(p=null==(S=U.fallback)?void 0:S.matchedSong)?void 0:p.id)||k.id,C=(null==(m=null==(h=U.fallback)?void 0:h.matchedSong)?void 0:m.source)||k.source,P=["128k","320k","flac"];for(const o of P)await l.setCachedMusicUrl(T,o,U.url,C);if(console.log("[refreshMusicUrl] 已更新所有音质缓存"),g.isRefreshingUrl=!1,g.currentSong.id!==k.id)return void console.log("[refreshMusicUrl] 歌曲已更换，不更新播放");const v=U.url;if(g.audioContext){const e=(null==(f=k.al)?void 0:f.picUrl)||(null==(L=k.album)?void 0:L.picUrl)||k.img||"/static/images/default-cover.png";g.audioContext.title=k.name||"未知歌曲",g.audioContext.singer=this.formatArtists(k),g.audioContext.coverImgUrl=e,g.audioContext.epname=(null==(x=k.al)?void 0:x.name)||(null==(M=k.album)?void 0:M.name)||"未知专辑",g.audioContext.src=v,console.log("[refreshMusicUrl] 已更新背景音频src，等待自动播放")}console.log("[refreshMusicUrl] 刷新URL成功，当前重试次数:",g.retryNum),this.setStatusText("播放链接已刷新",2e3)}catch(I){console.error("[refreshMusicUrl] 刷新URL失败:",I),g.isRefreshingUrl=!1,g.retryNum<2?(console.log("[refreshMusicUrl] 准备再次尝试刷新URL"),setTimeout(()=>{this.refreshMusicUrl()},1e3)):(console.log("[refreshMusicUrl] 重试次数用完，自动切换下一首"),e.index.showToast({title:"播放失败，切换下一首",icon:"none"}),this.handlePlayEndedWithRetry())}}else console.log("[refreshMusicUrl] 没有当前播放的歌曲")},async clearMusicUrlCache(o,l,t="kg"){try{const l=["128k","320k","flac"];for(const n of l){const l=`${o}_${n}_${t}`;e.index.removeStorageSync(`music_url_${l}`),console.log("[clearMusicUrlCache] 已清除缓存:",l)}}catch(n){console.error("[clearMusicUrlCache] 清除缓存失败:",n)}},startLoadTimeout(){g.loadTimeout&&clearTimeout(g.loadTimeout),g.loadTimeout=setTimeout(()=>{console.log("[startLoadTimeout] 加载超时，准备刷新URL"),this.setStatusText("播放加载超时，正在重试...",0),g.retryNum<2?this.refreshMusicUrl():(console.log("[startLoadTimeout] 重试次数用完，切到下一首"),this.handlePlayEndedWithRetry())},1e4),console.log("[startLoadTimeout] 已启动加载超时定时器（10秒）")},clearLoadTimeout(){g.loadTimeout&&(clearTimeout(g.loadTimeout),g.loadTimeout=null,console.log("[clearLoadTimeout] 已清除加载超时定时器"))},startQuickCheckTimeout(){g.quickCheckTimeout&&clearTimeout(g.quickCheckTimeout),g.quickCheckTimeout=setTimeout(()=>{!g.playing&&g.isUsingCachedUrl&&(console.log("[startQuickCheckTimeout] 缓存URL快速检测超时，链接可能过期"),this.setStatusText("正在检查链接...",0),g.isUsingCachedUrl=!1,g.retryNum<2&&(console.log("[startQuickCheckTimeout] 尝试刷新URL"),this.refreshMusicUrl()))},5e3),console.log("[startQuickCheckTimeout] 已启动快速检测超时定时器（5秒）")},clearQuickCheckTimeout(){g.quickCheckTimeout&&(clearTimeout(g.quickCheckTimeout),g.quickCheckTimeout=null,console.log("[clearQuickCheckTimeout] 已清除快速检测超时定时器"))},formatArtists(e){var o;return e?e.ar&&Array.isArray(e.ar)&&e.ar.length>0?e.ar.map(e=>e.name).join("/"):e.artists&&Array.isArray(e.artists)&&e.artists.length>0?e.artists.map(e=>e.name).join("/"):e.singer?e.singer:(null==(o=e.ar)?void 0:o.name)?e.ar.name:"未知歌手":"未知歌手"},setPlayMode(o){if([i.PLAY_MODE.listLoop,i.PLAY_MODE.random,i.PLAY_MODE.list,i.PLAY_MODE.singleLoop,i.PLAY_MODE.none].includes(o)){g.playMode=o,e.index.setStorageSync("playMode",o),console.log("[playerStore] 播放模式切换为:",o);const l={[i.PLAY_MODE.listLoop]:"列表循环",[i.PLAY_MODE.random]:"随机播放",[i.PLAY_MODE.list]:"顺序播放",[i.PLAY_MODE.singleLoop]:"单曲循环",[i.PLAY_MODE.none]:"播放已禁用"};this.setStatusText(l[o]||"已切换播放模式",2e3)}else console.warn("[playerStore] 无效的播放模式:",o)},seek(e){if(g.audioContext&&g.duration){const o=e/100*g.duration;g.audioContext.seek(o)}},toggleFullPlayer(){g.showFullPlayer=!g.showFullPlayer},playPlaylist(e){e&&0!==e.length&&(g.playlist=[...e],this.playSong(e[0]))},addToPlaylist(e){e&&0!==e.length&&(g.playlist=[...g.playlist,...e],g.currentSong||this.playSong(e[0]))},addToPlaylistAsNext(e){if(!e)return;const o=g.playlist.findIndex(e=>{var o;return e.id===(null==(o=g.currentSong)?void 0:o.id)}),l=[...g.playlist];-1!==o?l.splice(o+1,0,e):l.unshift(e),g.playlist=l},restoreState(){const o=e.index.getStorageSync("playMode");console.log("[playerStore] restoreState - 从本地存储读取的 playMode:",o,typeof o);const l=e.index.getStorageSync("playHistory"),t=e.index.getStorageSync("audioQuality"),n=e.index.getStorageSync("playerCacheSize"),r=e.index.getStorageSync("playerEnablePreload"),a={loop:i.PLAY_MODE.listLoop,sequence:i.PLAY_MODE.list,single:i.PLAY_MODE.singleLoop};o?(console.log("[playerStore] restoreState - playMode 存在，尝试恢复"),a[o]?(g.playMode=a[o],console.log("[playerStore] 恢复旧版播放模式:",o,"->",g.playMode)):Object.values(i.PLAY_MODE).includes(o)?(g.playMode=o,console.log("[playerStore] 恢复播放模式:",g.playMode)):(console.warn("[playerStore] 未知的播放模式:",o,"使用默认值"),g.playMode=i.PLAY_MODE.listLoop)):console.log("[playerStore] restoreState - playMode 为空，使用默认值:",i.PLAY_MODE.listLoop),l&&(g.playHistory=l),t&&(g.audioQuality=t),n&&(g.cacheSize=n),null!=r&&(g.enablePreload=r)},async preloadNextSong(){if(!g.enablePreload||g.isPreloading)return;const e=g.playlist.findIndex(e=>{var o;return e.id===(null==(o=g.currentSong)?void 0:o.id)});if(-1===e||e>=g.playlist.length-1)return;const t=g.playlist[e+1];if(!t||!t.id)return;const n={standard:"320k",high:"flac",lossless:"flac24bit",low:"128k"}[g.audioQuality]||"320k";if(await l.isMusicUrlCached(t.id,n))console.log("[preloadNextSong] 下一首已有缓存，跳过:",t.name);else{g.isPreloading=!0,console.log("[preloadNextSong] 开始预加载下一首:",t.name);try{await l.preloadNextMusic(t,o.getMusicUrl,n),console.log("[preloadNextSong] 预加载完成:",t.name)}catch(r){console.error("[preloadNextSong] 预加载失败:",r.message)}finally{g.isPreloading=!1}}},setCacheSize(o){"number"==typeof o&&o>0&&(g.cacheSize=o,e.index.setStorageSync("playerCacheSize",o),console.log("[playerStore] 缓存大小设置为:",o,"MB"))},setEnablePreload(o){g.enablePreload=!!o,e.index.setStorageSync("playerEnablePreload",g.enablePreload),console.log("[playerStore] 预加载设置为:",g.enablePreload)},async isSongCached(e,o){const t=o||{standard:"320k",high:"flac",lossless:"flac24bit",low:"128k"}[g.audioQuality]||"320k";return await l.isMusicUrlCached(e,t)},setUsingCachedUrl(e){g.isUsingCachedUrl=e,console.log("[playerStore] 设置使用缓存URL标记:",e)},updateCurrentSong(e){e&&e.id?(console.log("[updateCurrentSong] 更新当前歌曲:",e.name,"ID:",e.id),g.currentSong={...g.currentSong,...e,currentTime:g.currentTime},g.lyric=e.lyric||"",g.tlyric=e.tlyric||"",g.rlyric=e.rlyric||"",g.lxlyric=e.lxlyric||"",console.log("[updateCurrentSong] 歌曲信息已更新")):console.error("[updateCurrentSong] 歌曲信息无效")},setLyrics(e){var o,l,t,n;e?(console.log("[playerStore] 设置歌词:",{lyricLength:null==(o=e.lyric)?void 0:o.length,tlyricLength:null==(l=e.tlyric)?void 0:l.length,rlyricLength:null==(t=e.rlyric)?void 0:t.length,lxlyricLength:null==(n=e.lxlyric)?void 0:n.length}),g.lyric=e.lyric||"",g.tlyric=e.tlyric||"",g.rlyric=e.rlyric||"",g.lxlyric=e.lxlyric||"",console.log("[playerStore] 歌词设置完成")):console.log("[playerStore] 歌词信息为空，跳过设置")},async loadLyricsForSong(e){if(e&&e.id){console.log("[playerStore] 开始加载歌词:",{id:e.id,name:e.name,source:e.source});try{const l=[e.source,"tx"];let t=null;for(const n of l)try{if(console.log("[playerStore] 尝试获取歌词缓存，source:",n),t=await c.getCachedLyric(e.id,n),t){console.log("[playerStore] 从缓存获取到歌词，source:",n);break}}catch(o){console.error("[playerStore] 获取歌词缓存失败:",o)}t?(this.setLyrics({lyric:t.lyric||"",tlyric:t.tlyric||"",rlyric:t.rlyric||"",lxlyric:t.lxlyric||""}),console.log("[playerStore] 歌词加载完成并设置到 store")):(console.log("[playerStore] 未找到歌词缓存"),this.setLyrics({lyric:"",tlyric:"",rlyric:"",lxlyric:""}))}catch(l){console.error("[playerStore] 加载歌词失败:",l)}}else console.log("[playerStore] 歌曲信息无效，无法加载歌词")}};exports.playerStore=y;
