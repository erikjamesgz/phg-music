"use strict";const e=require("../../common/vendor.js");require("./list.js");const r={recommendPlaylists:[],userPlaylists:[],favoritePlaylists:[],currentPlaylist:null,loading:!1,error:null},t={getState:()=>r,setState(e){Object.assign(r,e)},safeParse(e,r=[]){if(!e)return r;if("string"==typeof e)try{return JSON.parse(e)||r}catch(t){return console.error("[playlistStore] JSON parse error:",t),r}return Array.isArray(e)||"object"==typeof e?e:r},getAllSongCount(){let r=0;try{const t=this.safeParse(e.index.getStorageSync("@user_lists"),[]),s=this.safeParse(e.index.getStorageSync("@list_love"),[]),i=this.safeParse(e.index.getStorageSync("imported_playlists"),[]);if(Array.isArray(s)&&(r+=s.length),Array.isArray(t))for(const e of t)e&&e.list&&Array.isArray(e.list)&&(r+=e.list.length);if(Array.isArray(i))for(const e of i)e&&e.songs&&Array.isArray(e.songs)&&(r+=e.songs.length);console.log("[playlistStore] getAllSongCount result:",{loveListCount:Array.isArray(s)?s.length:0,userListsCount:Array.isArray(t)?t.length:0,importedPlaylistsCount:Array.isArray(i)?i.length:0,totalCount:r})}catch(t){console.error("[playlistStore] getAllSongCount error:",t)}return r},get allPlaylists(){return[...r.userPlaylists,...r.favoritePlaylists]},get currentPlaylistSongCount(){return r.currentPlaylist?r.currentPlaylist.songs.length:0},async fetchRecommendPlaylists(){r.loading=!0,r.error=null;try{await new Promise(e=>setTimeout(e,1e3)),r.recommendPlaylists=[{id:"rec1",name:"流行热歌",coverUrl:"/static/images/playlist_cover1.png",description:"最热门的流行歌曲集合",creator:{id:"official",name:"拼好歌官方"},playCount:125e4,songCount:50,createTime:"2023-01-01"},{id:"rec2",name:"轻音乐放松",coverUrl:"/static/images/playlist_cover2.png",description:"舒缓的轻音乐，让你放松身心",creator:{id:"official",name:"拼好歌官方"},playCount:98e4,songCount:40,createTime:"2023-01-15"},{id:"rec3",name:"经典老歌",coverUrl:"/static/images/playlist_cover3.png",description:"永不过时的经典歌曲",creator:{id:"official",name:"拼好歌官方"},playCount:156e4,songCount:60,createTime:"2023-02-01"},{id:"rec4",name:"电音派对",coverUrl:"/static/images/playlist_cover4.png",description:"动感电音，点燃你的激情",creator:{id:"official",name:"拼好歌官方"},playCount:89e4,songCount:45,createTime:"2023-02-15"},{id:"rec5",name:"民谣精选",coverUrl:"/static/images/playlist_cover5.png",description:"治愈系民谣，温暖你的心灵",creator:{id:"official",name:"拼好歌官方"},playCount:76e4,songCount:35,createTime:"2023-03-01"},{id:"rec6",name:"摇滚经典",coverUrl:"/static/images/playlist_cover6.png",description:"经典摇滚，燃爆你的耳朵",creator:{id:"official",name:"拼好歌官方"},playCount:65e4,songCount:30,createTime:"2023-03-15"}]}catch(e){r.error=e.message||"获取推荐歌单失败",console.error("获取推荐歌单失败:",e)}finally{r.loading=!1}},async fetchUserPlaylists(){r.loading=!0,r.error=null;try{await new Promise(e=>setTimeout(e,800)),r.userPlaylists=[{id:"user1",name:"我喜欢的音乐",coverUrl:"/static/images/playlist_cover_like.png",description:"我收藏的所有喜欢的歌曲",creator:{id:"1",name:"青釉用户"},playCount:120,songCount:25,createTime:"2023-04-01",isDefault:!0},{id:"user2",name:"我的私人歌单",coverUrl:"/static/images/playlist_cover_private.png",description:"私人定制的歌曲集合",creator:{id:"1",name:"青釉用户"},playCount:85,songCount:18,createTime:"2023-04-15",isDefault:!1}]}catch(e){r.error=e.message||"获取用户歌单失败",console.error("获取用户歌单失败:",e)}finally{r.loading=!1}},async fetchFavoritePlaylists(){r.loading=!0,r.error=null;try{await new Promise(e=>setTimeout(e,800)),r.favoritePlaylists=[{id:"fav1",name:"热门华语",coverUrl:"/static/images/playlist_cover_chinese.png",description:"最热门的华语歌曲集合",creator:{id:"other1",name:"音乐达人"},playCount:45e4,songCount:42,createTime:"2023-03-10"},{id:"fav2",name:"欧美经典",coverUrl:"/static/images/playlist_cover_western.png",description:"经典欧美歌曲精选",creator:{id:"other2",name:"音乐收藏家"},playCount:38e4,songCount:38,createTime:"2023-03-20"}]}catch(e){r.error=e.message||"获取收藏歌单失败",console.error("获取收藏歌单失败:",e)}finally{r.loading=!1}},async fetchPlaylistDetail(e){r.loading=!0,r.error=null;try{await new Promise(e=>setTimeout(e,1200));let t=null;if(t=[...r.recommendPlaylists,...r.userPlaylists,...r.favoritePlaylists].find(r=>r.id===e),!t)throw new Error("歌单不存在");r.currentPlaylist={...t,songs:[{id:"s1",name:"青釉之梦",artist:"青釉乐队",album:"青釉",duration:240,coverUrl:"/static/images/song_cover1.png"},{id:"s2",name:"流动的旋律",artist:"陶音",album:"陶音集",duration:210,coverUrl:"/static/images/song_cover2.png"},{id:"s3",name:"釉色天空",artist:"青釉乐队",album:"青釉",duration:180,coverUrl:"/static/images/song_cover3.png"},{id:"s4",name:"陶艺人生",artist:"陶音",album:"陶音集",duration:195,coverUrl:"/static/images/song_cover4.png"},{id:"s5",name:"青色记忆",artist:"青釉乐队",album:"青釉",duration:225,coverUrl:"/static/images/song_cover5.png"}]}}catch(t){r.error=t.message||"获取歌单详情失败",console.error("获取歌单详情失败:",t)}finally{r.loading=!1}},async createPlaylist(e){r.loading=!0,r.error=null;try{await new Promise(e=>setTimeout(e,1e3));const t={id:"user"+Date.now(),name:e.name,coverUrl:e.coverUrl||"/static/images/playlist_cover_default.png",description:e.description||"",creator:{id:"1",name:"青釉用户"},playCount:0,songCount:0,createTime:(new Date).toISOString().split("T")[0],isDefault:!1,songs:[]};return r.userPlaylists.push(t),this.saveState(),t}catch(t){throw r.error=t.message||"创建歌单失败",console.error("创建歌单失败:",t),t}finally{r.loading=!1}},async updatePlaylist(e,t){r.loading=!0,r.error=null;try{await new Promise(e=>setTimeout(e,1e3));const s=r.userPlaylists.findIndex(r=>r.id===e);if(-1===s)throw new Error("歌单不存在或无权限修改");return r.userPlaylists[s]={...r.userPlaylists[s],name:t.name||r.userPlaylists[s].name,coverUrl:t.coverUrl||r.userPlaylists[s].coverUrl,description:void 0!==t.description?t.description:r.userPlaylists[s].description},r.currentPlaylist&&r.currentPlaylist.id===e&&(r.currentPlaylist={...r.currentPlaylist,name:t.name||r.currentPlaylist.name,coverUrl:t.coverUrl||r.currentPlaylist.coverUrl,description:void 0!==t.description?t.description:r.currentPlaylist.description}),this.saveState(),r.userPlaylists[s]}catch(s){throw r.error=s.message||"更新歌单失败",console.error("更新歌单失败:",s),s}finally{r.loading=!1}},async deletePlaylist(e){r.loading=!0,r.error=null;try{await new Promise(e=>setTimeout(e,1e3));const t=r.userPlaylists.findIndex(r=>r.id===e);if(-1===t)throw new Error("歌单不存在或无权限删除");if(r.userPlaylists[t].isDefault)throw new Error("默认歌单不能删除");return r.userPlaylists.splice(t,1),r.currentPlaylist&&r.currentPlaylist.id===e&&(r.currentPlaylist=null),this.saveState(),!0}catch(t){throw r.error=t.message||"删除歌单失败",console.error("删除歌单失败:",t),t}finally{r.loading=!1}},async toggleFavoritePlaylist(e){r.loading=!0,r.error=null;try{await new Promise(e=>setTimeout(e,800));const t=r.favoritePlaylists.findIndex(r=>r.id===e),s=r.recommendPlaylists.find(r=>r.id===e);if(!s)throw new Error("歌单不存在");return-1===t?(r.favoritePlaylists.push(s),this.saveState(),{isFavorite:!0}):(r.favoritePlaylists.splice(t,1),this.saveState(),{isFavorite:!1})}catch(t){throw r.error=t.message||"操作歌单收藏失败",console.error("操作歌单收藏失败:",t),t}finally{r.loading=!1}},async addSongToPlaylist(e,t){r.loading=!0,r.error=null;try{await new Promise(e=>setTimeout(e,800));const s=r.userPlaylists.find(r=>r.id===e);if(!s)throw new Error("歌单不存在或无权限修改");s.songs||(s.songs=[]);return s.songs.some(e=>e.id===t.id)?{message:"歌曲已存在于歌单中"}:(s.songs.push(t),s.songCount=s.songs.length,r.currentPlaylist&&r.currentPlaylist.id===e&&(r.currentPlaylist.songs||(r.currentPlaylist.songs=[]),r.currentPlaylist.songs.push(t),r.currentPlaylist.songCount=r.currentPlaylist.songs.length),this.saveState(),{message:"已添加到歌单"})}catch(s){throw r.error=s.message||"添加歌曲到歌单失败",console.error("添加歌曲到歌单失败:",s),s}finally{r.loading=!1}},async removeSongFromPlaylist(e,t){r.loading=!0,r.error=null;try{await new Promise(e=>setTimeout(e,800));const s=r.userPlaylists.find(r=>r.id===e);if(!s||!s.songs)throw new Error("歌单不存在或无权限修改");const i=s.songs.findIndex(e=>e.id===t);if(-1===i)return{message:"歌曲不在歌单中"};if(s.songs.splice(i,1),s.songCount=s.songs.length,r.currentPlaylist&&r.currentPlaylist.id===e){const e=r.currentPlaylist.songs.findIndex(e=>e.id===t);-1!==e&&(r.currentPlaylist.songs.splice(e,1),r.currentPlaylist.songCount=r.currentPlaylist.songs.length)}return this.saveState(),{message:"已从歌单中移除"}}catch(s){throw r.error=s.message||"从歌单中移除歌曲失败",console.error("从歌单中移除歌曲失败:",s),s}finally{r.loading=!1}},restoreState(){const t=e.index.getStorageSync("userPlaylists");t&&(r.userPlaylists=t);const s=e.index.getStorageSync("favoritePlaylists");s&&(r.favoritePlaylists=s)},saveState(){e.index.setStorageSync("userPlaylists",r.userPlaylists),e.index.setStorageSync("favoritePlaylists",r.favoritePlaylists)}};exports.playlistStore=t;
