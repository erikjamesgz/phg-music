"use strict";const t=require("../../common/vendor.js"),e={userInfo:null,isLoggedIn:!1,stats:{listenCount:0,favoriteCount:0,downloadCount:0,createPlaylistCount:0,listenTime:0,totalListenTime:0,favoriteSinger:"",singerPlayCount:{},todayListenCount:0,weeklyListenCount:0,consecutiveDays:0,lastListenDate:""},settings:{theme:"light",language:"zh-CN",cacheStrategy:"wifi",audioQuality:"standard",downloadQuality:"standard",autoPlay:!0,backgroundPlay:!0,showLyrics:!0,notification:!0}},s={getState:()=>e,setState(t){Object.assign(e,t)},get nickname(){return e.userInfo?e.userInfo.nickname:"未登录"},get avatar(){return e.userInfo?e.userInfo.avatar:"/static/images/default_avatar.png"},get isVip(){return!!e.userInfo&&e.userInfo.isVip},get vipExpireDate(){return e.userInfo?e.userInfo.vipExpireDate:null},setUserInfo(s){e.userInfo=s,e.isLoggedIn=!!s,s?t.index.setStorageSync("userInfo",s):t.index.removeStorageSync("userInfo")},login(t,e){return new Promise((s,n)=>{setTimeout(()=>{if("demo"===t&&"demo"===e){const t={id:"1",nickname:"青釉用户",avatar:"/static/images/default_avatar.png",isVip:!0,vipExpireDate:"2023-12-31"};this.setUserInfo(t),s(t)}else n(new Error("用户名或密码错误"))},1e3)})},logout(){this.setUserInfo(null),e.stats={listenCount:0,favoriteCount:0,downloadCount:0,createPlaylistCount:0,listenTime:0,totalListenTime:0,favoriteSinger:"",singerPlayCount:{},todayListenCount:0,weeklyListenCount:0,consecutiveDays:0,lastListenDate:""}},updateStats(s){e.stats={...e.stats,...s},t.index.setStorageSync("userStats",e.stats)},increaseListenCount(s=""){const n=(new Date).toISOString().split("T")[0];if(e.stats.listenCount++,e.stats.lastListenDate===n)e.stats.todayListenCount++;else{const t=new Date;t.setDate(t.getDate()-1);const s=t.toISOString().split("T")[0];e.stats.lastListenDate===s?e.stats.consecutiveDays++:e.stats.consecutiveDays=1,e.stats.todayListenCount=1}if(e.stats.lastListenDate=n,s&&"未知歌手"!==s){const t=s.trim();e.stats.singerPlayCount||(e.stats.singerPlayCount={}),e.stats.singerPlayCount[t]||(e.stats.singerPlayCount[t]=0),e.stats.singerPlayCount[t]++,this.updateFavoriteSinger()}t.index.setStorageSync("userStats",e.stats)},updateFavoriteSinger(){const t=e.stats.singerPlayCount;let s=0,n="";for(const[e,a]of Object.entries(t))"未知歌手"!==e&&e&&e.trim()&&a>s&&(s=a,n=e);e.stats.favoriteSinger=n,e.stats.favoriteSingerCount=s,console.log("[userStore] 更新最爱歌手:",n,"播放次数:",s)},increaseListenTime(s){e.stats.listenTime+=s,e.stats.totalListenTime+=s;const n=(new Date).toISOString().split("T")[0];(t.index.getStorageSync("listenTimeResetDate")||"")!==n&&(e.stats.listenTime=s,t.index.setStorageSync("listenTimeResetDate",n)),t.index.setStorageSync("userStats",e.stats)},resetTodayListenTime(){const s=(new Date).toISOString().split("T")[0];(t.index.getStorageSync("listenTimeResetDate")||"")!==s&&(e.stats.listenTime=0,t.index.setStorageSync("listenTimeResetDate",s),t.index.setStorageSync("userStats",e.stats))},increaseFavoriteCount(){e.stats.favoriteCount++,t.index.setStorageSync("userStats",e.stats)},getFavoriteSongCount:()=>e.stats.favoriteCount,increaseDownloadCount(){e.stats.downloadCount++,t.index.setStorageSync("userStats",e.stats)},increaseCreatePlaylistCount(){e.stats.createPlaylistCount++,t.index.setStorageSync("userStats",e.stats)},updateSettings(s){e.settings={...e.settings,...s},t.index.setStorageSync("userSettings",e.settings),s.theme&&this.applyTheme(s.theme)},applyTheme(e){t.index.setStorageSync("theme",e)},restoreState(){const s=t.index.getStorageSync("userInfo");s&&(e.userInfo=s,e.isLoggedIn=!0);const n=t.index.getStorageSync("userStats");if(n){if(n.singerPlayCount){delete n.singerPlayCount["未知歌手"],delete n.singerPlayCount[""];for(const t of Object.keys(n.singerPlayCount))t&&t.trim()||delete n.singerPlayCount[t]}e.stats=n}const a=t.index.getStorageSync("userSettings");a&&(e.settings=a)}};exports.userStore=s;
