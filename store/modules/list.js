"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/storage.js"),s={DEFAULT:"default",LOVE:"love",TEMP:"temp",DOWNLOAD:"download"},l={listLoop:"listLoop",random:"random",list:"list",singleLoop:"singleLoop",none:"none"},o=[l.listLoop,l.random,l.list,l.singleLoop,l.none],i=e.reactive({defaultList:{id:s.DEFAULT,name:"试听列表",list:[]},loveList:{id:s.LOVE,name:"我的收藏",list:[]},tempList:{id:s.TEMP,name:"",list:[],meta:{id:"",source:"",name:""}},userLists:[],playedList:[],tempPlayList:[],playInfo:{playIndex:-1,playerListId:null,playerPlayIndex:-1},playMusicInfo:{listId:null,musicInfo:null,isTempPlay:!1}}),n="@list_default",r="@list_love",a="@user_lists",d="@play_info";function c(e){if(e.id)return String(e.id);return`${e.name||""}_${e.singer||""}_${Date.now()}`}function u(e){var t,s,l,o;return e?{id:c(e),name:e.name||"未知歌曲",singer:e.singer||(null==(t=e.ar)?void 0:t.map(e=>e.name).join("/"))||"未知歌手",albumName:e.albumName||(null==(s=e.al)?void 0:s.name)||"",album:e.album||e.al||{picUrl:""},al:e.al||e.album||{picUrl:""},ar:e.ar||[{name:e.singer||"未知歌手"}],duration:e.duration||e.dt||0,dt:e.dt||e.duration||0,picUrl:e.picUrl||(null==(l=e.al)?void 0:l.picUrl)||(null==(o=e.album)?void 0:o.picUrl)||"",img:e.img||e.picUrl||"",source:e.source||e.sourceId||"",sourceId:e.sourceId||e.source||"",quality:e.quality||"",types:e.types||[],songmid:e.songmid||e.songMid||e.mid||"",hash:e.hash||"",lyric:e.lyric||"",tlyric:e.tlyric||"",rlyric:e.rlyric||"",lxlyric:e.lxlyric||""}:null}function g(e){return e?{id:e.id,name:e.name,singer:e.singer,albumName:e.albumName,al:e.al?{picUrl:e.al.picUrl}:{picUrl:""},ar:e.ar?e.ar.map(e=>({name:e.name})):[{name:e.singer||"未知歌手"}],dt:e.dt||e.duration||0,picUrl:e.picUrl,source:e.source,sourceId:e.sourceId,quality:e.quality}:null}function p(e){switch(e){case s.DEFAULT:return i.defaultList.list;case s.LOVE:return i.loveList.list;case s.TEMP:return i.tempList.list;default:const t=i.userLists.find(t=>t.id===e);return t?t.list:[]}}function y(e,t,s){console.log("[getPlayIndex] 开始 - listId:",e,"musicInfo:",null==t?void 0:t.name,"isTempPlay:",s),console.log("[getPlayIndex] 当前 playerListId:",i.playInfo.playerListId,"playerPlayIndex:",i.playInfo.playerPlayIndex);const l=p(i.playInfo.playerListId||e),o=p(e);console.log("[getPlayIndex] playerList长度:",l.length,"list长度:",o.length);let n=-1,r=-1;if(l.length&&(r=Math.min(i.playInfo.playerPlayIndex,l.length-1)),o.length&&t){const e=t.id;n=o.findIndex(t=>t.id===e),console.log("[getPlayIndex] 查找歌曲索引:",e,"结果:",n),s||(r=n<0?r<1?o.length-1:r-1:n)}return console.log("[getPlayIndex] 返回 - playIndex:",n,"playerPlayIndex:",r),{playIndex:n,playerPlayIndex:r}}const L={get state(){return e.readonly(i)},getState:()=>i,getList:e=>p(e),addToDefaultList(e,t="bottom"){const s=(Array.isArray(e)?e:[e]).map(u).filter(Boolean);s.forEach(e=>{const t=i.defaultList.list.findIndex(t=>t.id===e.id);t>-1&&i.defaultList.list.splice(t,1)}),"top"===t?i.defaultList.list.unshift(...s):i.defaultList.list.push(...s);i.defaultList.list.length>500&&(i.defaultList.list=i.defaultList.list.slice(-500)),this.saveDefaultList();const l=s[0];return i.defaultList.list.findIndex(e=>e.id===l.id)},removeFromDefaultList(e){const t=i.defaultList.list.findIndex(t=>t.id===e);t>-1&&(i.defaultList.list.splice(t,1),this.saveDefaultList())},clearDefaultList(){i.defaultList.list=[],this.saveDefaultList()},addToLoveList(e){const t=u(e);if(!t)return!1;return!(i.loveList.list.findIndex(e=>e.id===t.id)>-1)&&(i.loveList.list.push(t),this.saveLoveList(),!0)},removeFromLoveList(e){const t=i.loveList.list.findIndex(t=>t.id===e);t>-1&&(i.loveList.list.splice(t,1),this.saveLoveList())},isInLoveList:e=>i.loveList.list.some(t=>t.id===e),toggleLove(e){const t=u(e);return!!t&&(this.isInLoveList(t.id)?(this.removeFromLoveList(t.id),!1):(this.addToLoveList(t),!0))},setTempList(e,t,s={}){i.tempList.id=e;const l=new Map;i.tempList.list.forEach(e=>{e.id&&l.set(e.id,e)}),i.tempList.list=t.map(e=>{const t=u(e);if(!t)return null;const s=l.get(t.id);return s&&s._toggleMusicInfo?(console.log("[setTempList] 保留换源信息:",t.name,"source:",s.source),{...t,source:s.source,songmid:s.songmid,hash:s.hash,copyrightId:s.copyrightId,_toggleMusicInfo:s._toggleMusicInfo}):t}).filter(Boolean),i.tempList.meta={id:s.id||e,source:s.source||"",name:s.name||"临时列表"}},clearTempList(){i.tempList.list=[],i.tempList.meta={id:"",source:"",name:""}},addTempPlayList(e,t=s.DEFAULT,l=!1){const o=u(e);o&&i.tempPlayList.push({listId:t,musicInfo:o,isTempPlay:l})},addTempPlay(e){i.tempPlayList.push(e)},getNextTempPlay:()=>0===i.tempPlayList.length?null:i.tempPlayList.shift(),clearTempPlayList(){i.tempPlayList=[]},addPlayedList(e){i.playedList.push(e),i.playedList.length>1e3&&(i.playedList=i.playedList.slice(-500))},removePlayedList(e){e>=0&&e<i.playedList.length&&i.playedList.splice(e,1)},clearPlayedList(){i.playedList=[]},getPrevPlayed(){var e;if(i.playedList.length<2)return null;const t=null==(e=i.playMusicInfo.musicInfo)?void 0:e.id;if(!t)return null;const s=i.playedList.findIndex(e=>e.musicInfo.id===t);return s<=0?null:i.playedList[s-1]},setPlayMusicInfo(e,t,s=!1){console.log("[listStore] setPlayMusicInfo 开始:",e,null==t?void 0:t.name,"ID:",null==t?void 0:t.id),console.log("[listStore] musicInfo.ar:",null==t?void 0:t.ar),console.log("[listStore] musicInfo.singer:",null==t?void 0:t.singer),console.log("[listStore] musicInfo完整数据:",JSON.stringify(t));const l=t?u(t):null;if(i.playMusicInfo={listId:e,musicInfo:l,isTempPlay:s},console.log("[listStore] normalizeMusicInfo后:",JSON.stringify(i.playMusicInfo.musicInfo)),l){const{playIndex:t,playerPlayIndex:o}=y(e,l,s);console.log("[listStore] 计算播放索引 - playIndex:",t,"playerPlayIndex:",o),i.playInfo.playIndex=t,i.playInfo.playerPlayIndex=o,i.playInfo.playerListId=e}else i.playInfo.playIndex=-1,i.playInfo.playerPlayIndex=-1;console.log("[listStore] setPlayMusicInfo 完成 - playInfo:",JSON.stringify(i.playInfo))},updatePlayIndex(){const{playIndex:e,playerPlayIndex:t}=y(i.playMusicInfo.listId,i.playMusicInfo.musicInfo,i.playMusicInfo.isTempPlay);i.playInfo.playIndex=e,i.playInfo.playerPlayIndex=t},updatePlayIndexByListId(e,t){const s=p(e);if(!s||!s.length)return;const l=s.findIndex(e=>e.id===t);console.log("[listStore] updatePlayIndexByListId:",e,"songId:",t,"playIndex:",l),-1!==l&&(i.playInfo.playIndex=l,i.playInfo.playerPlayIndex=l,i.playInfo.playerListId=e)},setPlayerListId(e){console.log("[listStore] setPlayerListId:",e,"当前:",i.playInfo.playerListId),i.playInfo.playerListId=e,console.log("[listStore] setPlayerListId 完成:",i.playInfo.playerListId)},updateSongInList(e){var t;if(!e||!e.id)return null;console.log("[listStore] updateSongInList:",e.name,"ID:",e.id,"source:",e.source,"has _toggleMusicInfo:",!!e._toggleMusicInfo),console.log("[listStore] tempList.list 长度:",i.tempList.list.length);let s=null;const l=t=>{const l=t.findIndex(t=>t.id===e.id);-1!==l?(console.log("[listStore] 更新列表中的歌曲，索引:",l,"歌曲ID:",e.id),t[l]={...t[l],...e},s=t[l]):console.log("[listStore] 未找到歌曲，歌曲ID:",e.id,"列表长度:",t.length)};return l(i.defaultList.list),l(i.loveList.list),l(i.tempList.list),i.userLists.forEach(e=>{l(e.list)}),(null==(t=i.playMusicInfo.musicInfo)?void 0:t.id)===e.id&&(console.log("[listStore] 更新播放信息中的歌曲"),i.playMusicInfo.musicInfo={...i.playMusicInfo.musicInfo,...e}),console.log("[listStore] updateSongInList 完成，返回:",null==s?void 0:s.name,null==s?void 0:s.source),s},getNextSong(e="listLoop",t=!1){console.log("[listStore] ========== getNextSong 开始 =========="),console.log("[listStore] togglePlayMethod:",e,"isAutoToggle:",t),console.log("[listStore] playerListId:",i.playInfo.playerListId),console.log("[listStore] playerPlayIndex:",i.playInfo.playerPlayIndex);const s=this.getNextTempPlay();if(console.log("[listStore] 稍后播放列表检查:",s?"有歌曲":"无歌曲"),s)return s;const l=i.playInfo.playerListId;if(console.log("[listStore] 当前列表ID:",l),!l)return console.log("[listStore] 错误: 没有当前列表ID"),null;const o=p(l);if(console.log("[listStore] 当前列表长度:",null==o?void 0:o.length),!o||!o.length)return console.log("[listStore] 错误: 当前列表为空"),null;let n=i.playInfo.playerPlayIndex;console.log("[listStore] 当前播放索引:",n),(n<0||n>=o.length)&&(console.log("[listStore] 索引越界，重置为0"),n=0);let r=n;switch(e){case"random":r=Math.floor(Math.random()*o.length),console.log("[listStore] 随机模式，下一首索引:",r);break;case"list":if(n>=o.length-1)return console.log("[listStore] 顺序播放模式，已是最后一首，返回 null"),null;r=n+1,console.log("[listStore] 顺序播放模式，下一首索引:",r);break;case"singleLoop":r=n,console.log("[listStore] 单曲循环模式，重复当前歌曲");break;default:r=(n+1)%o.length,console.log("[listStore] 列表循环模式，当前索引:",n,"下一首索引:",r)}if(r<0||r>=o.length)return console.log("[listStore] 错误: 下一首索引越界:",r),null;const a=o[r];return console.log("[listStore] 下一首歌曲:",null==a?void 0:a.name,"ID:",null==a?void 0:a.id),console.log("[listStore] ========== getNextSong 结束 =========="),{listId:l,musicInfo:a,isTempPlay:!1}},getPrevSong(e="listLoop"){const t=this.getPrevPlayed();if(t)return t;const s=i.playInfo.playerListId;if(!s)return null;const l=p(s);if(!l.length)return null;let o=i.playInfo.playerPlayIndex;(o<0||o>=l.length)&&(o=0);let n=o;switch(e){case"random":n=Math.floor(Math.random()*l.length);break;case"singleLoop":n=o;break;default:n=o<=0?l.length-1:o-1}return n<0||n>=l.length?null:{listId:s,musicInfo:l[n],isTempPlay:!1}},saveDefaultList(){try{const e=i.defaultList.list.map(g);console.log("[listStore] 保存试听列表，数量:",e.length);const s=JSON.stringify(e),l=(s.length/1024).toFixed(2);console.log("[listStore] 试听列表数据大小:",l,"KB"),s.length>921600&&console.warn("[listStore] 试听列表数据过大，可能需要清理");t.setStorage(n,e)?console.log("[listStore] 试听列表保存成功"):console.error("[listStore] 保存试听列表失败")}catch(e){console.error("[listStore] 保存试听列表出错:",e)}},saveLoveList(){try{const e=i.loveList.list.map(g);console.log("[listStore] 保存收藏列表，数量:",e.length);const s=(JSON.stringify(e).length/1024).toFixed(2);console.log("[listStore] 收藏列表数据大小:",s,"KB");t.setStorage(r,e)?console.log("[listStore] 收藏列表保存成功"):console.error("[listStore] 保存收藏列表失败")}catch(e){console.error("[listStore] 保存收藏列表出错:",e)}},savePlayInfo(){const e={playIndex:i.playInfo.playIndex,playerListId:i.playInfo.playerListId,playerPlayIndex:i.playInfo.playerPlayIndex,playMusicInfo:i.playMusicInfo};t.setStorage(d,e)},restoreState(){console.log("[listStore] ========== 开始恢复状态 ==========");try{console.log("[listStore] 尝试恢复试听列表，键名:",n);const e=t.getStorage(n);console.log("[listStore] 从存储读取的试听列表:",e?`数组长度 ${e.length}`:"null"),e&&Array.isArray(e)?(i.defaultList.list=e,console.log("[listStore] 试听列表恢复完成，数量:",i.defaultList.list.length)):(console.log("[listStore] 试听列表为空或格式不正确，初始化为空数组"),i.defaultList.list=[]),console.log("[listStore] 尝试恢复收藏列表，键名:",r);const s=t.getStorage(r);console.log("[listStore] 从存储读取的收藏列表:",s?`数组长度 ${s.length}`:"null"),s&&Array.isArray(s)?(i.loveList.list=s,console.log("[listStore] 收藏列表恢复完成，数量:",i.loveList.list.length)):(console.log("[listStore] 收藏列表为空或格式不正确，初始化为空数组"),i.loveList.list=[]),console.log("[listStore] 尝试恢复播放信息，键名:",d);const l=t.getStorage(d);l?(console.log("[listStore] 播放信息恢复成功"),i.playInfo.playIndex=l.playIndex??-1,i.playInfo.playerListId=l.playerListId??null,i.playInfo.playerPlayIndex=l.playerPlayIndex??-1,l.playMusicInfo&&(i.playMusicInfo=l.playMusicInfo)):console.log("[listStore] 播放信息为空"),console.log("[listStore] 尝试恢复用户自定义列表，键名:",a);const o=t.getStorage(a);console.log("[listStore] 从存储读取的用户自定义列表:",o?`数组长度 ${o.length}`:"null"),o&&Array.isArray(o)?(i.userLists=o,console.log("[listStore] 用户自定义列表恢复完成，数量:",i.userLists.length),i.userLists.forEach((e,t)=>{var s;console.log(`[listStore] restoreState - [${t}] id="${e.id}" name="${e.name}" songs=${(null==(s=e.list)?void 0:s.length)||0}`)})):(console.log("[listStore] 用户自定义列表为空或格式不正确，初始化为空数组"),i.userLists=[])}catch(e){console.error("[listStore] 恢复状态出错:",e)}console.log("[listStore] ========== 状态恢复完成 ==========")},getAllListsInfo:()=>[{id:s.DEFAULT,name:i.defaultList.name,count:i.defaultList.list.length},{id:s.LOVE,name:i.loveList.name,count:i.loveList.list.length},...i.userLists.map(e=>({id:e.id,name:e.name,count:e.list.length}))],addListMusics(e,t,l="bottom"){const o=(Array.isArray(t)?t:[t]).map(u).filter(Boolean);if(0===o.length)return!1;let n,r;switch(e){case s.DEFAULT:n=i.defaultList.list,r=()=>this.saveDefaultList();break;case s.LOVE:n=i.loveList.list,r=()=>this.saveLoveList();break;case s.TEMP:n=i.tempList.list,r=null;break;default:const t=i.userLists.find(t=>t.id===e);if(!t)return!1;n=t.list,r=()=>this.saveUserLists()}return o.forEach(e=>{const t=n.findIndex(t=>t.id===e.id);t>-1&&n.splice(t,1)}),"top"===l?n.unshift(...o):n.push(...o),r&&r(),!0},removeListMusics(t,l){const o=Array.isArray(l)?l:[l];let n,r;switch(t){case s.DEFAULT:n=i.defaultList.list,r=()=>this.saveDefaultList();break;case s.LOVE:n=i.loveList.list,r=()=>this.saveLoveList();break;case s.TEMP:n=i.tempList.list,r=null;break;default:const l=i.userLists.find(e=>e.id===t);if(l){n=l.list,r=()=>this.saveUserLists();break}try{const s=e.index.getStorageSync("imported_playlists")||[],l=s.findIndex(e=>e.id===t);if(l>-1){n=s[l].songs||[],r=()=>{e.index.setStorageSync("imported_playlists",s),console.log("[ListStore] removeListMusics 已保存导入歌单:",t)};break}}catch(a){console.error("[ListStore] removeListMusics 读取导入歌单失败:",a)}return console.warn("[ListStore] removeListMusics 未找到列表:",t),!1}return o.forEach(e=>{const t=n.findIndex(t=>t.id===e);t>-1&&n.splice(t,1)}),r&&r(),!0},saveUserLists(){try{const e=i.userLists.map(e=>({id:e.id,name:e.name,coverImgUrl:e.coverImgUrl||"",list:e.list.map(g)}));console.log("[listStore] saveUserLists - 列表数量:",e.length),console.log("[listStore] saveUserLists - 存储键名:",a),e.forEach((e,t)=>{console.log(`[listStore] saveUserLists - [${t}] id="${e.id}" name="${e.name}" songs=${e.list.length}`)});const s=t.setStorage(a,e);console.log("[listStore] saveUserLists - 保存结果:",s);const l=t.getStorage(a);console.log("[listStore] saveUserLists - 验证读取:",l?`数量=${l.length}`:"null")}catch(e){console.error("[listStore] 保存用户列表出错:",e)}},createUserList(e){const t={id:`userlist_${Date.now()}`,name:e,coverImgUrl:"",list:[]};return i.userLists.push(t),this.saveUserLists(),t},updateUserList(e){console.log("[listStore] updateUserList - 开始更新，列表数量:",e.length);for(const t of e){const e=i.userLists.findIndex(e=>e.id===t.id);e>-1?(console.log(`[listStore] updateUserList - 找到列表 "${i.userLists[e].name}"，更新为 "${t.name}"`),i.userLists[e]={...i.userLists[e],name:t.name,coverImgUrl:t.coverImgUrl||i.userLists[e].coverImgUrl}):console.warn("[listStore] updateUserList - 未找到列表:",t.id)}this.saveUserLists(),console.log("[listStore] updateUserList - 更新完成")},removeUserList(e){console.log("[listStore] removeUserList - 开始移除，ID数量:",e.length);const t=[];for(const s of e){const e=i.userLists.findIndex(e=>e.id===s);if(e>-1){const l=i.userLists[e].name;i.userLists.splice(e,1),t.push(s),console.log(`[listStore] removeUserList - 已移除列表: "${l}" (${s})`)}else console.warn("[listStore] removeUserList - 未找到列表:",s)}return this.saveUserLists(),console.log("[listStore] removeUserList - 移除完成，共移除:",t.length),t},getAllAvailableLists(){let t=[];try{t=e.index.getStorageSync("imported_playlists")||[]}catch(l){console.error("[listStore] 获取歌单列表失败:",l)}return[{id:s.LOVE,name:i.loveList.name,type:"love"},...i.userLists.map(e=>({id:e.id,name:e.name,type:"user"})),...t.map(e=>({id:e.id,name:e.name,type:"imported"}))]},addMusicToAnyList(t,l,o="top"){if(t===s.DEFAULT||t===s.LOVE)return this.addListMusics(t,l,o);if(i.userLists.find(e=>e.id===t))return this.addListMusics(t,l,o);try{const s=e.index.getStorageSync("imported_playlists")||[],i=s.find(e=>e.id===t);if(i){const t=Array.isArray(l)?l:[l];return t.forEach(e=>{const t=i.songs.findIndex(t=>t.id===e.id);t>-1&&i.songs.splice(t,1)}),"top"===o?i.songs.unshift(...t):i.songs.push(...t),i.trackCount=i.songs.length,e.index.setStorageSync("imported_playlists",s),!0}}catch(n){console.error("[listStore] 添加到导入歌单失败:",n)}return!1},getListCount(t){var l;if(t===s.DEFAULT)return i.defaultList.list.length;if(t===s.LOVE)return i.loveList.list.length;if(t===s.TEMP)return i.tempList.list.length;const o=i.userLists.find(e=>e.id===t);if(o)return o.list.length;try{const s=(e.index.getStorageSync("imported_playlists")||[]).find(e=>e.id===t);return s&&(null==(l=s.songs)?void 0:l.length)||0}catch(n){return 0}},checkSongInList(t,l){var o;if(t===s.DEFAULT)return i.defaultList.list.some(e=>e.id===l);if(t===s.LOVE)return i.loveList.list.some(e=>e.id===l);if(t===s.TEMP)return i.tempList.list.some(e=>e.id===l);const n=i.userLists.find(e=>e.id===t);if(n)return n.list.some(e=>e.id===l);try{const s=(e.index.getStorageSync("imported_playlists")||[]).find(e=>e.id===t);return!!s&&(null==(o=s.songs)?void 0:o.some(e=>e.id===l))}catch(r){return!1}}};exports.LIST_IDS=s,exports.PLAY_MODE=l,exports.PLAY_MODE_LIST=o,exports.listStore=L;
