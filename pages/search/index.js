"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js");require("../../store/modules/list.js");const o=require("../../store/modules/player.js"),l=require("../../services/api.js"),s=require("../../utils/storage.js"),t=require("../../utils/system.js"),r=require("../../utils/imageProxy.js"),n=require("../../utils/playSong.js");Math||(i+u+c)();const c=()=>"../../components/player/MiniPlayer.js",i=()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js",u=()=>"../../components/common/CustomTabBar.js",v=Object.assign({components:{MiniPlayer:c,RocIconPlus:i}},{__name:"index",setup(c){const i=e.ref(t.getStatusBarHeight()),u=e.ref(!1);e.ref(!1);const v=e.ref(1),g=e.ref(""),h=e.ref(!1),d=e.ref(!1),f=e.ref(!1),m=e.ref(!0),p=e.ref("songs"),y=e.ref(""),S=e.ref([]),w=e.ref([]),x=e.ref([]),k=e.ref(!1),P=e.ref(0),$=e.ref(!1),b=e.ref(0),T=e.computed(()=>{const a=P.value,o=b.value;if($.value){const l=e.index.getSystemInfoSync().windowWidth/750*140;return{height:`${l-l/10+a+o}px`}}return{height:`${a+o}px`}}),I=e.reactive({songs:[],albums:[],artists:[],playlists:[]}),A=e.ref(null);e.onHide(()=>{h.value||g.value||(u.value=!1)}),e.onShow(()=>{console.log("[SearchPage] onShow"),k.value="true"===e.index.getStorageSync("darkMode"),console.log("[SearchPage] 暗黑模式:",k.value),setTimeout(()=>{try{e.wx$1.setNavigationBarColor({frontColor:k.value?"#ffffff":"#000000",backgroundColor:k.value?"#1f2937":"#ffffff",animation:{duration:300,timingFunc:"easeIn"},success:()=>{console.log("[SearchPage] 状态栏颜色设置成功")},fail:e=>{console.error("[SearchPage] 状态栏颜色设置失败:",e)}})}catch(a){console.error("[SearchPage] 设置状态栏颜色异常:",a)}},100);const a=e.index.getStorageSync("fromSearchBar");console.log("isFromSearchBar",a),a&&(u.value=!0,e.index.removeStorageSync("fromSearchBar"));const l=e.index.getStorageSync("searchKeywordFromIndex");l&&(console.log("[SearchPage] 从首页热门歌手跳转，搜索关键词:",l),e.index.removeStorageSync("searchKeywordFromIndex"),g.value=l,x.value=[],z()),(()=>{var a;try{const o=e.index.getSystemInfoSync(),l=o.windowWidth/750;P.value=110*l,b.value=(null==(a=o.safeAreaInsets)?void 0:a.bottom)||0,console.log("[Search] 底部高度初始化:",{tabBarHeight:P.value,safeAreaBottom:b.value})}catch(o){console.error("[Search] 获取底部高度失败:",o)}})(),(()=>{e.index.$on("miniPlayerHeightChange",e=>{$.value=e.isShowing,console.log("[Search] MiniPlayer 状态变化:",e.isShowing)});const a=o.playerStore.getState().currentSong;$.value=!(!a||!a.id)})()});const M=e.computed(()=>{const a=e.index.getMenuButtonBoundingClientRect();return{paddingTop:`${((null==a?void 0:a.top)||0)+((null==a?void 0:a.height)||32)}px`}});e.computed(()=>"ios"===e.index.getSystemInfoSync().platform),e.watch(p,e=>{g.value&&h.value&&C(g.value)});const W=e.computed(()=>"songs"===p.value?0===I.songs.length:"playlists"!==p.value||0===I.playlists.length),j=e.computed(()=>{var e;return null==(e=o.playerStore.state.currentSong)?void 0:e.id});e.watch(g,e=>{e&&""!==e.trim()||(x.value=[],h.value=!1)}),e.onMounted(()=>{H(),B();const e=getCurrentPages();if(e.length>1){const a=e[e.length-2];y.value=a.route}});const H=()=>{try{const e=s.getStorage("searchHistory")||[];e.length>0&&"string"==typeof e[0]?(S.value=e.map((e,a)=>({id:a+1,keyword:e,timestamp:Date.now()-6e4*a})),s.setStorage("searchHistory",S.value)):S.value=e}catch(e){console.error("加载搜索历史失败:",e),S.value=[]}},q=()=>{S.value=[],s.setStorage("searchHistory",[])},B=async()=>{var a,o,s,t,r,n,c,i,u,v,g,h;try{e.index.showLoading({title:"加载中..."});const d={wy:"网易云音乐",tx:"QQ音乐",kg:"酷狗音乐",kw:"酷我音乐",mg:"咪咕音乐",bd:"百度音乐"},f=await Promise.allSettled([l.searchApi.getWyHotSearch(),l.searchApi.getTxHotSearch(),l.searchApi.getKgHotSearch(),l.searchApi.getKwHotSearch(),l.searchApi.getMgHotSearch()]),m=[];let p=1;if("fulfilled"===f[0].status&&(null==(o=null==(a=f[0].value)?void 0:a.data)?void 0:o.itemList)){f[0].value.data.itemList.slice(0,10).forEach(e=>{m.push({id:p++,searchWord:e.searchWord,score:e.score?`${Math.floor(e.score/1e4)}万+`:"热门",content:e.content||"",source:d.wy})})}if("fulfilled"===f[1].status&&(null==(r=null==(t=null==(s=f[1].value)?void 0:s.hotkey)?void 0:t.data)?void 0:r.vec_hotkey)){f[1].value.hotkey.data.vec_hotkey.slice(0,10).forEach(e=>{m.push({id:p++,searchWord:e.query,score:e.score?`${Math.floor(e.score/1e4)}万+`:"热门",content:e.description||"",source:d.tx})})}if("fulfilled"===f[2].status&&(null==(c=null==(n=f[2].value)?void 0:n.data)?void 0:c.info)){f[2].value.data.info.slice(0,10).forEach(e=>{const a=e.filename.split(" - "),o=a[0]||"",l=a[1]||e.filename;let s="热门";e.filesize&&e.filesize>0?s=`${Math.floor(e.filesize/1e5)}万+`:e.rank_count&&e.rank_count>0?s=`${e.rank_count}万+`:e.sort&&(s=`Top ${e.sort}`),m.push({id:p++,searchWord:l,score:s,content:o||"",source:d.kg})})}if("fulfilled"===f[3].status&&(null==(i=f[3].value)?void 0:i.tagvalue)){f[3].value.tagvalue.slice(0,10).forEach((e,a)=>{const o=e.num?`${Math.floor(e.num/1e4)}万+`:`Top ${a+1}`;m.push({id:p++,searchWord:e.key,score:o,content:"",source:d.kw})})}if("fulfilled"===f[4].status&&(null==(h=null==(g=null==(v=null==(u=f[4].value)?void 0:u.data)?void 0:v.hotwords)?void 0:g[0])?void 0:h.hotwordList)){f[4].value.data.hotwords[0].hotwordList.filter(e=>"song"===e.resourceType).slice(0,10).forEach((e,a)=>{const o=e.searchCount?`${Math.floor(e.searchCount/1e4)}万+`:`Top ${a+1}`;m.push({id:p++,searchWord:e.word,score:o,content:"",source:d.mg})})}0===m.length&&m.push({id:1,searchWord:"周杰伦",score:"1200万+",content:"新歌《倒影》发布",source:"热搜榜"},{id:2,searchWord:"林俊杰",score:"980万+",content:"演唱会门票开售",source:"热搜榜"},{id:3,searchWord:"薛之谦",score:"870万+",content:"新专辑《渡》",source:"热搜榜"},{id:4,searchWord:"华晨宇",score:"750万+",content:"火星演唱会",source:"热搜榜"},{id:5,searchWord:"邓紫棋",score:"680万+",content:"新歌《超能力》",source:"热搜榜"},{id:6,searchWord:"五月天",score:"590万+",content:"好好好想见到你演唱会",source:"热搜榜"}),m.sort(()=>Math.random()-.5),w.value=m.slice(0,20),e.index.hideLoading()}catch(d){console.error("获取热搜榜失败:",d),e.index.hideLoading(),e.index.showToast({title:"获取热搜榜失败",icon:"none"})}},C=async e=>{if(console.log("[SearchPage] ========== search函数被调用 =========="),console.log("[SearchPage] 搜索关键词:",e),console.log("[SearchPage] 当前搜索类型:",p.value),e){h.value=!0,d.value=!0,v.value=1,m.value=!0,A.value=null,I.songs=[],I.playlists=[],(e=>{if(!e)return;const a=S.value.findIndex(a=>a.keyword===e);-1!==a&&S.value.splice(a,1),S.value.unshift({id:Date.now(),keyword:e,timestamp:Date.now()}),S.value.length>10&&(S.value=S.value.slice(0,10)),s.setStorage("searchHistory",S.value)})(e);try{switch(console.log("[SearchPage] 开始搜索，关键词:",e,"搜索类型:",p.value),p.value){case"songs":const a={kw:"酷我",kg:"酷狗",tx:"QQ",wy:"网易",mg:"咪咕"},o=["kw","kg","tx","wy","mg"].map(o=>l.searchApi.searchSongs(e,o,v.value,20).catch(e=>(console.error(`${a[o]}搜索失败:`,e),{source:o,list:[]}))),s=await Promise.all(o);let t=[];for(const e of s)if(e&&e.list&&e.list.length>0){const o=e.list.map(o=>{let l={...o};return"kg"===e.source&&(l.name&&(l.name=l.name.replace(/<[^>]*>?/gm,"")),l.artists&&Array.isArray(l.artists)?l.artists=l.artists.map(e=>({...e,name:e.name?e.name.replace(/<[^>]*>?/gm,""):""})):l.singer&&(l.singer=l.singer.replace(/<[^>]*>?/gm,""))),{...l,sourceId:e.source,source:a[e.source]||e.source}});t=[...t,...o]}const r={};for(const e of t){const a=e.source;r[a]||(r[a]=[]),r[a].push(e)}const n=[];let c=!0;for(;c;){c=!1;for(const e in r)r[e].length>0&&(n.push(r[e].shift()),r[e].length>0&&n.push(r[e].shift()),c=c||r[e].length>0)}I.songs=n,0===I.songs.length?m.value=!1:m.value=I.songs.length>=20;break;case"playlists":console.log("[SearchPage] 进入歌单搜索分支");const i=await l.searchApi.searchPlaylists(e,"all",v.value,20).catch(e=>(console.error("歌单搜索失败:",e),{list:[]}));I.playlists=i.list||[],console.log("[SearchPage] 歌单搜索结果列表:",I.playlists),console.log("[SearchPage] 歌单数量:",I.playlists.length),m.value=I.playlists.length>=20}}catch(a){console.error("搜索失败:",a),A.value="搜索失败，请稍后重试"}finally{d.value=!1}}},U=e=>{g.value=e,x.value=[],z()},z=()=>{console.log("[SearchPage] ========== onSearch函数被调用 =========="),console.log("[SearchPage] 搜索关键词:",g.value),console.log("[SearchPage] 当前搜索类型:",p.value),e.index.showToast({title:"onSearch被调用",icon:"none",duration:1500}),g.value&&(x.value=[],C(g.value))},L=async()=>{if(m.value&&!d.value&&g.value){d.value=!0,v.value+=1;try{switch(p.value){case"songs":const e={kw:"酷我",kg:"酷狗",tx:"QQ",wy:"网易",mg:"咪咕"},a=["kw","kg","tx","wy","mg"].map(a=>l.searchApi.searchSongs(g.value,a,v.value,20).catch(o=>(console.error(`${e[a]}搜索失败:`,o),{source:a,list:[]}))),o=await Promise.all(a);let s=[];for(const l of o)if(l&&l.list&&l.list.length>0){const a=l.list.map(a=>({...a,sourceId:l.source,source:e[l.source]||l.source}));s=[...s,...a]}const t={};for(const l of s){const e=l.source;t[e]||(t[e]=[]),t[e].push(l)}const r=[];let n=!0;for(;n;){n=!1;for(const e in t)t[e].length>0&&(r.push(t[e].shift()),t[e].length>0&&r.push(t[e].shift()),n=n||t[e].length>0)}const c=new Map;for(const l of r){const e=`${l.name}-${l.artists?l.artists.map(e=>e.name).join("/"):l.singer}`;(!c.has(e)||l.quality&&l.quality.includes("HQ"))&&c.set(e,l)}const i=Array.from(c.values());I.songs=[...I.songs,...i],console.log("[SearchPage] 加载更多单曲结果列表:",I.songs),console.log("[SearchPage] 新增单曲数量:",i.length),console.log("[SearchPage] 总单曲数量:",I.songs.length),m.value=i.length>0;break;case"playlists":console.log("[SearchPage] 加载更多：进入歌单搜索分支");const u=(await l.searchApi.searchPlaylists(g.value,"all",v.value,20).catch(e=>(console.error("歌单搜索失败:",e),{list:[]}))).list||[];I.playlists=[...I.playlists,...u],console.log("[SearchPage] 加载更多歌单结果列表:",I.playlists),console.log("[SearchPage] 新增歌单数量:",u.length),console.log("[SearchPage] 总歌单数量:",I.playlists.length),m.value=u.length>=20}}catch(a){console.error("加载更多失败:",a),e.index.showToast({title:"加载更多失败",icon:"none"})}finally{d.value=!1}}},Q=async()=>{f.value=!0,A.value=null;try{g.value&&(v.value=1,await C(g.value))}catch(e){console.error("刷新失败:",e),A.value="刷新失败，请稍后重试"}finally{setTimeout(()=>{f.value=!1},500)}},_=()=>{console.log("clearSearch"),g.value&&(g.value="",h.value=!1)},E=()=>{h.value&&(h.value=!1),g.value&&g.value.trim().length>0?(clearTimeout(window.suggestTimer),window.suggestTimer=setTimeout(()=>{(async e=>{if(e)try{const a=await l.searchApi.getSuggestions(e);a&&Array.isArray(a)&&a.length>0?x.value=a:x.value=[`${e}的歌`,`${e}的专辑`,`${e}的MV`,`关于${e}的歌单`]}catch(a){console.error("获取搜索建议失败:",a),x.value=[`${e}的歌`,`${e}的专辑`,`${e}的MV`,`关于${e}的歌单`]}})(g.value)},300)):x.value=[]},F=()=>{console.log("搜索框获取焦点"),u.value=!0},N=()=>{console.log("搜索框失去焦点"),g.value||(u.value=!1)},D=async a=>{if(console.log("[Search] 播放歌曲:",a.name),!a||!a.id)return console.error("[Search] 歌曲对象无效:",a),void e.index.showToast({title:"歌曲信息无效",icon:"none"});const o=a.sourceId||a.source||"tx",l={"酷我":"kw","酷狗":"kg","网易云":"wy",QQ:"tx","咪咕":"mg"}[o]||o;await n.playSongCommon(a,{addToDefaultList:!0,source:l})},K=e=>e&&e.length?"string"==typeof e?e:Array.isArray(e)?e.map(e=>"string"==typeof e?e:e.name||"").filter(Boolean).join(" / "):"未知歌手":"未知歌手",O=e=>{if(!e&&0!==e)return"00:00";let a=Math.floor(e/1e3);isNaN(a)&&(a=0);const o=a%60;return`${Math.floor(a/60).toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},J=e=>{if(0===e)return"#ff4d4f";if(1===e)return"#ff7a45";if(2===e)return"#ffa940";const a=["#52c41a","#1677ff","#722ed1","#eb2f96","#faad14","#13c2c2"];return a[e%a.length]},R=a=>{e.index.navigateTo({url:a})},V=a=>{e.index.showToast({title:"专辑详情功能暂未开放",icon:"none"})},X=a=>{e.index.showToast({title:"歌手详情功能暂未开放",icon:"none"})};return(l,t)=>e.e({a:i.value+"px",b:k.value?"#1f2937":"#ffffff",c:e.p({type:"fas",name:"search",size:"16",color:"#9ca3af"}),d:e.o(z),e:e.o([e=>g.value=e.detail.value,E]),f:u.value,g:e.o(F),h:e.o(N),i:g.value,j:g.value},g.value?{k:e.o(_),l:e.p({type:"fas",name:"times-circle",size:"16",color:"#9ca3af"})}:{},{m:g.value?1:"",n:g.value},g.value?{o:e.o(z)}:{},{p:e.s(M.value)},{},{r:g.value&&!h.value&&x.value.length>0},g.value&&!h.value&&x.value.length>0?{s:e.f(x.value,(a,o,l)=>({a:"1e4f5a8e-2-"+l,b:e.t(a),c:o,d:e.o(e=>U(a),o)})),t:e.p({type:"fas",name:"search",size:"16",color:"#9ca3af"})}:{},{v:!h.value&&!g.value&&S.value.length>0},!h.value&&!g.value&&S.value.length>0?{w:e.p({type:"fas",name:"trash",size:"14",color:"#999999"}),x:e.o(q),y:e.f(S.value,(a,o,l)=>({a:e.t(a.keyword),b:e.o(e=>(e=>{const a=S.value.findIndex(a=>a.id===e);-1!==a&&(S.value.splice(a,1),s.setStorage("searchHistory",S.value))})(a.id),a.id),c:a.id,d:e.o(e=>U(a.keyword),a.id)}))}:{},{z:!h.value&&!g.value},h.value||g.value?{}:{A:e.o(B),B:e.f(w.value,(a,o,l)=>e.e({a:e.t(o+1),b:J(o),c:e.t(a.searchWord),d:e.t(a.content),e:e.t(a.score),f:a.source},a.source?{g:e.t(a.source)}:{},{h:a.id,i:e.o(e=>U(a.searchWord),a.id)}))},{C:h.value},h.value?e.e({D:d.value&&1===v.value&&!f.value},(d.value&&1===v.value&&f.value,{}),{E:A.value},A.value?{F:a._imports_0,G:e.t(A.value),H:e.o(z)}:{},{I:h.value&&!d.value&&W.value},h.value&&!d.value&&W.value?{J:e.p({type:"fas",name:"frown",size:"80",color:"#9ca3af"}),K:e.t(g.value)}:"songs"===p.value?{M:e.f(I.songs,(a,l,s)=>e.e({a:e.t(a.name),b:e.t(K(a.artists)),c:e.t(a.album.name),d:a.quality},a.quality?{e:e.t(a.quality)}:{},{f:a.source},a.source?{g:e.t(a.source)}:{},{h:e.t(O(a.duration)),i:e.o(l=>(a=>{e.index.showActionSheet({itemList:["播放","添加到播放列表","下一首播放","收藏到歌单","下载","分享","歌手："+K(a.artists),"专辑："+a.album.name],success:l=>{switch(l.tapIndex){case 0:D(a);break;case 1:o.playerStore.addToPlaylist(a),e.index.showToast({title:"已添加到播放列表",icon:"none"});break;case 2:o.playerStore.addToPlaylistAsNext(a),e.index.showToast({title:"已添加到下一首播放",icon:"none"});break;case 3:R(`/pages/select-playlist/index?songId=${a.id}`);break;case 4:e.index.showToast({title:"开始下载",icon:"success"});break;case 5:e.index.share({provider:"weixin",scene:"WXSceneSession",type:0,title:a.name,summary:K(a.artists),imageUrl:a.album.picUrl,success:function(e){console.log("分享成功："+JSON.stringify(e))},fail:function(e){console.log("分享失败："+JSON.stringify(e))}});break;case 6:a.artists&&a.artists.length>0&&X(a.artists[0]);break;case 7:a.album&&V(a.album)}}})})(a),a.id),j:"1e4f5a8e-5-"+s,k:a.id,l:e.o(e=>D(a),a.id)})),N:e.p({type:"fas",name:"ellipsis-v",size:"18",color:"#999999"})}:"playlists"===p.value?{P:e.f(I.playlists,(a,o,l)=>{return e.e({a:e.unref(r.proxyImageUrl)(a.coverImgUrl),b:e.o(e=>((e,a)=>{if(!a||!a.coverImgUrl)return;let o=0;a.coverImgUrl.includes("wsrv.nl")?o=1:a.coverImgUrl.includes("weserv.nl")?o=2:a.coverImgUrl.includes("jina.ai")&&(o=3);const l=r.handleImageError(e,a.coverImgUrl,o);l&&(a.coverImgUrl=l)})(e,a),a.id),c:e.t(a.name),d:e.t((s=a.playCount,s||0===s?s<1e4?s.toString():s<1e8?(s/1e4).toFixed(1).replace(/\.0$/,"")+"万":(s/1e8).toFixed(1).replace(/\.0$/,"")+"亿":"0")),e:a.source},a.source?{f:e.t(a.source)}:{},{g:a.id,h:e.o(a=>{e.index.showToast({title:"歌单详情功能暂未开放",icon:"none"})},a.id)});var s})}:{},{L:"songs"===p.value,O:"playlists"===p.value,Q:m.value&&!d.value&&!W.value},!m.value||d.value||W.value?(d.value&&v.value>1||m.value||W.value,{}):{R:e.o(L)},{S:d.value&&v.value>1,T:!m.value&&!W.value}):{},{U:e.s(T.value),V:e.o(L),W:e.o(Q),X:h.value,Y:f.value,Z:e.p({"current-index":1}),aa:j.value},(j.value,{}),{ab:k.value?1:""})}});wx.createPage(v);
