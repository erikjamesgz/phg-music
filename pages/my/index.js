"use strict";const e=require("../../common/vendor.js"),o=require("../../store/modules/user.js"),t=require("../../store/modules/playlist.js"),n=require("../../store/modules/player.js"),r=require("../../store/modules/list.js"),l=require("../../utils/system.js"),a=require("../../utils/imageProxy.js"),s=require("../../utils/playSong.js");Math||(u+i+c)();const i=()=>"../../components/player/MiniPlayer.js",c=()=>"../../components/common/CustomTabBar.js",u=()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js",g={__name:"index",setup(i){const c=e.ref(l.getStatusBarHeight()),u=e.ref("true"===e.index.getStorageSync("darkMode")),g=e.ref(!1),d=e.ref(0),p=e.ref(0),m=e.computed(()=>{const o=d.value,t=p.value+o;if(g.value){return{height:`${t+126*(e.index.getSystemInfoSync().windowWidth/750)}px`}}return{height:`${t}px`}}),v=e.computed(()=>({height:`${c.value}px`,width:"100%",backgroundColor:u.value?"#1f2937":"#f9fafb"})),y=e.computed(()=>{const o=e.index.getSystemInfoSync().windowWidth/750,t=88*o,n=200*o;return{height:`calc(100vh - ${c.value+t+n}px)`}});e.computed(()=>o.userStore.getState().userInfo||{nickname:"未登录",avatar:"/static/images/default_avatar.png",isVip:!1});const f=e.ref(o.userStore.getState().stats||{listenCount:0,listenTime:0,favoriteSinger:""}),S=e.ref([]),h=(e,o=[])=>{if(!e)return o;const t=typeof e;if("string"===t)try{const t=JSON.parse(e);return t&&"object"==typeof t&&Array.isArray(t.data)?t.data:Array.isArray(t)?t:o}catch(n){return o}return Array.isArray(e)?e:"object"===t&&Array.isArray(e.data)?e.data:"object"===t?e:o},x=()=>{var o;const t=[];try{const n=e.index.getStorageSync("@list_love");console.log("[My] 收藏列表原始数据:",n);const r=h(n,[]);console.log("[My] 收藏列表解析后:",r.length),Array.isArray(r)&&r.length>0&&t.push({id:"love",name:"我喜欢的音乐",coverUrl:"/static/logo.png",songCount:r.length,isDefault:!0,source:"love"});const l=e.index.getStorageSync("imported_playlists");console.log("[My] 导入歌单原始数据:",l);const a=h(l,[]);if(console.log("[My] 导入歌单解析后:",a.length),Array.isArray(a))for(const e of a)t.push({id:e.id,name:e.name,coverUrl:e.coverImgUrl||"/static/logo.png",songCount:e.trackCount||(null==(o=e.songs)?void 0:o.length)||0,isDefault:!1,source:"imported",platform:e.platform});const s=e.index.getStorageSync("@user_lists");console.log("[My] 用户列表原始数据:",s);const i=h(s,[]);if(console.log("[My] 用户列表解析后:",i.length),Array.isArray(i))for(const e of i)t.push({id:e.id,name:e.name,coverUrl:e.coverImgUrl||"/static/logo.png",songCount:e.list?e.list.length:0,isDefault:!1,source:"user"})}catch(n){console.error("[My] 获取歌单列表失败:",n)}console.log("[My] 最终歌单列表:",t.length),S.value=t},U=e.computed(()=>S.value.find(e=>e.isDefault)||null),M=e.computed(()=>S.value.filter(e=>!e.isDefault)),b=e.computed(()=>(n.playerStore.getState().playHistory||[]).length),w=e.computed(()=>{var e,o;const t=n.playerStore.getState().playHistory||[];return t.length>0&&(console.log("[recentSongs] 第一首歌数据:",JSON.stringify(t[0]).substring(0,300)),console.log("[recentSongs] 图片字段 - al.picUrl:",null==(e=t[0].al)?void 0:e.picUrl),console.log("[recentSongs] 图片字段 - album.picUrl:",null==(o=t[0].album)?void 0:o.picUrl),console.log("[recentSongs] 图片字段 - picUrl:",t[0].picUrl),console.log("[recentSongs] 图片字段 - img:",t[0].img)),t.slice(0,5)}),C=e.computed(()=>h(e.index.getStorageSync("deleted_songs"),[]).length),A=e.computed(()=>{var o,t;const n=h(e.index.getStorageSync("deleted_songs"),[]);return n.length>0&&(console.log("[deletedSongs] 第一首歌数据:",JSON.stringify(n[0]).substring(0,300)),console.log("[deletedSongs] 图片字段 - al.picUrl:",null==(o=n[0].al)?void 0:o.picUrl),console.log("[deletedSongs] 图片字段 - album.picUrl:",null==(t=n[0].album)?void 0:t.picUrl),console.log("[deletedSongs] 图片字段 - picUrl:",n[0].picUrl),console.log("[deletedSongs] 图片字段 - img:",n[0].img)),n.slice(0,5)}),I=e.computed(()=>n.playerStore.getState().showMiniPlayer),T=e.ref(0),$=()=>{try{if(t.playlistStore&&"function"==typeof t.playlistStore.getAllSongCount){const e=t.playlistStore.getAllSongCount.call(t.playlistStore);T.value="number"==typeof e?e:0,console.log("[My] 刷新歌曲总数:",T.value)}else console.warn("[My] playlistStore.getAllSongCount 不可用"),T.value=0}catch(e){console.error("[My] 刷新歌曲总数失败:",e),T.value=0}},_=e.computed(()=>(T.value||0).toString()),j=e.computed(()=>{const e=f.value.listenTime||0;if(e>=60){const o=Math.floor(e/60),t=Math.round(e%60);return t>0?`${o}h ${t}m`:`${o}h`}return`${Math.round(e)}m`}),k=e.computed(()=>{const e=f.value.favoriteSinger;return e&&e.trim()?e.length>4?e.substring(0,4)+"...":e:"暂无"}),z=e=>{const o=Number(e)||0;return o>=1e4?(o/1e4).toFixed(1)+"万":o.toString()},R=e=>e?e.ar&&Array.isArray(e.ar)?e.ar.map(e=>e.name).join("、"):e.artists&&Array.isArray(e.artists)?e.artists.map(e=>e.name).join("、"):e.singer&&"string"==typeof e.singer?e.singer:e.ar&&"string"==typeof e.ar?e.ar:e.artists&&"string"==typeof e.artists?e.artists:"未知歌手":"未知歌手",q=e=>{var o,t;if(!e)return"/static/logo.png";const n=(null==(o=e.al)?void 0:o.picUrl)||(null==(t=e.album)?void 0:t.picUrl)||e.picUrl||e.img||e.pic||e.cover||e.coverUrl;return n||console.log("[getSongCover] 未找到图片字段，歌曲数据:",JSON.stringify(e).substring(0,200)),n?a.proxyImageUrl(n):"/static/logo.png"},N=()=>{e.index.navigateTo({url:"/pages/settings/index"})},H=(e,o,t)=>{if(!o||!o[t])return;const n=o[t];let r=0;n.includes("wsrv.nl")?r=1:n.includes("weserv.nl")?r=2:n.includes("jina.ai")&&(r=3);const l=a.handleImageError(e,n,r);l&&(o[t]=l)},D=()=>{e.index.navigateTo({url:"/pages/playlist/list"})},P=()=>{const o=n.playerStore.getState().playHistory||[];0!==o.length?(e.index.setStorageSync("recent_play_list",o),e.index.navigateTo({url:"/pages/sharelist/index?mode=recent&fromMyMusic=true"})):e.index.showToast({title:"暂无播放记录",icon:"none"})},B=()=>{const o=h(e.index.getStorageSync("deleted_songs"),[]);0!==o.length?(e.index.setStorageSync("deleted_play_list",o),e.index.navigateTo({url:"/pages/sharelist/index?mode=deleted&fromMyMusic=true"})):e.index.showToast({title:"暂无删除记录",icon:"none"})},J=o=>{if(o)if("love"!==o.source)if("user"!==o.source){if("imported"===o.source){const t=o.id.split("__"),n=t[0]||"tx",r=t[1]||o.id,l={wy:"网易云音乐",tx:"QQ音乐",kg:"酷狗音乐",kw:"酷我音乐",mg:"咪咕音乐"};e.index.navigateTo({url:`/pages/sharelist/index?source=${n}&link=${encodeURIComponent(r)}&platform=${encodeURIComponent(l[n]||n)}&preview=true&fromMyMusic=true&playlistId=${encodeURIComponent(o.id)}&coverUrl=${encodeURIComponent(o.coverUrl)}&playlistName=${encodeURIComponent(o.name)}`})}}else e.index.navigateTo({url:`/pages/sharelist/index?mode=user&fromMyMusic=true&playlistId=${encodeURIComponent(o.id)}&playlistName=${encodeURIComponent(o.name)}`});else e.index.navigateTo({url:"/pages/sharelist/index?mode=love&fromMyMusic=true"})},O=async e=>{e&&await s.playSongCommon(e,{addToDefaultList:!0,source:e.source||"tx"})},Q=()=>{e.index.showModal({title:"新建歌单",editable:!0,placeholderText:"你想起啥名...",success:o=>{if(o.confirm&&o.content){const t=o.content.trim();if(!t)return void e.index.showToast({title:"歌单名称不能为空",icon:"none"});r.listStore.createUserList(t)?(x(),e.index.showToast({title:"创建成功",icon:"success"})):e.index.showToast({title:"创建失败",icon:"none"})}}})},L=[{name:"网易云音乐",source:"wy"},{name:"QQ音乐",source:"tx"},{name:"酷狗音乐",source:"kg"},{name:"酷我音乐",source:"kw"},{name:"咪咕音乐",source:"mg"}],W=e.ref(!1),E=e.ref(""),F=e.ref(""),G=e.ref(""),K=e.ref(""),V=()=>{e.index.showActionSheet({itemList:L.map(e=>e.name),success:e=>{const o=L[e.tapIndex];G.value=o.source,K.value=o.name,E.value=`从${o.name}导入`,F.value="",W.value=!0}})},X=()=>{W.value=!1,F.value=""},Y=()=>{const o=F.value.trim();o?(W.value=!1,e.index.navigateTo({url:`/pages/sharelist/index?source=${G.value}&link=${encodeURIComponent(o)}&platform=${encodeURIComponent(K.value)}&preview=true&from=import`})):e.index.showToast({title:"请输入歌单链接",icon:"none"})};return e.onMounted(()=>{const o=e.index.getStorageSync("userStats")||{};f.value=o,x(),$()}),e.onShow(()=>{console.log("[My] onShow 触发，重新加载数据");const o=e.index.getStorageSync("userStats")||{};f.value=o,console.log("[My] 从Storage读取今日时长:",f.value.listenTime),console.log("[My] 从Storage读取最爱歌手:",f.value.favoriteSinger),u.value="true"===e.index.getStorageSync("darkMode"),l.setStatusBarTextColor(u.value?"light":"dark"),x(),$();const t=n.playerStore.getState().playHistory||[];console.log("[My] 最近播放数据数量:",t.length);const r=h(e.index.getStorageSync("deleted_songs"),[]);console.log("[My] 最近删除数据数量:",r.length),(()=>{var o;try{const t=e.index.getSystemInfoSync();d.value=(null==(o=t.safeAreaInsets)?void 0:o.bottom)||0;const n=t.windowWidth/750;p.value=110*n,console.log("[My] 底部高度初始化:",{safeAreaBottom:d.value,tabBarHeight:p.value})}catch(t){console.error("[My] 获取底部高度失败:",t)}})(),(()=>{e.index.$on("miniPlayerHeightChange",e=>{g.value=e.isShowing,console.log("[My] MiniPlayer 状态变化:",e.isShowing)});const o=n.playerStore.getState().currentSong;g.value=!(!o||!o.id)})(),setTimeout(()=>{S.value=[...S.value]},100)}),(o,t)=>{var n,r,l;return e.e({a:e.s(v.value),b:e.p({name:"gear",size:"20",color:"#6b7280"}),c:e.o(N),d:e.t(_.value),e:e.o(D),f:e.t(z(f.value.listenCount)),g:e.t(j.value),h:e.t(k.value),i:e.t(S.value.length||0),j:e.p({name:"plus",size:"16",color:"#6b7280"}),k:e.o(Q),l:e.p({name:"link",size:"16",color:"#6b7280"}),m:e.o(V),n:(null==(n=U.value)?void 0:n.coverUrl)?e.unref(a.proxyImageUrl)(U.value.coverUrl):"/static/logo.png",o:e.o(e=>H(e,U.value,"coverUrl")),p:e.t((null==(r=U.value)?void 0:r.name)||"我喜欢的音乐"),q:e.t((null==(l=U.value)?void 0:l.songCount)||0),r:e.p({name:"heart",size:"12",color:"#ff6687"}),s:e.o(e=>J(U.value)),t:e.f(M.value,(o,t,n)=>({a:e.unref(a.proxyImageUrl)(o.coverUrl),b:e.o(e=>H(e,o,"coverUrl"),o.id),c:e.t(o.name),d:e.t(o.songCount),e:o.id,f:e.o(e=>J(o),o.id)})),v:e.t(b.value),w:e.f(w.value,(o,t,n)=>{var r;return{a:q(o),b:e.o(e=>H(e,o,"picUrl"),o.id),c:"84cab870-4-"+n,d:e.t(o.name),e:e.t(R(o)),f:e.t((null==(r=o.al)?void 0:r.name)||o.album||o.albumName||"未知专辑"),g:o.id,h:e.o(e=>O(o),o.id)}}),x:e.p({name:"play",size:"16",color:"#ffffff"}),y:e.p({name:"chevron-right",size:"12",color:"#8a8a8a"}),z:e.o(P),A:e.t(C.value),B:e.f(A.value,(o,t,n)=>({a:q(o),b:"84cab870-6-"+n,c:e.t(o.name),d:e.t(o.type||"歌曲"),e:e.t(R(o)),f:o.id,g:e.o(e=>O(o),o.id)})),C:e.p({name:"play",size:"16",color:"#ffffff"}),D:e.p({name:"chevron-right",size:"12",color:"#8a8a8a"}),E:e.o(B),F:e.s(m.value),G:e.s(y.value),H:W.value},W.value?{I:e.t(E.value),J:e.p({name:"xmark",size:"20",color:"#999"}),K:e.o(X),L:F.value,M:e.o(e=>F.value=e.detail.value),N:e.o(X),O:e.o(Y),P:e.o(()=>{}),Q:e.o(X)}:{},{R:I.value},(I.value,{}),{S:e.p({"current-index":3}),T:u.value?1:""})}}},d=e._export_sfc(g,[["__scopeId","data-v-84cab870"]]);wx.createPage(d);
