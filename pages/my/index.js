"use strict";const e=require("../../common/vendor.js"),o=require("../../store/modules/user.js"),t=require("../../store/modules/playlist.js"),n=require("../../store/modules/player.js");require("../../store/modules/list.js");const l=require("../../utils/system.js"),r=require("../../utils/imageProxy.js"),a=require("../../utils/playSong.js");Math||(c+s+i)();const s=()=>"../../components/player/MiniPlayer.js",i=()=>"../../components/common/CustomTabBar.js",c=()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js",u={__name:"index",setup(s){const i=e.ref(l.getStatusBarHeight()),c=e.ref("true"===e.index.getStorageSync("darkMode")),u=e.ref(!1),g=e.ref(0),d=e.ref(0),m=e.computed(()=>{const o=g.value,t=d.value+o;if(u.value){return{height:`${t+126*(e.index.getSystemInfoSync().windowWidth/750)}px`}}return{height:`${t}px`}}),p=e.computed(()=>({height:`${i.value}px`,width:"100%",backgroundColor:c.value?"#1f2937":"#f9fafb"})),v=e.computed(()=>{const o=e.index.getSystemInfoSync().windowWidth/750,t=88*o,n=200*o;return{height:`calc(100vh - ${i.value+t+n}px)`}});e.computed(()=>o.userStore.getState().userInfo||{nickname:"未登录",avatar:"/static/images/default_avatar.png",isVip:!1});const y=e.ref(o.userStore.getState().stats||{listenCount:0,listenTime:0,favoriteSinger:""}),f=e.ref([]),S=(e,o=[])=>{if(!e)return o;const t=typeof e;if("string"===t)try{const t=JSON.parse(e);return t&&"object"==typeof t&&Array.isArray(t.data)?t.data:Array.isArray(t)?t:o}catch(n){return o}return Array.isArray(e)?e:"object"===t&&Array.isArray(e.data)?e.data:"object"===t?e:o},h=()=>{var o;const t=[];try{const n=e.index.getStorageSync("@list_love");console.log("[My] 收藏列表原始数据:",n);const l=S(n,[]);console.log("[My] 收藏列表解析后:",l.length),Array.isArray(l)&&l.length>0&&t.push({id:"love",name:"我喜欢的音乐",coverUrl:"/static/logo.png",songCount:l.length,isDefault:!0,source:"love"});const r=e.index.getStorageSync("imported_playlists");console.log("[My] 导入歌单原始数据:",r);const a=S(r,[]);if(console.log("[My] 导入歌单解析后:",a.length),Array.isArray(a))for(const e of a)t.push({id:e.id,name:e.name,coverUrl:e.coverImgUrl||"/static/logo.png",songCount:e.trackCount||(null==(o=e.songs)?void 0:o.length)||0,isDefault:!1,source:"imported",platform:e.platform});const s=e.index.getStorageSync("@user_lists");console.log("[My] 用户列表原始数据:",s);const i=S(s,[]);if(console.log("[My] 用户列表解析后:",i.length),Array.isArray(i))for(const e of i)t.push({id:e.id,name:e.name,coverUrl:e.coverImgUrl||"/static/logo.png",songCount:e.list?e.list.length:0,isDefault:!1,source:"user"})}catch(n){console.error("[My] 获取歌单列表失败:",n)}console.log("[My] 最终歌单列表:",t.length),f.value=t},x=e.computed(()=>f.value.find(e=>e.isDefault)||null),U=e.computed(()=>f.value.filter(e=>!e.isDefault)),M=e.computed(()=>(n.playerStore.getState().playHistory||[]).length),w=e.computed(()=>{var e,o;const t=n.playerStore.getState().playHistory||[];return t.length>0&&(console.log("[recentSongs] 第一首歌数据:",JSON.stringify(t[0]).substring(0,300)),console.log("[recentSongs] 图片字段 - al.picUrl:",null==(e=t[0].al)?void 0:e.picUrl),console.log("[recentSongs] 图片字段 - album.picUrl:",null==(o=t[0].album)?void 0:o.picUrl),console.log("[recentSongs] 图片字段 - picUrl:",t[0].picUrl),console.log("[recentSongs] 图片字段 - img:",t[0].img)),t.slice(0,5)}),b=e.computed(()=>S(e.index.getStorageSync("deleted_songs"),[]).length),C=e.computed(()=>{var o,t;const n=S(e.index.getStorageSync("deleted_songs"),[]);return n.length>0&&(console.log("[deletedSongs] 第一首歌数据:",JSON.stringify(n[0]).substring(0,300)),console.log("[deletedSongs] 图片字段 - al.picUrl:",null==(o=n[0].al)?void 0:o.picUrl),console.log("[deletedSongs] 图片字段 - album.picUrl:",null==(t=n[0].album)?void 0:t.picUrl),console.log("[deletedSongs] 图片字段 - picUrl:",n[0].picUrl),console.log("[deletedSongs] 图片字段 - img:",n[0].img)),n.slice(0,5)}),I=e.computed(()=>n.playerStore.getState().showMiniPlayer),T=e.ref(0),_=()=>{try{if(t.playlistStore&&"function"==typeof t.playlistStore.getAllSongCount){const e=t.playlistStore.getAllSongCount.call(t.playlistStore);T.value="number"==typeof e?e:0,console.log("[My] 刷新歌曲总数:",T.value)}else console.warn("[My] playlistStore.getAllSongCount 不可用"),T.value=0}catch(e){console.error("[My] 刷新歌曲总数失败:",e),T.value=0}},A=e.computed(()=>(T.value||0).toString()),$=e.computed(()=>{const e=y.value.listenTime||0;if(e>=60){const o=Math.floor(e/60),t=Math.round(e%60);return t>0?`${o}h ${t}m`:`${o}h`}return`${Math.round(e)}m`}),j=e.computed(()=>{const e=y.value.favoriteSinger;return e&&e.trim()?e.length>4?e.substring(0,4)+"...":e:"暂无"}),k=e=>{const o=Number(e)||0;return o>=1e4?(o/1e4).toFixed(1)+"万":o.toString()},q=e=>e.ar?e.ar.map(e=>e.name).join("/"):e.artists?e.artists.map(e=>e.name).join("/"):"未知歌手",z=e=>{var o,t;if(!e)return"/static/logo.png";const n=(null==(o=e.al)?void 0:o.picUrl)||(null==(t=e.album)?void 0:t.picUrl)||e.picUrl||e.img||e.pic||e.cover||e.coverUrl;return n||console.log("[getSongCover] 未找到图片字段，歌曲数据:",JSON.stringify(e).substring(0,200)),n?r.proxyImageUrl(n):"/static/logo.png"},R=()=>{e.index.navigateTo({url:"/pages/settings/index"})},D=(e,o,t)=>{if(!o||!o[t])return;const n=o[t];let l=0;n.includes("wsrv.nl")?l=1:n.includes("weserv.nl")?l=2:n.includes("jina.ai")&&(l=3);const a=r.handleImageError(e,n,l);a&&(o[t]=a)},H=()=>{e.index.navigateTo({url:"/pages/playlist/list"})},N=()=>{const o=n.playerStore.getState().playHistory||[];0!==o.length?(e.index.setStorageSync("recent_play_list",o),e.index.navigateTo({url:"/pages/sharelist/index?mode=recent&fromMyMusic=true"})):e.index.showToast({title:"暂无播放记录",icon:"none"})},P=()=>{const o=S(e.index.getStorageSync("deleted_songs"),[]);0!==o.length?(e.index.setStorageSync("deleted_play_list",o),e.index.navigateTo({url:"/pages/sharelist/index?mode=deleted&fromMyMusic=true"})):e.index.showToast({title:"暂无删除记录",icon:"none"})},B=o=>{if(o)if("love"!==o.source)if("user"!==o.source){if("imported"===o.source){const t=o.id.split("__"),n=t[0]||"tx",l=t[1]||o.id,r={wy:"网易云音乐",tx:"QQ音乐",kg:"酷狗音乐",kw:"酷我音乐",mg:"咪咕音乐"};e.index.navigateTo({url:`/pages/sharelist/index?source=${n}&link=${encodeURIComponent(l)}&platform=${encodeURIComponent(r[n]||n)}&preview=true&fromMyMusic=true&playlistId=${encodeURIComponent(o.id)}&coverUrl=${encodeURIComponent(o.coverUrl)}&playlistName=${encodeURIComponent(o.name)}`})}}else e.index.navigateTo({url:`/pages/sharelist/index?mode=user&fromMyMusic=true&playlistId=${encodeURIComponent(o.id)}&playlistName=${encodeURIComponent(o.name)}`});else e.index.navigateTo({url:"/pages/sharelist/index?mode=love&fromMyMusic=true"})},J=async e=>{e&&await a.playSongCommon(e,{addToDefaultList:!0,source:e.source||"tx"})},O=()=>{e.index.showModal({title:"新建歌单",editable:!0,placeholderText:"你想起啥名...",success:o=>{if(o.confirm&&o.content){const t=o.content.trim();if(!t)return void e.index.showToast({title:"歌单名称不能为空",icon:"none"});const n=S(e.index.getStorageSync("@user_lists"),[]),l={id:Date.now().toString(),name:t,list:[],coverImgUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80",createTime:Date.now()};n.push(l),e.index.setStorageSync("@user_lists",n),h(),e.index.showToast({title:"创建成功",icon:"success"})}}})},Q=[{name:"网易云音乐",source:"wy"},{name:"QQ音乐",source:"tx"},{name:"酷狗音乐",source:"kg"},{name:"酷我音乐",source:"kw"},{name:"咪咕音乐",source:"mg"}],L=e.ref(!1),W=e.ref(""),E=e.ref(""),F=e.ref(""),G=e.ref(""),K=()=>{e.index.showActionSheet({itemList:Q.map(e=>e.name),success:e=>{const o=Q[e.tapIndex];F.value=o.source,G.value=o.name,W.value=`从${o.name}导入`,E.value="",L.value=!0}})},V=()=>{L.value=!1,E.value=""},X=()=>{const o=E.value.trim();o?(L.value=!1,e.index.navigateTo({url:`/pages/sharelist/index?source=${F.value}&link=${encodeURIComponent(o)}&platform=${encodeURIComponent(G.value)}&preview=true&from=import`})):e.index.showToast({title:"请输入歌单链接",icon:"none"})};return e.onMounted(()=>{const o=e.index.getStorageSync("userStats")||{};y.value=o,h(),_()}),e.onShow(()=>{console.log("[My] onShow 触发，重新加载数据");const o=e.index.getStorageSync("userStats")||{};y.value=o,console.log("[My] 从Storage读取今日时长:",y.value.listenTime),console.log("[My] 从Storage读取最爱歌手:",y.value.favoriteSinger),c.value="true"===e.index.getStorageSync("darkMode"),l.setStatusBarTextColor(c.value?"light":"dark"),h(),_();const t=n.playerStore.getState().playHistory||[];console.log("[My] 最近播放数据数量:",t.length);const r=S(e.index.getStorageSync("deleted_songs"),[]);console.log("[My] 最近删除数据数量:",r.length),(()=>{var o;try{const t=e.index.getSystemInfoSync();g.value=(null==(o=t.safeAreaInsets)?void 0:o.bottom)||0;const n=t.windowWidth/750;d.value=110*n,console.log("[My] 底部高度初始化:",{safeAreaBottom:g.value,tabBarHeight:d.value})}catch(t){console.error("[My] 获取底部高度失败:",t)}})(),(()=>{e.index.$on("miniPlayerHeightChange",e=>{u.value=e.isShowing,console.log("[My] MiniPlayer 状态变化:",e.isShowing)});const o=n.playerStore.getState().currentSong;u.value=!(!o||!o.id)})(),setTimeout(()=>{f.value=[...f.value]},100)}),(o,t)=>{var n,l,a;return e.e({a:e.s(p.value),b:e.p({name:"gear",size:"20",color:"#6b7280"}),c:e.o(R),d:e.t(A.value),e:e.o(H),f:e.t(k(y.value.listenCount)),g:e.t($.value),h:e.t(j.value),i:e.t(f.value.length||0),j:e.p({name:"plus",size:"16",color:"#6b7280"}),k:e.o(O),l:e.p({name:"link",size:"16",color:"#6b7280"}),m:e.o(K),n:(null==(n=x.value)?void 0:n.coverUrl)?e.unref(r.proxyImageUrl)(x.value.coverUrl):"/static/logo.png",o:e.o(e=>D(e,x.value,"coverUrl")),p:e.t((null==(l=x.value)?void 0:l.name)||"我喜欢的音乐"),q:e.t((null==(a=x.value)?void 0:a.songCount)||0),r:e.p({name:"heart",size:"12",color:"#ff6687"}),s:e.o(e=>B(x.value)),t:e.f(U.value,(o,t,n)=>({a:e.unref(r.proxyImageUrl)(o.coverUrl),b:e.o(e=>D(e,o,"coverUrl"),o.id),c:e.t(o.name),d:e.t(o.songCount),e:o.id,f:e.o(e=>B(o),o.id)})),v:e.t(M.value),w:e.f(w.value,(o,t,n)=>{var l,r;return{a:z(o),b:e.o(e=>D(e,o,"picUrl"),o.id),c:"52da6cf3-4-"+n,d:e.t(o.name),e:e.t(q(o)),f:e.t((null==(l=o.al)?void 0:l.name)||(null==(r=o.album)?void 0:r.name)||"未知专辑"),g:o.id,h:e.o(e=>J(o),o.id)}}),x:e.p({name:"play",size:"16",color:"#ffffff"}),y:e.p({name:"chevron-right",size:"12",color:"#8a8a8a"}),z:e.o(N),A:e.t(b.value),B:e.f(C.value,(o,t,n)=>({a:z(o),b:"52da6cf3-6-"+n,c:e.t(o.name),d:e.t(o.type||"歌曲"),e:e.t(q(o)),f:o.id,g:e.o(e=>J(o),o.id)})),C:e.p({name:"play",size:"16",color:"#ffffff"}),D:e.p({name:"chevron-right",size:"12",color:"#8a8a8a"}),E:e.o(P),F:e.s(m.value),G:e.s(v.value),H:L.value},L.value?{I:e.t(W.value),J:e.p({name:"xmark",size:"20",color:"#999"}),K:e.o(V),L:E.value,M:e.o(e=>E.value=e.detail.value),N:e.o(V),O:e.o(X),P:e.o(()=>{}),Q:e.o(V)}:{},{R:I.value},(I.value,{}),{S:e.p({"current-index":3}),T:c.value?1:""})}}},g=e._export_sfc(u,[["__scopeId","data-v-52da6cf3"]]);wx.createPage(g);
