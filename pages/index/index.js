"use strict";const e=require("../../common/vendor.js"),t=require("../../store/modules/list.js"),o=require("../../store/modules/player.js"),a=require("../../store/modules/system.js"),n=require("../../utils/api/songlist-direct.js"),i=require("../../utils/api/music.js"),s=require("../../utils/musicUrlCache.js"),r=require("../../utils/lyricCache.js"),l=require("../../utils/musicParams.js"),c=require("../../utils/i18n.js"),d=require("../../utils/system.js"),m=require("../../utils/imageProxy.js"),u=require("../../utils/playSong.js");if(!Array){(e.resolveComponent("custom-tabbar")+e.resolveComponent("roc-icon-plus"))()}Math||(h+(()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js")+p+g)();const p=()=>"../../components/player/MiniPlayer.js",g=()=>"../../components/common/CustomTabBar.js",h=()=>"../../components/common/PactModal.js",f={__name:"index",setup(p,{expose:g}){const h=e.ref(d.getStatusBarHeight()),f=e.computed(()=>({height:`${h.value}px`,width:"100%",backgroundColor:x.value?"#1f2937":"transparent"}));e.ref(!0);const y=e.ref(0),w=e.ref(!1),x=e.ref(!1),b=["拼好歌","青釉音乐"],v=e.ref(0),I=e.computed(()=>b[v.value]);let S=0;const T=e.ref(!1),U=e.ref(!1),q=e.computed(()=>o.playerStore.getState().showMiniPlayer),C=e.ref(0),k=e.ref(!1),M=e.ref(0),L=e.ref(0),_=e.computed(()=>{const e=C.value,t=L.value;if(k.value){return{height:`${M.value+e+t}px`}}return{height:`${e+t}px`}}),$=e.ref([]),P=e.ref([]),D=e.ref([]),B=e.ref([]),A=e.ref([]),j=e.ref(null),E=()=>{j.value&&(j.value.style.opacity=0,setTimeout(()=>{j.value&&(j.value.style.opacity=1)},200))},R=async()=>{try{await Promise.all([z(),W(),Q(),H(),K()])}catch(t){console.error("获取首页数据失败:",t),e.index.showToast({title:"获取数据失败，请重试",icon:"none"})}},N=e=>e?e.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&#039;/g,"'").replace(/&nbsp;/g," ").replace(/&#32;/g," "):"",z=async()=>{try{const t=e.index.getStorageSync("kw_banner_max_page");let o=1;const a=10;t&&t>0?(o=Math.floor(Math.random()*t)+1,console.log("[Banner] 使用保存的页码范围:",t,"随机选择页码:",o)):console.log("[Banner] 首次打开，使用第1页");const n=`http://wapi.kuwo.cn/api/pc/classify/playlist/getRcmPlayList?loginUid=0&loginSid=0&appUid=76039576&pn=${o}&rn=${a}&order=hot`,i=await e.index.request({url:n,method:"GET",header:{Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"}});if(200!==i.statusCode||200!==i.data.code)throw new Error("获取歌单数据失败");const s=i.data.data.total||0,r=i.data.data.data||[],l=Math.ceil(s/a)||1;e.index.setStorageSync("kw_banner_max_page",l),console.log("[Banner] 酷我推荐歌单总数:",s,"计算总页数:",l,"本次获取:",r.length,"当前页码:",o);const c=[],d=[];for(;c.length<5&&d.length<r.length;){const e=Math.floor(Math.random()*r.length);if(!d.includes(e)){d.push(e);const t=r[e];let o=t.img?t.img.trim().replace(/`/g,""):"";!o||o.endsWith(".jpg")||o.endsWith(".png")||o.endsWith(".webp")||(o+=".jpg"),o=m.proxyImageUrl(o),c.push({imageUrl:o,targetType:1,targetId:`digest-${t.digest}__${t.id}`,titleColor:"red",typeTitle:N(t.name),subtitle:N(t.desc)||"精选歌单推荐",url:"",source:"kw",playCount:t.listencnt,total:t.total})}}if(c.length<5){const e=[{imageUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2886046289",titleColor:"red",typeTitle:"夏日特辑",subtitle:"清凉一夏，畅享音乐",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2847251561",titleColor:"blue",typeTitle:"古典新声",subtitle:"感受古典音乐的魅力",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2736267853",titleColor:"red",typeTitle:"电音节拍",subtitle:"夏夜狂欢，尽情舞动",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2829883282",titleColor:"blue",typeTitle:"轻音乐精选",subtitle:"放松身心，享受宁静",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop",targetType:1,targetId:"digest-8__2829816742",titleColor:"red",typeTitle:"流行热歌",subtitle:"当下最热门的流行音乐",url:"",source:"kw"}];for(;c.length<5;)c.push(e[c.length])}$.value=c,console.log("[Banner] 轮播图数据:",c)}catch(t){console.error("[Banner] 获取轮播图失败:",t),e.index.removeStorageSync("kw_banner_max_page"),console.log("[Banner] 请求失败，已清除保存的页码，下次将使用第1页"),$.value=[{imageUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2886046289",titleColor:"red",typeTitle:"夏日特辑",subtitle:"清凉一夏，畅享音乐",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2847251561",titleColor:"blue",typeTitle:"古典新声",subtitle:"感受古典音乐的魅力",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2736267853",titleColor:"red",typeTitle:"电音节拍",subtitle:"夏夜狂欢，尽情舞动",url:"",source:"kw"}]}},W=async()=>{try{const t=e.index.getStorageSync("mg_recommend_max_page");let o=1;t&&t>0?(o=Math.floor(Math.random()*t)+1,console.log("[Recommend] 使用保存的页码范围:",t,"随机选择页码:",o)):console.log("[Recommend] 首次打开，使用第1页");const a=`https://app.c.nf.migu.cn/pc/bmw/page-data/playlist-square-recommend/v1.0?templateVersion=2&pageNo=${o}`;console.log("[Recommend] 咪咕音乐请求URL:",a);const n=await e.index.request({url:a,method:"GET",header:{Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"}});if(200!==n.statusCode||"000000"!==n.data.code)throw new Error("获取咪咕音乐推荐歌单失败");let i=[],s=0;if(n.data.data)if(n.data.data.contents){const e=new Set,t=o=>{var a,n;for(const s of o)s.contents?t(s.contents):"2021"!=s.resType||e.has(s.resId)||(e.add(s.resId),i.push({id:String(s.resId),name:s.txt,coverImgUrl:s.img,playCount:(null==(n=null==(a=s.barList)?void 0:a[0])?void 0:n.title)||0,source:"mg"}))};t(n.data.data.contents),s=e.size}else n.data.data.contentItemList&&n.data.data.contentItemList[1]&&n.data.data.contentItemList[1].itemList&&(s=n.data.data.contentItemList[1].itemList.length||0,n.data.data.contentItemList[1].itemList.forEach(e=>{var t,o;i.push({id:String(e.logEvent.contentId),name:e.title,coverImgUrl:e.imageUrl,playCount:(null==(o=null==(t=e.barList)?void 0:t[0])?void 0:o.title)||0,source:"mg"})}));if(0===i.length)throw new Error("咪咕音乐返回数据为空");const r=30,l=Math.ceil(s/r)||10;e.index.setStorageSync("mg_recommend_max_page",l),console.log("[Recommend] 咪咕音乐推荐歌单总数:",s,"计算总页数:",l,"本次获取:",i.length,"当前页码:",o);const c=[],d=[];for(;c.length<8&&d.length<i.length;){const e=Math.floor(Math.random()*i.length);if(!d.includes(e)){d.push(e);const t=i[e];c.push({id:t.id,name:t.name,coverImgUrl:t.coverImgUrl,playCount:t.playCount,source:t.source})}}if(c.length<8){const e=[{id:"2847251561",name:"欧美点唱机：你听过最惊艳的英文歌",coverImgUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop",playCount:12893506},{id:"2829883282",name:"「催眠曲」当大自然的声音遇上轻音乐",coverImgUrl:"https://images.unsplash.com/photo-1459749411175-04bf5292ceea?q=80&w=1470&auto=format&fit=crop",playCount:8234567},{id:"2829816742",name:"沉醉在旋律里，感受古典音乐的魅力",coverImgUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop",playCount:5678234},{id:"2829844578",name:"华语速爆新歌",coverImgUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop",playCount:3456789},{id:"2829896232",name:"日系沙滩音乐，感受夏日氛围",coverImgUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop",playCount:2345678},{id:"2829807711",name:"韩流来袭：最新K-POP热门单曲",coverImgUrl:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop",playCount:1234567},{id:"2829807712",name:"爵士乐经典收藏",coverImgUrl:"https://images.unsplash.com/photo-1415201364774-f6f0bb35f28f?q=80&w=1470&auto=format&fit=crop",playCount:987654},{id:"2829807713",name:"电子音乐节拍",coverImgUrl:"https://images.unsplash.com/photo-1571330735066-03aaa9429d89?q=80&w=1470&auto=format&fit=crop",playCount:876543}];for(;c.length<8;)c.push(e[c.length])}P.value=c,console.log("[Recommend] 推荐歌单数据:",c)}catch(t){console.error("[Recommend] 获取推荐歌单失败:",t),e.index.removeStorageSync("mg_recommend_max_page"),console.log("[Recommend] 请求失败，已清除保存的页码，下次将使用第1页"),P.value=[{id:"2847251561",name:"欧美点唱机：你听过最惊艳的英文歌",coverImgUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop",playCount:12893506},{id:"2829883282",name:"「催眠曲」当大自然的声音遇上轻音乐",coverImgUrl:"https://images.unsplash.com/photo-1459749411175-04bf5292ceea?q=80&w=1470&auto=format&fit=crop",playCount:8234567},{id:"2829816742",name:"沉醉在旋律里，感受古典音乐的魅力",coverImgUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop",playCount:5678234},{id:"2829844578",name:"华语速爆新歌",coverImgUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop",playCount:3456789},{id:"2829896232",name:"日系沙滩音乐，感受夏日氛围",coverImgUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop",playCount:2345678},{id:"2829807711",name:"韩流来袭：最新K-POP热门单曲",coverImgUrl:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop",playCount:1234567},{id:"2829807712",name:"爵士乐经典收藏",coverImgUrl:"https://images.unsplash.com/photo-1415201364774-f6f0bb35f28f?q=80&w=1470&auto=format&fit=crop",playCount:987654},{id:"2829807713",name:"电子音乐节拍",coverImgUrl:"https://images.unsplash.com/photo-1571330735066-03aaa9429d89?q=80&w=1470&auto=format&fit=crop",playCount:876543}]}},Q=async()=>{try{const t="27",o=20,a=await e.index.request({url:"https://u.y.qq.com/cgi-bin/musicu.fcg",method:"POST",data:{comm:{g_tk:5381,uin:0,format:"json",inCharset:"utf-8",outCharset:"utf-8",notice:0,platform:"h5",needNewCode:1},detail:{module:"musicToplist.ToplistInfoServer",method:"GetDetail",param:{topId:parseInt(t),offset:0,num:o,period:""}}},header:{"Content-Type":"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",Referer:"https://y.qq.com"}});if(console.log("[NewSongs] QQ音乐新歌榜响应状态:",a.statusCode),!(a.data&&a.data.detail&&a.data.detail.data&&a.data.detail.data.songInfoList))throw new Error("QQ音乐新歌榜返回数据格式错误");{const e=a.data.detail.data.songInfoList;console.log("[NewSongs] QQ音乐新歌榜歌曲数量:",e.length);const t=e.map(e=>{let t="";return e.album&&e.album.name&&""!==e.album.name&&"空"!==e.album.name?t=`https://y.gtimg.cn/music/photo_new/T002R500x500M000${e.album.mid}.jpg`:e.singer&&e.singer.length>0&&(t=`https://y.gtimg.cn/music/photo_new/T001R500x500M000${e.singer[0].mid}.jpg`),{id:e.id||e.songId,name:e.name||e.title||"未知歌曲",singer:e.singer?e.singer.map(e=>e.name).join(" / "):"未知歌手",album:e.album?e.album.name:"",duration:e.interval||0,source:"tx",songmid:e.mid||e.songmid,img:t,albumMid:e.album?e.album.mid:"",singerMid:e.singer&&e.singer.length>0?e.singer[0].mid:""}}),o=[],n=[];for(;o.length<5&&n.length<t.length;){const e=Math.floor(Math.random()*t.length);if(!n.includes(e)){n.push(e);const a=t[e];o.push({id:a.id,name:a.name,singer:a.singer,album:a.album,duration:a.duration,source:a.source,songmid:a.songmid,img:a.img,albumMid:a.albumMid,singerMid:a.singerMid})}}D.value=o,console.log("[NewSongs] 新歌速递数据:",o)}}catch(t){console.error("[NewSongs] 获取新歌速递失败:",t),D.value=[{id:1463165983,name:"我好像在哪见过你",singer:"薛之谦",album:"我好像在哪见过你",duration:240,source:"tx",songmid:"003kui4t0Cr8Kz",img:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop"},{id:1456890123,name:"Blinding Lights",singer:"The Weeknd",album:"After Hours",duration:200,source:"tx",songmid:"001zLvbN1mM0qx",img:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop"},{id:1452345678,name:"Dynamite",singer:"BTS",album:"Dynamite (DayTime Version)",duration:199,source:"tx",songmid:"001zLvbN1mM0qx",img:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop"},{id:1452345679,name:"Levitating",singer:"Dua Lipa",album:"Future Nostalgia",duration:203,source:"tx",songmid:"001zLvbN1mM0qx",img:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop"},{id:1452345680,name:"Butter",singer:"BTS",album:"Butter",duration:164,source:"tx",songmid:"001zLvbN1mM0qx",img:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop"}]}},H=async()=>{try{B.value=[{id:91744369,name:"我好像在哪见过你",picUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop",artist:{id:12084589,name:"薛之谦"}},{id:87654321,name:"After Hours",picUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop",artist:{id:12345678,name:"The Weeknd"}},{id:76543210,name:"Dynamite (DayTime Version)",picUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop",artist:{id:23456789,name:"BTS"}},{id:65432109,name:"Future Nostalgia",picUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop",artist:{id:34567890,name:"Dua Lipa"}},{id:54321098,name:"Fine Line",picUrl:"https://p2.music.126.net/q5rKcBx9Y0V37DsUSaQKXg==/109951164799731696.jpg",artist:{id:45678901,name:"Harry Styles"}}]}catch(e){console.error("获取新碟上架失败:",e)}},K=async()=>{var t,o,a;try{const n="27186466",i=await e.index.request({url:`https://app.c.nf.migu.cn/MIGUM2.0/v1.0/content/querycontentbyId.do?columnId=${n}&needAll=0`,method:"GET",header:{"User-Agent":"Mozilla/5.0 (Linux; Android 5.1.1; Nexus 6 Build/LYZ28E) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Mobile Safari/537.36",Referer:"https://app.c.nf.migu.cn/",channel:"0146921"}});if(console.log("[TopArtists] 咪咕热歌榜响应状态:",i.statusCode),200!==i.statusCode||"000000"!==(null==(t=i.data)?void 0:t.code))throw new Error("获取咪咕热歌榜失败");const s=null==(a=null==(o=i.data)?void 0:o.columnInfo)?void 0:a.contents;if(!s||!Array.isArray(s))throw new Error("咪咕热歌榜无数据");console.log("[TopArtists] 咪咕热歌榜歌曲数量:",s.length);const r=new Map;for(const e of s){const t=e.objectInfo||e;let o=t.singerName||t.singer||"";if(!o)continue;o=o.split(/[,，/&]/)[0].trim();const a=t.singerId||"";let n="";if(t.landscapImg?n=t.landscapImg:t.albumImgs&&t.albumImgs.length>0&&(n=t.albumImgs[0].img||""),r.has(o)||r.set(o,{id:a||o,name:o,picUrl:n||"https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?q=80&w=1470&auto=format&fit=crop"}),r.size>=10)break}const l=Array.from(r.values());if(console.log("[TopArtists] 提取的热门歌手数量:",l.length),console.log("[TopArtists] 热门歌手列表:",l.map(e=>e.name).join(", ")),l.length<10){const e=[{id:"1",name:"薛之谦",picUrl:"https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?q=80&w=1470&auto=format&fit=crop"},{id:"2",name:"周杰伦",picUrl:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop"},{id:"3",name:"林俊杰",picUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop"},{id:"4",name:"邓紫棋",picUrl:"https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?q=80&w=1470&auto=format&fit=crop"},{id:"5",name:"张学友",picUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop"},{id:"6",name:"刘德华",picUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop"},{id:"7",name:"陈奕迅",picUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop"},{id:"8",name:"五月天",picUrl:"https://images.unsplash.com/photo-1549213783-8284d0336c4f?q=80&w=1470&auto=format&fit=crop"},{id:"9",name:"毛不易",picUrl:"https://images.unsplash.com/photo-1598387993281-cecf8b71a8f8?q=80&w=1476&auto=format&fit=crop"},{id:"10",name:"李荣浩",picUrl:"https://images.unsplash.com/photo-1501386761578-eac5c94b800a?q=80&w=1470&auto=format&fit=crop"}];for(;l.length<10;){const t=e[l.length];if(r.has(t.name))break;l.push(t)}}A.value=l}catch(n){console.error("[TopArtists] 获取热门歌手失败:",n),A.value=[{id:"1",name:"薛之谦",picUrl:"https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?q=80&w=1470&auto=format&fit=crop"},{id:"2",name:"周杰伦",picUrl:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop"},{id:"3",name:"林俊杰",picUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop"},{id:"4",name:"邓紫棋",picUrl:"https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?q=80&w=1470&auto=format&fit=crop"},{id:"5",name:"张学友",picUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop"},{id:"6",name:"刘德华",picUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop"},{id:"7",name:"陈奕迅",picUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop"},{id:"8",name:"五月天",picUrl:"https://images.unsplash.com/photo-1549213783-8284d0336c4f?q=80&w=1470&auto=format&fit=crop"},{id:"9",name:"毛不易",picUrl:"https://images.unsplash.com/photo-1598387993281-cecf8b71a8f8?q=80&w=1476&auto=format&fit=crop"},{id:"10",name:"李荣浩",picUrl:"https://images.unsplash.com/photo-1501386761578-eac5c94b800a?q=80&w=1470&auto=format&fit=crop"}]}};e.onMounted(()=>{R()}),e.onShow(()=>{d.setStatusBarTextColor("black"),V(),G(),O(),(()=>{var t;try{const o=e.index.getSystemInfoSync(),a=o.windowWidth/750;C.value=110*a,L.value=(null==(t=o.safeAreaInsets)?void 0:t.bottom)||0,console.log("[Index] 底部高度初始化:",{tabBarHeight:C.value,safeAreaBottom:L.value})}catch(o){console.error("[Index] 获取底部高度失败:",o)}})(),(()=>{e.index.$on("miniPlayerHeightChange",e=>{k.value=e.isShowing,M.value=e.height||0,console.log("[Index] MiniPlayer 状态变化:",e.isShowing,"高度:",e.height)});const t=o.playerStore.getState().currentSong;k.value=!(!t||!t.id)})();const t=o.playerStore.getState().currentSong;t&&t.id&&setTimeout(()=>{const t=e.index.getSystemInfoSync().windowWidth/750,o=140*t;0===C.value&&(C.value=110*t),k.value=!0,M.value=o,console.log("[Index] onShow 检测到有歌曲，强制更新底部高度:",o,"tabBarHeight:",C.value)},100)});const G=()=>{const t="true"===e.index.getStorageSync("darkMode");if("false"!==e.index.getStorageSync("followSystem")){const t=e.index.getSystemInfoSync();x.value="dark"===t.theme}else x.value=t;const o=x.value?"dark":"light";d.setAppTheme(o)},O=()=>{const t=e.index.getStorageSync("appNameIndex");v.value=""!==t&&null!=t&&parseInt(t,10)||0,console.log("[Index] 初始化APP名称:",I.value,"索引:",v.value)},V=()=>{const t="true"===e.index.getStorageSync("isAgreePact");if(console.log("[Index] 检查许可协议:",t?"已同意":"未同意"),t){U.value=!0,T.value=!1;if(!e.index.getStorageSync("pactAgreedTime")){const t=e.index.getStorageSync("appInstallTime")||Date.now();e.index.setStorageSync("pactAgreedTime",t),console.log("[Index] 补充保存协议同意时间:",new Date(t).toLocaleString())}}else T.value=!0,console.log("[Index] showPactModal 已设置为 true")},F=()=>{console.log("[Index] 用户同意许可协议"),e.index.setStorageSync("isAgreePact","true");const t=Date.now();e.index.setStorageSync("pactAgreedTime",t),console.log("[Index] 协议同意时间已保存:",new Date(t).toLocaleString()),U.value=!0,T.value=!1},J=()=>{console.log("[Index] 用户拒绝许可协议"),e.index.showModal({title:"提示",content:"您需要同意许可协议才能使用本应用。",showCancel:!1})},X=()=>{const t=Date.now(),o=t-S;if(console.log("[Index] APP Logo被点击，时间差:",o,"上次点击时间:",S),o>0&&o<300){console.log("[Index] 检测到双击，准备切换APP名称");const t=(v.value+1)%b.length;v.value=t,e.index.setStorageSync("appNameIndex",t),console.log("[Index] 切换APP名称成功:",I.value,"新索引:",t),e.index.showToast({title:`已切换为"${I.value}"`,icon:"none",duration:1500}),S=0}else S=t,console.log("[Index] 检测到单击，记录时间:",S)};e.onPullDownRefresh(async()=>{console.log("[Index] 下拉刷新开始"),e.index.showLoading({title:"刷新中...",mask:!0});try{$.value=[],P.value=[],D.value=[],B.value=[],A.value=[],await R(),e.index.showToast({title:"刷新成功",icon:"success",duration:1500})}catch(t){console.error("[Index] 下拉刷新失败:",t),e.index.showToast({title:"刷新失败",icon:"none",duration:1500})}finally{e.index.hideLoading(),e.index.stopPullDownRefresh(),console.log("[Index] 下拉刷新结束")}});const Y=e=>e.map(e=>e.name).join(" / "),Z=async(t,o)=>{if(console.log("[Index] 播放新歌:",t.name,"索引:",o),!t||!t.id)return console.error("[Index] 歌曲对象无效:",t),void e.index.showToast({title:"歌曲信息无效",icon:"none"});await u.playSongCommon(t,{addToDefaultList:!0,source:t.source||"tx"})},ee=t=>{if(console.log("[Banner] 点击轮播图:",t),"kw"===t.source&&t.targetId){const e=[`id=${t.targetId}`,"source=kw","fromName=index",`name=${encodeURIComponent(t.typeTitle||"")}`,`picUrl=${encodeURIComponent(t.imageUrl||"")}`,`playCount=${t.playCount||""}`,`link=${encodeURIComponent(t.targetId)}`].join("&");return void ae(`/pages/sharelist/index?${e}`)}switch(t.targetType){case 1:e.index.showToast({title:"播放歌曲ID: "+t.targetId,icon:"none"});break;case 10:e.index.showToast({title:"专辑详情功能暂未开放",icon:"none"});break;case 1e3:e.index.showToast({title:"歌单详情功能暂未开放",icon:"none"});break;case 1004:e.index.showToast({title:"MV功能暂未开放",icon:"none"});break;case 3e3:t.url&&e.index.showToast({title:"外链暂不支持",icon:"none"});break;default:if(t.targetId){const e=[`id=${t.targetId}`,"source=kw","fromName=index",`name=${encodeURIComponent(t.typeTitle||"")}`,`picUrl=${encodeURIComponent(t.imageUrl||"")}`,`playCount=${t.playCount||""}`,`link=${encodeURIComponent(t.targetId)}`].join("&");ae(`/pages/sharelist/index?${e}`)}else e.index.showToast({title:"未知类型",icon:"none"})}},te=async c=>{var d;if(console.log("[Banner] 播放按钮点击:",c),"kw"===c.source&&c.targetId){e.index.showLoading({title:"加载歌单中...",mask:!0});try{const m=await n.getListDetailDirect("kw",c.targetId,1);if(console.log("[Banner] 获取到歌单详情，歌曲数量:",null==(d=m.list)?void 0:d.length),!m.list||0===m.list.length)throw new Error("歌单为空");t.listStore.clearTempList();const u=`banner_${Date.now()}`;t.listStore.setTempList(u,m.list,{id:u,source:"kw",name:c.typeTitle||"歌单推荐"}),t.listStore.setPlayerListId(t.LIST_IDS.TEMP);const p=m.list[0],g=a.systemStore.getState().audioQuality||"128k",h=p.source||"kw";let f=await s.getCachedMusicUrl(p.id,g,h),y=null;if(f){o.playerStore.setUsingCachedUrl(!0);const e=await r.getCachedLyric(p.id,"kw");e&&(y=e)}else{const e=l.buildMusicRequestParams({...p,source:"kw"},g);if(!e)throw new Error("构建请求参数失败");const t=await i.getMusicUrl(e);f=null==t?void 0:t.url,f&&(await s.setCachedMusicUrl(p.id,g,f,h),y={lyric:t.lyric||"",tlyric:t.tlyric||"",rlyric:t.rlyric||"",lxlyric:t.lxlyric||""})}if(!f)throw new Error("无法获取播放链接");const w={id:p.id,name:p.name,singer:p.singer,album:p.album,duration:p.duration,source:"kw",songmid:p.songmid,img:p.img||"",url:f,playUrl:f,quality:g,lyric:(null==y?void 0:y.lyric)||"",tlyric:(null==y?void 0:y.tlyric)||"",rlyric:(null==y?void 0:y.rlyric)||"",lxlyric:(null==y?void 0:y.lxlyric)||""};t.listStore.setPlayMusicInfo(t.LIST_IDS.TEMP,w,!1),o.playerStore.playSong(w),e.index.showToast({title:`正在播放: ${c.typeTitle||"歌单推荐"}`,icon:"none",duration:2e3})}catch(m){console.error("[Banner] 播放失败:",m),e.index.showToast({title:m.message||"加载失败",icon:"none",duration:2e3})}finally{e.index.hideLoading()}}else e.index.showToast({title:"开始播放",icon:"none"}),c.targetType},oe=async t=>{if(console.log("[Banner] 收藏按钮点击:",t),"kw"!==t.source||!t.targetId)return void e.index.showToast({title:"暂不支持收藏此类型",icon:"none"});const o=`${t.source}__${t.targetId}`;let a=e.index.getStorageSync("imported_playlists")||[];const i=a.findIndex(e=>e.sourceListId===o);-1===i?e.index.showModal({title:"导入歌单",content:`是否将「${t.typeTitle}」导入到我的歌单？`,confirmText:"导入",cancelText:"取消",success:async i=>{var s,r;if(i.confirm){e.index.showLoading({title:"获取数据中..."});try{console.log("[Banner] 获取歌单详情:",t.source,t.targetId);const i=await n.getListDetailDirect(t.source,t.targetId,1),l=i.list||[];console.log("[Banner] 获取到歌曲:",l.length,"首");const c={id:o,name:t.typeTitle||(null==(s=i.info)?void 0:s.name)||"未知歌单",coverImgUrl:t.imageUrl||(null==(r=i.info)?void 0:r.img)||"",trackCount:l.length,source:t.source,sourceListId:o,link:t.targetId,platform:"酷我音乐",songs:l};a.push(c),e.index.setStorageSync("imported_playlists",a),e.index.showToast({title:`导入成功（${l.length}首）`,icon:"success"})}catch(l){console.error("[Banner] 导入失败:",l),e.index.showToast({title:"导入失败: "+(l.message||"未知错误"),icon:"none"})}finally{e.index.hideLoading()}}}}):e.index.showModal({title:"提示",content:`歌单「${a[i].name}」已存在，是否同步更新？`,confirmText:"更新",cancelText:"取消",success:async o=>{var s;if(o.confirm){e.index.showLoading({title:"更新中..."});try{const o=await n.getListDetailDirect(t.source,t.targetId,1),r=o.list||[];a[i].songs=r,a[i].trackCount=r.length,a[i].coverImgUrl=t.imageUrl||(null==(s=o.info)?void 0:s.img)||"",e.index.setStorageSync("imported_playlists",a),e.index.showToast({title:"更新成功",icon:"success"})}catch(r){console.error("[Banner] 更新失败:",r),e.index.showToast({title:"更新失败",icon:"none"})}finally{e.index.hideLoading()}}}})},ae=t=>{e.index.navigateTo({url:t})},ne=t=>{console.log("[Index] 点击热门歌手，跳转到搜索:",t),t?(e.index.setStorageSync("searchKeywordFromIndex",t),e.index.switchTab({url:"/pages/search/index"})):e.index.showToast({title:"歌手信息无效",icon:"none"})},ie=()=>{console.log("[Index] 点击热歌榜，跳转到排行榜页面"),e.index.setStorageSync("rank_temp_source","mg"),e.index.setStorageSync("rank_temp_boardId","mg__27186466"),e.index.navigateTo({url:"/pages/rank/index"})},se=()=>{console.log("[Index] 点击新歌速递更多，跳转到排行榜QQ音乐新歌榜"),e.index.setStorageSync("rank_temp_source","tx"),e.index.setStorageSync("rank_temp_boardId","tx__27"),e.index.navigateTo({url:"/pages/rank/index"})},re=async()=>{var c;console.log("[Index] 点击每日推荐，开始获取随机歌单"),e.index.showLoading({title:"正在获取推荐...",mask:!0});try{const d="https://app.c.nf.migu.cn/pc/bmw/page-data/playlist-square-recommend/v1.0?templateVersion=2&pageNo=1",m=await e.index.request({url:d,method:"GET",header:{Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"}});if(200!==m.statusCode||"000000"!==m.data.code)throw new Error("获取推荐歌单失败");let u=[];if(m.data.data)if(m.data.data.contents){const e=new Set,t=o=>{for(const a of o)a.contents?t(a.contents):"2021"!=a.resType||e.has(a.resId)||(e.add(a.resId),u.push({id:String(a.resId),name:a.txt,coverImgUrl:a.img,source:"mg"}))};t(m.data.data.contents)}else m.data.data.contentItemList&&m.data.data.contentItemList[1]&&m.data.data.contentItemList[1].itemList&&m.data.data.contentItemList[1].itemList.forEach(e=>{u.push({id:String(e.logEvent.contentId),name:e.title,coverImgUrl:e.imageUrl,source:"mg"})});if(0===u.length)throw new Error("暂无推荐歌单");const p=Math.floor(Math.random()*Math.min(u.length,10)),g=u[p];console.log("[Index] 随机选择歌单:",g.name,"ID:",g.id);const h=await n.getListDetailDirect("mg",g.id,1);if(console.log("[Index] 获取到歌单详情，歌曲数量:",null==(c=h.list)?void 0:c.length),!h.list||0===h.list.length)throw new Error("歌单为空");t.listStore.clearTempList();const f=`daily_${Date.now()}`;t.listStore.setTempList(f,h.list,{id:f,source:"mg",name:g.name||"每日推荐"}),t.listStore.setPlayerListId(t.LIST_IDS.TEMP);const y=h.list[0],w=a.systemStore.getState().audioQuality||"128k",x={id:y.id,name:y.name,singer:y.singer,album:y.album||y.albumName||"",duration:y.duration,source:"mg",songmid:y.songmid||y.songId,copyrightId:y.copyrightId||y.id,img:y.img||"",url:"",playUrl:"",quality:w,lyric:"",tlyric:"",rlyric:"",lxlyric:""};t.listStore.setPlayMusicInfo(t.LIST_IDS.TEMP,x,!1),o.playerStore.setCurrentSong(x,!0),o.playerStore.setStatusText("正在获取播放链接...",0),console.log("[Daily] 已设置歌曲信息，MiniPlayer 将显示");const b=y.source||"mg";let v=await s.getCachedMusicUrl(y.id,w,b),I=null;if(v){o.playerStore.setUsingCachedUrl(!0);const e=await r.getCachedLyric(y.id,"mg");e&&(I=e)}else{const e=l.buildMusicRequestParams({...y,source:"mg"},w);if(!e)throw new Error("构建请求参数失败");console.log("[Daily] 咪咕音乐歌曲字段:",{songmid:y.songmid,songId:y.songId,copyrightId:y.copyrightId,id:y.id});const t=await i.getMusicUrl(e);v=null==t?void 0:t.url,v&&(await s.setCachedMusicUrl(y.id,w,v,b),I={lyric:t.lyric||"",tlyric:t.tlyric||"",rlyric:t.rlyric||"",lxlyric:t.lxlyric||""})}if(!v)throw new Error("无法获取播放链接");const S={...x,url:v,playUrl:v,lyric:(null==I?void 0:I.lyric)||"",tlyric:(null==I?void 0:I.tlyric)||"",rlyric:(null==I?void 0:I.rlyric)||"",lxlyric:(null==I?void 0:I.lxlyric)||""};t.listStore.setPlayMusicInfo(t.LIST_IDS.TEMP,S,!1),o.playerStore.playSong(S),e.index.showToast({title:`正在播放: ${g.name}`,icon:"none",duration:2e3})}catch(d){console.error("[Index] 每日推荐获取失败:",d),o.playerStore.clearStatusText(),e.index.showToast({title:d.message||"获取推荐失败",icon:"none",duration:2e3})}finally{e.index.hideLoading()}},le=t=>{let o="";const a=t.source||"tx";switch(a){case"kw":o=`https://www.kuwo.cn/playlist_detail/${t.id}`;break;case"kg":o=`https://www.kugou.com/yy/special/single/${t.id}.html`;break;case"tx":o=`https://y.qq.com/n/ryqq/playlist/${t.id}`;break;case"wy":o=`https://music.163.com/playlist?id=${t.id}`;break;case"mg":o=`https://music.migu.cn/v3/music/playlist/${t.id}`;break;default:o=t.id}e.index.navigateTo({url:`/pages/sharelist/index?source=${a}&link=${encodeURIComponent(o)}&id=${t.id}&picUrl=${encodeURIComponent(t.coverImgUrl||"")}&name=${encodeURIComponent(t.name||"")}&author=${encodeURIComponent(t.author||"")}&playCount=${t.playCount||0}&fromName=index`})},ce=()=>{e.index.setStorageSync("fromSearchBar",!0),e.index.switchTab({url:"/pages/search/index"})},de=e.computed(()=>d.getSafeAreaStyle()),me=e=>{y.value=e.detail.current},ue=(e,t)=>{if(!t||!t.imageUrl)return;let o=0;t.imageUrl.includes("wsrv.nl")?o=1:t.imageUrl.includes("weserv.nl")?o=2:t.imageUrl.includes("jina.ai")&&(o=3);const a=m.handleImageError(e,t.imageUrl,o);a&&(t.imageUrl=a)};return g({t:c.t,banners:$,recommendPlaylists:P,newSongs:D,newAlbums:B,topArtists:A,currentBannerIndex:y,isLoadingMore:w,showMiniPlayer:q,showTabBar:!0,searchBarStyle:de,formatPlayCount:e=>e<1e4?e.toString():e<1e8?Math.floor(e/1e4)+"万":Math.floor(e/1e8)+"亿",formatArtists:Y,playSong:e=>{const t={...e,url:"",playUrl:""};o.playerStore.playSong(t)},showSongOptions:t=>{e.index.showActionSheet({itemList:["添加到播放列表","下一首播放","收藏到歌单","分享","歌手："+Y(t.artists),"专辑："+t.album.name],success:a=>{switch(a.tapIndex){case 0:o.playerStore.addToPlaylist(t),e.index.showToast({title:"已添加到播放列表",icon:"none"});break;case 1:o.playerStore.addToPlaylistAsNext(t),e.index.showToast({title:"已添加到下一首播放",icon:"none"});break;case 2:e.index.showToast({title:"收藏功能开发中",icon:"none"});break;case 3:e.index.share({provider:"weixin",scene:"WXSceneSession",type:0,title:t.name,summary:Y(t.artists),imageUrl:t.album.picUrl,success:function(e){console.log("分享成功："+JSON.stringify(e))},fail:function(e){console.log("分享失败："+JSON.stringify(e))}});break;case 4:e.index.showToast({title:"歌手详情功能暂未开放",icon:"none"});break;case 5:e.index.showToast({title:"专辑详情功能暂未开放",icon:"none"})}}})},playNewSong:Z,formatDuration:e=>{if(!e||e<=0)return"00:00";const t=Math.floor(e/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},handleBannerClick:ee,playBanner:te,collectBanner:oe,navigateTo:ae,goToPlaylistDetail:le,goToSearch:ce,goToSearchWithArtist:ne,goToHotSongs:ie,goToDailyRecommend:re,onBannerChange:me,handleBannerImageError:ue,handleTabSwitch:E}),(t,o)=>({a:e.o(F),b:e.o(J),c:e.p({visible:T.value,isAgreed:U.value}),d:e.s(f.value),e:e.o(E),f:e.p({"current-index":0}),g:e.p({name:"leaf",size:"20",color:"#ffffff"}),h:e.t(I.value),i:e.o(X),j:e.p({name:"magnifying-glass",size:"20",color:"#999999"}),k:e.o(ce),l:e.s(de.value),m:e.f($.value,(t,o,a)=>({a:t.imageUrl,b:e.o(e=>ue(e,t),o),c:e.t(t.typeTitle),d:e.t(t.subtitle||"精选音乐，为你推荐"),e:"31670c42-4-"+a,f:e.o(e=>te(t),o),g:"31670c42-5-"+a,h:e.o(e=>oe(t),o),i:o,j:e.o(e=>ee(t),o),k:o===y.value?1:""})),n:e.p({name:"play",size:"18",color:"#ffffff"}),o:e.p({name:"heart",size:"18",color:"#ffffff"}),p:e.o(me),q:e.f($.value,(t,o,a)=>({a:o,b:e.n({"indicator-dot-active":o===y.value})})),r:e.p({name:"heart",size:"22",color:"#ffffff"}),s:e.o(re),t:e.p({name:"ranking-star",size:"22",color:"#ffffff"}),v:e.o(e=>ae("/pages/rank/index")),w:e.p({name:"fire",size:"20",color:"#ffffff"}),x:e.o(ie),y:e.p({name:"list",size:"20",color:"#ffffff"}),z:e.o(e=>ae("/pages/songlist-list/index")),A:e.p({name:"chevron-right",size:"12",color:"#999999"}),B:e.o(e=>ae("/pages/songlist-list/index")),C:e.f(P.value,(t,o,a)=>({a:t.coverImgUrl,b:"31670c42-11-"+a,c:e.t(t.name),d:t.id,e:e.o(e=>le(t),t.id)})),D:e.p({name:"play",size:"12",color:"#ffffff"}),E:e.p({name:"chevron-right",size:"12",color:"#999999"}),F:e.o(se),G:e.f(D.value,(t,o,a)=>({a:t.img,b:e.t(t.name),c:e.t(t.singer),d:e.t(t.album),e:t.id,f:e.o(e=>Z(t,o),t.id)})),H:e.f(A.value,(t,o,a)=>({a:t.picUrl,b:e.t(t.name),c:t.id,d:e.o(e=>ne(t.name),t.id)})),I:e.s(_.value),J:e.p({"current-index":0}),K:x.value?1:""})}};wx.createPage(f);
