"use strict";const e=require("../../common/vendor.js"),t=require("../../store/modules/list.js"),o=require("../../store/modules/player.js"),a=require("../../store/modules/system.js"),n=require("../../utils/api/songlist-direct.js"),i=require("../../utils/api/music.js"),s=require("../../utils/musicUrlCache.js"),r=require("../../utils/lyricCache.js"),l=require("../../utils/i18n.js"),c=require("../../utils/system.js"),d=require("../../utils/imageProxy.js"),m=require("../../utils/playSong.js");if(!Array){(e.resolveComponent("custom-tabbar")+e.resolveComponent("roc-icon-plus"))()}Math||(p+(()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js")+g+u)();const g=()=>"../../components/player/MiniPlayer.js",u=()=>"../../components/common/CustomTabBar.js",p=()=>"../../components/common/PactModal.js",h={__name:"index",setup(g,{expose:u}){const p=e.ref(c.getStatusBarHeight()),h=e.computed(()=>({height:`${p.value}px`,width:"100%",backgroundColor:w.value?"#1f2937":"transparent"}));e.ref(!0);const f=e.ref(0),y=e.ref(!1),w=e.ref(!1),x=["拼好歌","青釉音乐"],b=e.ref(0),I=e.computed(()=>x[b.value]);let v=0;const S=e.ref(!1),T=e.ref(!1),U=e.computed(()=>o.playerStore.getState().showMiniPlayer),q=e.ref(0),C=e.ref(!1),k=e.ref(0),L=e.ref(0),M=e.computed(()=>{const e=q.value,t=L.value;if(C.value){return{height:`${k.value+e+t}px`}}return{height:`${e+t}px`}}),_=e.ref([]),$=e.ref([]),P=e.ref([]),D=e.ref([]),B=e.ref([]),A=e.ref(null),j=()=>{A.value&&(A.value.style.opacity=0,setTimeout(()=>{A.value&&(A.value.style.opacity=1)},200))},E=async()=>{try{await Promise.all([N(),z(),W(),Q(),H()])}catch(t){console.error("获取首页数据失败:",t),e.index.showToast({title:"获取数据失败，请重试",icon:"none"})}},R=e=>e?e.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&#039;/g,"'").replace(/&nbsp;/g," ").replace(/&#32;/g," "):"",N=async()=>{try{const t=e.index.getStorageSync("kw_banner_max_page");let o=1;const a=10;t&&t>0?(o=Math.floor(Math.random()*t)+1,console.log("[Banner] 使用保存的页码范围:",t,"随机选择页码:",o)):console.log("[Banner] 首次打开，使用第1页");const n=`http://wapi.kuwo.cn/api/pc/classify/playlist/getRcmPlayList?loginUid=0&loginSid=0&appUid=76039576&pn=${o}&rn=${a}&order=hot`,i=await e.index.request({url:n,method:"GET",header:{Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"}});if(200!==i.statusCode||200!==i.data.code)throw new Error("获取歌单数据失败");const s=i.data.data.total||0,r=i.data.data.data||[],l=Math.ceil(s/a)||1;e.index.setStorageSync("kw_banner_max_page",l),console.log("[Banner] 酷我推荐歌单总数:",s,"计算总页数:",l,"本次获取:",r.length,"当前页码:",o);const c=[],m=[];for(;c.length<5&&m.length<r.length;){const e=Math.floor(Math.random()*r.length);if(!m.includes(e)){m.push(e);const t=r[e];let o=t.img?t.img.trim().replace(/`/g,""):"";!o||o.endsWith(".jpg")||o.endsWith(".png")||o.endsWith(".webp")||(o+=".jpg"),o=d.proxyImageUrl(o),c.push({imageUrl:o,targetType:1,targetId:`digest-${t.digest}__${t.id}`,titleColor:"red",typeTitle:R(t.name),subtitle:R(t.desc)||"精选歌单推荐",url:"",source:"kw",playCount:t.listencnt,total:t.total})}}if(c.length<5){const e=[{imageUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2886046289",titleColor:"red",typeTitle:"夏日特辑",subtitle:"清凉一夏，畅享音乐",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2847251561",titleColor:"blue",typeTitle:"古典新声",subtitle:"感受古典音乐的魅力",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2736267853",titleColor:"red",typeTitle:"电音节拍",subtitle:"夏夜狂欢，尽情舞动",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2829883282",titleColor:"blue",typeTitle:"轻音乐精选",subtitle:"放松身心，享受宁静",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop",targetType:1,targetId:"digest-8__2829816742",titleColor:"red",typeTitle:"流行热歌",subtitle:"当下最热门的流行音乐",url:"",source:"kw"}];for(;c.length<5;)c.push(e[c.length])}_.value=c,console.log("[Banner] 轮播图数据:",c)}catch(t){console.error("[Banner] 获取轮播图失败:",t),e.index.removeStorageSync("kw_banner_max_page"),console.log("[Banner] 请求失败，已清除保存的页码，下次将使用第1页"),_.value=[{imageUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2886046289",titleColor:"red",typeTitle:"夏日特辑",subtitle:"清凉一夏，畅享音乐",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2847251561",titleColor:"blue",typeTitle:"古典新声",subtitle:"感受古典音乐的魅力",url:"",source:"kw"},{imageUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop",targetType:1,targetId:"digest-8__2736267853",titleColor:"red",typeTitle:"电音节拍",subtitle:"夏夜狂欢，尽情舞动",url:"",source:"kw"}]}},z=async()=>{try{const t=e.index.getStorageSync("mg_recommend_max_page");let o=1;t&&t>0?(o=Math.floor(Math.random()*t)+1,console.log("[Recommend] 使用保存的页码范围:",t,"随机选择页码:",o)):console.log("[Recommend] 首次打开，使用第1页");const a=`https://app.c.nf.migu.cn/pc/bmw/page-data/playlist-square-recommend/v1.0?templateVersion=2&pageNo=${o}`;console.log("[Recommend] 咪咕音乐请求URL:",a);const n=await e.index.request({url:a,method:"GET",header:{Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"}});if(200!==n.statusCode||"000000"!==n.data.code)throw new Error("获取咪咕音乐推荐歌单失败");let i=[],s=0;if(n.data.data)if(n.data.data.contents){const e=new Set,t=o=>{var a,n;for(const s of o)s.contents?t(s.contents):"2021"!=s.resType||e.has(s.resId)||(e.add(s.resId),i.push({id:String(s.resId),name:s.txt,coverImgUrl:s.img,playCount:(null==(n=null==(a=s.barList)?void 0:a[0])?void 0:n.title)||0,source:"mg"}))};t(n.data.data.contents),s=e.size}else n.data.data.contentItemList&&n.data.data.contentItemList[1]&&n.data.data.contentItemList[1].itemList&&(s=n.data.data.contentItemList[1].itemList.length||0,n.data.data.contentItemList[1].itemList.forEach(e=>{var t,o;i.push({id:String(e.logEvent.contentId),name:e.title,coverImgUrl:e.imageUrl,playCount:(null==(o=null==(t=e.barList)?void 0:t[0])?void 0:o.title)||0,source:"mg"})}));if(0===i.length)throw new Error("咪咕音乐返回数据为空");const r=30,l=Math.ceil(s/r)||10;e.index.setStorageSync("mg_recommend_max_page",l),console.log("[Recommend] 咪咕音乐推荐歌单总数:",s,"计算总页数:",l,"本次获取:",i.length,"当前页码:",o);const c=[],d=[];for(;c.length<8&&d.length<i.length;){const e=Math.floor(Math.random()*i.length);if(!d.includes(e)){d.push(e);const t=i[e];c.push({id:t.id,name:t.name,coverImgUrl:t.coverImgUrl,playCount:t.playCount,source:t.source})}}if(c.length<8){const e=[{id:"2847251561",name:"欧美点唱机：你听过最惊艳的英文歌",coverImgUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop",playCount:12893506},{id:"2829883282",name:"「催眠曲」当大自然的声音遇上轻音乐",coverImgUrl:"https://images.unsplash.com/photo-1459749411175-04bf5292ceea?q=80&w=1470&auto=format&fit=crop",playCount:8234567},{id:"2829816742",name:"沉醉在旋律里，感受古典音乐的魅力",coverImgUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop",playCount:5678234},{id:"2829844578",name:"华语速爆新歌",coverImgUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop",playCount:3456789},{id:"2829896232",name:"日系沙滩音乐，感受夏日氛围",coverImgUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop",playCount:2345678},{id:"2829807711",name:"韩流来袭：最新K-POP热门单曲",coverImgUrl:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop",playCount:1234567},{id:"2829807712",name:"爵士乐经典收藏",coverImgUrl:"https://images.unsplash.com/photo-1415201364774-f6f0bb35f28f?q=80&w=1470&auto=format&fit=crop",playCount:987654},{id:"2829807713",name:"电子音乐节拍",coverImgUrl:"https://images.unsplash.com/photo-1571330735066-03aaa9429d89?q=80&w=1470&auto=format&fit=crop",playCount:876543}];for(;c.length<8;)c.push(e[c.length])}$.value=c,console.log("[Recommend] 推荐歌单数据:",c)}catch(t){console.error("[Recommend] 获取推荐歌单失败:",t),e.index.removeStorageSync("mg_recommend_max_page"),console.log("[Recommend] 请求失败，已清除保存的页码，下次将使用第1页"),$.value=[{id:"2847251561",name:"欧美点唱机：你听过最惊艳的英文歌",coverImgUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop",playCount:12893506},{id:"2829883282",name:"「催眠曲」当大自然的声音遇上轻音乐",coverImgUrl:"https://images.unsplash.com/photo-1459749411175-04bf5292ceea?q=80&w=1470&auto=format&fit=crop",playCount:8234567},{id:"2829816742",name:"沉醉在旋律里，感受古典音乐的魅力",coverImgUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop",playCount:5678234},{id:"2829844578",name:"华语速爆新歌",coverImgUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop",playCount:3456789},{id:"2829896232",name:"日系沙滩音乐，感受夏日氛围",coverImgUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop",playCount:2345678},{id:"2829807711",name:"韩流来袭：最新K-POP热门单曲",coverImgUrl:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop",playCount:1234567},{id:"2829807712",name:"爵士乐经典收藏",coverImgUrl:"https://images.unsplash.com/photo-1415201364774-f6f0bb35f28f?q=80&w=1470&auto=format&fit=crop",playCount:987654},{id:"2829807713",name:"电子音乐节拍",coverImgUrl:"https://images.unsplash.com/photo-1571330735066-03aaa9429d89?q=80&w=1470&auto=format&fit=crop",playCount:876543}]}},W=async()=>{try{const t="27",o=20,a=await e.index.request({url:"https://u.y.qq.com/cgi-bin/musicu.fcg",method:"POST",data:{comm:{g_tk:5381,uin:0,format:"json",inCharset:"utf-8",outCharset:"utf-8",notice:0,platform:"h5",needNewCode:1},detail:{module:"musicToplist.ToplistInfoServer",method:"GetDetail",param:{topId:parseInt(t),offset:0,num:o,period:""}}},header:{"Content-Type":"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",Referer:"https://y.qq.com"}});if(console.log("[NewSongs] QQ音乐新歌榜响应状态:",a.statusCode),!(a.data&&a.data.detail&&a.data.detail.data&&a.data.detail.data.songInfoList))throw new Error("QQ音乐新歌榜返回数据格式错误");{const e=a.data.detail.data.songInfoList;console.log("[NewSongs] QQ音乐新歌榜歌曲数量:",e.length);const t=e.map(e=>{let t="";return e.album&&e.album.name&&""!==e.album.name&&"空"!==e.album.name?t=`https://y.gtimg.cn/music/photo_new/T002R500x500M000${e.album.mid}.jpg`:e.singer&&e.singer.length>0&&(t=`https://y.gtimg.cn/music/photo_new/T001R500x500M000${e.singer[0].mid}.jpg`),{id:e.id||e.songId,name:e.name||e.title||"未知歌曲",singer:e.singer?e.singer.map(e=>e.name).join(" / "):"未知歌手",album:e.album?e.album.name:"",duration:e.interval||0,source:"tx",songmid:e.mid||e.songmid,img:t,albumMid:e.album?e.album.mid:"",singerMid:e.singer&&e.singer.length>0?e.singer[0].mid:""}}),o=[],n=[];for(;o.length<5&&n.length<t.length;){const e=Math.floor(Math.random()*t.length);if(!n.includes(e)){n.push(e);const a=t[e];o.push({id:a.id,name:a.name,singer:a.singer,album:a.album,duration:a.duration,source:a.source,songmid:a.songmid,img:a.img,albumMid:a.albumMid,singerMid:a.singerMid})}}P.value=o,console.log("[NewSongs] 新歌速递数据:",o)}}catch(t){console.error("[NewSongs] 获取新歌速递失败:",t),P.value=[{id:1463165983,name:"我好像在哪见过你",singer:"薛之谦",album:"我好像在哪见过你",duration:240,source:"tx",songmid:"003kui4t0Cr8Kz",img:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop"},{id:1456890123,name:"Blinding Lights",singer:"The Weeknd",album:"After Hours",duration:200,source:"tx",songmid:"001zLvbN1mM0qx",img:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop"},{id:1452345678,name:"Dynamite",singer:"BTS",album:"Dynamite (DayTime Version)",duration:199,source:"tx",songmid:"001zLvbN1mM0qx",img:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop"},{id:1452345679,name:"Levitating",singer:"Dua Lipa",album:"Future Nostalgia",duration:203,source:"tx",songmid:"001zLvbN1mM0qx",img:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop"},{id:1452345680,name:"Butter",singer:"BTS",album:"Butter",duration:164,source:"tx",songmid:"001zLvbN1mM0qx",img:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop"}]}},Q=async()=>{try{D.value=[{id:91744369,name:"我好像在哪见过你",picUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop",artist:{id:12084589,name:"薛之谦"}},{id:87654321,name:"After Hours",picUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop",artist:{id:12345678,name:"The Weeknd"}},{id:76543210,name:"Dynamite (DayTime Version)",picUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop",artist:{id:23456789,name:"BTS"}},{id:65432109,name:"Future Nostalgia",picUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop",artist:{id:34567890,name:"Dua Lipa"}},{id:54321098,name:"Fine Line",picUrl:"https://p2.music.126.net/q5rKcBx9Y0V37DsUSaQKXg==/109951164799731696.jpg",artist:{id:45678901,name:"Harry Styles"}}]}catch(e){console.error("获取新碟上架失败:",e)}},H=async()=>{var t,o,a;try{const n="27186466",i=await e.index.request({url:`https://app.c.nf.migu.cn/MIGUM2.0/v1.0/content/querycontentbyId.do?columnId=${n}&needAll=0`,method:"GET",header:{"User-Agent":"Mozilla/5.0 (Linux; Android 5.1.1; Nexus 6 Build/LYZ28E) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Mobile Safari/537.36",Referer:"https://app.c.nf.migu.cn/",channel:"0146921"}});if(console.log("[TopArtists] 咪咕热歌榜响应状态:",i.statusCode),200!==i.statusCode||"000000"!==(null==(t=i.data)?void 0:t.code))throw new Error("获取咪咕热歌榜失败");const s=null==(a=null==(o=i.data)?void 0:o.columnInfo)?void 0:a.contents;if(!s||!Array.isArray(s))throw new Error("咪咕热歌榜无数据");console.log("[TopArtists] 咪咕热歌榜歌曲数量:",s.length);const r=new Map;for(const e of s){const t=e.objectInfo||e;let o=t.singerName||t.singer||"";if(!o)continue;o=o.split(/[,，/&]/)[0].trim();const a=t.singerId||"";let n="";if(t.landscapImg?n=t.landscapImg:t.albumImgs&&t.albumImgs.length>0&&(n=t.albumImgs[0].img||""),r.has(o)||r.set(o,{id:a||o,name:o,picUrl:n||"https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?q=80&w=1470&auto=format&fit=crop"}),r.size>=10)break}const l=Array.from(r.values());if(console.log("[TopArtists] 提取的热门歌手数量:",l.length),console.log("[TopArtists] 热门歌手列表:",l.map(e=>e.name).join(", ")),l.length<10){const e=[{id:"1",name:"薛之谦",picUrl:"https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?q=80&w=1470&auto=format&fit=crop"},{id:"2",name:"周杰伦",picUrl:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop"},{id:"3",name:"林俊杰",picUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop"},{id:"4",name:"邓紫棋",picUrl:"https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?q=80&w=1470&auto=format&fit=crop"},{id:"5",name:"张学友",picUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop"},{id:"6",name:"刘德华",picUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop"},{id:"7",name:"陈奕迅",picUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop"},{id:"8",name:"五月天",picUrl:"https://images.unsplash.com/photo-1549213783-8284d0336c4f?q=80&w=1470&auto=format&fit=crop"},{id:"9",name:"毛不易",picUrl:"https://images.unsplash.com/photo-1598387993281-cecf8b71a8f8?q=80&w=1476&auto=format&fit=crop"},{id:"10",name:"李荣浩",picUrl:"https://images.unsplash.com/photo-1501386761578-eac5c94b800a?q=80&w=1470&auto=format&fit=crop"}];for(;l.length<10;){const t=e[l.length];if(r.has(t.name))break;l.push(t)}}B.value=l}catch(n){console.error("[TopArtists] 获取热门歌手失败:",n),B.value=[{id:"1",name:"薛之谦",picUrl:"https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?q=80&w=1470&auto=format&fit=crop"},{id:"2",name:"周杰伦",picUrl:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1474&auto=format&fit=crop"},{id:"3",name:"林俊杰",picUrl:"https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1470&auto=format&fit=crop"},{id:"4",name:"邓紫棋",picUrl:"https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?q=80&w=1470&auto=format&fit=crop"},{id:"5",name:"张学友",picUrl:"https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1470&auto=format&fit=crop"},{id:"6",name:"刘德华",picUrl:"https://images.unsplash.com/photo-1507838153414-b4b713384a76?q=80&w=1470&auto=format&fit=crop"},{id:"7",name:"陈奕迅",picUrl:"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1470&auto=format&fit=crop"},{id:"8",name:"五月天",picUrl:"https://images.unsplash.com/photo-1549213783-8284d0336c4f?q=80&w=1470&auto=format&fit=crop"},{id:"9",name:"毛不易",picUrl:"https://images.unsplash.com/photo-1598387993281-cecf8b71a8f8?q=80&w=1476&auto=format&fit=crop"},{id:"10",name:"李荣浩",picUrl:"https://images.unsplash.com/photo-1501386761578-eac5c94b800a?q=80&w=1470&auto=format&fit=crop"}]}};e.onMounted(()=>{E()}),e.onShow(()=>{c.setStatusBarTextColor("black"),O(),K(),G(),(()=>{var t;try{const o=e.index.getSystemInfoSync(),a=o.windowWidth/750;q.value=110*a,L.value=(null==(t=o.safeAreaInsets)?void 0:t.bottom)||0,console.log("[Index] 底部高度初始化:",{tabBarHeight:q.value,safeAreaBottom:L.value})}catch(o){console.error("[Index] 获取底部高度失败:",o)}})(),(()=>{e.index.$on("miniPlayerHeightChange",e=>{C.value=e.isShowing,k.value=e.height||0,console.log("[Index] MiniPlayer 状态变化:",e.isShowing,"高度:",e.height)});const t=o.playerStore.getState().currentSong;C.value=!(!t||!t.id)})();const t=o.playerStore.getState().currentSong;t&&t.id&&setTimeout(()=>{const t=e.index.getSystemInfoSync().windowWidth/750,o=140*t;0===q.value&&(q.value=110*t),C.value=!0,k.value=o,console.log("[Index] onShow 检测到有歌曲，强制更新底部高度:",o,"tabBarHeight:",q.value)},100)});const K=()=>{const t="true"===e.index.getStorageSync("darkMode");if("false"!==e.index.getStorageSync("followSystem")){const t=e.index.getSystemInfoSync();w.value="dark"===t.theme}else w.value=t;const o=w.value?"dark":"light";c.setAppTheme(o)},G=()=>{const t=e.index.getStorageSync("appNameIndex");b.value=""!==t&&null!=t&&parseInt(t,10)||0,console.log("[Index] 初始化APP名称:",I.value,"索引:",b.value)},O=()=>{const t="true"===e.index.getStorageSync("isAgreePact");if(console.log("[Index] 检查许可协议:",t?"已同意":"未同意"),t){T.value=!0,S.value=!1;if(!e.index.getStorageSync("pactAgreedTime")){const t=e.index.getStorageSync("appInstallTime")||Date.now();e.index.setStorageSync("pactAgreedTime",t),console.log("[Index] 补充保存协议同意时间:",new Date(t).toLocaleString())}}else S.value=!0,console.log("[Index] showPactModal 已设置为 true")},V=()=>{console.log("[Index] 用户同意许可协议"),e.index.setStorageSync("isAgreePact","true");const t=Date.now();e.index.setStorageSync("pactAgreedTime",t),console.log("[Index] 协议同意时间已保存:",new Date(t).toLocaleString()),T.value=!0,S.value=!1},F=()=>{console.log("[Index] 用户拒绝许可协议"),e.index.showModal({title:"提示",content:"您需要同意许可协议才能使用本应用。",showCancel:!1})},J=()=>{const t=Date.now(),o=t-v;if(console.log("[Index] APP Logo被点击，时间差:",o,"上次点击时间:",v),o>0&&o<300){console.log("[Index] 检测到双击，准备切换APP名称");const t=(b.value+1)%x.length;b.value=t,e.index.setStorageSync("appNameIndex",t),console.log("[Index] 切换APP名称成功:",I.value,"新索引:",t),e.index.showToast({title:`已切换为"${I.value}"`,icon:"none",duration:1500}),v=0}else v=t,console.log("[Index] 检测到单击，记录时间:",v)};e.onPullDownRefresh(async()=>{console.log("[Index] 下拉刷新开始"),e.index.showLoading({title:"刷新中...",mask:!0});try{_.value=[],$.value=[],P.value=[],D.value=[],B.value=[],await E(),e.index.showToast({title:"刷新成功",icon:"success",duration:1500})}catch(t){console.error("[Index] 下拉刷新失败:",t),e.index.showToast({title:"刷新失败",icon:"none",duration:1500})}finally{e.index.hideLoading(),e.index.stopPullDownRefresh(),console.log("[Index] 下拉刷新结束")}});const X=e=>e.map(e=>e.name).join(" / "),Y=async(t,o)=>{if(console.log("[Index] 播放新歌:",t.name,"索引:",o),!t||!t.id)return console.error("[Index] 歌曲对象无效:",t),void e.index.showToast({title:"歌曲信息无效",icon:"none"});await m.playSongCommon(t,{addToDefaultList:!0,source:t.source||"tx"})},Z=t=>{if(console.log("[Banner] 点击轮播图:",t),"kw"===t.source&&t.targetId){const e=[`id=${t.targetId}`,"source=kw","fromName=index",`name=${encodeURIComponent(t.typeTitle||"")}`,`picUrl=${encodeURIComponent(t.imageUrl||"")}`,`playCount=${t.playCount||""}`,`link=${encodeURIComponent(t.targetId)}`].join("&");return void oe(`/pages/sharelist/index?${e}`)}switch(t.targetType){case 1:e.index.showToast({title:"播放歌曲ID: "+t.targetId,icon:"none"});break;case 10:e.index.showToast({title:"专辑详情功能暂未开放",icon:"none"});break;case 1e3:e.index.showToast({title:"歌单详情功能暂未开放",icon:"none"});break;case 1004:e.index.showToast({title:"MV功能暂未开放",icon:"none"});break;case 3e3:t.url&&e.index.showToast({title:"外链暂不支持",icon:"none"});break;default:if(t.targetId){const e=[`id=${t.targetId}`,"source=kw","fromName=index",`name=${encodeURIComponent(t.typeTitle||"")}`,`picUrl=${encodeURIComponent(t.imageUrl||"")}`,`playCount=${t.playCount||""}`,`link=${encodeURIComponent(t.targetId)}`].join("&");oe(`/pages/sharelist/index?${e}`)}else e.index.showToast({title:"未知类型",icon:"none"})}},ee=async l=>{var c;if(console.log("[Banner] 播放按钮点击:",l),"kw"===l.source&&l.targetId){e.index.showLoading({title:"加载歌单中...",mask:!0});try{const d=await n.getListDetailDirect("kw",l.targetId,1);if(console.log("[Banner] 获取到歌单详情，歌曲数量:",null==(c=d.list)?void 0:c.length),!d.list||0===d.list.length)throw new Error("歌单为空");t.listStore.clearTempList();const m=`banner_${Date.now()}`;t.listStore.setTempList(m,d.list,{id:m,source:"kw",name:l.typeTitle||"歌单推荐"}),t.listStore.setPlayerListId(t.LIST_IDS.TEMP);const g=d.list[0],u=a.systemStore.getState().audioQuality||"128k";let p=await s.getCachedMusicUrl(g.id,u),h=null;if(p){const e=await r.getCachedLyric(g.id,"kw");e&&(h=e)}else{const e=await i.getMusicUrl({source:"kw",musicInfo:{id:g.id,name:g.name,singer:g.singer,source:"kw",songmid:g.songmid||g.id,interval:g.interval||g.duration,meta:{songId:g.id,albumName:g.album||"",hash:g.id}},quality:u});p=null==e?void 0:e.url,p&&(await s.setCachedMusicUrl(g.id,u,p),h={lyric:e.lyric||"",tlyric:e.tlyric||"",rlyric:e.rlyric||"",lxlyric:e.lxlyric||""})}if(!p)throw new Error("无法获取播放链接");const f={id:g.id,name:g.name,singer:g.singer,album:g.album,duration:g.duration,source:"kw",songmid:g.songmid,img:g.img||"",url:p,playUrl:p,quality:u,lyric:(null==h?void 0:h.lyric)||"",tlyric:(null==h?void 0:h.tlyric)||"",rlyric:(null==h?void 0:h.rlyric)||"",lxlyric:(null==h?void 0:h.lxlyric)||""};t.listStore.setPlayMusicInfo(t.LIST_IDS.TEMP,f,!1),o.playerStore.playSong(f),e.index.showToast({title:`正在播放: ${l.typeTitle||"歌单推荐"}`,icon:"none",duration:2e3})}catch(d){console.error("[Banner] 播放失败:",d),e.index.showToast({title:d.message||"加载失败",icon:"none",duration:2e3})}finally{e.index.hideLoading()}}else e.index.showToast({title:"开始播放",icon:"none"}),l.targetType},te=async t=>{if(console.log("[Banner] 收藏按钮点击:",t),"kw"!==t.source||!t.targetId)return void e.index.showToast({title:"暂不支持收藏此类型",icon:"none"});const o=`${t.source}__${t.targetId}`;let a=e.index.getStorageSync("imported_playlists")||[];const i=a.findIndex(e=>e.sourceListId===o);-1===i?e.index.showModal({title:"导入歌单",content:`是否将「${t.typeTitle}」导入到我的歌单？`,confirmText:"导入",cancelText:"取消",success:async i=>{var s,r;if(i.confirm){e.index.showLoading({title:"获取数据中..."});try{console.log("[Banner] 获取歌单详情:",t.source,t.targetId);const i=await n.getListDetailDirect(t.source,t.targetId,1),l=i.list||[];console.log("[Banner] 获取到歌曲:",l.length,"首");const c={id:o,name:t.typeTitle||(null==(s=i.info)?void 0:s.name)||"未知歌单",coverImgUrl:t.imageUrl||(null==(r=i.info)?void 0:r.img)||"",trackCount:l.length,source:t.source,sourceListId:o,link:t.targetId,platform:"酷我音乐",songs:l};a.push(c),e.index.setStorageSync("imported_playlists",a),e.index.showToast({title:`导入成功（${l.length}首）`,icon:"success"})}catch(l){console.error("[Banner] 导入失败:",l),e.index.showToast({title:"导入失败: "+(l.message||"未知错误"),icon:"none"})}finally{e.index.hideLoading()}}}}):e.index.showModal({title:"提示",content:`歌单「${a[i].name}」已存在，是否同步更新？`,confirmText:"更新",cancelText:"取消",success:async o=>{var s;if(o.confirm){e.index.showLoading({title:"更新中..."});try{const o=await n.getListDetailDirect(t.source,t.targetId,1),r=o.list||[];a[i].songs=r,a[i].trackCount=r.length,a[i].coverImgUrl=t.imageUrl||(null==(s=o.info)?void 0:s.img)||"",e.index.setStorageSync("imported_playlists",a),e.index.showToast({title:"更新成功",icon:"success"})}catch(r){console.error("[Banner] 更新失败:",r),e.index.showToast({title:"更新失败",icon:"none"})}finally{e.index.hideLoading()}}}})},oe=t=>{e.index.navigateTo({url:t})},ae=t=>{console.log("[Index] 点击热门歌手，跳转到搜索:",t),t?(e.index.setStorageSync("searchKeywordFromIndex",t),e.index.switchTab({url:"/pages/search/index"})):e.index.showToast({title:"歌手信息无效",icon:"none"})},ne=()=>{console.log("[Index] 点击热歌榜，跳转到排行榜页面"),e.index.setStorageSync("rank_temp_source","mg"),e.index.setStorageSync("rank_temp_boardId","mg__27186466"),e.index.navigateTo({url:"/pages/rank/index"})},ie=()=>{console.log("[Index] 点击新歌速递更多，跳转到排行榜QQ音乐新歌榜"),e.index.setStorageSync("rank_temp_source","tx"),e.index.setStorageSync("rank_temp_boardId","tx__27"),e.index.navigateTo({url:"/pages/rank/index"})},se=async()=>{var l;console.log("[Index] 点击每日推荐，开始获取随机歌单"),e.index.showLoading({title:"正在获取推荐...",mask:!0});try{const c="https://app.c.nf.migu.cn/pc/bmw/page-data/playlist-square-recommend/v1.0?templateVersion=2&pageNo=1",d=await e.index.request({url:c,method:"GET",header:{Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"}});if(200!==d.statusCode||"000000"!==d.data.code)throw new Error("获取推荐歌单失败");let m=[];if(d.data.data)if(d.data.data.contents){const e=new Set,t=o=>{for(const a of o)a.contents?t(a.contents):"2021"!=a.resType||e.has(a.resId)||(e.add(a.resId),m.push({id:String(a.resId),name:a.txt,coverImgUrl:a.img,source:"mg"}))};t(d.data.data.contents)}else d.data.data.contentItemList&&d.data.data.contentItemList[1]&&d.data.data.contentItemList[1].itemList&&d.data.data.contentItemList[1].itemList.forEach(e=>{m.push({id:String(e.logEvent.contentId),name:e.title,coverImgUrl:e.imageUrl,source:"mg"})});if(0===m.length)throw new Error("暂无推荐歌单");const g=Math.floor(Math.random()*Math.min(m.length,10)),u=m[g];console.log("[Index] 随机选择歌单:",u.name,"ID:",u.id);const p=await n.getListDetailDirect("mg",u.id,1);if(console.log("[Index] 获取到歌单详情，歌曲数量:",null==(l=p.list)?void 0:l.length),!p.list||0===p.list.length)throw new Error("歌单为空");t.listStore.clearTempList();const h=`daily_${Date.now()}`;t.listStore.setTempList(h,p.list,{id:h,source:"mg",name:u.name||"每日推荐"}),t.listStore.setPlayerListId(t.LIST_IDS.TEMP);const f=p.list[0],y=a.systemStore.getState().audioQuality||"128k",w={id:f.id,name:f.name,singer:f.singer,album:f.album||f.albumName||"",duration:f.duration,source:"mg",songmid:f.songmid||f.songId,copyrightId:f.copyrightId||f.id,img:f.img||"",url:"",playUrl:"",quality:y,lyric:"",tlyric:"",rlyric:"",lxlyric:""};t.listStore.setPlayMusicInfo(t.LIST_IDS.TEMP,w,!1),o.playerStore.setCurrentSong(w,!0),o.playerStore.setStatusText("正在获取播放链接...",0),console.log("[Daily] 已设置歌曲信息，MiniPlayer 将显示");let x=await s.getCachedMusicUrl(f.id,y),b=null;if(x){const e=await r.getCachedLyric(f.id,"mg");e&&(b=e)}else{const e=f.songmid||f.songId,t=f.copyrightId||f.id;console.log("[Daily] 咪咕音乐歌曲字段:",{songmid:f.songmid,songId:f.songId,copyrightId:f.copyrightId,id:f.id,"使用songmid":e,"使用copyrightId":t});const o=await i.getMusicUrl({source:"mg",songmid:e,id:t,musicInfo:{songmid:e,copyrightId:t,name:f.name,singer:f.singer||"",album:f.album||f.albumName||""},quality:y});x=null==o?void 0:o.url,x&&(await s.setCachedMusicUrl(f.id,y,x),b={lyric:o.lyric||"",tlyric:o.tlyric||"",rlyric:o.rlyric||"",lxlyric:o.lxlyric||""})}if(!x)throw new Error("无法获取播放链接");const I={...w,url:x,playUrl:x,lyric:(null==b?void 0:b.lyric)||"",tlyric:(null==b?void 0:b.tlyric)||"",rlyric:(null==b?void 0:b.rlyric)||"",lxlyric:(null==b?void 0:b.lxlyric)||""};t.listStore.setPlayMusicInfo(t.LIST_IDS.TEMP,I,!1),o.playerStore.playSong(I),e.index.showToast({title:`正在播放: ${u.name}`,icon:"none",duration:2e3})}catch(c){console.error("[Index] 每日推荐获取失败:",c),o.playerStore.clearStatusText(),e.index.showToast({title:c.message||"获取推荐失败",icon:"none",duration:2e3})}finally{e.index.hideLoading()}},re=t=>{let o="";const a=t.source||"tx";switch(a){case"kw":o=`https://www.kuwo.cn/playlist_detail/${t.id}`;break;case"kg":o=`https://www.kugou.com/yy/special/single/${t.id}.html`;break;case"tx":o=`https://y.qq.com/n/ryqq/playlist/${t.id}`;break;case"wy":o=`https://music.163.com/playlist?id=${t.id}`;break;case"mg":o=`https://music.migu.cn/v3/music/playlist/${t.id}`;break;default:o=t.id}e.index.navigateTo({url:`/pages/sharelist/index?source=${a}&link=${encodeURIComponent(o)}&id=${t.id}&picUrl=${encodeURIComponent(t.coverImgUrl||"")}&name=${encodeURIComponent(t.name||"")}&author=${encodeURIComponent(t.author||"")}&playCount=${t.playCount||0}&fromName=index`})},le=()=>{e.index.setStorageSync("fromSearchBar",!0),e.index.switchTab({url:"/pages/search/index"})},ce=e.computed(()=>c.getSafeAreaStyle()),de=e=>{f.value=e.detail.current},me=(e,t)=>{if(!t||!t.imageUrl)return;let o=0;t.imageUrl.includes("wsrv.nl")?o=1:t.imageUrl.includes("weserv.nl")?o=2:t.imageUrl.includes("jina.ai")&&(o=3);const a=d.handleImageError(e,t.imageUrl,o);a&&(t.imageUrl=a)};return u({t:l.t,banners:_,recommendPlaylists:$,newSongs:P,newAlbums:D,topArtists:B,currentBannerIndex:f,isLoadingMore:y,showMiniPlayer:U,showTabBar:!0,searchBarStyle:ce,formatPlayCount:e=>e<1e4?e.toString():e<1e8?Math.floor(e/1e4)+"万":Math.floor(e/1e8)+"亿",formatArtists:X,playSong:e=>{o.playerStore.playSong(e)},showSongOptions:t=>{e.index.showActionSheet({itemList:["添加到播放列表","下一首播放","收藏到歌单","分享","歌手："+X(t.artists),"专辑："+t.album.name],success:a=>{switch(a.tapIndex){case 0:o.playerStore.addToPlaylist(t),e.index.showToast({title:"已添加到播放列表",icon:"none"});break;case 1:o.playerStore.addToPlaylistAsNext(t),e.index.showToast({title:"已添加到下一首播放",icon:"none"});break;case 2:e.index.showToast({title:"收藏功能开发中",icon:"none"});break;case 3:e.index.share({provider:"weixin",scene:"WXSceneSession",type:0,title:t.name,summary:X(t.artists),imageUrl:t.album.picUrl,success:function(e){console.log("分享成功："+JSON.stringify(e))},fail:function(e){console.log("分享失败："+JSON.stringify(e))}});break;case 4:e.index.showToast({title:"歌手详情功能暂未开放",icon:"none"});break;case 5:e.index.showToast({title:"专辑详情功能暂未开放",icon:"none"})}}})},playNewSong:Y,formatDuration:e=>{if(!e||e<=0)return"00:00";const t=Math.floor(e/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},handleBannerClick:Z,playBanner:ee,collectBanner:te,navigateTo:oe,goToPlaylistDetail:re,goToSearch:le,goToSearchWithArtist:ae,goToHotSongs:ne,goToDailyRecommend:se,onBannerChange:de,handleBannerImageError:me,handleTabSwitch:j}),(t,o)=>({a:e.o(V),b:e.o(F),c:e.p({visible:S.value,isAgreed:T.value}),d:e.s(h.value),e:e.o(j),f:e.p({"current-index":0}),g:e.p({name:"leaf",size:"20",color:"#ffffff"}),h:e.t(I.value),i:e.o(J),j:e.p({name:"magnifying-glass",size:"20",color:"#999999"}),k:e.o(le),l:e.s(ce.value),m:e.f(_.value,(t,o,a)=>({a:t.imageUrl,b:e.o(e=>me(e,t),o),c:e.t(t.typeTitle),d:e.t(t.subtitle||"精选音乐，为你推荐"),e:"31670c42-4-"+a,f:e.o(e=>ee(t),o),g:"31670c42-5-"+a,h:e.o(e=>te(t),o),i:o,j:e.o(e=>Z(t),o),k:o===f.value?1:""})),n:e.p({name:"play",size:"18",color:"#ffffff"}),o:e.p({name:"heart",size:"18",color:"#ffffff"}),p:e.o(de),q:e.f(_.value,(t,o,a)=>({a:o,b:e.n({"indicator-dot-active":o===f.value})})),r:e.p({name:"heart",size:"22",color:"#ffffff"}),s:e.o(se),t:e.p({name:"ranking-star",size:"22",color:"#ffffff"}),v:e.o(e=>oe("/pages/rank/index")),w:e.p({name:"fire",size:"20",color:"#ffffff"}),x:e.o(ne),y:e.p({name:"list",size:"20",color:"#ffffff"}),z:e.o(e=>oe("/pages/songlist-list/index")),A:e.p({name:"chevron-right",size:"12",color:"#999999"}),B:e.o(e=>oe("/pages/songlist-list/index")),C:e.f($.value,(t,o,a)=>({a:t.coverImgUrl,b:"31670c42-11-"+a,c:e.t(t.name),d:t.id,e:e.o(e=>re(t),t.id)})),D:e.p({name:"play",size:"12",color:"#ffffff"}),E:e.p({name:"chevron-right",size:"12",color:"#999999"}),F:e.o(ie),G:e.f(P.value,(t,o,a)=>({a:t.img,b:e.t(t.name),c:e.t(t.singer),d:e.t(t.album),e:t.id,f:e.o(e=>Y(t,o),t.id)})),H:e.f(B.value,(t,o,a)=>({a:t.picUrl,b:e.t(t.name),c:t.id,d:e.o(e=>ae(t.name),t.id)})),I:e.s(M.value),J:e.p({"current-index":0}),K:w.value?1:""})}};wx.createPage(h);
