"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/musicSourceStorage.js"),a=require("../../utils/system.js"),s=require("../../utils/config.js");if(require("../../store/modules/list.js"),require("../../store/modules/player.js"),!Array){e.resolveComponent("roc-icon-plus")()}Math;const o={__name:"index",setup(o){const i=e.ref("9:41"),n=e.ref(null),r=e.computed(()=>{const t="true"===e.index.getStorageSync("darkMode");return console.log("[music-sources] isDarkMode:",t),t}),c=e.ref(a.getStatusBarHeight()),l=e.computed(()=>({height:`${c.value}px`,width:"100%",backgroundColor:"transparent"})),d=e.ref(!1),u=e.ref([]),p=e.ref([]),m=()=>{e.index.navigateBack()},f=async a=>{e.index.showModal({title:"确认删除",content:`确定要删除音源"${a.name}"吗？`,confirmColor:"#ff4d4f",success:async o=>{if(o.confirm){const o=`${a.name} ${a.version}`;e.index.showLoading({title:"删除中...",mask:!0});try{const i=await e.index.request({url:`${s.getServerUrl()}/api/scripts/delete`,method:"POST",header:{"Content-Type":"application/json"},data:{id:a.id}});e.index.hideLoading();const n=i.data;if(200===n.code&&n.data&&n.data.success){n.data.scripts&&(u.value=n.data.scripts.map(e=>({id:e.id,name:e.name,type:e.isDefault?"official":"custom",version:e.version||"1.0.0",developer:e.author||"未知开发者",updateDate:e.createdAt||(new Date).toLocaleDateString(),description:e.description||"远程音源",updateNotify:!0,selected:e.isDefault})),t.saveMusicSources(u.value));const a={type:"delete",text:`删除音源 ${o}`,textHtml:`删除音源 <strong>${o}</strong>`,time:(new Date).toLocaleTimeString()};p.value.unshift(a),t.addActivity(a),e.index.showToast({title:n.msg||"删除成功",icon:"success"})}else e.index.showToast({title:n.msg||"删除失败",icon:"none"})}catch(i){e.index.hideLoading(),console.error("删除音源失败:",i),e.index.showToast({title:"删除失败，请检查网络",icon:"none"})}}}})},v=e.ref(""),h=e.ref(!0),g=e.ref(""),y=e.ref(!1),x=()=>{v.value="",h.value=!0,g.value="",y.value=!1,d.value=!0},w=()=>{e.index.showModal({title:"提示",content:"此功能暂不支持",showCancel:!1,confirmText:"确定"})},S=()=>{d.value=!1},D=async()=>{if(v.value.trim()){y.value=!0;try{const a=(await e.index.request({url:`${s.getServerUrl()}/api/scripts/import/url`,method:"POST",header:{"Content-Type":"application/json"},data:{url:v.value.trim()}})).data;if(200===a.code&&a.data&&a.data.success){a.data.scripts&&(u.value=a.data.scripts.map(e=>({id:e.id,name:e.name,type:e.isDefault?"official":"custom",version:e.version||"1.0.0",developer:e.author||"未知开发者",updateDate:e.createdAt||(new Date).toLocaleDateString(),description:e.description||"远程音源",updateNotify:!0,selected:e.isDefault})),t.saveMusicSources(u.value));const s={type:"add",text:"导入音源成功",textHtml:"导入音源 <strong>成功</strong>",time:(new Date).toLocaleTimeString()};p.value.unshift(s),t.addActivity(s),e.index.showToast({title:a.msg||"导入成功",icon:"success"}),S()}else e.index.showToast({title:a.msg||"导入失败",icon:"none"})}catch(a){console.error("导入音源失败:",a),e.index.showModal({title:"导入失败",content:a.message||"网络错误，请检查网络连接",showCancel:!1,confirmText:"确定"})}finally{y.value=!1}}else e.index.showToast({title:"请输入音源URL",icon:"none"})};return e.onMounted(()=>{(()=>{const e=()=>{const e=new Date,t=e.getHours(),a=e.getMinutes();i.value=`${t}:${a<10?"0"+a:a}`};e(),setInterval(e,6e4)})(),(()=>{const a=s.getServerUrl();e.index.request({url:`${a}/api/scripts/loaded`,method:"GET",success:e=>{if(e.data&&200===e.data.code){const a=e.data.data||[];console.log("[音源管理] 获取音源列表成功:",a),u.value=a.map(e=>({id:e.id,name:e.name,version:e.version||"1.0.0",developer:e.author||"未知开发者",updateDate:e.updateTime||(new Date).toLocaleDateString(),description:e.description||"远程音源",isDefault:e.isDefault||!1,selected:e.isDefault||!1})),t.saveMusicSources(u.value)}else console.error("[音源管理] 获取音源列表失败:",e.data),u.value=t.getMusicSources()},fail:e=>{console.error("[音源管理] 获取音源列表请求失败:",e),u.value=t.getMusicSources()}})})(),p.value=t.getActivities(),e.index.getStorageSync("music_sources_initialized")||e.index.setStorageSync("music_sources_initialized",!0),a.setStatusBarTextColor("black")}),(a,o)=>e.e({a:e.s(l.value),b:e.p({type:"fas",name:"chevron-left",size:"20",color:"#4b5563"}),c:e.o(m),d:0===u.value.length},0===u.value.length?{e:e.p({type:"fas",name:"music",size:"48",color:"#00d7cd"})}:{f:e.f(u.value,(a,o,i)=>e.e({a:"92af1ee3-2-"+i,b:e.t(a.name),c:e.t(a.version),d:"92af1ee3-3-"+i,e:e.t(a.developer),f:"92af1ee3-4-"+i,g:e.t(a.updateDate),h:"92af1ee3-5-"+i,i:e.t(a.description),j:a.selected},a.selected?{k:"92af1ee3-6-"+i,l:e.p({type:"fas",name:"check-circle",size:"18",color:"#6dc380"})}:{},{m:e.o(t=>(t=>{n.value=t.id,e.index.showActionSheet({itemList:["删除音源"],itemColor:"#ff4d4f",success:e=>{0===e.tapIndex&&f(t)}})})(a),a.id),n:a.id,o:a.selected?1:"",p:e.o(o=>(async a=>{const o=s.getServerUrl();e.index.showLoading({title:"设置中...",mask:!0});try{const s=await e.index.request({url:`${o}/api/scripts/default`,method:"POST",header:{"Content-Type":"application/json"},data:{id:a}});e.index.hideLoading();const i=s.data;if(200===i.code&&i.data&&i.data.success){const s=u.value.find(e=>e.id===a),o=s?s.name:"未知音源";u.value=u.value.map(e=>({...e,selected:e.id===a,isDefault:e.id===a})),t.saveMusicSources(u.value);const i={type:"update",text:`设置默认音源 ${o}`,textHtml:`设置默认音源 <strong>${o}</strong>`,time:(new Date).toLocaleTimeString()};p.value.unshift(i),t.addActivity(i),e.index.showToast({title:"设置成功",icon:"success"})}else e.index.showToast({title:i.msg||"设置失败",icon:"none"})}catch(i){e.index.hideLoading(),console.error("[音源管理] 设置默认音源失败:",i),e.index.showToast({title:"设置失败，请检查网络",icon:"none"})}})(a.id),a.id)})),g:e.p({type:"fas",name:"music",size:"20",color:"#00d7cd"}),h:e.p({type:"fas",name:"user",size:"12",color:"#999"}),i:e.p({type:"fas",name:"calendar-alt",size:"12",color:"#999"}),j:e.p({type:"fas",name:"comment-alt",size:"12",color:"#999"})},{k:e.p({type:"fas",name:"cloud-download-alt",size:"20",color:"#0084ff"}),l:e.o(x),m:e.p({type:"fas",name:"file-import",size:"20",color:"#00d7cd"}),n:e.o(w),o:0===p.value.length},0===p.value.length?{p:e.p({type:"fas",name:"history",size:"48",color:"#7b68ee"})}:{q:e.f(p.value,(t,a,s)=>{return{a:"92af1ee3-10-"+s,b:e.p({type:"fas",name:(o=t.type,{add:"plus",update:"sync",edit:"edit",delete:"trash-alt",share:"share-alt"}[o]||"circle"),size:"14"}),c:e.n(t.type),d:t.textHtml,e:e.t(t.time),f:a};var o})},{r:d.value},d.value?e.e({s:e.p({type:"fas",name:"times",size:"20",color:"#999"}),t:e.o(S),v:y.value,w:v.value,x:e.o(e=>v.value=e.detail.value),y:e.o(S),z:y.value?1:"",A:y.value},y.value?{B:e.p({type:"fas",name:"spinner",size:"16",color:"#fff"})}:{},{C:e.o(D),D:y.value||!v.value.trim()?1:"",E:e.o(()=>{}),F:e.o(S)}):{},{G:r.value?1:""})}},i=e._export_sfc(o,[["__scopeId","data-v-92af1ee3"]]);wx.createPage(i);
