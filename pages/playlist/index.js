"use strict";const e=require("../../common/vendor.js"),l=require("../../utils/system.js"),o=require("../../store/modules/list.js"),t=require("../../store/modules/player.js"),a=require("../../store/modules/system.js"),i=require("../../utils/playInfoStorage.js"),s=require("../../utils/api/music.js"),n=require("../../utils/api/songlist.js"),r=require("../../utils/api/songlist-direct.js"),u=require("../../utils/musicUrlCache.js"),c=require("../../utils/lyricCache.js"),d=require("../../utils/musicSwitchSourceStorage.js"),v=require("../../utils/imageProxy.js");Math||(m+I+g+y+f+p+S)();const m=()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js",g=()=>"../../components/common/CustomTabBar.js",y=()=>"../../components/player/MiniPlayer.js",f=()=>"../../components/player/MusicToggleModal.js",p=()=>"../../components/common/AutoUpdateToast.js",S=()=>"../../components/common/LoadingToast.js",I=()=>"../../components/common/VirtualList.js",h="listPrevSelectId",P={__name:"index",setup(m){const g=e.ref(!1);e.computed(()=>l.getSafeAreaStyle());const y=e.ref(l.getStatusBarHeight());e.ref(l.getNavbarHeight());const f=e.computed(()=>({paddingTop:`${y.value}px`})),p=e.computed(()=>({paddingTop:`${y.value}px`})),S=e.computed(()=>o.listStore.state.defaultList.list.length),I=e.computed(()=>o.listStore.state.loveList.list.length),P=e.ref(!1),L=e.ref(""),U=e.ref(""),x=e.ref(""),T=e.ref(""),w=e.ref(!1),D=e.ref(null),b=e.ref(-1),_=e.ref(!1),k=e.ref(null),A=e.ref(-1),C=e.ref("custom"),E=e.ref(!1),F=e.ref(null),M=e.ref(!1),$=e.ref(""),j=e.ref(!1),q=e.ref("加载中"),O=e.ref(""),N=e.ref(!1),V=e.ref([]),z=e.ref(""),R=e.ref([]),W=e.ref(new Set),B=e.ref(!1),Q=e.ref(!1),H=l=>{try{e.index.setStorageSync(h,l),console.log("[Playlist] 保存上次选择的歌单ID:",l)}catch(o){console.error("[Playlist] 保存歌单ID失败:",o)}},J=e.ref(!1),K=e.ref(0);e.computed(()=>{const l=K.value;if(J.value){const o=e.index.getSystemInfoSync().windowWidth/750*140;return{height:`${o-o/10+l}px`}}return{height:`${l}px`}});const X=()=>{B.value="true"===e.index.getStorageSync("darkMode"),console.log("[Playlist] 初始化暗黑模式:",B.value)},G=()=>{R.value=o.listStore.state.userLists.map(e=>({id:e.id,name:e.name,coverImgUrl:e.coverImgUrl||"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80",trackCount:e.list?e.list.length:0}))};e.watch(()=>o.listStore.state.userLists,()=>{G()},{deep:!0}),e.onMounted(()=>{X(),G(),console.log("[Playlist] ====== onMounted 快速初始化 ======"),"undefined"!=typeof requestAnimationFrame?requestAnimationFrame(()=>{setTimeout(()=>{Qe()},100)}):setTimeout(()=>{Qe()},200)});const Y=e.ref("trial"),Z=e.reactive({id:"trial",name:"试听列表",coverImgUrl:"",creator:{nickname:"拼好歌官方",avatarUrl:""},description:"试听列表，存放您最近试听的歌曲",trackCount:0,playCount:0}),ee=e.ref([]),le=e.ref(!1),oe=e=>Array.isArray(e)?e.map(e=>{if(e._switchSourceApplied)return e;const l=String(e.id||""),o=l.replace(/^(tx|wy|kg|kw|mg)_/,"")||l,t=d.getMusicSwitchSourceById(o);return t&&t.newSource?(console.log("[applySwitchSourceToSongs] 恢复歌曲换源信息:",e.name,"换源后:",t.newSource),{...e,source:t.newSource,id:t.newSongId||e.id,name:t.newSongName||e.name,singer:t.newSongSinger||e.singer,url:t.url||"",_switchSourceApplied:!0}):e}):e,te=l=>{if(!Array.isArray(l))return console.warn("[Playlist] setSongList: allSongs 不是数组",typeof l,l),ee.value=[],void(j.value=!1);const o=l.length;console.log("[Playlist] setSongList: 准备加载",o,"首歌曲");const t=oe(l);o>100?(j.value=!0,q.value="正在加载",O.value=`${o}首歌曲`,e.nextTick$1(()=>{ee.value=t,setTimeout(()=>{j.value=!1},300)})):ee.value=t,console.log(`[Playlist] 已设置歌曲列表，共 ${o} 首`)},ae=e.computed(()=>t.playerStore.state.isPlaying),ie=e.computed(()=>t.playerStore.state.isPlaying),se=e.computed(()=>{const e=o.listStore.state.playInfo.playerListId,l=o.listStore.state.tempList.meta,t=e===o.LIST_IDS.TEMP&&l.id===Y.value;if(e!==("trial"===Y.value||Y.value===o.LIST_IDS.DEFAULT?o.LIST_IDS.DEFAULT:"favorite"===Y.value||Y.value===o.LIST_IDS.LOVE?o.LIST_IDS.LOVE:Y.value)&&!t)return-1;const a=o.listStore.state.playInfo.playIndex;return a>=0&&a<ee.value.length?a:-1});e.computed(()=>se.value>=0&&ee.value.length>se.value?ee.value[se.value]:null);const ne=e.ref(0),re=e.ref(""),ue=e.ref(null),ce=e.computed(()=>{const l=(e.index.getSystemInfoSync().windowHeight||667)-y.value-44-50-(J.value?56:0)-K.value;return`${Math.max(l,300)}px`}),de=e=>{},ve=({index:e,item:l})=>{console.log("[VirtualList] 点击歌曲:",e,l.name),Te(e)},me=({index:e,item:l})=>{console.log("[VirtualList] 点击更多:",e,l.name),De(l,e)},ge=()=>{g.value=!g.value,g.value&&(console.log("========== [Sidebar] 侧边栏打开 =========="),console.log("[Sidebar] 当前选中歌单 currentPlaylistId:",Y.value),console.log("[Sidebar] 已导入歌单数量:",V.value.length),V.value.forEach((e,l)=>{console.log(`[Sidebar] [${l}] id="${e.id}" name="${e.name}" platform="${e.platform}" active=${Y.value===e.id}`)}),console.log("=========================================="))},ye=()=>{g.value=!1},fe=(e,l,o)=>{if(!l||!l.coverImgUrl)return;let t=0;l.coverImgUrl.includes("wsrv.nl")?t=1:l.coverImgUrl.includes("weserv.nl")?t=2:l.coverImgUrl.includes("jina.ai")&&(t=3);const a=v.handleImageError(e,l.coverImgUrl,t);a&&(l.coverImgUrl=a)},pe=()=>{console.log("[saveImportedPlaylist] 开始保存，歌单ID:",Y.value);const l=V.value.findIndex(e=>e.id===Y.value);if(l>-1){console.log("[saveImportedPlaylist] 找到歌单，索引:",l),V.value[l].songs=[...ee.value],V.value[l].trackCount=ee.value.length,console.log("[saveImportedPlaylist] 更新后的歌曲数量:",V.value[l].trackCount),e.index.setStorageSync("imported_playlists",V.value),console.log("[saveImportedPlaylist] 本地存储已保存");const o=[...V.value];V.value=o,console.log("[saveImportedPlaylist] 已触发响应式更新")}else console.warn("[saveImportedPlaylist] 未找到要保存的歌单，歌单ID:",Y.value)},Se=(e,l=!1)=>{if(N.value)console.log("[Playlist] 歌单正在加载中，阻止切换");else{if(console.log("========== [Playlist] selectPlaylist 被调用 =========="),console.log("[Playlist] 传入的 playlistId:",e,"forceReload:",l),console.log("[Playlist] 当前 currentPlaylistId:",Y.value),Y.value===e&&!l)return console.log("[Playlist] 歌单已选中，关闭侧边栏"),void(g.value=!1);if(Y.value=e,g.value=!1,H(e),"trial"===e||e===o.LIST_IDS.DEFAULT)Z.id=o.LIST_IDS.DEFAULT,Z.name="试听列表",Z.description="试听列表，存放您最近试听的歌曲",z.value="";else if("favorite"===e||e===o.LIST_IDS.LOVE)Z.id=o.LIST_IDS.LOVE,Z.name="我的收藏",Z.description="您收藏的歌曲",z.value="";else if(e.startsWith("custom_")||e.startsWith("userlist_")){const l=o.listStore.state.userLists.find(l=>l.id===e);if(l){console.log("[Playlist] 选择自定义歌单:",l.name),Z.id=l.id,Z.name=l.name,Z.coverImgUrl=l.coverImgUrl||"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80",Z.description="自定义歌单",z.value="custom";const e=l.list||[];return te(e),ne.value=0,void console.log("[Playlist] 自定义歌单歌曲数:",e.length)}}ee.value=[],Ue()}},Ie=[{name:"网易云音乐",source:"wy"},{name:"QQ音乐",source:"tx"},{name:"酷狗音乐",source:"kg"},{name:"酷我音乐",source:"kw"},{name:"咪咕音乐",source:"mg"}],he=()=>{e.index.showModal({title:"新建歌单",editable:!0,placeholderText:"你想起啥名...",success:l=>{if(l.confirm&&l.content){const t=l.content.trim();if(!t)return void e.index.showToast({title:"歌单名称不能为空",icon:"none"});if(o.listStore.state.userLists.some(e=>e.name===t))return void e.index.showModal({title:"提示",content:"已存在同名歌单，是否继续创建？",success:e=>{e.confirm&&Pe(t)}});Pe(t)}}})},Pe=l=>{const t=o.listStore.createUserList(l);t&&(G(),g.value=!0,e.index.showToast({title:"创建成功",icon:"success"}),console.log("[createNewPlaylist] 新建歌单成功:",t.name,"ID:",t.id))},Le=()=>{e.index.showActionSheet({itemList:Ie.map(e=>e.name),success:e=>{const l=Ie[e.tapIndex];x.value=l.source,T.value=l.name,L.value=`从${l.name}导入`,U.value="",P.value=!0}})},Ue=async()=>{var l;if(!le.value){le.value=!0;try{if("trial"===Y.value||Y.value===o.LIST_IDS.DEFAULT)console.log("[fetchSongs] 从试听列表获取歌曲，数量:",o.listStore.state.defaultList.list.length),ee.value=oe([...o.listStore.state.defaultList.list]);else if("favorite"===Y.value||Y.value===o.LIST_IDS.LOVE)console.log("[fetchSongs] 从收藏列表获取歌曲，数量:",o.listStore.state.loveList.list.length),ee.value=oe([...o.listStore.state.loveList.list]);else if(Y.value.startsWith("custom_")||Y.value.startsWith("userlist_")){const e=o.listStore.state.userLists.find(e=>e.id===Y.value);console.log("[fetchSongs] 从自定义歌单获取歌曲，歌单ID:",Y.value,"歌曲数量:",(null==(l=null==e?void 0:e.list)?void 0:l.length)||0),e&&e.list?ee.value=oe([...e.list]):ee.value=[]}else{const l=(e.index.getStorageSync("imported_playlists")||[]).find(e=>e.id===Y.value);l&&l.songs?(console.log("[fetchSongs] 从导入的歌单获取歌曲，歌单ID:",Y.value,"歌曲数量:",l.songs.length),ee.value=oe([...l.songs])):(console.log("[fetchSongs] 未找到导入歌单数据"),ee.value=[])}console.log("[fetchSongs] 加载完成，共:",ee.value.length,"首")}catch(t){console.error("[fetchSongs] 获取歌曲列表失败:",t)}finally{le.value=!1}}},xe=()=>{console.log("[Playlist] onScrollToLower 触发，已加载全部",ee.value.length,"首歌曲")},Te=l=>{if(se.value===l)return void(ae.value?t.playerStore.pause():t.playerStore.resume());const i="trial"===Y.value||Y.value===o.LIST_IDS.DEFAULT?o.LIST_IDS.DEFAULT:"favorite"===Y.value||Y.value===o.LIST_IDS.LOVE?o.LIST_IDS.LOVE:Y.value;o.listStore.setPlayerListId(i),(async l=>{var i,n,r,d,v,m,g,y;const f=ee.value[l];if(f){console.log("[Playlist] ========== 开始播放歌曲 =========="),console.log("[Playlist] 歌曲索引:",l),console.log("[Playlist] 歌曲名称:",f.name);try{const e=a.systemStore.getState().audioQuality||"128k";let l="trial"===Y.value||Y.value===o.LIST_IDS.DEFAULT?o.LIST_IDS.DEFAULT:"favorite"===Y.value||Y.value===o.LIST_IDS.LOVE?o.LIST_IDS.LOVE:null;ee.value.length>0&&(console.log("[Playlist] 播放歌曲，设置临时列表"),o.listStore.setTempList(Y.value,ee.value,{id:Z.id,source:z.value||"",name:Z.name}),l=o.LIST_IDS.TEMP),l||(l=o.LIST_IDS.DEFAULT),console.log("[Playlist] 列表ID:",l),o.listStore.setPlayerListId(l);const p={id:f.id,name:f.name,singer:f.ar?f.ar.map(e=>e.name).join("/"):f.singer||"",album:(null==(i=f.al)?void 0:i.name)||f.albumName||f.album||"",duration:f.dt||f.interval||f.duration,source:f.source||"tx",songmid:f.songmid,hash:f.hash,copyrightId:f.copyrightId,img:(null==(n=f.al)?void 0:n.picUrl)||f.img||f.albumPic||"",url:"",playUrl:"",quality:e,lyric:f.lyric||"",tlyric:f.tlyric||"",rlyric:f.rlyric||"",lxlyric:f.lxlyric||""};o.listStore.setPlayMusicInfo(l,p,!1),t.playerStore.setCurrentSong(p,!0),t.playerStore.setStatusText("正在获取播放链接...",0),console.log("[Playlist] 已设置歌曲信息，MiniPlayer 将显示");const S=await u.getCachedMusicUrl(f.id,e);let I=S,h=null;if((f.lyric||f.tlyric||f.rlyric||f.lxlyric)&&(h={lyric:f.lyric||"",tlyric:f.tlyric||"",rlyric:f.rlyric||"",lxlyric:f.lxlyric||""}),S){if(!h){const e=await c.getCachedLyric(f.id,f.source||"tx");e?(h=e,console.log("[Playlist] 从缓存获取歌词:",f.id)):(h={},console.log("[Playlist] 歌词缓存未命中:",f.id))}}else{const l=f.source||"tx";let o=f.id,t={};switch(console.log("[Playlist] playSongFromList 构建请求参数:"),console.log("[Playlist] song.source:",f.source),console.log("[Playlist] song.id:",f.id),console.log("[Playlist] song.songmid:",f.songmid),console.log("[Playlist] song.hash:",f.hash),console.log("[Playlist] song.copyrightId:",f.copyrightId),l){case"tx":o=f.songmid||f.id,t={source:"tx",musicInfo:{id:o,name:f.name,singer:f.ar?f.ar.map(e=>e.name).join("/"):f.singer||"",source:"tx",interval:f.dt?Oe(f.dt):f.interval||"",meta:{songId:o,albumName:(null==(r=f.al)?void 0:r.name)||f.albumName||f.album||""}},quality:e};break;case"mg":o=f.songmid||f.songId||f.id;const a=f.copyrightId||f.id;console.log("[Playlist] 咪咕音乐 - 使用 songmid:",o,"copyrightId:",a),t={source:"mg",songmid:o,id:a,musicInfo:{songmid:o,copyrightId:a,name:f.name,singer:f.ar?f.ar.map(e=>e.name).join("/"):f.singer||"",album:(null==(d=f.al)?void 0:d.name)||f.albumName||f.album||""},quality:e};break;case"kg":o=f.hash||f.id,t={source:"kg",musicInfo:{id:o,name:f.name,singer:f.ar?f.ar.map(e=>e.name).join("/"):f.singer||"",source:"kg",interval:f.dt?Oe(f.dt):f.interval||"",meta:{songId:o,albumName:(null==(v=f.al)?void 0:v.name)||f.albumName||f.album||"",hash:f.hash||f.id}},quality:e};break;case"kw":t={source:"kw",musicInfo:{id:f.id,name:f.name,singer:f.ar?f.ar.map(e=>e.name).join("/"):f.singer||"",source:"kw",interval:f.dt?Oe(f.dt):f.interval||"",meta:{songId:f.id,albumName:(null==(m=f.al)?void 0:m.name)||f.albumName||f.album||""}},quality:e};break;case"wy":t={source:"wy",musicInfo:{id:f.id,name:f.name,singer:f.ar?f.ar.map(e=>e.name).join("/"):f.singer||"",source:"wy",interval:f.dt?Oe(f.dt):f.interval||"",meta:{songId:f.id,albumName:(null==(g=f.al)?void 0:g.name)||f.albumName||f.album||""}},quality:e};break;default:t={source:l,musicInfo:{id:f.id,name:f.name,singer:f.ar?f.ar.map(e=>e.name).join("/"):f.singer||"",source:l,interval:f.dt?Oe(f.dt):f.interval||"",meta:{songId:f.id,albumName:(null==(y=f.al)?void 0:y.name)||f.albumName||f.album||""}},quality:e}}console.log("[Playlist] 请求播放URL，参数:",JSON.stringify(t));const a=await s.getMusicUrl(t);I=a.url,await u.setCachedMusicUrl(f.id,e,I),h={lyric:a.lyric||(null==h?void 0:h.lyric)||"",tlyric:a.tlyric||(null==h?void 0:h.tlyric)||"",rlyric:a.rlyric||(null==h?void 0:h.rlyric)||"",lxlyric:a.lxlyric||(null==h?void 0:h.lxlyric)||""},(h.lyric||h.tlyric||h.rlyric||h.lxlyric)&&(await c.setCachedLyric(f.id,f.source||"tx",h),console.log("[Playlist] 歌词已缓存:",f.id))}const P={...p,url:I,playUrl:I,lyric:(null==h?void 0:h.lyric)||f.lyric||"",tlyric:(null==h?void 0:h.tlyric)||f.tlyric||"",rlyric:(null==h?void 0:h.rlyric)||f.rlyric||"",lxlyric:(null==h?void 0:h.lxlyric)||f.lxlyric||""};console.log("[Playlist] 更新播放音乐信息:",P.name,"ID:",P.id),o.listStore.setPlayMusicInfo(l,P,!1),console.log("[Playlist] 调用 playerStore.playSong"),t.playerStore.playSong(P),console.log("[Playlist] 播放完成")}catch(p){console.error("[Playlist] 播放失败:",p),t.playerStore.clearStatusText(),e.index.showToast({title:"播放失败",icon:"none"})}}})(l)},we=async()=>{var l;console.log("[locateCurrentSong] ========== 开始定位当前歌曲 ==========");const t=o.listStore.state.playInfo.playIndex,a=o.listStore.state.playInfo.playerListId,i=o.listStore.state.tempList.meta;console.log("[locateCurrentSong] 播放索引:",t,"列表ID:",a),console.log("[locateCurrentSong] 当前列表歌曲数:",ee.value.length);const s="trial"===Y.value||Y.value===o.LIST_IDS.DEFAULT?o.LIST_IDS.DEFAULT:"favorite"===Y.value||Y.value===o.LIST_IDS.LOVE?o.LIST_IDS.LOVE:Y.value,n=a===o.LIST_IDS.TEMP&&i.id===Y.value;if(a!==s&&!n)return console.warn("[locateCurrentSong] 当前没有播放本列表的歌曲"),void e.index.showToast({title:"当前没有播放本列表的歌曲",icon:"none"});if(t<0||t>=ee.value.length)return console.warn("[locateCurrentSong] 播放索引无效:",t,"列表长度:",ee.value.length),void e.index.showToast({title:"无法定位当前歌曲",icon:"none"});if(console.log("[locateCurrentSong] 目标歌曲索引:",t,"名称:",null==(l=ee.value[t])?void 0:l.name),ue.value)console.log("[locateCurrentSong] 使用虚拟列表 scrollToIndex:",t),ue.value.scrollToIndex(t,!0);else{const l=`virtual-item-${t}`;re.value="",await e.nextTick$1(),re.value=l,console.log("[locateCurrentSong] 降级使用 scrollIntoViewId:",l)}e.index.showToast({title:`已定位到第${t+1}首`,icon:"none",duration:1500}),console.log("[locateCurrentSong] ========== 定位完成 ==========")},De=(e,l)=>{D.value=e,b.value=l,w.value=!0},be=(e=!0)=>{w.value=!1,e&&(D.value=null,b.value=-1)},_e=(e,l,o="custom")=>{console.log("[showPlaylistContextMenu] 显示歌单菜单，歌单:",e.name,"ID:",e.id,"类型:",o),console.log("[showPlaylistContextMenu] 歌单完整信息:",JSON.stringify(e)),console.log("[showPlaylistContextMenu] canAutoUpdate:",e.canAutoUpdate,"isFromImport:",e.isFromImport),k.value=e,A.value=l,C.value=o,_.value=!0},ke=()=>{_.value=!1,k.value=null,A.value=-1,C.value="custom"},Ae=()=>{if(!k.value)return;const l=k.value,t=C.value,a=l.name,i=l.id,s=l.coverImgUrl||"";ke(),e.index.showModal({title:"重命名歌单",editable:!0,placeholderText:"请输入新名称",success:l=>{if(l.confirm&&l.content){const n=l.content.trim();if(!n)return void e.index.showToast({title:"名称不能为空",icon:"none"});if(n.length>100)return void e.index.showToast({title:"名称不能超过100个字符",icon:"none"});if(n===a)return void e.index.showToast({title:"名称未改变",icon:"none"});if(console.log("[renamePlaylist] 重命名歌单:",a,"->",n,"类型:",t),"imported"===t){const l=V.value.findIndex(e=>e.id===i);l>-1&&(V.value[l]={...V.value[l],name:n},e.index.setStorageSync("imported_playlists",V.value),console.log("[renamePlaylist] 导入歌单已重命名并保存"),V.value=[...V.value])}else o.listStore.updateUserList([{id:i,name:n,coverImgUrl:s}]),G();e.index.showToast({title:"重命名成功",icon:"success"})}}})},Ce=()=>{if(!k.value)return;const l="imported"===C.value;e.index.showModal({title:"提示",content:`确定删除歌单"${k.value.name}"吗？${l?"将从导入列表中移除，歌曲不会删除。":"删除后无法恢复。"}`,confirmText:"删除",confirmColor:"#ff4d4f",success:t=>{if(t.confirm){console.log("[removePlaylist] 开始移除歌单:",k.value.name,"ID:",k.value.id,"类型:",C.value);const t=o.listStore.state.playInfo.playerListId===k.value.id;if(Y.value===k.value.id&&(console.log("[removePlaylist] 当前正在查看该歌单，清空列表并切换到试听列表"),ee.value=[],Y.value="",Se("trial")),t){console.log("[removePlaylist] 播放器正在播放该歌单，更新播放列表"),o.listStore.setPlayerListId(o.LIST_IDS.DEFAULT);const e=o.listStore.state.defaultList.list;e.length>0?o.listStore.setPlayMusicInfo(o.LIST_IDS.DEFAULT,e[0],!1):o.listStore.setPlayMusicInfo(o.LIST_IDS.DEFAULT,null,!1)}if(l){console.log("[removePlaylist] 从导入歌单中移除");const l=V.value.findIndex(e=>e.id===k.value.id);l>-1&&(V.value.splice(l,1),e.index.setStorageSync("imported_playlists",V.value),console.log("[removePlaylist] 已从导入列表移除并保存，本地存储剩余:",V.value.length,"个"),V.value=[...V.value])}else console.log("[removePlaylist] 从自定义歌单中移除"),o.listStore.removeUserList([k.value.id]),G();ke(),e.index.showToast({title:"已删除",icon:"success"})}}})},Ee=e=>e&&Array.isArray(e)?e.map(e=>{var l,o;const t={id:e.id,name:e.name,singer:e.singer||(e.ar?e.ar.map(e=>e.name).join("/"):""),album:e.album||e.albumName||(e.al?e.al.name:""),duration:e.duration||e.dt||e.interval,dt:e.dt||e.duration||e.interval,interval:e.interval||e.dt||e.duration,source:e.source};return e.songmid&&(t.songmid=e.songmid),e.hash&&(t.hash=e.hash),e.copyrightId&&(t.copyrightId=e.copyrightId),(e.img||e.albumPic||(null==(l=e.al)?void 0:l.picUrl))&&(t.img=e.img||e.albumPic||(null==(o=e.al)?void 0:o.picUrl)),t}):[],Fe=()=>{if(!k.value||"imported"!==C.value)return;const l=k.value;l.link?e.index.showModal({title:"同步歌单",content:`确定要同步歌单"${l.name}"吗？\n\n同步操作将会：\n• 重新从源头获取最新歌单内容\n• 完全覆盖当前歌单\n• 清除所有播放进度和收藏状态\n\n请确保您当前的网络连接正常。`,confirmText:"确定同步",cancelText:"取消",success:async o=>{var t,a,i,s,u,c,d,v;if(o.confirm){console.log("[syncPlaylist] 开始同步歌单:",l.name,"链接:",l.link,"平台:",l.source);try{let o;e.index.showLoading({title:"正在同步..."});if("tx"===l.source)console.log("[syncPlaylist] QQ音乐使用后端接口"),o=await n.getListDetail(l.source,l.link,1);else{console.log("[syncPlaylist] 使用前端直接API:",l.source);let i=l.link;if(/^https?:\/\//.test(l.link)){let o=l.link.match(/[?&]id=(\d+)/);if(o)i=o[1],console.log("[syncPlaylist] 从URL查询参数解析出ID:",i);else if(o=l.link.match(/\/playlist(?:_detail)?\/(\d+)/),o)i=o[1],console.log("[syncPlaylist] 从URL路径解析出ID:",i);else if("mg"===l.source&&l.link.includes("c.migu.cn")){console.log("[syncPlaylist] 检测到咪咕短链接，尝试获取真实URL...");try{const o=await e.index.request({url:l.link,method:"HEAD",header:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15"}}),s=(null==(t=o.header)?void 0:t.Location)||(null==(a=o.header)?void 0:a.location);if(s){console.log("[syncPlaylist] 咪咕短链接重定向到:",s);const e=s.match(/[?&]id=(\d+)/);e&&(i=e[1],console.log("[syncPlaylist] 从咪咕重定向URL解析出ID:",i))}}catch(m){console.error("[syncPlaylist] 获取咪咕短链接失败:",m)}}}else console.log("[syncPlaylist] 直接使用作为ID:",i);o=await r.getListDetailDirect(l.source,i,1)}const g=o.list||[];if(0===g.length)throw new Error("获取到0首歌曲，可能歌单已删除或无权限访问");const y=V.value.findIndex(e=>e.id===l.id);if(y>-1){const t=Ee(g);V.value[y].songs=t,V.value[y].trackCount=g.length,V.value[y].coverImgUrl=(null==(i=o.info)?void 0:i.img)||o.coverImgUrl||l.coverImgUrl,V.value[y].name=(null==(s=o.info)?void 0:s.name)||o.name||l.name,((null==(u=o.info)?void 0:u.desc)||o.desc)&&(V.value[y].desc=(null==(c=o.info)?void 0:c.desc)||o.desc),e.index.setStorageSync("imported_playlists",V.value),console.log("[syncPlaylist] 歌单已更新并保存，歌曲数:",g.length),V.value=[...V.value],Y.value===l.id&&(ee.value=oe([...g]),l.name=(null==(d=o.info)?void 0:d.name)||o.name||l.name,l.coverImgUrl=(null==(v=o.info)?void 0:v.img)||o.coverImgUrl||l.coverImgUrl,l.trackCount=g.length,console.log("[syncPlaylist] 当前歌单已更新，歌曲数:",g.length))}ke(),e.index.showToast({title:`同步成功（${g.length}首）`,icon:"success"})}catch(g){console.error("[syncPlaylist] 同步失败:",g);let l="同步失败";g.message&&(l=g.message.includes("404")||g.message.includes("not found")?"歌单不存在或已删除":g.message.includes("403")||g.message.includes("forbidden")?"没有权限访问该歌单":g.message.includes("network")||g.message.includes("网络")?"网络连接失败":`同步失败: ${g.message}`),e.index.showToast({title:l,icon:"none"})}finally{e.index.hideLoading()}}}}):e.index.showToast({title:"该歌单没有链接信息，无法同步",icon:"none"})},Me=()=>{if(!k.value||"imported"!==C.value)return;const l=k.value,o=!l.autoUpdate,t=V.value.findIndex(e=>e.id===l.id);t>-1&&(V.value[t].autoUpdate=o,e.index.setStorageSync("imported_playlists",V.value),console.log("[toggleAutoUpdate] 自动更新状态已更新:",o),V.value=[...V.value],k.value.autoUpdate=o,e.index.showToast({title:o?"已开启自动更新":"已关闭自动更新",icon:"success"}))},$e=async()=>{console.log("[batchAutoUpdatePlaylists] 开始批量自动更新检查");const e=V.value.filter(e=>e.autoUpdate&&e.canAutoUpdate);if(console.log("[batchAutoUpdatePlaylists] 开启自动更新的歌单数量:",e.length),0!==e.length){for(const o of e)if(W.value.has(o.id))console.log("[batchAutoUpdatePlaylists] 歌单已更新过，跳过:",o.name);else{console.log("[batchAutoUpdatePlaylists] 开始自动更新歌单:",o.name),M.value=!0,$.value=o.name;try{W.value.add(o.id),await je(o,!1),console.log("[batchAutoUpdatePlaylists] 歌单自动更新成功:",o.name)}catch(l){console.error("[batchAutoUpdatePlaylists] 歌单自动更新失败:",o.name,l),W.value.delete(o.id)}await new Promise(e=>setTimeout(e,1e3))}console.log("[batchAutoUpdatePlaylists] 批量自动更新完成"),M.value=!1,$.value=""}else console.log("[batchAutoUpdatePlaylists] 没有开启自动更新的歌单，跳过")},je=async(l,o=!0)=>{var t,a,i,s,u,c,d,v;console.log("[autoUpdatePlaylist] 开始自动更新歌单:",l.name,"链接:",l.link,"平台:",l.source);try{let g;if("tx"===l.source)console.log("[autoUpdatePlaylist] QQ音乐使用后端接口"),g=await n.getListDetail(l.source,l.link,1);else{console.log("[autoUpdatePlaylist] 使用前端直接API:",l.source);let o=l.link;if(/^https?:\/\//.test(l.link)){let i=l.link.match(/[?&]id=(\d+)/);if(i)o=i[1],console.log("[autoUpdatePlaylist] 从URL查询参数解析出ID:",o);else if(i=l.link.match(/\/playlist(?:_detail)?\/(\d+)/),i)o=i[1],console.log("[autoUpdatePlaylist] 从URL路径解析出ID:",o);else if("mg"===l.source&&l.link.includes("c.migu.cn")){console.log("[autoUpdatePlaylist] 检测到咪咕短链接，尝试获取真实URL...");try{const i=await e.index.request({url:l.link,method:"HEAD",header:{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15"}}),s=(null==(t=i.header)?void 0:t.Location)||(null==(a=i.header)?void 0:a.location);if(s){console.log("[autoUpdatePlaylist] 咪咕短链接重定向到:",s);const e=s.match(/[?&]id=(\d+)/);e&&(o=e[1],console.log("[autoUpdatePlaylist] 从咪咕重定向URL解析出ID:",o))}}catch(m){console.error("[autoUpdatePlaylist] 获取咪咕短链接失败:",m)}}}else console.log("[autoUpdatePlaylist] 直接使用作为ID:",o);g=await r.getListDetailDirect(l.source,o,1)}const y=g.list||[];if(0===y.length)throw new Error("获取到0首歌曲，可能歌单已删除或无权限访问");const f=V.value.findIndex(e=>e.id===l.id);if(f>-1){const t=Ee(y),a=oe(t);return V.value[f].songs=a,V.value[f].trackCount=y.length,V.value[f].coverImgUrl=(null==(i=g.info)?void 0:i.img)||g.coverImgUrl||l.coverImgUrl,V.value[f].name=(null==(s=g.info)?void 0:s.name)||g.name||l.name,((null==(u=g.info)?void 0:u.desc)||g.desc)&&(V.value[f].desc=(null==(c=g.info)?void 0:c.desc)||g.desc),e.index.setStorageSync("imported_playlists",V.value),console.log("[autoUpdatePlaylist] 歌单已自动更新并保存，歌曲数:",y.length),V.value=[...V.value],Y.value===l.id?(ee.value=[...a],Z.name=(null==(d=g.info)?void 0:d.name)||g.name||l.name,Z.coverImgUrl=(null==(v=g.info)?void 0:v.img)||g.coverImgUrl||l.coverImgUrl,Z.trackCount=y.length,console.log("[autoUpdatePlaylist] 当前歌单已自动更新，歌曲数:",y.length)):console.log("[autoUpdatePlaylist] 歌单在后台更新完成，当前显示的是其他歌单，不更新页面"),o&&e.index.showToast({title:`自动更新成功（${y.length}首）`,icon:"success"}),y}}catch(g){console.error("[autoUpdatePlaylist] 自动更新失败:",g);const e=l.songs||[];return ee.value=oe([...e]),Z.name=l.name,Z.coverImgUrl=l.coverImgUrl,Z.trackCount=e.length,e}finally{M.value=!1}},qe=()=>{D.value&&e.index.showModal({title:"提示",content:"确定从当前列表移除这首歌曲吗？",success:l=>{if(l.confirm){if(console.log("[removeSongFromList] 开始移除歌曲，歌单ID:",Y.value,"歌曲ID:",D.value.id),"trial"===Y.value||Y.value===o.LIST_IDS.DEFAULT)console.log("[removeSongFromList] 从试听列表移除"),o.listStore.removeFromDefaultList(D.value.id);else if("favorite"===Y.value||Y.value===o.LIST_IDS.LOVE)console.log("[removeSongFromList] 从收藏列表移除（取消收藏）"),o.listStore.removeFromLoveList(D.value.id);else if(Y.value.startsWith("custom_")||Y.value.startsWith("userlist_")){console.log("[removeSongFromList] 从自定义歌单移除");const e=o.listStore.state.userLists.find(e=>e.id===Y.value);if(e){const l=e.list.findIndex(e=>e.id===D.value.id);l>-1&&(e.list.splice(l,1),console.log("[removeSongFromList] 自定义歌单移除成功，保存数据"),o.listStore.saveUserLists())}}else{console.log("[removeSongFromList] 从导入的歌单移除，歌单ID:",Y.value);const e=ee.value.findIndex(e=>e.id===D.value.id);e>-1&&(ee.value.splice(e,1),console.log("[removeSongFromList] 导入歌单移除成功，剩余歌曲:",ee.value.length),pe())}try{const l=e.index.getStorageSync("deleted_songs")||[];-1===l.findIndex(e=>e.id===D.value.id)&&(l.unshift(D.value),l.length>200&&l.pop(),e.index.setStorageSync("deleted_songs",l),console.log("[removeSongFromList] 已记录删除的歌曲，当前删除记录数:",l.length))}catch(t){console.error("[removeSongFromList] 记录删除歌曲失败:",t)}Ue(),e.index.showToast({title:"已移除",icon:"success"})}be()}})},Oe=e=>{if("string"==typeof e&&e.includes(":"))return e;if("number"==typeof e){return`${Math.floor(e/6e4)}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}`}return"0:00"},Ne=()=>{var e;if(!D.value)return;console.log("[toggleMusicSource] 打开歌曲换源弹窗，歌曲:",D.value.name),console.log("[toggleMusicSource] 歌曲数据:",JSON.stringify(D.value));const l={...D.value};F.value=l,console.log("[toggleMusicSource] toggleOriginalSong已设置:",null==(e=F.value)?void 0:e.name),be(!1),E.value=!0},Ve=()=>{E.value=!1,F.value=null},ze=l=>{const{originalSong:a,newSong:i,listId:s}=l;console.log("[handleToggleConfirm] 确认换源:",{from:a.name,to:i.name,listId:s});const n=ee.value.findIndex(e=>e.id===a.id);if(-1===n)return console.error("[handleToggleConfirm] 未找到原歌曲"),void e.index.showToast({title:"换源失败：未找到原歌曲",icon:"none"});ee.value[n]={...i,_toggledFrom:a.source,_toggledAt:Date.now()};const r=String(a.id||""),u=r.replace(/^(tx|wy|kg|kw|mg)_/,"")||r;if(console.log("[handleToggleConfirm] 保存换源信息, 原始歌曲ID:",u,"原始source:",a.source,"新source:",i.source),d.saveMusicSwitchSource(u,{originalSource:a.source,newSource:i.source,newSongId:i.id,newSongName:i.name,newSongSinger:i.singer,url:i.url||i.playUrl||"",quality:i.quality||"standard"}),console.log("[handleToggleConfirm] 已保存换源信息到本地存储, 新歌曲ID:",i.id),"trial"===s||s===o.LIST_IDS.DEFAULT)o.listStore.updateDefaultList(ee.value);else if("favorite"===s||s===o.LIST_IDS.LOVE)o.listStore.updateLoveList(ee.value);else if(s.startsWith("custom_")||s.startsWith("userlist_")){const e=o.listStore.state.userLists.find(e=>e.id===s);e&&(e.list=[...ee.value],o.listStore.saveUserLists())}else pe();const c=o.listStore.state.playInfo.playerListId;o.listStore.state.playInfo.playIndex===n&&c===s&&(console.log("[handleToggleConfirm] 更新播放器中的歌曲信息"),t.playerStore.updateCurrentSong(i)),e.index.showToast({title:"换源成功",icon:"success"}),ee.value=[...ee.value]},Re=async l=>{console.log("[handleTogglePreview] 预览歌曲:",l.name),console.log("[handleTogglePreview] 歌曲信息:",JSON.stringify(l)),j.value=!0,q.value="加载中",O.value="获取播放链接";try{const o=l.sourceId||l.source||"tx";let a;console.log("[handleTogglePreview] 音源:",o),a="mg"===o?{source:"mg",songmid:l.songmid||l.id,id:l.copyrightId||l.id,musicInfo:{songmid:l.songmid||l.id,copyrightId:l.copyrightId||l.id,name:l.name,singer:l.artists?l.artists.map(e=>e.name).join("/"):l.singer||"",album:l.album?l.album.name:l.albumName||""},quality:"320k"}:"kg"===o?{source:o,musicInfo:{id:l.id,hash:l.id,name:l.name,singer:l.artists?l.artists.map(e=>e.name).join("/"):l.singer||"",source:o,interval:l.duration?Oe(l.duration):l.interval||"",album:l.album?l.album.name:l.albumName||"",meta:{songId:l.id,albumName:l.album?l.album.name:l.albumName||"",hash:l.id}},quality:"320k"}:{source:o,musicInfo:{id:l.id,name:l.name,singer:l.artists?l.artists.map(e=>e.name).join("/"):l.singer||"",source:o,interval:l.duration?Oe(l.duration):l.interval||"",meta:{songId:l.id,albumName:l.album?l.album.name:l.albumName||"",hash:l.id}},quality:"320k"},console.log("[handleTogglePreview] 请求参数:",a);const i=await s.getMusicUrl(a);console.log("[handleTogglePreview] 获取到URL:",i.url);const n={...l,url:i.url,playUrl:i.url,lyric:i.lyric||"",tlyric:i.tlyric||"",rlyric:i.rlyric||"",lxlyric:i.lxlyric||""};t.playerStore.playSong(n),j.value=!1,e.index.showToast({title:`正在播放: ${l.name}`,icon:"none",duration:2e3})}catch(o){console.error("[handleTogglePreview] 播放失败:",o),j.value=!1,e.index.showToast({title:"播放失败: "+(o.message||"未知错误"),icon:"none",duration:2e3})}},We=()=>{P.value=!1,U.value=""},Be=()=>{const l=U.value.trim();l?(P.value=!1,e.index.navigateTo({url:`/pages/sharelist/index?source=${x.value}&link=${encodeURIComponent(l)}&platform=${encodeURIComponent(T.value)}&preview=true&from=import`})):e.index.showToast({title:"请输入歌单链接",icon:"none"})},Qe=async()=>{console.log("[Playlist] ====== loadPlaylistData 开始 ======"),Q.value=!0;const l=e.index.getStorageSync("imported_playlists")||[];V.value=l,console.log("[Playlist] 已导入歌单数量:",l.length);const t=(()=>{try{const l=e.index.getStorageSync(h);return console.log("[Playlist] 获取上次选择的歌单ID:",l),l||null}catch(l){return console.error("[Playlist] 获取歌单ID失败:",l),null}})();console.log("[Playlist] 上次选择的歌单ID:",t);let a=!1;if(t)if(console.log("[Playlist] 尝试恢复上次选择的歌单:",t),"trial"===t||t===o.LIST_IDS.DEFAULT)console.log("[Playlist] 恢复为试听列表"),Y.value="trial",Z.id=o.LIST_IDS.DEFAULT,Z.name="试听列表",Z.description="试听列表，存放您最近试听的歌曲",z.value="",ee.value=oe([...o.listStore.state.defaultList.list]),a=!0;else if("favorite"===t||t===o.LIST_IDS.LOVE)console.log("[Playlist] 恢复为我的收藏"),Y.value="favorite",Z.id=o.LIST_IDS.LOVE,Z.name="我的收藏",Z.description="您收藏的歌曲",z.value="",ee.value=oe([...o.listStore.state.loveList.list]),a=!0;else if(t.startsWith("custom_")||t.startsWith("userlist_")){const e=o.listStore.state.userLists.find(e=>e.id===t);e&&(console.log("[Playlist] 恢复自定义歌单:",e.name),Y.value=e.id,Z.id=e.id,Z.name=e.name,Z.coverImgUrl=e.coverImgUrl||"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80",Z.description="自定义歌单",z.value="custom",ee.value=oe([...e.list||[]]),a=!0)}else{const e=l.find(e=>e.id===t);if(e)if(console.log("[Playlist] 恢复导入歌单:",e.name),Y.value=e.id,Z.id=e.id,Z.name=e.name,Z.coverImgUrl=e.coverImgUrl,Z.description=`从${e.platform}导入的歌单`,z.value=e.source||"",e.autoUpdate&&e.link&&!W.value.has(e.id)){console.log("[Playlist] 检测到自动更新已开启，开始自动同步歌单:",e.name),W.value.add(e.id);const l=e.songs||[];l.length>600&&(j.value=!0,q.value="正在加载",O.value=`${l.length}首歌曲`),je(e,!1).then(e=>{console.log("[Playlist] 自动更新完成，更新歌曲列表"),N.value=!1,e&&e.length>0?(te(e),j.value=!1):j.value=!1,$e()}),ee.value=oe([...l]),a=!0,l.length>600&&(N.value=!0)}else{const l=e.songs||[];te(l),a=!0,N.value=!1,$e()}}if(N.value)console.log("[Playlist] 歌单正在加载中，等待加载完成");else{if(a)return console.log("[Playlist] 从上次选择的歌单恢复成功，currentPlaylistId:",Y.value),console.log("[Playlist] ====== loadPlaylistData 结束 ======"),void $e();try{const e=await i.getPlayInfo();console.log("[Playlist] 获取到 playInfo:",e);let t=!1;if(e&&e.listId&&e.index>=0)if(console.log("[Playlist] 尝试恢复上次播放状态 - listId:",e.listId,"index:",e.index),e.listId===o.LIST_IDS.DEFAULT||"trial"===e.listId)console.log("[Playlist] 恢复为试听列表"),Y.value="trial",Z.id=o.LIST_IDS.DEFAULT,Z.name="试听列表",Z.description="试听列表，存放您最近试听的歌曲",z.value="",ee.value=oe([...o.listStore.state.defaultList.list]),t=!0;else if(e.listId===o.LIST_IDS.LOVE||"favorite"===e.listId)console.log("[Playlist] 恢复为我的收藏"),Y.value="favorite",Z.id=o.LIST_IDS.LOVE,Z.name="我的收藏",Z.description="您收藏的歌曲",z.value="",ee.value=oe([...o.listStore.state.loveList.list]),t=!0;else if(e.listId===o.LIST_IDS.TEMP){if(console.log("[Playlist] 尝试恢复临时列表，playInfo.meta:",JSON.stringify(e.meta)),e.meta&&e.meta.id){const o=l.find(l=>l.id===e.meta.id);if(o){if(console.log("[Playlist] 从导入歌单中找到临时列表对应的歌单:",o.name),Y.value=o.id,Z.id=o.id,Z.name=o.name,Z.coverImgUrl=o.coverImgUrl,Z.description=`从${o.platform}导入的歌单`,z.value=o.source||"",o.autoUpdate&&o.link&&!W.value.has(o.id))return console.log("[Playlist] 检测到自动更新已开启，开始自动同步歌单:",o.name),W.value.add(o.id),void je(o,!1);const e=o.songs||[];te(e),t=!0}}}else{console.log("[Playlist] 尝试恢复歌单，listId:",e.listId);const a=l.find(l=>l.id===e.listId);if(console.log("[Playlist] 在已导入歌单中查找:",e.listId,"结果:",a?"找到":"未找到"),a){if(console.log("[Playlist] 找到匹配的导入歌单:",a.name),Y.value=a.id,Z.id=a.id,Z.name=a.name,Z.coverImgUrl=a.coverImgUrl,Z.description=`从${a.platform}导入的歌单`,z.value=a.source||"",a.autoUpdate&&a.link&&!W.value.has(a.id))return console.log("[Playlist] 检测到自动更新已开启，开始自动同步歌单:",a.name),W.value.add(a.id),void je(a,!1);const e=a.songs||[];te(e),t=!0}else{const l=o.listStore.state.userLists.find(l=>l.id===e.listId);if(l){console.log("[Playlist] 找到匹配的自定义歌单:",l.name),Y.value=l.id,Z.id=l.id,Z.name=l.name,Z.coverImgUrl=l.coverImgUrl||"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80",Z.description="自定义歌单",z.value="custom";const e=l.list||[];te(e),t=!0}}}if(!t)if(console.log("[Playlist] 未找到有效的播放记录，使用默认逻辑"),l.length>0){const e=l[0];if(console.log("[Playlist] 自动选择第一个导入的歌单:",e.name),Y.value=e.id,Z.id=e.id,Z.name=e.name,Z.coverImgUrl=e.coverImgUrl,Z.description=`从${e.platform||"未知平台"}导入的歌单`,z.value=e.source||"",e.autoUpdate&&e.link&&!W.value.has(e.id))return console.log("[Playlist] 检测到自动更新已开启，开始自动同步歌单:",e.name),W.value.add(e.id),void je(e,!1);const o=e.songs||[];ee.value=oe([...o]),console.log("[Playlist] 已加载歌曲:",ee.value.length,"首")}else if(o.listStore.state.userLists.length>0){const e=o.listStore.state.userLists[0];console.log("[Playlist] 自动选择第一个自定义歌单:",e.name),Y.value=e.id,Z.id=e.id,Z.name=e.name,Z.coverImgUrl=e.coverImgUrl||"https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80",Z.description="自定义歌单",z.value="custom";const l=e.list||[];te(l)}else console.log("[Playlist] 使用默认列表"),Ue();console.log("[Playlist] 最终 currentPlaylistId:",Y.value),console.log("[Playlist] ====== loadPlaylistData 结束 ======"),$e()}catch(s){if(console.error("[Playlist] 恢复播放状态失败:",s),l.length>0){const e=l[0];Y.value=e.id,Z.id=e.id,Z.name=e.name,Z.coverImgUrl=e.coverImgUrl,Z.description=`从${e.platform||"未知平台"}导入的歌单`,z.value=e.source||"";const o=e.songs||[];te(o)}else Ue()}}};e.onShow(()=>{if(l.setStatusBarTextColor("black"),X(),(()=>{var l;try{const o=e.index.getSystemInfoSync();K.value=(null==(l=o.safeAreaInsets)?void 0:l.bottom)||0,console.log("[Playlist] 底部高度初始化:",{safeAreaBottom:K.value})}catch(o){console.error("[Playlist] 获取底部高度失败:",o)}})(),(()=>{e.index.$on("miniPlayerHeightChange",e=>{J.value=e.isShowing,console.log("[Playlist] MiniPlayer 状态变化:",e.isShowing)});const l=t.playerStore.getState().currentSong;J.value=!(!l||!l.id)})(),console.log("[Playlist] ====== onShow ======"),console.log("[Playlist] isDataLoaded:",Q.value),Q.value){const l=e.index.getStorageSync("imported_playlists")||[];V.value=l,console.log("[Playlist] onShow 刷新已导入歌单:",l.length,"个"),console.log("[Playlist] 当前 currentPlaylistId:",Y.value),He()}});const He=()=>{if(console.log("[Playlist] refreshCurrentPlaylist 当前歌单ID:",Y.value),"trial"===Y.value||Y.value===o.LIST_IDS.DEFAULT){const e=o.listStore.state.defaultList.list||[];return ee.value=[...e],Z.id="trial",Z.name="试听列表",Z.trackCount=e.length,void console.log("[Playlist] 刷新试听列表，歌曲数:",e.length)}if("favorite"===Y.value||Y.value===o.LIST_IDS.LOVE){const e=o.listStore.state.loveList.list||[];return ee.value=[...e],Z.id="favorite",Z.name="我的收藏",Z.trackCount=e.length,void console.log("[Playlist] 刷新我的收藏，歌曲数:",e.length)}if(Y.value&&(Y.value.startsWith("custom_")||Y.value.startsWith("userlist_"))){const e=o.listStore.state.userLists.find(e=>e.id===Y.value);if(e){const l=e.list||[];ee.value=oe([...l]),Z.id=e.id,Z.name=e.name,Z.trackCount=l.length,console.log("[Playlist] 刷新自定义歌单:",e.name,"歌曲数:",l.length)}else Y.value="trial",ee.value=oe([...o.listStore.state.defaultList.list]),Z.name="试听列表",console.log("[Playlist] 自定义歌单不存在，切换到试听列表");return}const l=(e.index.getStorageSync("imported_playlists")||[]).find(e=>e.id===Y.value);if(l){const e=l.songs||[];ee.value=oe([...e]),Z.id=l.id,Z.name=l.name,Z.trackCount=e.length,console.log("[Playlist] 刷新导入歌单:",l.name,"歌曲数:",e.length)}else Y.value="trial",ee.value=oe([...o.listStore.state.defaultList.list]),Z.name="试听列表",console.log("[Playlist] 导入歌单不存在，切换到试听列表")};return e.onReachBottom(()=>{console.log("[Playlist] onReachBottom 触发"),loadMoreSongs()}),(l,t)=>{var a,i,s,n,r,u,c,d,m,y,h,x,T;return e.e({a:e.t(Z.name),b:e.p({name:"chevron-down",size:"16",color:B.value?"#fff":"#666"}),c:e.o(ge),d:e.s(f.value),e:g.value},g.value?{f:e.o(ye)}:{},{g:e.p({name:"music",size:"20",color:"#00d7cd"}),h:e.t(S.value),i:"trial"===Y.value?1:"",j:e.o(e=>Se("trial")),k:e.p({name:"heart",size:"20",color:"#ff6b6b"}),l:e.t(I.value),m:"favorite"===Y.value?1:"",n:e.o(e=>Se("favorite")),o:V.value.length>0},V.value.length>0?{p:e.f(V.value,(l,o,t)=>({a:e.unref(v.proxyImageUrl)(l.coverImgUrl),b:e.o(e=>fe(e,l),l.id),c:e.t(l.name),d:e.t(l.trackCount||0),e:e.t(l.platform),f:"4a2daac1-3-"+t,g:e.o(e=>_e(l,o,"imported"),l.id),h:l.id,i:Y.value===l.id?1:"",j:e.o(e=>(e=>{if(N.value)return void console.log("[Playlist] 歌单正在加载中，阻止切换");if(console.log("========== [Playlist] selectImportedPlaylist 被调用 =========="),console.log("[Playlist] 传入的歌单:",JSON.stringify({id:e.id,name:e.name})),console.log("[Playlist] 当前 currentPlaylistId:",Y.value),Y.value===e.id)return console.log("[Playlist] 歌单已选中，关闭侧边栏"),void(g.value=!1);Y.value=e.id,g.value=!1,H(e.id),Z.id=e.id,Z.name=e.name,Z.coverImgUrl=e.coverImgUrl,Z.description=`从${e.platform}导入的歌单`,z.value=e.source||"";const l=e.songs||[];te(l),ne.value=0,console.log("[Playlist] 选择已导入歌单:",e.name,"歌曲数量:",l.length),console.log("========== [Playlist] selectImportedPlaylist 完成 ==========")})(l),l.id)})),q:e.p({name:"ellipsis-vertical",size:"18"})}:{},{r:R.value.length>0},R.value.length>0?{s:e.f(R.value,(l,o,t)=>({a:e.unref(v.proxyImageUrl)(l.coverImgUrl),b:e.o(e=>fe(e,l),l.id),c:e.t(l.name),d:e.t(l.trackCount||0),e:"4a2daac1-4-"+t,f:e.o(e=>_e(l,o,"custom"),l.id),g:l.id,h:Y.value===l.id?1:"",i:e.o(e=>Se(l.id),l.id)})),t:e.p({name:"ellipsis-vertical",size:"18"})}:{},{v:e.o(he),w:e.o(Le),x:g.value?1:"",y:e.s(p.value),z:e.p({name:"location-crosshairs",size:"18",color:"#fff"}),A:e.o(we),B:e.sr(ue,"4a2daac1-6",{k:"virtualListRef"}),C:e.o(xe),D:e.o(de),E:e.o(ve),F:e.o(me),G:e.p({items:ee.value,"item-height":60,height:ce.value,"buffer-size":10,loading:le.value,"current-play-index":se.value,"is-playing":ie.value,"dark-mode":B.value}),H:e.p({"current-index":2}),I:P.value},P.value?{J:e.t(L.value),K:e.p({name:"xmark",size:"20",color:"#999"}),L:e.o(We),M:U.value,N:e.o(e=>U.value=e.detail.value),O:e.o(We),P:e.o(Be),Q:e.o(()=>{}),R:e.o(We)}:{},{S:w.value},w.value?e.e({T:D.value},D.value?{U:e.t(D.value.name),V:e.t((T=D.value.ar||D.value.singer,T?"string"==typeof T?T:Array.isArray(T)?T.map(e=>e.name||e).join("、"):"未知歌手":"未知歌手"))}:{},{W:e.p({type:"fas",name:"rotate",size:"20",color:"#3b82f6"}),X:e.o(Ne),Y:e.p({type:"fas",name:"trash",size:"20",color:"#ef4444"}),Z:e.t("favorite"===Y.value.value||Y.value.value===e.unref(o.LIST_IDS).LOVE?"取消收藏并移除":"从列表中移除"),aa:e.o(qe),ab:e.o(()=>{}),ac:e.o(be)}):{},{ad:_.value},_.value?e.e({ae:k.value},k.value?{af:e.t(k.value.name),ag:e.t("imported"===C.value?`从${k.value.platform||""}导入`:"自定义歌单")}:{},{ah:e.p({type:"fas",name:"pen",size:"20",color:"#3b82f6"}),ai:e.o(Ae),aj:"imported"===C.value&&(null==(a=k.value)?void 0:a.canAutoUpdate)&&(null==(i=k.value)?void 0:i.isFromImport)},"imported"===C.value&&(null==(s=k.value)?void 0:s.canAutoUpdate)&&(null==(n=k.value)?void 0:n.isFromImport)?{ak:e.p({type:"fas",name:(null==(r=k.value)?void 0:r.autoUpdate)?"check-circle":"clock-rotate-left",size:"20",color:(null==(u=k.value)?void 0:u.autoUpdate)?"#10b981":"#999"}),al:e.t((null==(c=k.value)?void 0:c.autoUpdate)?"已开启自动更新":"开启自动更新"),am:(null==(d=k.value)?void 0:d.autoUpdate)?"#10b981":"#999",an:e.o(Me)}:{},{ao:"imported"===C.value&&(null==(m=k.value)?void 0:m.canAutoUpdate)&&(null==(y=k.value)?void 0:y.isFromImport)},"imported"===C.value&&(null==(h=k.value)?void 0:h.canAutoUpdate)&&(null==(x=k.value)?void 0:x.isFromImport)?{ap:e.p({type:"fas",name:"rotate",size:"20",color:"#10b981"}),aq:e.o(Fe)}:{},{ar:e.p({type:"fas",name:"trash",size:"20",color:"#ef4444"}),as:e.o(Ce),at:e.o(()=>{}),av:e.o(ke)}):{},{aw:e.o(Ve),ax:e.o(ze),ay:e.o(Re),az:e.p({visible:E.value,"original-song":F.value,"list-id":Y.value,"dark-mode":B.value}),aA:e.p({visible:M.value,"playlist-name":$.value}),aB:e.p({visible:j.value,title:q.value,subtitle:O.value}),aC:B.value?1:""})}}},L=e._export_sfc(P,[["__scopeId","data-v-4a2daac1"]]);wx.createPage(L);
