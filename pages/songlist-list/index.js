"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/system.js"),a=require("../../utils/format.js"),l=require("../../utils/api/tags.js"),o=require("../../utils/imageProxy.js");if(!Array){e.resolveComponent("roc-icon-plus")()}Math||((()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js")+i)();const i=()=>"../../components/player/MiniPlayer.js",n="songlist_last_source",s="songlist_last_tag",c="songlist_last_sort",r={__name:"index",setup(i){const r=t.getStatusBarHeight();e.computed(()=>({height:`${r}px`}));const u=e.computed(()=>({paddingTop:`${r}px`})),d=e.ref(!1),g=()=>{d.value="true"===e.index.getStorageSync("darkMode"),console.log("[SonglistList] 初始化暗黑模式:",d.value)},m=[{id:"kw",name:"酷我音乐"},{id:"kg",name:"酷狗音乐"},{id:"tx",name:"QQ音乐"},{id:"mg",name:"咪咕音乐"},{id:"wy",name:"网易云音乐"}],p=e.ref({kw:[{id:"",name:"推荐"}],kg:[{id:"",name:"推荐"}],tx:[{id:"",name:"推荐"}],mg:[{id:"",name:"推荐"}],wy:[{id:"",name:"推荐"}]}),v=e.ref(!1),h=async e=>{if(console.log("[SonglistList] 加载标签:",e),v.value)console.log("[SonglistList] 标签正在加载中，跳过");else{v.value=!0;try{const t=await l.getTagsBySource(e);console.log("[SonglistList] 获取到标签分组:",t.length);const a=l.flattenTags(t);console.log("[SonglistList] 扁平化后标签数量:",a.length),p.value[e]=a;a.some(e=>e.id===x.value)||(x.value="")}catch(t){console.error("[SonglistList] 加载标签失败:",t)}finally{v.value=!1}}},y={kw:[{id:"hot",name:"最热"},{id:"new",name:"最新"}],kg:[{id:"6",name:"最热"},{id:"5",name:"最新"}],tx:[{id:"5",name:"最热"},{id:"2",name:"最新"}],mg:[],wy:[{id:"hot",name:"最热"},{id:"new",name:"最新"}]},f=()=>{try{return e.index.getStorageSync(n)||"tx"}catch(t){return"tx"}},_=()=>{try{return e.index.getStorageSync(s)||""}catch(t){return""}},w=()=>{try{return e.index.getStorageSync(c)||"hot"}catch(t){return"hot"}},k=t=>{try{e.index.setStorageSync(s,t)}catch(a){console.error("[SonglistList] 保存标签失败:",a)}},S=t=>{try{e.index.setStorageSync(c,t)}catch(a){console.error("[SonglistList] 保存排序失败:",a)}},b=e.ref(f()),x=e.ref(_()),L=e.ref(w()),$=e.ref([]),U=e.ref(1),C=e.ref(!1),I=e.ref(!1),j=e.ref(!0),q=e.ref(""),P=e.ref(!1),R=e.computed(()=>{const e=m.find(e=>e.id===b.value);return e?e.name:"酷我音乐"}),M=e.computed(()=>p.value[b.value]||[{id:"",name:"推荐"}]),T=e.computed(()=>y[b.value]||[]),z=()=>{e.index.navigateBack()},A=t=>{console.log("[SonglistList] 切换平台:",t),b.value=t,x.value="",L.value="hot",U.value=1,$.value=[],j.value=!0,P.value=!1,(t=>{try{e.index.setStorageSync(n,t)}catch(a){console.error("[SonglistList] 保存平台失败:",a)}})(t),k(""),S("hot"),h(t),E()},E=async()=>{if(!C.value){1===U.value&&(C.value=!0),q.value="";try{const t=b.value,a=x.value,l=L.value,o=U.value;let i="";switch(t){case"kw":{const e="new"===l?"new":"hot";if(a){const[e,t]=a.split("-");i="10000"===t?`http://wapi.kuwo.cn/api/pc/classify/playlist/getTagPlayList?loginUid=0&loginSid=0&appUid=76039576&pn=${o}&id=${e}&rn=30`:"43"===t?`http://mobileinterfaces.kuwo.cn/er.s?type=get_pc_qz_data&f=web&id=${e}&prod=pc`:`http://wapi.kuwo.cn/api/pc/classify/playlist/getTagPlayList?loginUid=0&loginSid=0&appUid=76039576&pn=${o}&id=${e}&rn=30`}else i=`http://wapi.kuwo.cn/api/pc/classify/playlist/getRcmPlayList?loginUid=0&loginSid=0&appUid=76039576&pn=${o}&rn=30&order=${e}`;console.log("酷我音乐请求URL:",i);break}case"kg":i=`http://www2.kugou.kugou.com/yueku/v9/special/getSpecial?is_ajax=1&cdn=cdn&t=${l||"6"}&c=${a||""}&p=${o}`,console.log("酷狗音乐请求URL:",i);break;case"tx":{const e="2"===l?2:5,t={comm:{cv:1602,ct:20},playlist:{method:a?"get_category_content":"get_playlist_by_tag",param:a?{titleid:parseInt(a),caller:"0",category_id:parseInt(a),size:30,page:o-1,use_page:1}:{id:1e7,sin:30*(o-1),size:30,order:e,cur_page:o},module:a?"playlist.PlayListCategoryServer":"playlist.PlayListPlazaServer"}};i=`https://u.y.qq.com/cgi-bin/musicu.fcg?loginUin=0&hostUin=0&format=json&inCharset=utf-8&outCharset=utf-8&notice=0&platform=wk_v15.json&needNewCode=0&data=${encodeURIComponent(JSON.stringify(t))}`,console.log("QQ音乐请求URL:",i);break}case"mg":i=a?`https://app.c.nf.migu.cn/pc/v1.0/template/musiclistplaza-listbytag/release?pageNumber=${o}&templateVersion=2&tagId=${a}`:`https://app.c.nf.migu.cn/pc/bmw/page-data/playlist-square-recommend/v1.0?templateVersion=2&pageNo=${o}`,console.log("咪咕音乐请求URL:",i);break;case"wy":{const e="new"===l?"new":"hot";i=`https://music.163.com/api/playlist/list?cat=${encodeURIComponent(a||"全部")}&order=${e}&limit=30&offset=${30*(o-1)}`,console.log("网易云音乐请求URL:",i);break}default:i=`http://wapi.kuwo.cn/api/pc/classify/playlist/getRcmPlayList?loginUid=0&loginSid=0&appUid=76039576&pn=${o}&rn=30&order=hot`,console.log("默认请求URL:",i)}const n=await e.index.request({url:i,method:"GET",header:{Referer:"https://servicewechat.com/wx2d02f54a4e4c4027/devtools/page-frame.html"}});if(200===n.statusCode){const e=B(n.data,t);console.log("=== fetchSonglist 完成 ==="),console.log("result.list.length:",e.list.length),console.log("currentPage:",U.value),console.log("result.total:",e.total),1===U.value?$.value=e.list:$.value=[...$.value,...e.list],j.value=e.list.length>=30,console.log("hasMore 更新为:",j.value),0===e.list.length&&1===U.value&&(q.value="暂无歌单数据")}else if(403===n.statusCode)q.value="请求被拒绝，请检查网络设置";else if(404===n.statusCode)q.value="接口不存在";else{if(!(n.statusCode>=500))throw new Error(`请求失败 (${n.statusCode})`);q.value="服务器错误，请稍后重试"}}catch(t){console.error("获取歌单列表失败:",t),q.value=t.message||"加载失败，请重试"}finally{C.value=!1,I.value=!1}}},B=(e,t)=>{const a=[];let l=0;console.log("解析数据:",t,JSON.stringify(e).substring(0,500));try{switch(t){case"kw":Array.isArray(e)?(e.forEach(e=>{e.list&&Array.isArray(e.list)&&e.list.forEach(t=>{var l;let o=t.img?t.img.trim().replace(/`/g,""):"";!o||o.endsWith(".jpg")||o.endsWith(".png")||o.endsWith(".webp")||(o+=".jpg"),a.push({id:`digest-${t.digest}__${t.id}`,name:H(t.name),author:H((null==(l=e.label)?void 0:l.replace("分类",""))||""),img:o,play_count:0,total:0,desc:H(t.desc),source:"kw"})})}),l=a.length):200===e.code&&e.data&&e.data.data&&(l=e.data.total||0,e.data.data.forEach(e=>{let t=e.img?e.img.trim().replace(/`/g,""):"";!t||t.endsWith(".jpg")||t.endsWith(".png")||t.endsWith(".webp")||(t+=".jpg"),a.push({id:`digest-${e.digest}__${e.id}`,name:H(e.name),author:H(e.uname),img:t,play_count:e.listencnt,total:e.total,desc:H(e.desc),source:"kw"})}));break;case"kg":1===e.status&&e.special_db&&(l=e.special_db.length||0,e.special_db.forEach(e=>{a.push({id:"id_"+e.specialid,name:e.specialname,author:e.nickname,img:e.img||"",play_count:e.play_count||e.total_play_count,total:e.songcount,time:e.publishtime||e.publish_time,desc:e.intro,source:"kg"})}));break;case"tx":if(0===e.code&&e.playlist&&e.playlist.data){const t=e.playlist.data;t.v_playlist&&Array.isArray(t.v_playlist)&&(l=t.total||0,t.v_playlist.forEach(e=>{a.push({id:String(e.tid),name:e.title,author:e.creator_info?e.creator_info.nick:"未知",img:e.cover_url_big||e.cover_url_medium||e.cover_url_small||"",play_count:e.access_num,total:e.song_ids?e.song_ids.length:0,time:e.modify_time?1e3*e.modify_time:null,desc:e.desc||"",source:"tx"})})),t.content&&t.content.v_item&&Array.isArray(t.content.v_item)&&(l=t.content.total_cnt||0,t.content.v_item.forEach(({basic:e})=>{e&&a.push({id:String(e.tid),name:e.title,author:e.creator?e.creator.nick:"未知",img:e.cover&&(e.cover.big_url||e.cover.medium_url||e.cover.default_url)||"",play_count:e.play_cnt,total:e.song_cnt||0,desc:e.desc||"",source:"tx"})}))}break;case"mg":if("000000"===e.code&&e.data)if(e.data.contents){const t=new Set,o=e=>{var l,i;for(const n of e)n.contents?o(n.contents):"2021"!=n.resType||t.has(n.resId)||(t.add(n.resId),a.push({id:String(n.resId),author:"",name:n.txt,img:n.img,play_count:(null==(i=null==(l=n.barList)?void 0:l[0])?void 0:i.title)||void 0,desc:n.txt2||"",source:"mg"}))};o(e.data.contents),l=t.size}else e.data.contentItemList&&e.data.contentItemList[1]&&e.data.contentItemList[1].itemList&&(l=e.data.contentItemList[1].itemList.length||0,e.data.contentItemList[1].itemList.forEach(e=>{var t,l;a.push({id:String(e.logEvent.contentId),author:"",name:e.title,img:e.imageUrl,play_count:(null==(l=null==(t=e.barList)?void 0:t[0])?void 0:l.title)||void 0,desc:"",source:"mg"})}));break;case"wy":e.playlists&&Array.isArray(e.playlists)&&(l=e.total||0,e.playlists.forEach(e=>{a.push({id:String(e.id),name:e.name,author:"",img:e.coverImgUrl,play_count:e.playCount,total:e.trackCount,time:e.createTime,desc:e.description||"",source:"wy"})}))}}catch(o){console.error("解析歌单数据失败:",o)}return{list:a,total:l}},H=e=>e?e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&nbsp;/g," ").replace(/<br>/g,"\n"):"";let N=null,W=0;const Q=t=>{const a=e.index.createSelectorQuery();a.select(".list-wrapper").boundingClientRect(),a.select(".list-wrapper").scrollOffset(),a.exec(e=>{if(!e[0]||!e[1])return;const t=e[0],a=e[1],l=a.scrollTop,o=a.scrollHeight,i=t.height,n=o-l-i;Math.abs(l-W)>100&&(console.log("=== onScroll ==="),console.log("scrollTop:",l),console.log("scrollHeight:",o),console.log("clientHeight:",i),console.log("scrollBottom:",n),console.log("hasMore:",j.value),console.log("isLoadingMore:",I.value),W=l),n<100&&j.value&&!I.value&&!C.value&&(console.log("触发自动加载更多"),N&&clearTimeout(N),N=setTimeout(()=>{console.log("=== loadMore 触发 ==="),console.log("hasMore:",j.value),console.log("isLoadingMore:",I.value),console.log("currentPage:",U.value),!j.value||I.value||C.value?console.log("loadMore 被拦截"):(console.log("loadMore 执行：准备加载下一页"),U.value++,I.value=!0,E())},200))})},O=()=>{Q()};let J=null;return e.onMounted(()=>{g(),t.setStatusBarTextColor(d.value?"white":"dark"),J=({height:e,isShowing:t})=>{console.log("[SonglistList] MiniPlayer 高度变化:",e,"是否显示:",t)},e.index.$on("miniPlayerHeightChange",J);const a=f(),l=_(),o=w();console.log("[SonglistList] 读取上次选择:",{source:a,tag:l,sort:o}),b.value=a,x.value=l,L.value=o,h(b.value).then(()=>{(p.value[b.value]||[]).some(e=>e.id===x.value)||""===x.value||(console.log("[SonglistList] 保存的标签不存在，重置为推荐"),x.value=""),E()})}),e.onShow(()=>{g(),t.setStatusBarTextColor(d.value?"white":"dark")}),e.watch(b,e=>{console.log("[SonglistList] watch 平台变化:",e),x.value="",L.value="hot",h(e)}),e.watch(x,()=>{W=0}),e.onUnmounted(()=>{J&&(e.index.$off("miniPlayerHeightChange",J),console.log("[SonglistList] 已清理 MiniPlayer 监听器"))}),(t,l)=>e.e({a:e.p({name:"chevron-left",size:"24",color:"#333"}),b:e.o(z),c:e.t(R.value),d:e.p({name:"chevron-down",size:"14",color:"#666"}),e:e.o(e=>P.value=!0),f:e.f(M.value,(t,a,l)=>({a:e.t(t.name),b:t.id,c:x.value===t.id?1:"",d:e.o(e=>{return a=t.id,x.value=a,U.value=1,$.value=[],j.value=!0,k(a),void E();var a},t.id)})),g:T.value.length>0},T.value.length>0?{h:e.f(T.value,(t,a,l)=>({a:e.t(t.name),b:t.id,c:L.value===t.id?1:"",d:e.o(e=>{return a=t.id,L.value=a,U.value=1,$.value=[],j.value=!0,S(a),void E();var a},t.id)}))}:{},{i:e.s(u.value),j:C.value&&0===$.value.length},(C.value&&$.value.length,{}),{k:q.value&&!C.value},q.value&&!C.value?{l:e.t(q.value)}:{},{m:$.value.length>0},$.value.length>0?{n:e.f($.value,(t,l,i)=>e.e({a:e.unref(o.proxyImageUrl)(t.img),b:e.o(e=>((e,t)=>{if(!t||!t.img)return;let a=0;t.img.includes("wsrv.nl")?a=1:t.img.includes("weserv.nl")?a=2:t.img.includes("jina.ai")&&(a=3);const l=o.handleImageError(e,t.img,a);l&&(t.img=l)})(e,t),t.id+l),c:t.play_count},t.play_count?{d:"baf9cd20-2-"+i,e:e.p({name:"play",size:"10",color:"#fff"}),f:e.t(e.unref(a.formatPlayCount)(t.play_count))}:{},{g:t.total},t.total?{h:"baf9cd20-3-"+i,i:e.p({name:"music",size:"10",color:"#fff"}),j:e.t(t.total)}:{},{k:e.t(t.name),l:t.author||t.time},t.author||t.time?e.e({m:t.author},t.author?{n:e.t(t.author)}:{},{o:t.author&&t.time},(t.author&&t.time,{}),{p:t.time},t.time?{q:e.t(e.unref(a.formatDate)(t.time))}:{}):{},{r:t.desc},t.desc?{s:e.t(t.desc)}:{},{t:t.id+l,v:e.o(a=>(t=>{let a="";switch(t.source){case"kw":a=`https://www.kuwo.cn/playlist_detail/${t.id}`;break;case"kg":a=`https://www.kugou.com/yy/special/single/${t.id}.html`;break;case"tx":a=`https://y.qq.com/n/ryqq/playlist/${t.id}`;break;case"wy":a=`https://music.163.com/playlist?id=${t.id}`;break;case"mg":a=`https://music.migu.cn/v3/music/playlist/${t.id}`;break;default:a=t.id}e.index.navigateTo({url:`/pages/sharelist/index?source=${t.source}&link=${encodeURIComponent(a)}&id=${t.id}&picUrl=${encodeURIComponent(t.img)}&name=${encodeURIComponent(t.name||"")}&author=${encodeURIComponent(t.author||"")}&playCount=${t.play_count||0}&fromName=songlist-list`})})(t),t.id+l)}))}:{},{o:$.value.length>0},$.value.length>0?e.e({p:I.value},(I.value||j.value,{}),{q:!j.value}):{},{r:!C.value&&!q.value&&0===$.value.length},C.value||q.value||0!==$.value.length?{}:{s:e.p({name:"inbox",size:"64",color:"#ccc"})},{t:e.o(Q),v:e.o(O),w:P.value},P.value?{x:e.p({name:"xmark",size:"20",color:"#999"}),y:e.o(e=>P.value=!1),z:e.f(m,(t,a,l)=>e.e({a:e.t(t.name),b:b.value===t.id},b.value===t.id?{c:"baf9cd20-6-"+l,d:e.p({name:"check",size:"16",color:"#00d7cd"})}:{},{e:t.id,f:b.value===t.id?1:"",g:e.o(e=>A(t.id),t.id)})),A:e.o(()=>{}),B:e.o(e=>P.value=!1)}:{},{C:d.value?1:""})}},u=e._export_sfc(r,[["__scopeId","data-v-baf9cd20"]]);wx.createPage(u);
