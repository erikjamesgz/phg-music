"use strict";const e=require("../../common/vendor.js"),l=require("../../store/modules/list.js"),o=require("../../store/modules/player.js"),a=require("../../utils/lyricCache.js"),t=require("../../utils/musicPic.js"),r=require("../../utils/lyric.js"),n=require("../../utils/kgLyricDecoder.js"),i=require("../../utils/system.js"),u=require("../../utils/imageProxy.js");Math||(s+c)();const s=()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js",c=()=>"../../components/comment/MusicComment.js",v={__name:"index",setup(s){const c=e.getCurrentInstance(),v=e.ref(i.getStatusBarHeight()),y=e.computed(()=>({height:`${v.value}px`,width:"100%",backgroundColor:"transparent"})),d=e.computed(()=>({paddingTop:`${v.value}px`})),g=e.computed(()=>{var e,l;const a=o.playerStore.state.currentSong;return console.log("[player] currentSong computed:",{name:null==a?void 0:a.name,al:null==a?void 0:a.al,albumName:null==a?void 0:a.albumName,album:null==a?void 0:a.album,"al?.name":null==(e=null==a?void 0:a.al)?void 0:e.name,albumName:null==a?void 0:a.albumName,"album?.name":null==(l=null==a?void 0:a.album)?void 0:l.name}),a}),p=e.computed(()=>{const e=o.playerStore.state.originalSong;return console.log("[player] originalSong computed:",{name:null==e?void 0:e.name,source:null==e?void 0:e.source,id:null==e?void 0:e.id}),e}),f=e.computed(()=>o.playerStore.state.playing),m=e.computed(()=>o.playerStore.state.playMode),h=e.computed(()=>o.playerStore.state.currentTime),S=e.computed(()=>o.playerStore.state.duration),x=e.ref(!1),L=e.ref(0),w=e.ref(0),b=e.ref([]),T=e.ref(0),I=e.ref(!1),P=e.ref(0),$=e.ref("");let k=-1,M=!1;const C=e.ref(!1),j=e.computed(()=>l.listStore.getAllAvailableLists()),U=e.computed(()=>!!g.value&&l.listStore.isInLoveList(g.value.id)),z=e.ref(!1),q=e.ref("å–œæ¬¢è¿™é¦–æ­Œï¼Ÿç‚¹å‡»æ”¶è—");let D=null;const N=e.ref(""),_=e.ref(!0);e.ref(null);const A=e.ref(!1);e.ref(null);const R=e.ref(!1),F=e.ref(""),K=e.ref(!1),G=e.ref([]),B=e.ref(""),E=e.ref(!1),O=e.ref(!1),H=()=>{var l,a,t,i;const u=o.playerStore.state;console.log("[player] updateCachedLyricsForStatus è°ƒç”¨:",{lyricLength:null==(l=u.lyric)?void 0:l.length,tlyricLength:null==(a=u.tlyric)?void 0:a.length,lxlyricLength:null==(t=u.lxlyric)?void 0:t.length,cachedLength:G.value.length});const s={lyric:u.lyric||"",tlyric:u.tlyric||"",rlyric:u.rlyric||"",lxlyric:u.lxlyric||""},{lyric:c,tlyric:v,rlyric:y,lxlyric:d}=r.extractLyricsFromMusicData(s);let g=c||"",p=d||"";if(n.isKgCompressedLyric(g))try{g=n.tryDecodeKgLyric(g).lyric||g}catch(m){}if(n.isKgCompressedLyric(p))try{const e=n.tryDecodeKgLyric(p);p=e.lxlyric||p,!g&&e.lyric&&(g=e.lyric)}catch(m){}const f=p||g;console.log("[player] updateCachedLyricsForStatus finalLyric:",{length:null==f?void 0:f.length,lastLyricLength:null==(i=B.value)?void 0:i.length,isSame:f===B.value}),f!==B.value&&(B.value=f,f?(G.value=r.parseLyric(f),console.log("[player] è§£æžæ­Œè¯æˆåŠŸï¼Œè¡Œæ•°:",G.value.length),O.value=!0,e.nextTick$1(()=>{Q()})):(G.value=[],console.log("[player] æ­Œè¯ä¸ºç©ºï¼Œæ¸…ç©ºç¼“å­˜"),O.value=!0,e.nextTick$1(()=>{Q()})))},Q=()=>{const e=o.playerStore.state;if(e.statusText)return F.value=e.statusText,K.value=!0,void(O.value=!1);if(K.value=!1,e.playing&&!E.value&&(E.value=!0,O.value=!0),e.playing&&!O.value&&(O.value=!0),O.value){if(!(G.value.length>0))return void(F.value="æš‚æ— æ­Œè¯")}const l=e.currentTime;if(l&&G.value.length>0){const e=r.getCurrentLyricIndex(G.value,l);if(e>=0&&e<G.value.length)return void(F.value=G.value[e].text||"")}F.value=""},W=e.computed(()=>F.value),V=e.ref(!1),J=e.ref(!1),X=e.ref(0),Y=e.ref(!1),Z=e.ref([0,0]),ee=e.ref(0),le=e.ref(0),oe=e.computed(()=>{const e=[];for(let l=0;l<=99;l++)e.push(l<10?`0${l}`:`${l}`);return e}),ae=e.computed(()=>{const e=[];for(let l=0;l<=59;l++)e.push(l<10?`0${l}`:`${l}`);return e}),te=e.computed(()=>{const e=Math.floor(X.value/3600),l=Math.floor(X.value%3600/60),o=X.value%60;return e>0?`${e}æ—¶${l}åˆ†${o}ç§’`:l>0?`${l}åˆ†${o}ç§’`:`${o}ç§’`}),re=e.computed(()=>{const e=Math.floor(X.value/3600),l=Math.floor(X.value%3600/60);return e>0?`${e}h${l}m`:`${l}m`}),ne=e=>{X.value=e.remaining},ie=()=>{Z.value=[0,0],ee.value=0,le.value=0,Y.value=!0},ue=()=>{Y.value=!1},se=e=>{const l=e.detail.value;Z.value=l,ee.value=l[0],le.value=l[1]},ce=()=>{e.index.$emit("sleepTimerCancel")},ve=()=>{const l=ee.value,o=le.value,a=3600*l+60*o;if(a<=0)return void e.index.showToast({title:"è¯·é€‰æ‹©æœ‰æ•ˆçš„æ—¶é—´",icon:"none"});e.index.$emit("sleepTimerSet",{totalSeconds:a});const t=l>0?`${l}æ—¶${o}åˆ†åŽåœæ­¢æ’­æ”¾`:`${o}åˆ†é’ŸåŽåœæ­¢æ’­æ”¾`;e.index.showToast({title:t,icon:"success"}),ue()};e.watch(()=>f.value,e=>{console.log("[Player] æ’­æ”¾çŠ¶æ€å˜åŒ–:",e)});let ye=!1,de=!1;const ge=async()=>{de||(o.playerStore.setOnPlayEndedCallback(async e=>{var a,t,r,n;if(console.log("[player] æ’­æ”¾ç»“æŸå›žè°ƒè§¦å‘ï¼Œæ¨¡å¼:",e),"singleLoop"===e){if(console.log("[player] å•æ›²å¾ªçŽ¯ï¼Œé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²"),g.value){const e=o.playerStore.state.audioContext,l=g.value;if(e&&l){let o=l.url||l.playUrl;if(!o)return void console.log("[player] å½“å‰æ­Œæ›²æ²¡æœ‰æ’­æ”¾URL");const i=o.replace(/^http:/,"https:");console.log("[player] å¾®ä¿¡å°ç¨‹åºï¼Œé‡æ–°è®¾ç½®srcæ’­æ”¾"),e.title=l.name||"æœªçŸ¥æ­Œæ›²",e.singer=me(l);let u=(null==(a=l.al)?void 0:a.picUrl)||(null==(t=l.album)?void 0:t.picUrl)||l.img||"";u&&(u=u.replace(/^http:/,"https:")),e.coverImgUrl=u,e.epname=(null==(r=l.al)?void 0:r.name)||(null==(n=l.album)?void 0:n.name)||"æœªçŸ¥ä¸“è¾‘",e.src=i,console.log("[player] å•æ›²å¾ªçŽ¯æ’­æ”¾å·²è§¦å‘")}}return}if("list"===e){console.log("[player] é¡ºåºæ’­æ”¾æ¨¡å¼ï¼Œæ£€æŸ¥æ˜¯å¦æœ€åŽä¸€é¦–");const e=l.listStore.state.playInfo.playerListId,a=e===l.LIST_IDS.DEFAULT?l.listStore.state.defaultList.list:e===l.LIST_IDS.LOVE?l.listStore.state.loveList.list:l.listStore.state.tempList.list;if(l.listStore.state.playInfo.playerPlayIndex>=a.length-1)return console.log("[player] é¡ºåºæ’­æ”¾æ¨¡å¼ï¼šå·²æ˜¯æœ€åŽä¸€é¦–ï¼Œåœæ­¢æ’­æ”¾"),void o.playerStore.pause();console.log("[player] é¡ºåºæ’­æ”¾æ¨¡å¼ï¼šä¸æ˜¯æœ€åŽä¸€é¦–ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€é¦–");const t=l.listStore.getNextSong("list",!0);return void(t&&t.musicInfo?(console.log("[player] è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–:",t.musicInfo.name),await ke(t)):console.log("[player] æ²¡æœ‰ä¸‹ä¸€é¦–æ­Œæ›²å¯æ’­æ”¾"))}if("none"===e)return console.log("[player] ç¦ç”¨æ¨¡å¼ï¼Œä¸è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€é¦–"),void o.playerStore.pause();const i="random"===e?"random":"listLoop",u=l.listStore.getNextSong(i,!0);u&&u.musicInfo?(console.log("[player] è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–:",u.musicInfo.name),await ke(u)):console.log("[player] æ²¡æœ‰ä¸‹ä¸€é¦–æ­Œæ›²å¯æ’­æ”¾")}),de=!0,console.log("[player] æ’­æ”¾ç»“æŸå›žè°ƒå·²è®¾ç½®"))};e.onMounted(()=>{console.log("[player] onMounted è°ƒç”¨"),J.value="true"===e.index.getStorageSync("darkMode"),console.log("[Player] åˆå§‹åŒ–æš—é»‘æ¨¡å¼:",J.value),!ye&&g.value&&g.value.id&&(console.log("[player] onMounted - è°ƒç”¨loadLyrics"),ye=!0,e.nextTick$1(()=>{ze&&ze()})),ge(),e.nextTick$1(()=>{we()})}),e.onShow(()=>{console.log("[player] onShow è°ƒç”¨"),i.setStatusBarTextColor("black"),J.value="true"===e.index.getStorageSync("darkMode"),console.log("[Player] åˆ·æ–°æš—é»‘æ¨¡å¼:",J.value),ge(),g.value&&console.log("[player] onShow currentSong æ­Œæ‰‹å­—æ®µæ£€æŸ¥:",{singer:g.value.singer,ar:g.value.ar,artists:g.value.artists,name:g.value.name}),!ye&&0===b.value.length&&g.value&&g.value.id&&(console.log("[player] onShow - æ­Œè¯ä¸ºç©ºï¼Œè°ƒç”¨loadLyrics"),ye=!0,e.nextTick$1(()=>{ze&&ze()})),e.index.$on("sleepTimerUpdate",ne);const l=getApp();l&&l.getSleepTimerRemaining&&(X.value=l.getSleepTimerRemaining())}),e.onHide(()=>{console.log("[player] onHide è°ƒç”¨ - é¡µé¢éšè—ï¼Œä¸åšä»»ä½•æ“ä½œ"),e.index.$off("sleepTimerUpdate",ne)}),e.onUnload(()=>{console.log("[player] onUnload è°ƒç”¨ - é¡µé¢å¸è½½ï¼Œæ¸…ç†èµ„æº"),b.value=[],T.value=0,e.index.$off("sleepTimerUpdate",ne)}),e.onUnmounted(()=>{console.log("[player] onUnmounted è°ƒç”¨ - ç»„ä»¶å¸è½½")}),e.onBackPress(()=>(console.log("[player] onBackPress è§¦å‘ - ç³»ç»Ÿè¿”å›žæŒ‰é’®è¢«æŒ‰ä¸‹ï¼Œé”€æ¯é¡µé¢"),!1)),e.watch(()=>{var e;return null==(e=g.value)?void 0:e.id},async(l,o)=>{if(l!==o){const l=g.value;if(l){const e=l.sourceId||l.source;let o=t.getSongPicUrl(l,e);o?(N.value=o,_.value=!1):(N.value="",_.value=!0,o=await t.fetchSongPicUrl(l,e),o&&(N.value=o,_.value=!1)),console.log("[songPicCache] æ›´æ–°å›¾ç‰‡ç¼“å­˜:",N.value,"showDefaultCover:",_.value,"source:",e)}else N.value="",_.value=!0;A.value=!1,e.nextTick$1(()=>{we()})}},{immediate:!0}),e.watch(()=>W.value,()=>{R.value=!1,e.nextTick$1(()=>{be()})});const pe=e.computed(()=>x.value?L.value:S.value>0?h.value/S.value*100:0),fe=e.computed(()=>({listLoop:"repeat",random:"shuffle",list:"arrow-right-arrow-left",singleLoop:"rotate-right",none:"ban"}[m.value]||"repeat"));e.computed(()=>({listLoop:"åˆ—è¡¨å¾ªçŽ¯",random:"éšæœºæ’­æ”¾",list:"é¡ºåºæ’­æ”¾",singleLoop:"å•æ›²å¾ªçŽ¯",none:"ç¦ç”¨æ­Œæ›²åˆ‡æ¢"}[m.value]||"åˆ—è¡¨å¾ªçŽ¯"));const me=e=>e?e.singer?e.singer:e.ar&&e.ar.length>0?e.ar.map(e=>e.name).join("/"):e.artists&&e.artists.length>0?e.artists.map(e=>e.name).join("/"):"æœªçŸ¥æ­Œæ‰‹":"æœªçŸ¥æ­Œæ‰‹",he=e=>{var l,o;if(!e)return"æœªçŸ¥";let a="";e.ar&&Array.isArray(e.ar)&&e.ar.length>0?a=e.ar.map(e=>e.name).join("/"):e.artists&&Array.isArray(e.artists)&&e.artists.length>0?a=e.artists.map(e=>e.name).join("/"):e.singer&&(a=e.singer);let t="";return(null==(l=e.al)?void 0:l.name)?t=e.al.name:e.albumName?t=e.albumName:(null==(o=e.album)?void 0:o.name)?t=e.album.name:e.album&&(t=e.album),a&&t?`${a}-${t}`:a||(t||"æœªçŸ¥")},Se=()=>{console.log("[onPicError] å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡"),N.value="",_.value=!0},xe=e=>{if(!N.value)return void Se();let l=0;N.value.includes("wsrv.nl")?l=1:N.value.includes("weserv.nl")?l=2:N.value.includes("jina.ai")&&(l=3);const o=u.handleImageError(e,N.value,l);o?N.value=o:Se()},Le=e=>{if(!e||isNaN(e))return"00:00";const l=(e=Math.floor(e))%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`},we=()=>{try{const l=e.index.createSelectorQuery().in(c);l.select(".player-navbar__marquee").boundingClientRect(),l.select(".player-navbar__marquee-content").boundingClientRect(),l.exec(e=>{if(!e||!e[0]||!e[1])return;const l=e[0],o=e[1],a=A.value?o.width/2:o.width;A.value=a>l.width+5})}catch(l){}},be=()=>{if(W.value)try{const l=e.index.createSelectorQuery().in(c);l.select(".song-info__status-marquee").boundingClientRect(),l.select(".song-info__status-content").boundingClientRect(),l.exec(e=>{if(!e||!e[0]||!e[1])return;const l=e[0],o=e[1],a=R.value?o.width/2:o.width;console.log("[player] checkStatusMarquee:",{marqueeWidth:l.width,contentWidth:o.width,singleContentWidth:a,statusMarqueeScroll:R.value,needScroll:a>l.width+5}),R.value=a>l.width+5})}catch(l){}},Te=()=>{console.log("[player] goBack è°ƒç”¨ - ç”¨æˆ·ç‚¹å‡»è¿”å›žï¼Œé”€æ¯é¡µé¢"),e.index.navigateBack()},Ie=()=>{o.playerStore.togglePlay()},Pe=async()=>{console.log("[Player] æ’­æ”¾ä¸‹ä¸€é¦–");const a="random"===m.value?"random":"listLoop";if(o.playerStore.getState().isGettingUrl){console.log("[Player] æ­£åœ¨èŽ·å–æ’­æ”¾é“¾æŽ¥ï¼Œåªæ›´æ–°å¾…æ’­æ”¾æ­Œæ›²");const e=l.listStore.getNextSong(a,!1);return void(e&&e.musicInfo&&(console.log("[Player] æ›´æ–°å¾…æ’­æ”¾æ­Œæ›²:",e.musicInfo.name),o.playerStore.updatePendingSong(e.musicInfo)))}o.playerStore.setGettingUrl(!0);const t=l.listStore.getNextSong(a,!1);if(!t||!t.musicInfo)return console.log("[Player] æ²¡æœ‰ä¸‹ä¸€é¦–æ­Œæ›²"),o.playerStore.setGettingUrl(!1),void e.index.showToast({title:"å·²ç»æ˜¯æœ€åŽä¸€é¦–äº†",icon:"none"});console.log("[Player] ä¸‹ä¸€é¦–æ­Œæ›²:",t.musicInfo.name),await ke(t)},$e=async()=>{if(console.log("[Player] æ’­æ”¾ä¸Šä¸€é¦–"),o.playerStore.getState().isGettingUrl){console.log("[Player] æ­£åœ¨èŽ·å–æ’­æ”¾é“¾æŽ¥ï¼Œåªæ›´æ–°å¾…æ’­æ”¾æ­Œæ›²");const e="random"===m.value?"random":"listLoop",a=l.listStore.getPrevSong(e);return void(a&&a.musicInfo&&(console.log("[Player] æ›´æ–°å¾…æ’­æ”¾æ­Œæ›²:",a.musicInfo.name),o.playerStore.updatePendingSong(a.musicInfo)))}o.playerStore.setGettingUrl(!0);const a="random"===m.value?"random":"listLoop",t=l.listStore.getPrevSong(a);if(!t||!t.musicInfo)return console.log("[Player] æ²¡æœ‰ä¸Šä¸€é¦–æ­Œæ›²"),o.playerStore.setGettingUrl(!1),void e.index.showToast({title:"å·²ç»æ˜¯ç¬¬ä¸€é¦–äº†",icon:"none"});console.log("[Player] ä¸Šä¸€é¦–æ­Œæ›²:",t.musicInfo.name),await ke(t)},ke=async a=>{const t=a.musicInfo,r=a.listId,n=a.isTempPlay;try{const a={...t,url:"",playUrl:""};l.listStore.setPlayMusicInfo(r,a,n),l.listStore.addPlayedList({listId:r,musicInfo:a,isTempPlay:n}),await o.playerStore.playSong(a),b.value=[],T.value=0,I.value=!1,ye=!1,e.nextTick$1(()=>{ze()})}catch(i){console.error("[Player] æ’­æ”¾å¤±è´¥:",i),o.playerStore.setGettingUrl(!1),e.index.showToast({title:"æ’­æ”¾å¤±è´¥: "+(i.message||"æœªçŸ¥é”™è¯¯"),icon:"none"})}},Me=()=>{const l=["listLoop","random","list","singleLoop","none"],a=l.indexOf(m.value),t=l[(a+1)%l.length];o.playerStore.setPlayMode(t);e.index.showToast({title:{listLoop:"åˆ—è¡¨å¾ªçŽ¯",random:"éšæœºæ’­æ”¾",list:"é¡ºåºæ’­æ”¾",singleLoop:"å•æ›²å¾ªçŽ¯",none:"ç¦ç”¨æ­Œæ›²åˆ‡æ¢"}[t],icon:"none"})},Ce=e=>{w.value=e.detail.current,console.log("[player] æ»‘åŠ¨åˆ‡æ¢åˆ°:",0===w.value?"ä¸“è¾‘":"æ­Œè¯")},je=()=>{w.value=1,console.log("[player] ç‚¹å‡»å·¦ç®­å¤´ï¼Œåˆ‡æ¢åˆ°æ­Œè¯è§†å›¾")},Ue=()=>{w.value=0,console.log("[player] ç‚¹å‡»å³ç®­å¤´ï¼Œåˆ‡æ¢åˆ°ä¸“è¾‘è§†å›¾")},ze=async()=>{var l,t,i,u,s,c,v,y;if(I.value)return void console.log("[player] æ­Œè¯æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚");if(b.value.length>0)return void console.log("[player] å·²æœ‰æ­Œè¯ï¼Œè·³è¿‡åŠ è½½");I.value=!0,console.log("[player] ========== å¼€å§‹åŠ è½½æ­Œè¯ ==========");const d=o.playerStore.state.currentSong;console.log("[player] å½“å‰æ­Œæ›²ä¿¡æ¯:",{id:null==d?void 0:d.id,name:null==d?void 0:d.name,source:(null==d?void 0:d.source)||(null==d?void 0:d.sourceId)});try{let g={lyric:o.playerStore.state.lyric||"",tlyric:o.playerStore.state.tlyric||"",rlyric:o.playerStore.state.rlyric||"",lxlyric:o.playerStore.state.lxlyric||""};if(console.log("[player] ä»ŽplayerStoreèŽ·å–æ­Œè¯:",{lyricLength:null==(l=g.lyric)?void 0:l.length,tlyricLength:null==(t=g.tlyric)?void 0:t.length,rlyricLength:null==(i=g.rlyric)?void 0:i.length,lxlyricLength:null==(u=g.lxlyric)?void 0:u.length,source:(null==d?void 0:d.source)||(null==d?void 0:d.sourceId)}),!(g.lyric||g.tlyric||g.rlyric||g.lxlyric)){console.log("[player] playerStoreä¸­æ— æ­Œè¯ï¼Œå°è¯•ä»Žç¼“å­˜èŽ·å–");const e=(null==d?void 0:d.source)||(null==d?void 0:d.sourceId)||"tx";console.log("[player] èŽ·å–æ­Œè¯ç¼“å­˜ï¼Œæ­Œæ›²ID:",null==d?void 0:d.id,"éŸ³æº:",e);const l=[e];(null==d?void 0:d.source)&&(null==d?void 0:d.sourceId)&&(null==d?void 0:d.source)!==(null==d?void 0:d.sourceId)&&l.push(null==d?void 0:d.sourceId),"tx"!==e&&l.push("tx");let o=null;for(const t of l)if(console.log("[player] å°è¯•èŽ·å–æ­Œè¯ç¼“å­˜ï¼Œsource:",t),o=await a.getCachedLyric(null==d?void 0:d.id,t),o){console.log("[player] ä»Žç¼“å­˜èŽ·å–åˆ°æ­Œè¯ï¼Œsource:",t);break}o?g={lyric:o.lyric||"",tlyric:o.tlyric||"",rlyric:o.rlyric||"",lxlyric:o.lxlyric||""}:console.log("[player] ç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰æ­Œè¯ï¼Œå·²å°è¯•çš„source:",l)}const p=(null==d?void 0:d.source)||(null==d?void 0:d.sourceId);if("é…·ç‹—"===p||"kg"===p){if(console.log("[player] æ£€æµ‹åˆ°é…·ç‹—éŸ³æºï¼Œæ£€æŸ¥æ­Œè¯æ ¼å¼"),n.isKgCompressedLyric(g.lyric)){console.log("[player] æ£€æµ‹åˆ°é…·ç‹—åŽ‹ç¼©æ­Œè¯ï¼Œå¼€å§‹è§£ç ");const e=await n.tryDecodeKgLyric(g.lyric);console.log("[player] é…·ç‹—æ­Œè¯è§£ç ç»“æžœ:",{lyricLength:null==(s=e.lyric)?void 0:s.length,tlyricLength:null==(c=e.tlyric)?void 0:c.length,rlyricLength:null==(v=e.rlyric)?void 0:v.length,lxlyricLength:null==(y=e.lxlyric)?void 0:y.length}),g={lyric:e.lyric||g.lyric,tlyric:e.tlyric||g.tlyric,rlyric:e.rlyric||g.rlyric,lxlyric:e.lxlyric||g.lxlyric}}if(n.isKgCompressedLyric(g.lxlyric)){console.log("[player] æ£€æµ‹åˆ°é…·ç‹—åŽ‹ç¼©lxlyricï¼Œå¼€å§‹è§£ç ");const e=await n.tryDecodeKgLyric(g.lxlyric);g.lxlyric=e.lxlyric||g.lxlyric,!g.lyric&&e.lyric&&(g.lyric=e.lyric)}}b.value=(e=>{console.log("[player] processLyricData è¾“å…¥:",{hasLyric:!!(null==e?void 0:e.lyric),hasTlyric:!!(null==e?void 0:e.tlyric),hasRlyric:!!(null==e?void 0:e.rlyric),hasLxlyric:!!(null==e?void 0:e.lxlyric)});const{lyric:l,tlyric:o,rlyric:a,lxlyric:t}=r.extractLyricsFromMusicData(e);console.log("[player] extractLyricsFromMusicData æå–ç»“æžœ:",{lyricLength:null==l?void 0:l.length,tlyricLength:null==o?void 0:o.length,rlyricLength:null==a?void 0:a.length,lxlyricLength:null==t?void 0:t.length,lyricPreview:null==l?void 0:l.substring(0,100)}),console.log("[player] å¼€å§‹è§£æžæ­Œè¯...");const n=r.parseLyric(l);console.log("[player] parseLyric ç»“æžœ:",{inputLength:null==l?void 0:l.length,outputLength:null==n?void 0:n.length,firstLine:null==n?void 0:n[0],lastLine:null==n?void 0:n[(null==n?void 0:n.length)-1]});const i=r.parseTranslation(o);console.log("[player] parseTranslation ç»“æžœ:",{inputLength:null==o?void 0:o.length,outputLength:null==i?void 0:i.length});const u=r.mergeLyrics(n,i);return console.log("[player] æ­Œè¯å¤„ç†å®Œæˆï¼Œå…±",u.length,"è¡Œ"),console.log("[player] æ­Œè¯æ•°ç»„å‰3è¡Œ:",u.slice(0,3)),u})(g),o.playerStore.setLyrics({lyric:g.lyric,tlyric:g.tlyric,rlyric:g.rlyric,lxlyric:g.lxlyric}),e.nextTick$1(()=>{setTimeout(()=>{qe()},50)})}catch(g){console.error("[player] èŽ·å–æ­Œè¯å¤±è´¥:",g),console.error("[player] é”™è¯¯è¯¦æƒ…:",null==g?void 0:g.message,null==g?void 0:g.stack),b.value=[]}finally{I.value=!1}console.log("[player] ========== æ­Œè¯åŠ è½½ç»“æŸ ==========")},qe=()=>{if(0===b.value.length)return;const e=r.getCurrentLyricIndex(b.value,h.value);e!==T.value&&(T.value=e,De())},De=()=>{T.value<0||0===b.value.length||T.value===k&&M||(k=T.value,M=!0,setTimeout(()=>{$.value="lyric-line-"+T.value},50),setTimeout(()=>{M=!1},650))},Ne=e=>{},_e=()=>{De()};e.watch(()=>h.value,()=>{1===w.value&&qe()}),e.watch(()=>o.playerStore.state.lyric,H,{immediate:!0}),e.watch(()=>o.playerStore.state.lxlyric,H),e.watch(()=>o.playerStore.state.currentTime,Q),e.watch(()=>o.playerStore.state.statusText,()=>{Q()},{immediate:!0}),e.watch(()=>g.value,(l,o)=>{console.log("[player] watch currentSong å˜åŒ–:",{newId:null==l?void 0:l.id,oldId:null==o?void 0:o.id,hasNewSong:!(!l||!l.id)}),l&&(console.log("[player] currentSong å®Œæ•´ä¿¡æ¯:",JSON.stringify(l,null,2)),console.log("[player] currentSong æ­Œæ‰‹å­—æ®µæ£€æŸ¥:",{singer:l.singer,ar:l.ar,artists:l.artists})),(null==l?void 0:l.id)!==(null==o?void 0:o.id)&&(console.log("[player] æ­Œæ›²å˜åŒ–ï¼Œæ¸…ç©ºæ­Œè¯çŠ¶æ€"),b.value=[],T.value=0,I.value=!1,ye=!1,E.value=!1,O.value=!1,Ee=null,Oe.delete(null==l?void 0:l.id),z.value=!1,D&&(clearTimeout(D),D=null),console.log("[player] æ”¶è—æç¤ºè·Ÿè¸ªå·²é‡ç½®")),l&&l.id&&!ye&&(console.log("[player] watch currentSong - è°ƒç”¨loadLyrics"),ye=!0,e.nextTick$1(()=>{ze()}))});const Ae=e=>{x.value=!0,Ke(e)},Re=e=>{x.value&&Ke(e)},Fe=()=>{x.value&&(x.value=!1,L.value,S.value,o.playerStore.seek(L.value))},Ke=l=>{const o=l.touches[0],a=e.index.createSelectorQuery();a.select(".progress-bar-wrapper").boundingClientRect(),a.exec(e=>{if(e[0]){const l=e[0],a=o.clientX-l.left,t=Math.min(Math.max(a/l.width*100,0),100);L.value=t}})},Ge=()=>{e.index.showToast({title:"ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­",icon:"none"})},Be=[{text:"å–œæ¬¢è¿™é¦–æ­Œï¼Ÿç‚¹å‡»æ”¶è—",emoji:"ðŸ’š"},{text:"è¿™é¦–æ­Œä¸é”™å§ï¼Ÿç‚¹çˆ±å¿ƒæ”¶è—",emoji:"â¤ï¸"},{text:"å¥½å¬çš„æ­Œå€¼å¾—æ”¶è—",emoji:"ðŸ’–"},{text:"è¿™é¦–æ­Œå”±è¿›å¿ƒé‡Œäº†",emoji:"ðŸ’—"},{text:"æ”¶è—èµ·æ¥æ…¢æ…¢å¬",emoji:"ðŸ’“"},{text:"è¿™é¦–æ­Œæ˜¯ä½ çš„èœå—ï¼Ÿ",emoji:"ðŸ¤"},{text:"è®¾ä¸ºå–œæ¬¢çš„æ­Œå§",emoji:"ðŸ’˜"},{text:"éŸ³ä¹å€¼å¾—è¢«çè—",emoji:"ðŸ’"}];let Ee=null;const Oe=new Set,He=()=>{const e=Math.floor(Math.random()*Be.length),l=Be[e];return`${l.emoji} ${l.text}`};e.watch(()=>h.value,(e,l)=>{var o;if(!f.value||U.value)return;const a=null==(o=g.value)?void 0:o.id;if(!a)return;if(Ee!==a)return Ee=a,void Oe.delete(a);if(Oe.has(a))return;const t=(()=>{const e=S.value;if(!e||e<=60)return 60;const l=Math.max(60,e-30);return Math.floor(Math.random()*(l-60+1))+60})();e>=t&&l<t&&(console.log(`[Player] æ’­æ”¾æ—¶é•¿è¾¾åˆ°${Math.floor(t)}ç§’ï¼Œæ˜¾ç¤ºæ”¶è—æç¤º`),Oe.add(a),U.value||z.value||(console.log("[Player] æ˜¾ç¤ºæ”¶è—æç¤º"),q.value=He(),z.value=!0,D&&clearTimeout(D),D=setTimeout(()=>{z.value=!1,console.log("[Player] æ”¶è—æç¤ºå·²è‡ªåŠ¨éšè—")},5e3)))},{immediate:!1});const Qe=()=>{if(!g.value)return void e.index.showToast({title:"æ²¡æœ‰æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²",icon:"none"});z.value=!1,D&&(clearTimeout(D),D=null);const l=j.value;if(console.log("[Player] handleFavorite - å¯ç”¨åˆ—è¡¨æ•°é‡:",l.length),1===l.length&&"love"===l[0].type)return console.log("[Player] åªæœ‰ä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ‡æ¢æ”¶è—çŠ¶æ€"),void We();console.log("[Player] æœ‰å¤šä¸ªåˆ—è¡¨ï¼Œæ˜¾ç¤ºé€‰æ‹©å¼¹çª—"),C.value=!0},We=()=>{if(!g.value)return;l.listStore.isInLoveList(g.value.id)?(l.listStore.removeFromLoveList(g.value.id),console.log("[Player] å–æ¶ˆæ”¶è—:",g.value.name),e.index.showToast({title:"å·²å–æ¶ˆå–œæ¬¢",icon:"none"})):(l.listStore.addListMusics(l.LIST_IDS.LOVE,g.value,"top"),console.log("[Player] æ·»åŠ åˆ°æˆ‘çš„æ”¶è—:",g.value.name),e.index.showToast({title:"å·²æ·»åŠ åˆ°æˆ‘å–œæ¬¢çš„éŸ³ä¹",icon:"success"}))},Ve=()=>{C.value=!1},Je=(e,l=!1)=>l?{default:"rgba(0, 215, 205, 0.4)",love:"rgba(255, 107, 107, 0.4)",user:"rgba(107, 114, 128, 0.4)",custom:"rgba(245, 158, 11, 0.4)",imported:"rgba(59, 130, 246, 0.4)"}[e]||"rgba(107, 114, 128, 0.4)":{default:"#00d7cd",love:"#ff6b6b",user:"#6b7280",custom:"#f59e0b",imported:"#3b82f6"}[e]||"#6b7280",Xe=e=>!!g.value&&l.listStore.checkSongInList(e,g.value.id),Ye=()=>{e.index.showModal({title:"æ–°å»ºæ­Œå•",editable:!0,placeholderText:"è¯·è¾“å…¥æ­Œå•åç§°",success:o=>{if(o.confirm&&o.content){const a=o.content.trim();if(!a)return void e.index.showToast({title:"æ­Œå•åç§°ä¸èƒ½ä¸ºç©º",icon:"none"});l.listStore.createUserList(a)&&(e.index.showToast({title:"åˆ›å»ºæˆåŠŸ",icon:"success"}),Ve())}}})},Ze=()=>{V.value=!0},el=()=>{V.value=!1};return(a,t)=>e.e({a:e.s(y.value),b:e.p({type:"fas",name:"chevron-down",size:"20",color:J.value?"#ffffff":"#4b5563"}),c:e.o(Te),d:e.t(he(g.value)),e:A.value},(A.value,{}),{f:A.value},A.value?{g:e.t(he(g.value))}:{},{h:A.value?1:"",i:0===w.value?1:"",j:1===w.value?1:"",k:e.s(d.value),l:!_.value&&N.value},!_.value&&N.value?{m:e.unref(u.proxyImageUrl)(N.value),n:e.o(xe)}:{o:e.p({type:"fas",name:"music",size:"80",color:"rgba(0, 215, 205, 0.4)"})},{p:!_.value&&N.value?1:"",q:f.value?1:"",r:f.value?1:"",s:e.t(g.value.name),t:W.value},W.value?e.e({v:e.t(W.value),w:R.value},(R.value,{}),{x:R.value},R.value?{y:e.t(W.value)}:{},{z:R.value?1:""}):{},{A:f.value?"":1,B:b.value.length>0},b.value.length>0?{C:e.f(b.value,(l,a,t)=>e.e({a:e.t(l.text),b:l.translation},l.translation?{c:e.t(l.translation)}:{},{d:T.value===a?1:"",e:a,f:"lyric-line-"+a,g:a,h:e.o(e=>(e=>{if(0===b.value.length||e<0||e>=b.value.length)return;const l=b.value[e].time/1e3,a=S.value>0?l/S.value*100:0;o.playerStore.seek(a)})(a),a)})),D:P.value,E:$.value,F:e.o(Ne),G:e.o(_e)}:{},{H:w.value,I:e.o(Ce),J:1===w.value},1===w.value?{K:e.p({type:"fas",name:"chevron-left",size:"16",color:J.value?"#ffffff":"#4b5563"}),L:e.o(Ue)}:{},{M:0===w.value},0===w.value?{N:e.p({type:"fas",name:"chevron-right",size:"16",color:J.value?"#ffffff":"#4b5563"}),O:e.o(je)}:{},{P:x.value?L.value+"%":pe.value+"%",Q:x.value?L.value+"%":pe.value+"%",R:e.o(Ae),S:e.o(Re),T:e.o(Fe),U:e.t(Le(h.value)),V:e.t(Le(S.value)),W:e.p({type:"fas",name:fe.value,size:"20",color:J.value?"#ffffff":"#6b7280"}),X:e.o(Me),Y:e.p({type:"fas",name:"backward-step",size:"28",color:J.value?"#ffffff":"#374151"}),Z:e.o($e),aa:e.p({type:"fas",name:f.value?"pause":"play",size:"28",color:"#ffffff"}),ab:e.o(Ie),ac:e.p({type:"fas",name:"forward-step",size:"28",color:J.value?"#ffffff":"#374151"}),ad:e.o(Pe),ae:e.p({type:"fas",name:"comment",size:"20",color:J.value?"#ffffff":"#6b7280"}),af:e.o(Ze),ag:e.p({type:"fas",name:"clock",size:"18",color:X.value>0?"#00d7cd":J.value?"#ffffff":"#6b7280"}),ah:X.value>0},X.value>0?{ai:e.t(re.value)}:{},{aj:X.value>0?1:"",ak:e.o(ie),al:z.value},z.value?{am:e.t(q.value),an:e.p({type:"fas",name:"xmark",size:"10",color:"rgba(255,255,255,0.7)"}),ao:e.o(e=>z.value=!1),ap:e.o(Qe)}:{},{aq:e.p({type:"fas",name:(U.value,"heart"),size:18,color:U.value?"#ff6b6b":J.value?"#ffffff":"#6b7280"}),ar:U.value?1:"",as:e.o(Qe),at:e.p({type:"fas",name:"plus",size:"18",color:J.value?"#ffffff":"#6b7280"}),av:e.o(Ye),aw:e.p({type:"fas",name:"download",size:"18",color:J.value?"#ffffff":"#6b7280"}),ax:e.o(Ge),ay:C.value},C.value?{az:e.p({type:"fas",name:"xmark",size:"20",color:"#999"}),aA:e.o(Ve),aB:e.p({type:"fas",name:"plus",size:"18",color:"#00d7cd"}),aC:e.o(Ye),aD:e.f(j.value,(o,a,t)=>{return{a:"54811c87-16-"+t,b:e.p({type:"fas",name:(n=o.type,{default:"music",love:"heart",user:"list-ul",custom:"folder",imported:"download"}[n]||"list-ul"),size:"18",color:Xe(o.id)?Je(o.type,!0):Je(o.type,!1)}),c:e.t(o.name),d:Xe(o.id)?1:"",e:e.t(Xe(o.id)?"å·²æ·»åŠ ":(r=o.id,l.listStore.getListCount(r)+"é¦–")),f:Xe(o.id)?1:"",g:Xe(o.id)?1:"",h:o.id,i:e.o(a=>(o=>{var a,t;if(!g.value)return;if(l.listStore.checkSongInList(o,g.value.id)){l.listStore.removeListMusics(o,g.value.id);const t=(null==(a=j.value.find(e=>e.id===o))?void 0:a.name)||"åˆ—è¡¨";e.index.showToast({title:`å·²ä»Ž${t}ç§»é™¤`,icon:"none"})}else if(l.listStore.addMusicToAnyList(o,g.value,"top")){const l=(null==(t=j.value.find(e=>e.id===o))?void 0:t.name)||"åˆ—è¡¨";e.index.showToast({title:`å·²æ·»åŠ åˆ°${l}`,icon:"success"})}else e.index.showToast({title:"æ“ä½œå¤±è´¥",icon:"none"});Ve()})(o.id),o.id)};var r,n}),aE:e.o(()=>{}),aF:e.o(Ve)}:{},{aG:Y.value},Y.value?e.e({aH:e.p({type:"fas",name:"xmark",size:"16",color:"#6b7280"}),aI:e.o(ue),aJ:X.value>0},X.value>0?{aK:e.t(te.value),aL:e.o(ce)}:{},{aM:e.f(oe.value,(l,o,a)=>({a:e.t(l),b:o})),aN:e.f(ae.value,(l,o,a)=>({a:e.t(l),b:o})),aO:Z.value,aP:e.o(se),aQ:e.o(ue),aR:e.o(ve),aS:e.o(()=>{}),aT:e.o(ue)}):{},{aU:e.o(el),aV:e.p({show:V.value,"music-info":p.value}),aW:J.value?1:""})}};wx.createPage(v);
