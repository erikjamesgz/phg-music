"use strict";const e=require("../../common/vendor.js"),l=require("../../store/modules/list.js"),o=require("../../store/modules/player.js"),a=require("../../store/modules/system.js"),t=require("../../utils/api/music.js"),r=require("../../utils/musicUrlCache.js"),n=require("../../utils/lyricCache.js"),i=require("../../utils/musicPic.js"),s=require("../../utils/lyric.js"),u=require("../../utils/kgLyricDecoder.js"),c=require("../../utils/system.js"),v=require("../../utils/imageProxy.js");Math||d();const d=()=>"../../uni_modules/roc-icon-plus/components/roc-icon-plus/roc-icon-plus.js",y={__name:"index",setup(d){const y=e.ref(c.getStatusBarHeight()),g=e.computed(()=>({height:`${y.value}px`,width:"100%",backgroundColor:"transparent"})),p=e.computed(()=>({paddingTop:`${y.value}px`})),m=e.computed(()=>o.playerStore.state.currentSong),f=e.computed(()=>o.playerStore.state.playing),h=e.computed(()=>o.playerStore.state.playMode),x=e.computed(()=>o.playerStore.state.currentTime),S=e.computed(()=>o.playerStore.state.duration),L=e.ref(!1),w=e.ref(0),b=e.ref(0),I=e.ref([]),T=e.ref(0),P=e.ref(!1),k=e.ref(0),$=e.ref("");let M=-1,j=!1;const U=e.ref(!1),q=e.computed(()=>l.listStore.getAllAvailableLists()),z=e.computed(()=>!!m.value&&l.listStore.isInLoveList(m.value.id)),C=e.ref(!1),N=e.ref("å–œæ¬¢è¿™é¦–æ­Œï¼Ÿç‚¹å‡»æ”¶è—");let D=null;const B=e.ref(""),E=e.ref(!0),F=e.ref(!1),A=e.ref(0),O=e.ref(!1),K=e.ref([0,0]),R=e.ref(0),_=e.ref(0),H=e.computed(()=>{const e=[];for(let l=0;l<=99;l++)e.push(l<10?`0${l}`:`${l}`);return e}),J=e.computed(()=>{const e=[];for(let l=0;l<=59;l++)e.push(l<10?`0${l}`:`${l}`);return e}),Q=e.computed(()=>{const e=Math.floor(A.value/3600),l=Math.floor(A.value%3600/60),o=A.value%60;return e>0?`${e}æ—¶${l}åˆ†${o}ç§’`:l>0?`${l}åˆ†${o}ç§’`:`${o}ç§’`}),V=e.computed(()=>{const e=Math.floor(A.value/3600),l=Math.floor(A.value%3600/60);return e>0?`${e}h${l}m`:`${l}m`}),G=e=>{A.value=e.remaining},X=()=>{K.value=[0,0],R.value=0,_.value=0,O.value=!0},W=()=>{O.value=!1},Y=e=>{const l=e.detail.value;K.value=l,R.value=l[0],_.value=l[1]},Z=()=>{e.index.$emit("sleepTimerCancel")},ee=()=>{const l=R.value,o=_.value,a=3600*l+60*o;if(a<=0)return void e.index.showToast({title:"è¯·é€‰æ‹©æœ‰æ•ˆçš„æ—¶é—´",icon:"none"});e.index.$emit("sleepTimerSet",{totalSeconds:a});const t=l>0?`${l}æ—¶${o}åˆ†åŽåœæ­¢æ’­æ”¾`:`${o}åˆ†é’ŸåŽåœæ­¢æ’­æ”¾`;e.index.showToast({title:t,icon:"success"}),W()};e.watch(()=>f.value,e=>{console.log("[Player] æ’­æ”¾çŠ¶æ€å˜åŒ–:",e)});let le=!1,oe=!1;const ae=async()=>{oe||(o.playerStore.setOnPlayEndedCallback(async e=>{var a,t,r,n;if(console.log("[player] æ’­æ”¾ç»“æŸå›žè°ƒè§¦å‘ï¼Œæ¨¡å¼:",e),"singleLoop"===e){if(console.log("[player] å•æ›²å¾ªçŽ¯ï¼Œé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²"),m.value){const e=o.playerStore.state.audioContext,l=m.value;if(e&&l){let o=l.url||l.playUrl;if(!o)return void console.log("[player] å½“å‰æ­Œæ›²æ²¡æœ‰æ’­æ”¾URL");const i=o.replace(/^http:/,"https:");console.log("[player] å¾®ä¿¡å°ç¨‹åºï¼Œé‡æ–°è®¾ç½®srcæ’­æ”¾"),e.title=l.name||"æœªçŸ¥æ­Œæ›²",e.singer=ne(l);let s=(null==(a=l.al)?void 0:a.picUrl)||(null==(t=l.album)?void 0:t.picUrl)||l.img||"";s&&(s=s.replace(/^http:/,"https:")),e.coverImgUrl=s,e.epname=(null==(r=l.al)?void 0:r.name)||(null==(n=l.album)?void 0:n.name)||"æœªçŸ¥ä¸“è¾‘",e.src=i,console.log("[player] å•æ›²å¾ªçŽ¯æ’­æ”¾å·²è§¦å‘")}}return}if("list"===e){console.log("[player] é¡ºåºæ’­æ”¾æ¨¡å¼ï¼Œæ£€æŸ¥æ˜¯å¦æœ€åŽä¸€é¦–");const e=l.listStore.state.playInfo.playerListId,o=e===l.LIST_IDS.DEFAULT?l.listStore.state.defaultList.list:e===l.LIST_IDS.LOVE?l.listStore.state.loveList.list:l.listStore.state.tempList.list;return l.listStore.state.playInfo.playerPlayIndex>=o.length-1?void console.log("[player] é¡ºåºæ’­æ”¾æ¨¡å¼ï¼šå·²æ˜¯æœ€åŽä¸€é¦–ï¼Œåœæ­¢æ’­æ”¾"):void console.log("[player] é¡ºåºæ’­æ”¾æ¨¡å¼ï¼šä¸æ˜¯æœ€åŽä¸€é¦–ï¼Œä¸è‡ªåŠ¨åˆ‡æ¢")}if("none"===e)return void console.log("[player] ç¦ç”¨æ¨¡å¼ï¼Œä¸è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€é¦–");const i="random"===e?"random":"listLoop",s=l.listStore.getNextSong(i,!0);s&&s.musicInfo?(console.log("[player] è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–:",s.musicInfo.name),await ge(s)):console.log("[player] æ²¡æœ‰ä¸‹ä¸€é¦–æ­Œæ›²å¯æ’­æ”¾")}),oe=!0,console.log("[player] æ’­æ”¾ç»“æŸå›žè°ƒå·²è®¾ç½®"))};e.onMounted(()=>{console.log("[player] onMounted è°ƒç”¨"),F.value="true"===e.index.getStorageSync("darkMode"),console.log("[Player] åˆå§‹åŒ–æš—é»‘æ¨¡å¼:",F.value),!le&&m.value&&m.value.id&&(console.log("[player] onMounted - è°ƒç”¨loadLyrics"),le=!0,e.nextTick$1(()=>{Se&&Se()})),ae()}),e.onShow(()=>{console.log("[player] onShow è°ƒç”¨"),c.setStatusBarTextColor("black"),F.value="true"===e.index.getStorageSync("darkMode"),console.log("[Player] åˆ·æ–°æš—é»‘æ¨¡å¼:",F.value),ae(),m.value&&console.log("[player] onShow currentSong æ­Œæ‰‹å­—æ®µæ£€æŸ¥:",{singer:m.value.singer,ar:m.value.ar,artists:m.value.artists,name:m.value.name}),!le&&0===I.value.length&&m.value&&m.value.id&&(console.log("[player] onShow - æ­Œè¯ä¸ºç©ºï¼Œè°ƒç”¨loadLyrics"),le=!0,e.nextTick$1(()=>{Se&&Se()})),e.index.$on("sleepTimerUpdate",G);const l=getApp();l&&l.getSleepTimerRemaining&&(A.value=l.getSleepTimerRemaining())}),e.onHide(()=>{console.log("[player] onHide è°ƒç”¨ - é¡µé¢éšè—ï¼Œä¸åšä»»ä½•æ“ä½œ"),e.index.$off("sleepTimerUpdate",G)}),e.onUnload(()=>{console.log("[player] onUnload è°ƒç”¨ - é¡µé¢å¸è½½ï¼Œæ¸…ç†èµ„æº"),I.value=[],T.value=0,e.index.$off("sleepTimerUpdate",G)}),e.onUnmounted(()=>{console.log("[player] onUnmounted è°ƒç”¨ - ç»„ä»¶å¸è½½")}),e.onBackPress(()=>(console.log("[player] onBackPress è§¦å‘ - ç³»ç»Ÿè¿”å›žæŒ‰é’®è¢«æŒ‰ä¸‹ï¼Œé”€æ¯é¡µé¢"),!1)),e.watch(()=>{var e;return null==(e=m.value)?void 0:e.id},async(e,l)=>{if(e!==l){const e=m.value;if(e){const l=e.sourceId||e.source;let o=i.getSongPicUrl(e,l);o?(B.value=o,E.value=!1):(B.value="",E.value=!0,o=await i.fetchSongPicUrl(e,l),o&&(B.value=o,E.value=!1)),console.log("[songPicCache] æ›´æ–°å›¾ç‰‡ç¼“å­˜:",B.value,"showDefaultCover:",E.value,"source:",l)}else B.value="",E.value=!0}},{immediate:!0});const te=e.computed(()=>L.value?w.value:S.value>0?x.value/S.value*100:0),re=e.computed(()=>({listLoop:"repeat",random:"shuffle",list:"arrow-right-arrow-left",singleLoop:"rotate-right",none:"ban"}[h.value]||"repeat"));e.computed(()=>({listLoop:"åˆ—è¡¨å¾ªçŽ¯",random:"éšæœºæ’­æ”¾",list:"é¡ºåºæ’­æ”¾",singleLoop:"å•æ›²å¾ªçŽ¯",none:"ç¦ç”¨æ­Œæ›²åˆ‡æ¢"}[h.value]||"åˆ—è¡¨å¾ªçŽ¯"));const ne=e=>e?e.singer?e.singer:e.ar&&e.ar.length>0?e.ar.map(e=>e.name).join("/"):e.artists&&e.artists.length>0?e.artists.map(e=>e.name).join("/"):"æœªçŸ¥æ­Œæ‰‹":"æœªçŸ¥æ­Œæ‰‹",ie=()=>{console.log("[onPicError] å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡"),B.value="",E.value=!0},se=e=>{if(!B.value)return void ie();let l=0;B.value.includes("wsrv.nl")?l=1:B.value.includes("weserv.nl")?l=2:B.value.includes("jina.ai")&&(l=3);const o=v.handleImageError(e,B.value,l);o?B.value=o:ie()},ue=e=>{if(!e||isNaN(e))return"00:00";const l=(e=Math.floor(e))%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`},ce=()=>{console.log("[player] goBack è°ƒç”¨ - ç”¨æˆ·ç‚¹å‡»è¿”å›žï¼Œé”€æ¯é¡µé¢"),e.index.navigateBack()},ve=()=>{o.playerStore.togglePlay()},de=async()=>{console.log("[Player] æ’­æ”¾ä¸‹ä¸€é¦–");const a="random"===h.value?"random":"singleLoop"===h.value?"singleLoop":"listLoop";"singleLoop"===h.value&&(console.log("[Player] å•æ›²å¾ªçŽ¯æ¨¡å¼ä¸‹åˆ‡æ¢åˆ°åˆ—è¡¨å¾ªçŽ¯"),o.playerStore.setPlayMode("listLoop"));const t=l.listStore.getNextSong(a,!1);if(!t||!t.musicInfo)return console.log("[Player] æ²¡æœ‰ä¸‹ä¸€é¦–æ­Œæ›²"),void e.index.showToast({title:"å·²ç»æ˜¯æœ€åŽä¸€é¦–äº†",icon:"none"});console.log("[Player] ä¸‹ä¸€é¦–æ­Œæ›²:",t.musicInfo.name),await ge(t)},ye=async()=>{console.log("[Player] æ’­æ”¾ä¸Šä¸€é¦–");const o="random"===h.value?"random":"listLoop",a=l.listStore.getPrevSong(o);if(!a||!a.musicInfo)return console.log("[Player] æ²¡æœ‰ä¸Šä¸€é¦–æ­Œæ›²"),void e.index.showToast({title:"å·²ç»æ˜¯ç¬¬ä¸€é¦–äº†",icon:"none"});console.log("[Player] ä¸Šä¸€é¦–æ­Œæ›²:",a.musicInfo.name),await ge(a)},ge=async i=>{var s,u,c,v,d,y;const g=i.musicInfo,p=i.listId,m=i.isTempPlay;try{const i=a.systemStore.getState().audioQuality||"128k",f=await r.getCachedMusicUrl(g.id,i);let h=f,x=null;if(f){const e=g.source||"tx";x=await n.getCachedLyric(g.id,e)||{}}else{const e=g.source||"tx";let l=g.id,o={};switch(console.log("[Player] playSongFromList æž„å»ºè¯·æ±‚å‚æ•°:"),console.log("[Player] song.source:",g.source),console.log("[Player] song.id:",g.id),console.log("[Player] song.songmid:",g.songmid),console.log("[Player] song.hash:",g.hash),console.log("[Player] song.copyrightId:",g.copyrightId),e){case"tx":l=g.songmid||g.id,o={source:"tx",musicInfo:{id:l,name:g.name,singer:g.singer||(g.ar?g.ar.map(e=>e.name).join("/"):""),source:"tx",interval:g.dt||g.duration||"",meta:{songId:l,albumName:(null==(s=g.al)?void 0:s.name)||g.albumName||""}},quality:i};break;case"mg":l=g.songmid||g.songId||g.id;const a=g.copyrightId||g.id;console.log("[Player] å’ªå’•éŸ³ä¹ - ä½¿ç”¨ songmid:",l,"copyrightId:",a),o={source:"mg",songmid:l,id:a,musicInfo:{songmid:l,copyrightId:a,name:g.name,singer:g.singer||(g.ar?g.ar.map(e=>e.name).join("/"):""),album:(null==(u=g.al)?void 0:u.name)||g.albumName||""},quality:i};break;case"kg":l=g.hash||g.id,o={source:"kg",musicInfo:{id:l,name:g.name,singer:g.singer||(g.ar?g.ar.map(e=>e.name).join("/"):""),source:"kg",interval:g.dt||g.duration||"",meta:{songId:l,albumName:(null==(c=g.al)?void 0:c.name)||g.albumName||"",hash:g.hash||g.id}},quality:i};break;case"kw":o={source:"kw",musicInfo:{id:g.id,name:g.name,singer:g.singer||(g.ar?g.ar.map(e=>e.name).join("/"):""),source:"kw",interval:g.dt||g.duration||"",meta:{songId:g.id,albumName:(null==(v=g.al)?void 0:v.name)||g.albumName||""}},quality:i};break;case"wy":o={source:"wy",musicInfo:{id:g.id,name:g.name,singer:g.singer||(g.ar?g.ar.map(e=>e.name).join("/"):""),source:"wy",interval:g.dt||g.duration||"",meta:{songId:g.id,albumName:(null==(d=g.al)?void 0:d.name)||g.albumName||""}},quality:i};break;default:o={source:e,musicInfo:{id:g.id,name:g.name,singer:g.singer||(g.ar?g.ar.map(e=>e.name).join("/"):""),source:e,interval:g.dt||g.duration||"",meta:{songId:g.id,albumName:(null==(y=g.al)?void 0:y.name)||g.albumName||""}},quality:i}}console.log("[Player] requestData:",JSON.stringify(o));const a=await t.getMusicUrl(o);h=a.url,await r.setCachedMusicUrl(g.id,i,h),x={lyric:a.lyric||"",tlyric:a.tlyric||"",rlyric:a.rlyric||"",lxlyric:a.lxlyric||""}}const S={...g,url:h,playUrl:h,quality:i,lyric:x.lyric||"",tlyric:x.tlyric||"",rlyric:x.rlyric||"",lxlyric:x.lxlyric||""};l.listStore.setPlayMusicInfo(p,S,m),l.listStore.addPlayedList({listId:p,musicInfo:S,isTempPlay:m}),await o.playerStore.playSong(S),I.value=[],T.value=0,P.value=!1,le=!1,e.nextTick$1(()=>{Se()})}catch(f){console.error("[Player] æ’­æ”¾å¤±è´¥:",f),e.index.showToast({title:"æ’­æ”¾å¤±è´¥: "+(f.message||"æœªçŸ¥é”™è¯¯"),icon:"none"})}},pe=()=>{const l=["listLoop","random","list","singleLoop","none"],a=l.indexOf(h.value),t=l[(a+1)%l.length];o.playerStore.setPlayMode(t);e.index.showToast({title:{listLoop:"åˆ—è¡¨å¾ªçŽ¯",random:"éšæœºæ’­æ”¾",list:"é¡ºåºæ’­æ”¾",singleLoop:"å•æ›²å¾ªçŽ¯",none:"ç¦ç”¨æ­Œæ›²åˆ‡æ¢"}[t],icon:"none"})},me=()=>{e.index.showToast({title:"æ’­æ”¾åˆ—è¡¨åŠŸèƒ½å¼€å‘ä¸­",icon:"none"})},fe=e=>{b.value=e.detail.current,console.log("[player] æ»‘åŠ¨åˆ‡æ¢åˆ°:",0===b.value?"ä¸“è¾‘":"æ­Œè¯")},he=()=>{b.value=1,console.log("[player] ç‚¹å‡»å·¦ç®­å¤´ï¼Œåˆ‡æ¢åˆ°æ­Œè¯è§†å›¾")},xe=()=>{b.value=0,console.log("[player] ç‚¹å‡»å³ç®­å¤´ï¼Œåˆ‡æ¢åˆ°ä¸“è¾‘è§†å›¾")},Se=async()=>{var l,a,t,r,i,c,v,d;if(P.value)return void console.log("[player] æ­Œè¯æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚");if(I.value.length>0)return void console.log("[player] å·²æœ‰æ­Œè¯ï¼Œè·³è¿‡åŠ è½½");P.value=!0,console.log("[player] ========== å¼€å§‹åŠ è½½æ­Œè¯ ==========");const y=o.playerStore.state.currentSong;console.log("[player] å½“å‰æ­Œæ›²ä¿¡æ¯:",{id:null==y?void 0:y.id,name:null==y?void 0:y.name,source:(null==y?void 0:y.source)||(null==y?void 0:y.sourceId)});try{let g={lyric:o.playerStore.state.lyric||"",tlyric:o.playerStore.state.tlyric||"",rlyric:o.playerStore.state.rlyric||"",lxlyric:o.playerStore.state.lxlyric||""};if(console.log("[player] ä»ŽplayerStoreèŽ·å–æ­Œè¯:",{lyricLength:null==(l=g.lyric)?void 0:l.length,tlyricLength:null==(a=g.tlyric)?void 0:a.length,rlyricLength:null==(t=g.rlyric)?void 0:t.length,lxlyricLength:null==(r=g.lxlyric)?void 0:r.length,source:(null==y?void 0:y.source)||(null==y?void 0:y.sourceId)}),!(g.lyric||g.tlyric||g.rlyric||g.lxlyric)){console.log("[player] playerStoreä¸­æ— æ­Œè¯ï¼Œå°è¯•ä»Žç¼“å­˜èŽ·å–");const e=(null==y?void 0:y.source)||(null==y?void 0:y.sourceId)||"tx";console.log("[player] èŽ·å–æ­Œè¯ç¼“å­˜ï¼Œæ­Œæ›²ID:",null==y?void 0:y.id,"éŸ³æº:",e);const l=[e];(null==y?void 0:y.source)&&(null==y?void 0:y.sourceId)&&(null==y?void 0:y.source)!==(null==y?void 0:y.sourceId)&&l.push(null==y?void 0:y.sourceId),"tx"!==e&&l.push("tx");let o=null;for(const a of l)if(console.log("[player] å°è¯•èŽ·å–æ­Œè¯ç¼“å­˜ï¼Œsource:",a),o=await n.getCachedLyric(null==y?void 0:y.id,a),o){console.log("[player] ä»Žç¼“å­˜èŽ·å–åˆ°æ­Œè¯ï¼Œsource:",a);break}o?g={lyric:o.lyric||"",tlyric:o.tlyric||"",rlyric:o.rlyric||"",lxlyric:o.lxlyric||""}:console.log("[player] ç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰æ­Œè¯ï¼Œå·²å°è¯•çš„source:",l)}const p=(null==y?void 0:y.source)||(null==y?void 0:y.sourceId);if("é…·ç‹—"===p||"kg"===p){if(console.log("[player] æ£€æµ‹åˆ°é…·ç‹—éŸ³æºï¼Œæ£€æŸ¥æ­Œè¯æ ¼å¼"),u.isKgCompressedLyric(g.lyric)){console.log("[player] æ£€æµ‹åˆ°é…·ç‹—åŽ‹ç¼©æ­Œè¯ï¼Œå¼€å§‹è§£ç ");const e=await u.tryDecodeKgLyric(g.lyric);console.log("[player] é…·ç‹—æ­Œè¯è§£ç ç»“æžœ:",{lyricLength:null==(i=e.lyric)?void 0:i.length,tlyricLength:null==(c=e.tlyric)?void 0:c.length,rlyricLength:null==(v=e.rlyric)?void 0:v.length,lxlyricLength:null==(d=e.lxlyric)?void 0:d.length}),g={lyric:e.lyric||g.lyric,tlyric:e.tlyric||g.tlyric,rlyric:e.rlyric||g.rlyric,lxlyric:e.lxlyric||g.lxlyric}}if(u.isKgCompressedLyric(g.lxlyric)){console.log("[player] æ£€æµ‹åˆ°é…·ç‹—åŽ‹ç¼©lxlyricï¼Œå¼€å§‹è§£ç ");const e=await u.tryDecodeKgLyric(g.lxlyric);g.lxlyric=e.lxlyric||g.lxlyric,!g.lyric&&e.lyric&&(g.lyric=e.lyric)}}I.value=(e=>{console.log("[player] processLyricData è¾“å…¥:",{hasLyric:!!(null==e?void 0:e.lyric),hasTlyric:!!(null==e?void 0:e.tlyric),hasRlyric:!!(null==e?void 0:e.rlyric),hasLxlyric:!!(null==e?void 0:e.lxlyric)});const{lyric:l,tlyric:o,rlyric:a,lxlyric:t}=s.extractLyricsFromMusicData(e);console.log("[player] extractLyricsFromMusicData æå–ç»“æžœ:",{lyricLength:null==l?void 0:l.length,tlyricLength:null==o?void 0:o.length,rlyricLength:null==a?void 0:a.length,lxlyricLength:null==t?void 0:t.length,lyricPreview:null==l?void 0:l.substring(0,100)}),console.log("[player] å¼€å§‹è§£æžæ­Œè¯...");const r=s.parseLyric(l);console.log("[player] parseLyric ç»“æžœ:",{inputLength:null==l?void 0:l.length,outputLength:null==r?void 0:r.length,firstLine:null==r?void 0:r[0],lastLine:null==r?void 0:r[(null==r?void 0:r.length)-1]});const n=s.parseTranslation(o);console.log("[player] parseTranslation ç»“æžœ:",{inputLength:null==o?void 0:o.length,outputLength:null==n?void 0:n.length});const i=s.mergeLyrics(r,n);return console.log("[player] æ­Œè¯å¤„ç†å®Œæˆï¼Œå…±",i.length,"è¡Œ"),console.log("[player] æ­Œè¯æ•°ç»„å‰3è¡Œ:",i.slice(0,3)),i})(g),e.nextTick$1(()=>{setTimeout(()=>{Le()},50)})}catch(g){console.error("[player] èŽ·å–æ­Œè¯å¤±è´¥:",g),console.error("[player] é”™è¯¯è¯¦æƒ…:",null==g?void 0:g.message,null==g?void 0:g.stack),I.value=[]}finally{P.value=!1}console.log("[player] ========== æ­Œè¯åŠ è½½ç»“æŸ ==========")},Le=()=>{if(0===I.value.length)return;const e=s.getCurrentLyricIndex(I.value,x.value);e!==T.value&&(T.value=e,we())},we=()=>{T.value<0||0===I.value.length||T.value===M&&j||(M=T.value,j=!0,setTimeout(()=>{$.value="lyric-line-"+T.value},50),setTimeout(()=>{j=!1},650))},be=e=>{},Ie=()=>{we()};e.watch(()=>x.value,()=>{1===b.value&&Le()}),e.watch(()=>m.value,(l,o)=>{console.log("[player] watch currentSong å˜åŒ–:",{newId:null==l?void 0:l.id,oldId:null==o?void 0:o.id,hasNewSong:!(!l||!l.id)}),l&&(console.log("[player] currentSong å®Œæ•´ä¿¡æ¯:",JSON.stringify(l,null,2)),console.log("[player] currentSong æ­Œæ‰‹å­—æ®µæ£€æŸ¥:",{singer:l.singer,ar:l.ar,artists:l.artists})),(null==l?void 0:l.id)!==(null==o?void 0:o.id)&&(console.log("[player] æ­Œæ›²å˜åŒ–ï¼Œæ¸…ç©ºæ­Œè¯çŠ¶æ€"),I.value=[],T.value=0,P.value=!1,le=!1,Ue=null,qe.delete(null==l?void 0:l.id),C.value=!1,D&&(clearTimeout(D),D=null),console.log("[player] æ”¶è—æç¤ºè·Ÿè¸ªå·²é‡ç½®")),l&&l.id&&!le&&(console.log("[player] watch currentSong - è°ƒç”¨loadLyrics"),le=!0,e.nextTick$1(()=>{Se()}))});const Te=e=>{L.value=!0,$e(e)},Pe=e=>{L.value&&$e(e)},ke=()=>{L.value&&(L.value=!1,w.value,S.value,o.playerStore.seek(w.value))},$e=l=>{const o=l.touches[0],a=e.index.createSelectorQuery();a.select(".progress-bar-wrapper").boundingClientRect(),a.exec(e=>{if(e[0]){const l=e[0],a=o.clientX-l.left,t=Math.min(Math.max(a/l.width*100,0),100);w.value=t}})},Me=()=>{e.index.showToast({title:"ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­",icon:"none"})},je=[{text:"å–œæ¬¢è¿™é¦–æ­Œï¼Ÿç‚¹å‡»æ”¶è—",emoji:"ðŸ’š"},{text:"è¿™é¦–æ­Œä¸é”™å§ï¼Ÿç‚¹çˆ±å¿ƒæ”¶è—",emoji:"â¤ï¸"},{text:"å¥½å¬çš„æ­Œå€¼å¾—æ”¶è—",emoji:"ðŸ’–"},{text:"è¿™é¦–æ­Œå”±è¿›å¿ƒé‡Œäº†",emoji:"ðŸ’—"},{text:"æ”¶è—èµ·æ¥æ…¢æ…¢å¬",emoji:"ðŸ’“"},{text:"è¿™é¦–æ­Œæ˜¯ä½ çš„èœå—ï¼Ÿ",emoji:"ðŸ¤"},{text:"è®¾ä¸ºå–œæ¬¢çš„æ­Œå§",emoji:"ðŸ’˜"},{text:"éŸ³ä¹å€¼å¾—è¢«çè—",emoji:"ðŸ’"}];let Ue=null;const qe=new Set,ze=()=>{const e=Math.floor(Math.random()*je.length),l=je[e];return`${l.emoji} ${l.text}`};e.watch(()=>x.value,(e,l)=>{var o;if(!f.value||z.value)return;const a=null==(o=m.value)?void 0:o.id;if(!a)return;if(Ue!==a)return Ue=a,void qe.delete(a);if(qe.has(a))return;const t=(()=>{const e=S.value;if(!e||e<=60)return 60;const l=Math.max(60,e-30);return Math.floor(Math.random()*(l-60+1))+60})();e>=t&&l<t&&(console.log(`[Player] æ’­æ”¾æ—¶é•¿è¾¾åˆ°${Math.floor(t)}ç§’ï¼Œæ˜¾ç¤ºæ”¶è—æç¤º`),qe.add(a),z.value||C.value||(console.log("[Player] æ˜¾ç¤ºæ”¶è—æç¤º"),N.value=ze(),C.value=!0,D&&clearTimeout(D),D=setTimeout(()=>{C.value=!1,console.log("[Player] æ”¶è—æç¤ºå·²è‡ªåŠ¨éšè—")},5e3)))},{immediate:!1});const Ce=()=>{if(!m.value)return void e.index.showToast({title:"æ²¡æœ‰æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²",icon:"none"});C.value=!1,D&&(clearTimeout(D),D=null);const l=q.value;if(console.log("[Player] handleFavorite - å¯ç”¨åˆ—è¡¨æ•°é‡:",l.length),1===l.length&&"love"===l[0].type)return console.log("[Player] åªæœ‰ä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ‡æ¢æ”¶è—çŠ¶æ€"),void Ne();console.log("[Player] æœ‰å¤šä¸ªåˆ—è¡¨ï¼Œæ˜¾ç¤ºé€‰æ‹©å¼¹çª—"),U.value=!0},Ne=()=>{if(!m.value)return;l.listStore.isInLoveList(m.value.id)?(l.listStore.removeFromLoveList(m.value.id),console.log("[Player] å–æ¶ˆæ”¶è—:",m.value.name),e.index.showToast({title:"å·²å–æ¶ˆå–œæ¬¢",icon:"none"})):(l.listStore.addListMusics(l.LIST_IDS.LOVE,m.value,"top"),console.log("[Player] æ·»åŠ åˆ°æˆ‘çš„æ”¶è—:",m.value.name),e.index.showToast({title:"å·²æ·»åŠ åˆ°æˆ‘å–œæ¬¢çš„éŸ³ä¹",icon:"success"}))},De=()=>{U.value=!1},Be=(e,l=!1)=>l?{default:"rgba(0, 215, 205, 0.4)",love:"rgba(255, 107, 107, 0.4)",user:"rgba(107, 114, 128, 0.4)",custom:"rgba(245, 158, 11, 0.4)",imported:"rgba(59, 130, 246, 0.4)"}[e]||"rgba(107, 114, 128, 0.4)":{default:"#00d7cd",love:"#ff6b6b",user:"#6b7280",custom:"#f59e0b",imported:"#3b82f6"}[e]||"#6b7280",Ee=e=>!!m.value&&l.listStore.checkSongInList(e,m.value.id),Fe=()=>{e.index.showModal({title:"æ–°å»ºæ­Œå•",editable:!0,placeholderText:"è¯·è¾“å…¥æ­Œå•åç§°",success:o=>{if(o.confirm&&o.content){const a=o.content.trim();if(!a)return void e.index.showToast({title:"æ­Œå•åç§°ä¸èƒ½ä¸ºç©º",icon:"none"});l.listStore.createUserList(a)&&(e.index.showToast({title:"åˆ›å»ºæˆåŠŸ",icon:"success"}),De())}}})};return(a,t)=>{var r;return e.e({a:e.s(g.value),b:e.p({type:"fas",name:"chevron-down",size:"20",color:F.value?"#ffffff":"#4b5563"}),c:e.o(ce),d:e.t((null==(r=m.value.album)?void 0:r.name)||"æœªçŸ¥ä¸“è¾‘"),e:e.s(p.value),f:0===b.value?1:"",g:1===b.value?1:"",h:!E.value&&B.value},!E.value&&B.value?{i:e.unref(v.proxyImageUrl)(B.value),j:e.o(se)}:{k:e.p({type:"fas",name:"music",size:"80",color:"rgba(0, 215, 205, 0.4)"})},{l:!E.value&&B.value?1:"",m:f.value?1:"",n:f.value?1:"",o:e.t(m.value.name),p:e.t(ne(m.value)),q:f.value?"":1,r:I.value.length>0},I.value.length>0?{s:e.f(I.value,(l,a,t)=>e.e({a:e.t(l.text),b:l.translation},l.translation?{c:e.t(l.translation)}:{},{d:T.value===a?1:"",e:a,f:"lyric-line-"+a,g:a,h:e.o(e=>(e=>{if(0===I.value.length||e<0||e>=I.value.length)return;const l=I.value[e].time/1e3,a=S.value>0?l/S.value*100:0;o.playerStore.seek(a)})(a),a)})),t:k.value,v:$.value,w:e.o(be),x:e.o(Ie)}:{},{y:b.value,z:e.o(fe),A:1===b.value},1===b.value?{B:e.p({type:"fas",name:"chevron-left",size:"16",color:F.value?"#ffffff":"#4b5563"}),C:e.o(xe)}:{},{D:0===b.value},0===b.value?{E:e.p({type:"fas",name:"chevron-right",size:"16",color:F.value?"#ffffff":"#4b5563"}),F:e.o(he)}:{},{G:L.value?w.value+"%":te.value+"%",H:L.value?w.value+"%":te.value+"%",I:e.o(Te),J:e.o(Pe),K:e.o(ke),L:e.t(ue(x.value)),M:e.t(ue(S.value)),N:e.p({type:"fas",name:re.value,size:"20",color:F.value?"#ffffff":"#6b7280"}),O:e.o(pe),P:e.p({type:"fas",name:"backward-step",size:"28",color:F.value?"#ffffff":"#374151"}),Q:e.o(ye),R:e.p({type:"fas",name:f.value?"pause":"play",size:"28",color:"#ffffff"}),S:e.o(ve),T:e.p({type:"fas",name:"forward-step",size:"28",color:F.value?"#ffffff":"#374151"}),U:e.o(de),V:e.p({type:"fas",name:"list-ul",size:"20",color:F.value?"#ffffff":"#6b7280"}),W:e.o(me),X:e.p({type:"fas",name:"clock",size:"18",color:A.value>0?"#00d7cd":F.value?"#ffffff":"#6b7280"}),Y:A.value>0},A.value>0?{Z:e.t(V.value)}:{},{aa:A.value>0?1:"",ab:e.o(X),ac:C.value},C.value?{ad:e.t(N.value),ae:e.p({type:"fas",name:"xmark",size:"10",color:"rgba(255,255,255,0.7)"}),af:e.o(e=>C.value=!1),ag:e.o(Ce)}:{},{ah:e.p({type:"fas",name:(z.value,"heart"),size:18,color:z.value?"#ff6b6b":F.value?"#ffffff":"#6b7280"}),ai:z.value?1:"",aj:e.o(Ce),ak:e.p({type:"fas",name:"plus",size:"18",color:F.value?"#ffffff":"#6b7280"}),al:e.o(Fe),am:e.p({type:"fas",name:"download",size:"18",color:F.value?"#ffffff":"#6b7280"}),an:e.o(Me),ao:U.value},U.value?{ap:e.p({type:"fas",name:"xmark",size:"20",color:"#999"}),aq:e.o(De),ar:e.p({type:"fas",name:"plus",size:"18",color:"#00d7cd"}),as:e.o(Fe),at:e.f(q.value,(o,a,t)=>{return{a:"54811c87-16-"+t,b:e.p({type:"fas",name:(n=o.type,{default:"music",love:"heart",user:"list-ul",custom:"folder",imported:"download"}[n]||"list-ul"),size:"18",color:Ee(o.id)?Be(o.type,!0):Be(o.type,!1)}),c:e.t(o.name),d:Ee(o.id)?1:"",e:e.t(Ee(o.id)?"å·²æ·»åŠ ":(r=o.id,l.listStore.getListCount(r)+"é¦–")),f:Ee(o.id)?1:"",g:Ee(o.id)?1:"",h:o.id,i:e.o(a=>(o=>{var a,t;if(!m.value)return;if(l.listStore.checkSongInList(o,m.value.id)){l.listStore.removeListMusics(o,m.value.id);const t=(null==(a=q.value.find(e=>e.id===o))?void 0:a.name)||"åˆ—è¡¨";e.index.showToast({title:`å·²ä»Ž${t}ç§»é™¤`,icon:"none"})}else if(l.listStore.addMusicToAnyList(o,m.value,"top")){const l=(null==(t=q.value.find(e=>e.id===o))?void 0:t.name)||"åˆ—è¡¨";e.index.showToast({title:`å·²æ·»åŠ åˆ°${l}`,icon:"success"})}else e.index.showToast({title:"æ“ä½œå¤±è´¥",icon:"none"});De()})(o.id),o.id)};var r,n}),av:e.o(()=>{}),aw:e.o(De)}:{},{ax:O.value},O.value?e.e({ay:e.p({type:"fas",name:"xmark",size:"16",color:"#6b7280"}),az:e.o(W),aA:A.value>0},A.value>0?{aB:e.t(Q.value),aC:e.o(Z)}:{},{aD:e.f(H.value,(l,o,a)=>({a:e.t(l),b:o})),aE:e.f(J.value,(l,o,a)=>({a:e.t(l),b:o})),aF:K.value,aG:e.o(Y),aH:e.o(W),aI:e.o(ee),aJ:e.o(()=>{}),aK:e.o(W)}):{},{aL:F.value?1:""})}}};wx.createPage(y);
