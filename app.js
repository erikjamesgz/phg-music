"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("./common/vendor.js"),o=require("./store/index.js"),n=require("./store/modules/player.js"),t=require("./store/modules/user.js");Math;const s={name:"App",data:()=>({isAppEnvironment:"undefined"!=typeof plus,isMpWeixin:!1,playStartTime:0,sleepTimerRemaining:0,sleepTimerEndTime:null,sleepTimerInterval:null}),onLaunch:async function(){console.log("======================"),console.log("[App] 应用启动"),console.log("[App] 时间:",(new Date).toISOString()),console.log("[App] 运行环境:","mp-weixin"),console.log("[App] isAppEnvironment:",this.isAppEnvironment);if(!e.index.getStorageSync("appInstallTime")){const o=Date.now();e.index.setStorageSync("appInstallTime",o),console.log("[App] 首次安装时间已保存:",new Date(o).toLocaleString())}console.log("[App] 开始初始化状态管理...");try{await o.initializeStores(),console.log("[App] 状态管理初始化完成")}catch(t){console.error("[App] 状态管理初始化失败:",t)}this.isMpWeixin=!0,console.log("[App] 检测到微信小程序环境"),this.initBackgroundAudioManager(),this.initThemeChangeListener(),this.checkSystemThemeOnLaunch(),e.index.$on("songChanging",()=>{console.log("[App] 收到切歌事件，统计播放时长"),this.recordPlayTime()}),e.index.$on("sleepTimerStop",()=>{console.log("[App] 收到定时停止播放事件，停止播放"),n.playerStore.pause(),e.index.showToast({title:"定时停止播放已生效",icon:"none"})}),e.index.$on("sleepTimerSet",e=>{console.log("[App] 收到设置定时器事件:",e),this.startSleepTimer(e.totalSeconds)}),e.index.$on("sleepTimerCancel",()=>{console.log("[App] 收到取消定时器事件"),this.cancelSleepTimer()}),console.log("[App] isMpWeixin:",this.isMpWeixin),console.log("======================")},onThemeChange(o){console.log("[App] onThemeChange 生命周期触发:",o);const n=e.index.getStorageSync("followSystem");if(console.log("[App] onThemeChange - followSystem:",n),"false"!==n){const n="dark"===o.theme;console.log("[App] onThemeChange - 系统主题:",o.theme,"isDark:",n),e.index.setStorageSync("darkMode",n.toString()),console.log("[App] onThemeChange - darkMode 已更新:",e.index.getStorageSync("darkMode")),e.index.$emit("systemThemeChange",{theme:o.theme,isDark:n}),console.log("[App] onThemeChange - 已发送主题变化事件")}else console.log("[App] onThemeChange - 跟随系统未开启，跳过更新")},onShow:function(){console.log("[App] 应用显示"),this.syncBackgroundAudioState(),this.checkSystemTheme()},onHide:function(){console.log("[App] 应用隐藏")},methods:{initBackgroundAudioManager(){console.log("[App] 初始化背景音频管理器");const o=e.index.getBackgroundAudioManager();o&&(o.onPlay(()=>{console.log("[BackgroundAudio] onPlay");const e=n.playerStore.getState();e&&(e.playing=!0),n.playerStore.clearLoadTimeout(),n.playerStore.clearQuickCheckTimeout(),n.playerStore.clearStatusText();const o=n.playerStore.getState();o&&(o.playNextRetryCount=0),o&&(o.isUsingCachedUrl=!1),this.playStartTime=Date.now()}),o.onPause(()=>{console.log("[BackgroundAudio] onPause");const e=n.playerStore.getState();e&&(e.playing=!1),this.recordPlayTime()}),o.onStop(()=>{console.log("[BackgroundAudio] onStop");const e=n.playerStore.getState();e&&(e.playing=!1,e.currentTime=0),this.recordPlayTime()}),o.onEnded(()=>{console.log("[BackgroundAudio] onEnded"),this.recordPlayTime(),console.log("[App] 调用 playerStore.handlePlayEnded"),n.playerStore.handlePlayEnded()}),o.onTimeUpdate(()=>{const e=n.playerStore.getState();e&&(e.currentTime=o.currentTime,e.duration=o.duration)}),o.onPrev(()=>{console.log("[BackgroundAudio] onPrev"),n.playerStore.playPrev()}),o.onNext(()=>{console.log("[BackgroundAudio] onNext"),n.playerStore.playNext()}),o.onError(e=>{console.error("[BackgroundAudio] onError:",e);const o=n.playerStore.getState();o&&(o.playing=!1,o.error=e.errMsg||"播放错误"),this.recordPlayTime(),console.log("[BackgroundAudio] onError - 准备刷新URL"),n.playerStore.refreshMusicUrl()}),console.log("[App] 背景音频管理器初始化完成"))},syncBackgroundAudioState(){const o=e.index.getBackgroundAudioManager();if(o){console.log("[App] 同步背景音频状态:",{paused:o.paused,duration:o.duration,currentTime:o.currentTime,src:o.src});const e=n.playerStore.getState();e&&(e.playing=!o.paused,e.currentTime=o.currentTime||0,e.duration=o.duration||0)}},recordPlayTime(){if(!this.playStartTime)return;const e=(Date.now()-this.playStartTime)/1e3/60;this.playStartTime=0,e>5/60&&(t.userStore.increaseListenTime(e),console.log("[App] 播放时长统计: +"+e.toFixed(2)+"分钟, 当前总时长:",t.userStore.getState().stats.listenTime.toFixed(2),"分钟"))},startSleepTimer(o){this.sleepTimerInterval&&clearInterval(this.sleepTimerInterval),this.sleepTimerRemaining=o,this.sleepTimerEndTime=Date.now()+1e3*o,this.sleepTimerInterval=setInterval(()=>{const o=Math.floor((this.sleepTimerEndTime-Date.now())/1e3);o<=0?(clearInterval(this.sleepTimerInterval),this.sleepTimerInterval=null,this.sleepTimerRemaining=0,this.sleepTimerEndTime=null,e.index.$emit("sleepTimerStop")):(this.sleepTimerRemaining=o,e.index.$emit("sleepTimerUpdate",{remaining:this.sleepTimerRemaining}))},1e3),e.index.$emit("sleepTimerUpdate",{remaining:this.sleepTimerRemaining})},cancelSleepTimer(){this.sleepTimerInterval&&(clearInterval(this.sleepTimerInterval),this.sleepTimerInterval=null),this.sleepTimerRemaining=0,this.sleepTimerEndTime=null,e.index.$emit("sleepTimerUpdate",{remaining:0}),e.index.showToast({title:"已取消定时停止播放",icon:"success"})},getSleepTimerRemaining(){return this.sleepTimerRemaining},initThemeChangeListener(){console.log("[App] 初始化系统主题变化监听"),"function"==typeof e.index.onThemeChange?(e.index.onThemeChange(o=>{if(console.log("[App] uni.onThemeChange 回调触发:",JSON.stringify(o)),console.log("[App] res.theme:",o.theme),!o||!o.theme)return void console.log("[App] 主题变化回调数据无效");const n=e.index.getStorageSync("followSystem");if(console.log("[App] followSystem 当前值:",n),"false"!==n){const n="dark"===o.theme,t=e.index.getStorageSync("darkMode");console.log("[App] darkMode 旧值:",t,"-> 新值:",n.toString()),e.index.setStorageSync("darkMode",n.toString()),console.log("[App] darkMode 已更新:",e.index.getStorageSync("darkMode")),e.index.$emit("systemThemeChange",{theme:o.theme,isDark:n}),console.log("[App] 已发送主题变化事件")}else console.log("[App] 跟随系统未开启，跳过更新")}),console.log("[App] 系统主题变化监听初始化完成")):console.log("[App] uni.onThemeChange 不可用，跳过监听")},async checkSystemTheme(){try{console.log("[App] 检查系统主题...");const o=e.index.getStorageSync("followSystem");if(console.log("[App] checkSystemTheme - followSystem:",o),"false"!==o){const o=await e.index.getSystemInfo();if(console.log("[App] checkSystemTheme - systemInfo.theme:",o.theme),o.theme){const n="dark"===o.theme,t=e.index.getStorageSync("darkMode"),s=n.toString();console.log("[App] checkSystemTheme - 当前 darkMode:",t,"应该更新为:",s),t!==s?(e.index.setStorageSync("darkMode",s),console.log("[App] checkSystemTheme - 已更新 darkMode"),e.index.$emit("systemThemeChange",{theme:o.theme,isDark:n}),console.log("[App] checkSystemTheme - 已发送主题变化事件")):console.log("[App] checkSystemTheme - 值相同，无需更新")}}else console.log("[App] checkSystemTheme - 跟随系统未开启")}catch(o){console.error("[App] checkSystemTheme 失败:",o)}},async checkSystemThemeOnLaunch(){try{console.log("[App] checkSystemThemeOnLaunch - 开始检查系统主题");const o=e.index.getStorageSync("followSystem");if(console.log("[App] checkSystemThemeOnLaunch - followSystem:",o),"false"!==o){const o=e.index.getSystemInfoSync();if(console.log("[App] checkSystemThemeOnLaunch - systemInfo:",JSON.stringify(o)),console.log("[App] checkSystemThemeOnLaunch - systemInfo.theme:",o.theme),o.theme){const n="dark"===o.theme,t=n.toString();e.index.setStorageSync("darkMode",t),console.log("[App] checkSystemThemeOnLaunch - darkMode 已更新为:",t),e.index.$emit("systemThemeChange",{theme:o.theme,isDark:n}),console.log("[App] checkSystemThemeOnLaunch - 已发送主题变化事件")}else console.log("[App] checkSystemThemeOnLaunch - systemInfo.theme 为空，无法获取系统主题")}else console.log("[App] checkSystemThemeOnLaunch - 跟随系统未开启")}catch(o){console.error("[App] checkSystemThemeOnLaunch 失败:",o)}}}};const i=e._export_sfc(s,[["render",function(e,o,n,t,s,i){return{}}]]);function l(){return{app:e.createSSRApp(i)}}l().app.mount("#app"),exports.createApp=l;
